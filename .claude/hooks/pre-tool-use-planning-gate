#!/bin/bash
# Hook PreToolUse: Bloqueia Edit/Write se planejamento não foi feito
# Mecanismo: verifica flag /tmp/.claude-planning-done
#
# Input: JSON via stdin com tool_name e tool_input
# Output: JSON com permissionDecision ou exit code 2
#
# - TaskCreate/TaskUpdate → cria o flag (planejamento feito)
# - Edit/Write → verifica se flag existe, bloqueia se não

FLAG_FILE="/tmp/.claude-planning-done"
INPUT=$(cat)

# Extrai tool_name do JSON via grep/sed (sem jq)
TOOL_NAME=$(echo "$INPUT" | grep -o '"tool_name"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"tool_name"[[:space:]]*:[[:space:]]*"//;s/"//')

# Se é TaskCreate, TaskUpdate ou TodoWrite, marca que planejamento foi feito
if [[ "$TOOL_NAME" == "TaskCreate" || "$TOOL_NAME" == "TaskUpdate" || "$TOOL_NAME" == "TodoWrite" ]]; then
    touch "$FLAG_FILE"
    exit 0
fi

# Se é Edit ou Write, verifica se planejamento foi feito
if [[ "$TOOL_NAME" == "Edit" || "$TOOL_NAME" == "Write" ]]; then
    if [[ ! -f "$FLAG_FILE" ]]; then
        echo "BLOQUEADO: Crie planejamento com TaskCreate antes de editar/escrever codigo." >&2
        exit 2
    fi
fi

exit 0
