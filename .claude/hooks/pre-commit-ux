#!/bin/bash
###############################################################################
# PRE-COMMIT HOOK: UX Auto-Fix
###############################################################################
#
# Este hook roda automaticamente antes de cada commit para:
# 1. Detectar issues de UX em arquivos staged
# 2. Auto-fixar issues automatiz√°veis
# 3. Bloquear commit se houver issues CR√çTICOS n√£o fixados
#
# Instala√ß√£o:
#   ln -s $(pwd)/.claude/hooks/pre-commit-ux .git/hooks/pre-commit
#
# Desabilitar temporariamente:
#   git commit --no-verify
#
###############################################################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}üîç Pre-Commit Hook: UX Auto-Fix${NC}"
echo ""

# Check if we're in the right directory
if [ ! -f "scripts/ux-auto-fix.js" ]; then
    echo -e "${RED}‚ùå Script ux-auto-fix.js n√£o encontrado!${NC}"
    exit 1
fi

# Get list of staged files in public/participante/
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/participante/" | grep -E "\.(html|css|js)$" || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ Nenhum arquivo do participante modificado. Prosseguindo...${NC}"
    exit 0
fi

echo -e "${YELLOW}üìÇ Arquivos staged no participante:${NC}"
echo "$STAGED_FILES" | sed 's/^/  - /'
echo ""

# Run auto-fix on staged files
echo -e "${BLUE}üîß Rodando auto-fix nos arquivos modificados...${NC}"
echo ""

# Create temp file with staged files
TEMP_FILES=$(mktemp)
echo "$STAGED_FILES" | sed 's|^public/participante/||' > "$TEMP_FILES"

# Run auto-fix for each file
ISSUES_FOUND=0
ISSUES_FIXED=0

while IFS= read -r file; do
    if [ -n "$file" ]; then
        OUTPUT=$(node scripts/ux-auto-fix.js --file="$file" 2>&1 || true)

        # Check if issues were found
        if echo "$OUTPUT" | grep -q "Total:.*issue(s) detectado(s)"; then
            ISSUES=$(echo "$OUTPUT" | grep -oP "Total: \K\d+" | tail -1)
            if [ "$ISSUES" -gt 0 ]; then
                ISSUES_FOUND=$((ISSUES_FOUND + ISSUES))
                echo -e "${YELLOW}‚ö†Ô∏è  $file: $ISSUES issue(s) detectado(s)${NC}"
            fi
        fi
    fi
done < "$TEMP_FILES"

rm "$TEMP_FILES"

if [ $ISSUES_FOUND -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}üìä Total: $ISSUES_FOUND issue(s) de UX detectado(s)${NC}"
    echo ""
    echo -e "${BLUE}ü§î O que fazer?${NC}"
    echo ""
    echo "1. Auto-fix autom√°tico:"
    echo -e "   ${GREEN}node scripts/ux-auto-fix.js --apply${NC}"
    echo "   git add ."
    echo "   git commit"
    echo ""
    echo "2. Pular verifica√ß√£o (n√£o recomendado):"
    echo -e "   ${RED}git commit --no-verify${NC}"
    echo ""

    # Check if user wants to auto-fix (require manual approval for safety)
    echo -e "${YELLOW}‚ö†Ô∏è  Issues detectados, mas commit ser√° permitido.${NC}"
    echo -e "${YELLOW}üí° Recomendamos rodar auto-fix antes do pr√≥ximo commit.${NC}"
    echo ""

    # Don't block commit, just warn
    exit 0
else
    echo -e "${GREEN}‚úÖ Nenhum issue de UX detectado!${NC}"
    echo ""
    exit 0
fi
