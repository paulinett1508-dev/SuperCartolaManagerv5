<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>APIs Jogos ao Vivo | Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <style>
            .ap { background: #121212; min-height: 100vh; }
            .ap-c { padding: 16px; max-width: 1100px; margin: 0 auto; }
            .ap-back { display: inline-flex; align-items: center; gap: 4px; color: #9ca3af; text-decoration: none; font-size: 0.8rem; margin-bottom: 12px; }
            .ap-back:hover { color: #FF5500; }

            /* Header compacto */
            .ap-hdr { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px 16px; background: #1a1a1a; border-radius: 8px; border: 1px solid #2d2d2d; }
            .ap-hdr-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
            .ap-hdr-icon .material-icons { font-size: 20px; color: #fff; }
            .ap-hdr h1 { font-size: 1.1rem; font-weight: 700; color: #fff; margin: 0; }
            .ap-hdr p { font-size: 0.75rem; color: #6b7280; margin: 0; }

            /* Fluxo */
            .ap-fluxo { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: #10b981; background: #1a1a1a; padding: 8px 12px; border-radius: 6px; border: 1px solid #2d2d2d; margin-bottom: 16px; }
            .ap-fluxo label { color: #6b7280; font-family: 'Inter', sans-serif; margin-right: 6px; }

            /* Grid 2 colunas */
            .ap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
            @media (max-width: 768px) { .ap-grid { grid-template-columns: 1fr; } }

            /* Painel API */
            .api-panel { background: #1a1a1a; border-radius: 8px; border: 1px solid #2d2d2d; overflow: hidden; }
            .api-panel-hdr { padding: 10px 14px; border-bottom: 1px solid #2d2d2d; display: flex; align-items: center; justify-content: space-between; }
            .api-panel-title { font-size: 0.8rem; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 6px; }
            .api-panel-body { padding: 10px 14px; }

            /* Tabela compacta de dados */
            .dt { width: 100%; border-collapse: collapse; }
            .dt td { padding: 4px 0; font-size: 0.78rem; vertical-align: top; }
            .dt td:first-child { color: #6b7280; width: 120px; white-space: nowrap; }
            .dt td:last-child { color: #d1d5db; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
            .dt tr + tr td { border-top: 1px solid #1f1f1f; }

            /* Badge */
            .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; font-size: 0.68rem; font-weight: 600; }
            .badge.on { background: rgba(16,185,129,0.15); color: #10b981; }
            .badge.sec { background: rgba(139,92,246,0.15); color: #8b5cf6; }
            .badge.off { background: rgba(239,68,68,0.15); color: #ef4444; }
            .badge.warn { background: rgba(245,158,11,0.15); color: #f59e0b; }
            .badge .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

            /* Barra de quota */
            .quota-bar { height: 6px; background: #2d2d2d; border-radius: 3px; margin-top: 4px; overflow: hidden; }
            .quota-fill { height: 100%; border-radius: 3px; transition: width 0.4s; }
            .quota-fill.g { background: #10b981; }
            .quota-fill.y { background: #f59e0b; }
            .quota-fill.r { background: #ef4444; }

            /* Protecoes inline */
            .protecoes { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
            .protecoes span { font-size: 0.68rem; background: #252525; color: #9ca3af; padding: 3px 8px; border-radius: 4px; white-space: nowrap; }

            /* Jogos section */
            .jogos-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
            .jogos-hdr-title { font-size: 0.85rem; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 6px; }
            .refresh-btn { background: #252525; border: 1px solid #3d3d3d; color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; display: flex; align-items: center; gap: 4px; }
            .refresh-btn:hover { border-color: #FF5500; }
            .refresh-btn .material-icons { font-size: 14px; }
            .refresh-btn.loading .material-icons { animation: spin 1s linear infinite; }
            @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

            /* Lista de jogos compacta */
            .jogo-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; background: #1a1a1a; border: 1px solid #2d2d2d; border-radius: 6px; margin-bottom: 4px; }
            .jogo-item:last-child { margin-bottom: 0; }
            .jogo-teams { display: flex; align-items: center; gap: 6px; flex: 1; font-size: 0.78rem; color: #d1d5db; }
            .jogo-teams img { width: 18px; height: 18px; object-fit: contain; }
            .jogo-score { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; color: #fff; min-width: 40px; text-align: center; }
            .jogo-meta { text-align: right; font-size: 0.68rem; }
            .jogo-meta .time { color: #10b981; font-weight: 600; }
            .jogo-meta .league { color: #6b7280; }
            .no-jogos { text-align: center; padding: 20px; color: #6b7280; font-size: 0.8rem; }

            /* Tabela de fontes */
            .fontes-tbl { width: 100%; border-collapse: collapse; }
            .fontes-tbl th { font-size: 0.65rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.04em; padding: 6px 10px; text-align: left; border-bottom: 1px solid #2d2d2d; }
            .fontes-tbl td { font-size: 0.75rem; color: #d1d5db; padding: 6px 10px; border-bottom: 1px solid #1f1f1f; }
            .fontes-tbl code { background: #252525; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; }
            .ord { display: inline-block; color: #fff; padding: 1px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: 600; }
        </style>
    </head>

    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main ap">
                <div class="ap-c">
                    <a href="ferramentas.html" class="ap-back"><span class="material-icons" style="font-size:16px">arrow_back</span> Ferramentas</a>

                    <div class="ap-hdr">
                        <div class="ap-hdr-icon"><span class="material-icons">sports_soccer</span></div>
                        <div>
                            <h1>Orquestrador Multi-API</h1>
                            <p>SoccerDataAPI + API-Football v3 + Globo SSR | Jogos ao Vivo</p>
                        </div>
                    </div>

                    <div class="ap-fluxo"><label>Fluxo:</label> <span id="fluxo-fallback">Carregando...</span></div>

                    <!-- ═══ APIs lado a lado ═══ -->
                    <div class="ap-grid">
                        <!-- SoccerDataAPI -->
                        <div class="api-panel">
                            <div class="api-panel-hdr">
                                <span class="api-panel-title"><span class="material-icons" style="font-size:16px;color:#10b981">cloud</span> SoccerDataAPI</span>
                                <span id="soccerdata-badge" class="badge off"><span class="dot"></span> ...</span>
                            </div>
                            <div class="api-panel-body">
                                <table class="dt">
                                    <tr><td>Papel</td><td style="color:#10b981">PRINCIPAL (livescores)</td></tr>
                                    <tr><td>Limite</td><td>75 req/dia (free)</td></tr>
                                    <tr><td>Info</td><td id="soccerdata-info">-</td></tr>
                                </table>
                            </div>
                        </div>

                        <!-- API-Football -->
                        <div class="api-panel">
                            <div class="api-panel-hdr">
                                <span class="api-panel-title"><span class="material-icons" style="font-size:16px;color:#8b5cf6">api</span> API-Football v3</span>
                                <span id="apifootball-badge" class="badge off"><span class="dot"></span> ...</span>
                            </div>
                            <div class="api-panel-body">
                                <table class="dt">
                                    <tr><td>Papel</td><td style="color:#8b5cf6">SECUNDARIA (fallback + eventos)</td></tr>
                                    <tr><td>Quota</td><td><span id="af-used">0</span>/<span id="af-cap">90</span> <span id="af-pct" style="color:#6b7280">(0%)</span></td></tr>
                                    <tr><td colspan="2"><div class="quota-bar"><div class="quota-fill g" id="af-bar" style="width:0%"></div></div></td></tr>
                                    <tr><td>Restante API</td><td id="af-remaining">?</td></tr>
                                    <tr><td>Circuit Breaker</td><td id="af-circuit"><span class="badge on"><span class="dot"></span> Fechado</span></td></tr>
                                    <tr><td>Stats</td><td id="af-stats">-</td></tr>
                                </table>
                                <div class="protecoes" id="af-protecoes">
                                    <span>Hard Cap 90</span>
                                    <span>2 req/min</span>
                                    <span>30s intervalo</span>
                                    <span>CB < 10</span>
                                    <span>Dedup 60s</span>
                                    <span>Backoff 429</span>
                                    <span>MongoDB persist</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cache -->
                    <div class="api-panel" style="margin-bottom: 16px;">
                        <div class="api-panel-hdr">
                            <span class="api-panel-title"><span class="material-icons" style="font-size:16px;color:#3b82f6">cached</span> Cache</span>
                            <span id="cache-badge" class="badge off"><span class="dot"></span> -</span>
                        </div>
                        <div class="api-panel-body">
                            <table class="dt">
                                <tr><td>Fonte</td><td id="cache-fonte">-</td></tr>
                                <tr><td>TTL</td><td id="cache-ttl">-</td></tr>
                                <tr><td>Idade</td><td id="cache-idade">-</td></tr>
                                <tr><td>Jogos</td><td id="cache-jogos">0</td></tr>
                            </table>
                        </div>
                    </div>

                    <!-- Jogos do Dia -->
                    <div class="jogos-hdr">
                        <span class="jogos-hdr-title"><span class="material-icons" style="font-size:18px;color:#FF5500">calendar_today</span> Jogos do Dia <span id="jogos-total" style="color:#6b7280;font-weight:400;font-size:0.75rem">(0)</span></span>
                        <button class="refresh-btn" onclick="carregarJogos()"><span class="material-icons">refresh</span> Atualizar</button>
                    </div>
                    <div id="jogos-container" class="no-jogos">Carregando...</div>

                    <!-- Arquitetura (tabela compacta) -->
                    <div class="api-panel" style="margin-top: 16px;">
                        <div class="api-panel-hdr">
                            <span class="api-panel-title"><span class="material-icons" style="font-size:16px;color:#FF5500">architecture</span> Arquitetura</span>
                        </div>
                        <div class="api-panel-body" style="padding: 0;">
                            <table class="fontes-tbl">
                                <thead><tr><th>#</th><th>Fonte</th><th>Endpoint</th><th>Limite</th></tr></thead>
                                <tbody>
                                    <tr><td><span class="ord" style="background:#10b981">1</span></td><td>SoccerDataAPI</td><td><code>api.soccerdataapi.com</code></td><td>75/dia</td></tr>
                                    <tr><td><span class="ord" style="background:#8b5cf6">2</span></td><td>API-Football v3</td><td><code>v3.football.api-sports.io</code></td><td>90/dia (cap)</td></tr>
                                    <tr><td><span class="ord" style="background:#3b82f6">||</span></td><td>Globo SSR</td><td><code>ge.globo.com (scraper)</code></td><td>Ilimitado</td></tr>
                                    <tr><td><span class="ord" style="background:#f59e0b">3</span></td><td>Cache Stale</td><td><code>Ultimo valido</code></td><td>30 min</td></tr>
                                    <tr><td><span class="ord" style="background:#6b7280">4</span></td><td>Globo JSON</td><td><code>data/jogos-globo.json</code></td><td>Estatico</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            if (window.__api_football_guard) return;
            window.__api_football_guard = true;

            async function loadLayout() {
                try {
                    if (document.querySelector('.app-sidebar')) return;
                    const r = await fetch("layout.html");
                    const html = await r.text();
                    const doc = new DOMParser().parseFromString(html, "text/html");
                    const sb = doc.querySelector(".app-sidebar");
                    if (sb) document.getElementById("sidebar-placeholder")?.replaceWith(sb);
                    if (!window.__layoutScriptsInjected) {
                        window.__layoutScriptsInjected = true;
                        doc.querySelectorAll("script").forEach(s => {
                            if (s.textContent.trim()) {
                                const ns = document.createElement("script");
                                ns.textContent = `(function(){${s.textContent}})();`;
                                document.head.appendChild(ns);
                            }
                        });
                    }
                } catch (e) { console.error("Layout:", e); }
            }

            async function carregarStatus() {
                const fluxoEl = document.getElementById('fluxo-fallback');
                if (!fluxoEl) return;

                try {
                    const data = await (await fetch('/api/jogos-ao-vivo/status')).json();

                    if (data.fluxo) fluxoEl.textContent = data.fluxo;

                    // SoccerDataAPI
                    const sd = data.fontes?.['soccerdata'];
                    const sdBadge = document.getElementById('soccerdata-badge');
                    const sdInfo = document.getElementById('soccerdata-info');
                    if (sdBadge) {
                        sdBadge.className = `badge ${sd?.configurado ? 'on' : 'off'}`;
                        sdBadge.innerHTML = `<span class="dot"></span> ${sd?.configurado ? 'Ativa' : 'Sem key'}`;
                    }
                    if (sdInfo) sdInfo.textContent = sd?.configurado ? 'Operacional' : (sd?.aviso || 'SOCCERDATA_API_KEY ausente');

                    // API-Football
                    const af = data.fontes?.['api-football'];
                    if (af) {
                        const afBadge = document.getElementById('apifootball-badge');
                        if (afBadge) {
                            const cls = af.habilitado ? 'sec' : af.configurado ? 'warn' : 'off';
                            const txt = af.habilitado ? 'Ativa' : af.configurado ? 'Inativa' : 'Sem key';
                            afBadge.className = `badge ${cls}`;
                            afBadge.innerHTML = `<span class="dot"></span> ${txt}`;
                        }

                        const q = af.quota || {};
                        const pct = q.percentUsado || 0;
                        const el = (id) => document.getElementById(id);
                        if (el('af-used')) el('af-used').textContent = q.usadas || 0;
                        if (el('af-cap')) el('af-cap').textContent = q.limite || 90;
                        if (el('af-pct')) el('af-pct').textContent = `(${pct}%)`;
                        if (el('af-remaining')) el('af-remaining').textContent = q.restanteApi ?? '?';
                        if (el('af-bar')) {
                            el('af-bar').style.width = `${Math.min(pct, 100)}%`;
                            el('af-bar').className = `quota-fill ${pct > 80 ? 'r' : pct > 50 ? 'y' : 'g'}`;
                        }
                        if (el('af-circuit')) {
                            el('af-circuit').innerHTML = q.circuitBreaker
                                ? `<span class="badge off"><span class="dot"></span> ABERTO</span> ${q.circuitReason || ''}`
                                : `<span class="badge on"><span class="dot"></span> Fechado</span>`;
                        }
                        const s = af.stats || {};
                        if (el('af-stats')) {
                            el('af-stats').textContent = `OK:${s.successCount||0} ERR:${s.errorCount||0} 429:${s.rateLimitHits||0} Cache:${s.cacheHits||0}`;
                        }
                    }

                    // Cache
                    const c = data.cache;
                    if (c) {
                        const fonteMap = { soccerdata:'SoccerData', 'soccerdata+globo':'SoccerData+Globo', 'api-football':'API-Football', 'api-football+globo':'API-Football+Globo', 'cache-stale':'Stale', globo:'Globo' };
                        const el = (id) => document.getElementById(id);
                        if (el('cache-fonte')) el('cache-fonte').textContent = fonteMap[c.fonte] || c.fonte || '-';
                        if (el('cache-ttl')) el('cache-ttl').textContent = c.ttlAtual || '-';
                        if (el('cache-idade')) {
                            el('cache-idade').textContent = c.idadeMinutos !== null ? `${c.idadeMinutos} min${c.stale ? ' (stale)' : ''}` : 'Sem cache';
                            el('cache-idade').style.color = c.stale ? '#f59e0b' : '#d1d5db';
                        }
                        if (el('cache-jogos')) el('cache-jogos').textContent = c.jogosEmCache || 0;
                        const cb = document.getElementById('cache-badge');
                        if (cb) {
                            cb.className = `badge ${c.temJogosAoVivo ? 'on' : 'warn'}`;
                            cb.innerHTML = `<span class="dot"></span> ${c.temJogosAoVivo ? 'Ao vivo' : 'Normal'}`;
                        }
                    }
                } catch (e) { console.error('Status:', e); }
            }

            window.carregarJogos = async function() {
                const btn = document.querySelector('.refresh-btn');
                if (btn) btn.classList.add('loading');
                try {
                    const data = await (await fetch('/api/jogos-ao-vivo')).json();
                    const total = document.getElementById('jogos-total');
                    if (total) total.textContent = `(${data.jogos?.length || 0} - ${data.fonte || '?'})`;

                    const container = document.getElementById('jogos-container');
                    if (!container) return;

                    if (!data.jogos || data.jogos.length === 0) {
                        container.innerHTML = `<div class="no-jogos">${data.mensagem || 'Nenhum jogo'} <span style="color:#4b5563">(${data.fonte || '-'})</span></div>`;
                        return;
                    }

                    container.innerHTML = data.jogos.map(j => `
                        <div class="jogo-item">
                            <div class="jogo-teams">
                                ${j.logoMandante ? `<img src="${j.logoMandante}" alt="">` : ''}
                                <span>${j.mandante}</span>
                            </div>
                            <div class="jogo-score">${j.placar || 'vs'}</div>
                            <div class="jogo-teams" style="justify-content:flex-end">
                                <span>${j.visitante}</span>
                                ${j.logoVisitante ? `<img src="${j.logoVisitante}" alt="">` : ''}
                            </div>
                            <div class="jogo-meta">
                                <div class="time">${j.tempo || j.status || j.horario}</div>
                                <div class="league">${j.liga || ''}</div>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('Jogos:', e);
                    const c = document.getElementById('jogos-container');
                    if (c) c.innerHTML = '<div class="no-jogos">Erro ao carregar</div>';
                } finally {
                    if (btn) btn.classList.remove('loading');
                }
            }

            let interval = null;
            function cleanup() { if (interval) { clearInterval(interval); interval = null; } }

            document.addEventListener("DOMContentLoaded", () => {
                loadLayout();
                carregarStatus();
                carregarJogos();
                cleanup();
                interval = setInterval(() => { carregarStatus(); carregarJogos(); }, 60000);
                new MutationObserver((_, obs) => {
                    if (!document.getElementById('fluxo-fallback')) { cleanup(); obs.disconnect(); }
                }).observe(document.body, { childList: true, subtree: true });
            });
        </script>
    </body>
</html>
