<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>APIs Jogos ao Vivo - Analytics | Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <style>
            .analytics-page {
                background: #121212;
                min-height: 100vh;
            }
            .analytics-content {
                padding: 20px 16px;
                max-width: 1200px;
                margin: 0 auto;
            }
            .analytics-header {
                background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                border: 1px solid #2d2d2d;
                display: flex;
                align-items: center;
                gap: 16px;
            }
            .analytics-header-icon {
                width: 56px;
                height: 56px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .analytics-header-icon .material-icons {
                font-size: 28px;
                color: white;
            }
            .analytics-header h1 {
                font-size: 1.5rem;
                font-weight: 700;
                color: #ffffff;
                margin: 0 0 4px 0;
            }
            .analytics-header p {
                font-size: 0.85rem;
                color: #9ca3af;
                margin: 0;
            }

            /* Stats Cards */
            .stats-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }
            .stat-card {
                background: #1a1a1a;
                border-radius: 12px;
                padding: 20px;
                border: 1px solid #2d2d2d;
            }
            .stat-card-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 12px;
            }
            .stat-card-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .stat-card-icon.green { background: rgba(16, 185, 129, 0.15); }
            .stat-card-icon.green .material-icons { color: #10b981; }
            .stat-card-icon.orange { background: rgba(255, 85, 0, 0.15); }
            .stat-card-icon.orange .material-icons { color: #FF5500; }
            .stat-card-icon.blue { background: rgba(59, 130, 246, 0.15); }
            .stat-card-icon.blue .material-icons { color: #3b82f6; }
            .stat-card-icon.yellow { background: rgba(245, 158, 11, 0.15); }
            .stat-card-icon.yellow .material-icons { color: #f59e0b; }
            .stat-card-label {
                font-size: 0.75rem;
                font-weight: 600;
                color: #9ca3af;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            .stat-card-value {
                font-size: 2rem;
                font-weight: 700;
                color: #ffffff;
                margin-bottom: 4px;
            }
            .stat-card-sub {
                font-size: 0.75rem;
                color: #6b7280;
            }
            .stat-card-sub.success { color: #10b981; }
            .stat-card-sub.warning { color: #f59e0b; }
            .stat-card-sub.danger { color: #ef4444; }

            /* Progress Bar */
            .progress-container {
                margin-top: 12px;
            }
            .progress-bar {
                height: 8px;
                background: #2d2d2d;
                border-radius: 4px;
                overflow: hidden;
            }
            .progress-fill {
                height: 100%;
                border-radius: 4px;
                transition: width 0.5s ease;
            }
            .progress-fill.green { background: linear-gradient(90deg, #10b981, #059669); }
            .progress-fill.yellow { background: linear-gradient(90deg, #f59e0b, #d97706); }
            .progress-fill.red { background: linear-gradient(90deg, #ef4444, #dc2626); }

            /* Sections */
            .section {
                background: #1a1a1a;
                border-radius: 12px;
                border: 1px solid #2d2d2d;
                margin-bottom: 24px;
                overflow: hidden;
            }
            .section-header {
                padding: 16px 20px;
                border-bottom: 1px solid #2d2d2d;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .section-title {
                font-size: 1rem;
                font-weight: 600;
                color: #ffffff;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .section-title .material-icons {
                color: #FF5500;
                font-size: 20px;
            }
            .section-body {
                padding: 20px;
            }

            /* Leagues Table */
            .leagues-table {
                width: 100%;
                border-collapse: collapse;
            }
            .leagues-table th,
            .leagues-table td {
                padding: 12px 16px;
                text-align: left;
                border-bottom: 1px solid #2d2d2d;
            }
            .leagues-table th {
                font-size: 0.7rem;
                font-weight: 600;
                color: #9ca3af;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            .leagues-table td {
                font-size: 0.85rem;
                color: #ffffff;
            }
            .leagues-table tr:last-child td {
                border-bottom: none;
            }
            .league-id {
                font-family: monospace;
                background: #252525;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.75rem;
                color: #9ca3af;
            }

            /* Live Games */
            .live-games-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .live-game {
                background: #252525;
                border-radius: 10px;
                padding: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .live-game-teams {
                display: flex;
                align-items: center;
                gap: 12px;
                flex: 1;
            }
            .live-game-team {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .live-game-team img {
                width: 28px;
                height: 28px;
                object-fit: contain;
            }
            .live-game-team span {
                font-size: 0.9rem;
                font-weight: 500;
                color: #ffffff;
            }
            .live-game-score {
                font-size: 1.25rem;
                font-weight: 700;
                color: #ffffff;
                padding: 0 16px;
            }
            .live-game-info {
                text-align: right;
            }
            .live-game-time {
                font-size: 0.85rem;
                font-weight: 600;
                color: #10b981;
            }
            .live-game-league {
                font-size: 0.7rem;
                color: #6b7280;
            }
            .no-games {
                text-align: center;
                padding: 40px;
                color: #6b7280;
            }
            .no-games .material-icons {
                font-size: 48px;
                margin-bottom: 12px;
                opacity: 0.5;
            }

            /* Status Badge */
            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 600;
            }
            .status-badge.online {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
            }
            .status-badge.offline {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }
            .status-badge .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: currentColor;
            }
            .status-badge.online .dot {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            /* Refresh Button */
            .refresh-btn {
                background: #252525;
                border: 1px solid #3d3d3d;
                color: #ffffff;
                padding: 8px 16px;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: all 0.2s ease;
            }
            .refresh-btn:hover {
                background: #3d3d3d;
                border-color: #FF5500;
            }
            .refresh-btn .material-icons {
                font-size: 18px;
            }
            .refresh-btn.loading .material-icons {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            /* Back Link */
            .back-link {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                color: #9ca3af;
                text-decoration: none;
                font-size: 0.85rem;
                margin-bottom: 16px;
                transition: color 0.2s;
            }
            .back-link:hover {
                color: #FF5500;
            }
        </style>
    </head>

    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main analytics-page">
                <div class="analytics-content">
                    <!-- Back Link -->
                    <a href="ferramentas.html" class="back-link">
                        <span class="material-icons">arrow_back</span>
                        Voltar para Ferramentas
                    </a>

                    <!-- Header -->
                    <header class="analytics-header">
                        <div class="analytics-header-icon">
                            <span class="material-icons">sports_soccer</span>
                        </div>
                        <div>
                            <h1>APIs Jogos ao Vivo</h1>
                            <p>Monitoramento de uso e status das APIs de jogos ao vivo (SoccerDataAPI Principal + Fallbacks)</p>
                        </div>
                    </header>

                    <!-- Fluxo de Fallback -->
                    <div class="section" style="margin-bottom: 24px;">
                        <div class="section-body" style="padding: 16px 20px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="color: #9ca3af; font-size: 0.8rem;">Fluxo:</span>
                                <span id="fluxo-fallback" style="font-family: monospace; font-size: 0.85rem; color: #10b981;">Carregando...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Row - SoccerDataAPI -->
                    <div style="margin-bottom: 8px; margin-top: 24px; color: #9ca3af; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="font-size: 16px; color: #10b981;">looks_one</span>
                        SoccerDataAPI (PRINCIPAL)
                    </div>
                    <div class="stats-row">
                        <!-- Status SoccerDataAPI -->
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon green">
                                    <span class="material-icons">check_circle</span>
                                </div>
                                <span class="stat-card-label">Status</span>
                            </div>
                            <div id="soccerdata-status">
                                <span class="status-badge offline">
                                    <span class="dot"></span>
                                    Verificando...
                                </span>
                            </div>
                        </div>

                        <!-- Limite SoccerDataAPI -->
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon orange">
                                    <span class="material-icons">speed</span>
                                </div>
                                <span class="stat-card-label">Limite Diario</span>
                            </div>
                            <div class="stat-card-value" id="soccerdata-limite">75</div>
                            <div class="stat-card-sub">requests/dia (free)</div>
                        </div>

                        <!-- Aviso SoccerDataAPI -->
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon yellow">
                                    <span class="material-icons">info</span>
                                </div>
                                <span class="stat-card-label">Info</span>
                            </div>
                            <div class="stat-card-value" style="font-size: 0.9rem;" id="soccerdata-info">-</div>
                        </div>
                    </div>

                    <!-- Stats Row - Cache e Jogos -->
                    <div style="margin-bottom: 8px; margin-top: 24px; color: #9ca3af; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="font-size: 16px; color: #3b82f6;">cached</span>
                        Cache & Jogos ao Vivo
                    </div>
                    <div class="stats-row">
                        <!-- Jogos ao Vivo -->
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon yellow">
                                    <span class="material-icons">live_tv</span>
                                </div>
                                <span class="stat-card-label">Jogos Brasileiros</span>
                            </div>
                            <div class="stat-card-value" id="jogos-ao-vivo">-</div>
                            <div class="stat-card-sub" id="jogos-fonte">Fonte: -</div>
                        </div>

                        <!-- Cache Status -->
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon blue">
                                    <span class="material-icons">storage</span>
                                </div>
                                <span class="stat-card-label">Cache</span>
                            </div>
                            <div class="stat-card-value" style="font-size: 1rem;" id="cache-status">-</div>
                            <div class="stat-card-sub" id="cache-idade">-</div>
                        </div>

                        <!-- Cache TTL -->
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon green">
                                    <span class="material-icons">timer</span>
                                </div>
                                <span class="stat-card-label">TTL Atual</span>
                            </div>
                            <div class="stat-card-value" style="font-size: 1.25rem;" id="cache-ttl">-</div>
                            <div class="stat-card-sub" id="cache-jogos">- jogos em cache</div>
                        </div>
                    </div>

                    <!-- Header Jogos do Dia -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons" style="color: #FF5500;">calendar_today</span>
                            <span style="font-size: 1rem; font-weight: 600; color: #fff;" id="data-jogos">Jogos do Dia</span>
                        </div>
                        <button class="refresh-btn" onclick="carregarJogos()">
                            <span class="material-icons">refresh</span>
                            Atualizar
                        </button>
                    </div>

                    <!-- Jogos em Andamento -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-title">
                                <span class="material-icons" style="color: #10b981;">play_circle</span>
                                Jogos em Andamento
                            </span>
                            <span id="count-andamento" style="background: #10b981; color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">0</span>
                        </div>
                        <div class="section-body">
                            <div class="live-games-list" id="jogos-andamento">
                                <div class="no-games">
                                    <span class="material-icons">sports_soccer</span>
                                    <p>Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Jogos Encerrados -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-title">
                                <span class="material-icons" style="color: #6b7280;">check_circle</span>
                                Jogos Encerrados
                            </span>
                            <span id="count-encerrados" style="background: #6b7280; color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">0</span>
                        </div>
                        <div class="section-body">
                            <div class="live-games-list" id="jogos-encerrados">
                                <div class="no-games">
                                    <span class="material-icons">sports_soccer</span>
                                    <p>Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ligas Monitoradas -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-title">
                                <span class="material-icons">flag</span>
                                Ligas Brasileiras Monitoradas
                            </span>
                        </div>
                        <div class="section-body" style="padding: 0;">
                            <table class="leagues-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Liga</th>
                                        <th>Temporada</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="league-id">71</span></td>
                                        <td>Brasileirao Serie A</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">72</span></td>
                                        <td>Brasileirao Serie B</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">73</span></td>
                                        <td>Copa do Brasil</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">475</span></td>
                                        <td>Campeonato Carioca</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">76</span></td>
                                        <td>Campeonato Paulista</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">629</span></td>
                                        <td>Copa Verde</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">630</span></td>
                                        <td>Copa do Nordeste</td>
                                        <td>2026</td>
                                    </tr>
                                    <tr>
                                        <td><span class="league-id">618</span></td>
                                        <td>Copinha (Sao Paulo Youth Cup)</td>
                                        <td>2026</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Informacoes Tecnicas -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-title">
                                <span class="material-icons">info</span>
                                Informacoes Tecnicas
                            </span>
                        </div>
                        <div class="section-body">
                            <table class="leagues-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Ordem</th>
                                        <th>Fonte</th>
                                        <th>Endpoint</th>
                                        <th>Limite</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span style="background:#10b981;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.7rem;">1</span></td>
                                        <td style="font-weight: 600;">SoccerDataAPI</td>
                                        <td><code style="background:#252525;padding:4px 8px;border-radius:4px;font-size:0.75rem;">api.soccerdataapi.com</code></td>
                                        <td>75 req/dia</td>
                                    </tr>
                                    <tr style="opacity: 0.5;">
                                        <td><span style="background:#ef4444;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.7rem;">❌</span></td>
                                        <td style="font-weight: 600; text-decoration: line-through;">API-Football</td>
                                        <td><code style="background:#252525;padding:4px 8px;border-radius:4px;font-size:0.75rem;">DESABILITADA (banido)</code></td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td><span style="background:#3b82f6;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.7rem;">2</span></td>
                                        <td style="font-weight: 600;">Cache Stale</td>
                                        <td><code style="background:#252525;padding:4px 8px;border-radius:4px;font-size:0.75rem;">Ultimo cache valido</code></td>
                                        <td>Max 30 min</td>
                                    </tr>
                                    <tr>
                                        <td><span style="background:#6b7280;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.7rem;">3</span></td>
                                        <td style="font-weight: 600;">Globo Esporte</td>
                                        <td><code style="background:#252525;padding:4px 8px;border-radius:4px;font-size:0.75rem;">Scraper (agenda)</code></td>
                                        <td>Ilimitado</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #2d2d2d;">
                                <table class="leagues-table">
                                    <tbody>
                                        <tr>
                                            <td style="color: #9ca3af; width: 200px;">Rota Interna</td>
                                            <td><code style="background:#252525;padding:4px 8px;border-radius:4px;font-size:0.8rem;">/api/jogos-ao-vivo</code></td>
                                        </tr>
                                        <tr>
                                            <td style="color: #9ca3af;">Rota Status</td>
                                            <td><code style="background:#252525;padding:4px 8px;border-radius:4px;font-size:0.8rem;">/api/jogos-ao-vivo/status</code></td>
                                        </tr>
                                        <tr>
                                            <td style="color: #9ca3af;">Cache TTL (ao vivo)</td>
                                            <td>2 minutos</td>
                                        </tr>
                                        <tr>
                                            <td style="color: #9ca3af;">Cache TTL (sem jogos)</td>
                                            <td>10 minutos</td>
                                        </tr>
                                        <tr>
                                            <td style="color: #9ca3af;">Reset Limites</td>
                                            <td>00:00 UTC</td>
                                        </tr>
                                        <tr>
                                            <td style="color: #9ca3af;">Total Requests/dia</td>
                                            <td style="color: #10b981; font-weight: 600;">75 (SoccerDataAPI)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- Scripts -->
        <script type="module">
            if (window.__api_football_guard) {
                console.warn('[API-FOOTBALL] Script já inicializado, pulando...');
            } else {
            window.__api_football_guard = true;
            // Carregar layout
            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document.getElementById("sidebar-placeholder")?.replaceWith(sidebar);
                    }

                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            // Carregar status da API
            async function carregarStatus() {
                try {
                    // Guard: verifica se ainda estamos na página correta
                    const fluxoEl = document.getElementById('fluxo-fallback');
                    if (!fluxoEl) {
                        console.warn('[Jogos-Dia] Elementos não encontrados, página mudou');
                        return;
                    }

                    const response = await fetch('/api/jogos-ao-vivo/status');
                    const data = await response.json();

                    // Fluxo de fallback
                    if (data.fluxo && fluxoEl) {
                        fluxoEl.textContent = data.fluxo;
                    }

                    // === SoccerDataAPI ===
                    const soccerData = data.fontes?.['soccerdata'];
                    const statusSoccerData = document.getElementById('soccerdata-status');
                    const soccerdataInfo = document.getElementById('soccerdata-info');

                    if (!statusSoccerData) return; // Guard: elemento não existe

                    if (soccerData?.configurado) {
                        statusSoccerData.innerHTML = `
                            <span class="status-badge online">
                                <span class="dot"></span>
                                Configurada
                            </span>
                        `;
                        if (soccerdataInfo) {
                            soccerdataInfo.textContent = 'Fonte principal ativa';
                            soccerdataInfo.style.color = '#10b981';
                        }
                    } else {
                        statusSoccerData.innerHTML = `
                            <span class="status-badge offline">
                                <span class="dot"></span>
                                Nao configurada
                            </span>
                        `;
                        if (soccerdataInfo) {
                            soccerdataInfo.textContent = soccerData?.aviso || 'API key nao definida';
                            soccerdataInfo.style.color = '#f59e0b';
                        }
                    }

                    // === Cache ===
                    const cache = data.cache;
                    if (cache) {
                        const cacheStatusEl = document.getElementById('cache-status');
                        const cacheIdadeEl = document.getElementById('cache-idade');
                        const cacheTtlEl = document.getElementById('cache-ttl');
                        const cacheJogosEl = document.getElementById('cache-jogos');

                        if (!cacheStatusEl) return; // Guard: elementos não existem

                        // Fonte atual do cache
                        const fonteMap = {
                            'api-football': 'API-Football (REMOVIDA)',
                            'cache-stale': 'Cache Stale',
                            'soccerdata': 'SoccerDataAPI',
                            'globo': 'Globo Esporte'
                        };
                        if (cacheStatusEl) {
                            cacheStatusEl.textContent = fonteMap[cache.fonte] || cache.fonte || '-';
                        }

                        // Idade do cache
                        if (cacheIdadeEl) {
                            if (cache.idadeMinutos !== null) {
                                const idadeText = cache.stale
                                    ? `${cache.idadeMinutos} min (stale)`
                                    : `${cache.idadeMinutos} min`;
                                cacheIdadeEl.textContent = idadeText;
                                cacheIdadeEl.style.color = cache.stale ? '#f59e0b' : '#9ca3af';
                            } else {
                                cacheIdadeEl.textContent = 'Sem cache';
                            }
                        }

                        // TTL
                        if (cacheTtlEl) cacheTtlEl.textContent = cache.ttlAtual || '-';
                        if (cacheJogosEl) cacheJogosEl.textContent = `${cache.jogosEmCache || 0} jogos em cache`;
                    }

                } catch (error) {
                    console.error('Erro ao carregar status:', error);
                    const statusEl = document.getElementById('api-football-status');
                    if (statusEl) {
                        statusEl.innerHTML = `
                            <span class="status-badge offline">
                                <span class="dot"></span>
                                Erro
                            </span>
                        `;
                    }
                }
            }

            // Carregar jogos ao vivo
            window.carregarJogos = async function() {
                const btn = document.querySelector('.refresh-btn');
                if (btn) btn.classList.add('loading');

                try {
                    const response = await fetch('/api/jogos-ao-vivo');
                    const data = await response.json();

                    // Contador (com null checks)
                    const countEl = document.getElementById('jogos-ao-vivo');
                    const fonteEl = document.getElementById('jogos-fonte');
                    const fonteFriendly = {
                        'soccerdata': 'SoccerDataAPI',
                        'cache-stale': 'Cache Stale',
                        'globo': 'Globo Esporte',
                        'api-football': 'API-Football (REMOVIDA)'
                    }[data.fonte] || data.fonte || '-';
                    if (countEl) countEl.textContent = data.jogos?.length || 0;
                    if (fonteEl) fonteEl.textContent = `Fonte: ${fonteFriendly}`;

                    // Lista de jogos (usa jogos-andamento como container principal)
                    const container = document.getElementById('jogos-andamento');
                    if (!container) {
                        console.warn('[Jogos-Dia] Container jogos-andamento nao encontrado');
                        return;
                    }

                    if (!data.jogos || data.jogos.length === 0) {
                        container.innerHTML = `
                            <div class="no-games">
                                <span class="material-icons">sports_soccer</span>
                                <p>${data.mensagem || 'Nenhum jogo ao vivo no momento'}</p>
                                <p style="font-size: 0.75rem; margin-top: 8px;">Fonte: ${data.fonte || '-'}</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = data.jogos.map(jogo => `
                            <div class="live-game">
                                <div class="live-game-teams">
                                    <div class="live-game-team">
                                        ${jogo.logoMandante ? `<img src="${jogo.logoMandante}" alt="${jogo.mandante}">` : ''}
                                        <span>${jogo.mandante}</span>
                                    </div>
                                    <div class="live-game-score">${jogo.placar || 'vs'}</div>
                                    <div class="live-game-team">
                                        <span>${jogo.visitante}</span>
                                        ${jogo.logoVisitante ? `<img src="${jogo.logoVisitante}" alt="${jogo.visitante}">` : ''}
                                    </div>
                                </div>
                                <div class="live-game-info">
                                    <div class="live-game-time">${jogo.tempo || jogo.status || jogo.horario}</div>
                                    <div class="live-game-league">${jogo.liga || ''}</div>
                                </div>
                            </div>
                        `).join('');
                    }

                } catch (error) {
                    console.error('Erro ao carregar jogos:', error);
                    const errorContainer = document.getElementById('jogos-andamento');
                    if (errorContainer) {
                        errorContainer.innerHTML = `
                            <div class="no-games">
                                <span class="material-icons">error</span>
                                <p>Erro ao carregar jogos</p>
                            </div>
                        `;
                    }
                } finally {
                    if (btn) btn.classList.remove('loading');
                }
            }

            // Variável global para armazenar o interval ID
            let autoRefreshInterval = null;

            // Função para limpar o interval quando sair da página
            function cleanupApiFootballPage() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    console.log('[Jogos-Dia] Auto-refresh limpo');
                }
            }

            // Inicializar
            document.addEventListener("DOMContentLoaded", () => {
                loadLayout();
                carregarStatus();
                carregarJogos();

                // Limpar interval anterior se existir
                cleanupApiFootballPage();

                // Auto-refresh a cada 60 segundos
                autoRefreshInterval = setInterval(() => {
                    carregarStatus();
                    carregarJogos();
                }, 60000);

                // Limpar interval quando navegar para outra página (SPA)
                // Detecta quando elementos principais desaparecem
                const observer = new MutationObserver(() => {
                    if (!document.getElementById('fluxo-fallback')) {
                        cleanupApiFootballPage();
                        observer.disconnect();
                    }
                });

                observer.observe(document.body, { childList: true, subtree: true });
            });
            } // guard
        </script>
    </body>
</html>
