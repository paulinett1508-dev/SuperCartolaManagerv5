<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Migra√ß√£o LocalStorage ‚Üí MongoDB</title>
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link rel="stylesheet" href="css/modules/super-modal.css" />
        <script src="js/super-modal.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .container {
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: 800px;
                width: 100%;
                padding: 40px;
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
            }

            .header h1 {
                font-size: 28px;
                color: #2d3748;
                margin-bottom: 10px;
            }

            .header p {
                color: #718096;
                font-size: 15px;
            }

            .alert {
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 30px;
            }

            .alert h3 {
                color: #856404;
                margin-bottom: 10px;
                font-size: 16px;
            }

            .alert ul {
                margin-left: 20px;
                color: #856404;
            }

            .alert li {
                margin: 5px 0;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: #f7fafc;
                border-radius: 10px;
                padding: 20px;
                text-align: center;
            }

            .stat-card .number {
                font-size: 32px;
                font-weight: 700;
                color: #667eea;
                margin-bottom: 5px;
            }

            .stat-card .label {
                font-size: 13px;
                color: #718096;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .actions {
                display: flex;
                gap: 15px;
                margin-bottom: 30px;
            }

            button {
                flex: 1;
                padding: 15px 30px;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            }

            .btn-secondary {
                background: #e2e8f0;
                color: #4a5568;
            }

            .btn-secondary:hover:not(:disabled) {
                background: #cbd5e0;
            }

            .btn-danger {
                background: #f56565;
                color: white;
            }

            .btn-danger:hover:not(:disabled) {
                background: #e53e3e;
            }

            .log-container {
                background: #1a202c;
                border-radius: 10px;
                padding: 20px;
                max-height: 400px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 13px;
            }

            .log-entry {
                margin: 5px 0;
                padding: 5px;
                border-left: 3px solid transparent;
                padding-left: 10px;
            }

            .log-info {
                color: #63b3ed;
                border-left-color: #63b3ed;
            }

            .log-success {
                color: #48bb78;
                border-left-color: #48bb78;
            }

            .log-error {
                color: #f56565;
                border-left-color: #f56565;
            }

            .log-warning {
                color: #ecc94b;
                border-left-color: #ecc94b;
            }

            .progress-bar {
                height: 8px;
                background: #e2e8f0;
                border-radius: 10px;
                overflow: hidden;
                margin: 20px 0;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                width: 0%;
                transition: width 0.3s ease;
            }

            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üîÑ Migra√ß√£o de Dados</h1>
                <p>LocalStorage ‚Üí MongoDB</p>
            </div>

            <div class="alert">
                <h3>‚ö†Ô∏è Importante:</h3>
                <ul>
                    <li>
                        Esta ferramenta migra campos edit√°veis do localStorage
                        para o MongoDB
                    </li>
                    <li>Fa√ßa backup dos dados antes de prosseguir</li>
                    <li>
                        A migra√ß√£o n√£o apaga os dados do localStorage
                        automaticamente
                    </li>
                    <li>
                        Ap√≥s confirmar que funcionou, limpe manualmente o
                        localStorage
                    </li>
                </ul>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalTimes">0</div>
                    <div class="label">Times Encontrados</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalCampos">0</div>
                    <div class="label">Campos Totais</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="migradosCount">0</div>
                    <div class="label">Migrados</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="errosCount">0</div>
                    <div class="label">Erros</div>
                </div>
            </div>

            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="actions">
                <button
                    class="btn-secondary"
                    id="btnAnalisar"
                    onclick="analisarLocalStorage()"
                >
                    üîç Analisar Dados
                </button>
                <button
                    class="btn-primary"
                    id="btnMigrar"
                    onclick="iniciarMigracao()"
                    disabled
                >
                    üöÄ Migrar para MongoDB
                </button>
                <button
                    class="btn-danger"
                    id="btnLimpar"
                    onclick="limparLocalStorage()"
                    disabled
                >
                    üóëÔ∏è Limpar LocalStorage
                </button>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">
                    Aguardando an√°lise dos dados...
                </div>
            </div>
        </div>

        <script type="module">
            import { FluxoFinanceiroAPI } from "./js/fluxo-financeiro/fluxo-financeiro-api.js";

            if (window.__migrar_localstorage_guard) {
                console.warn('[MIGRAR] Script j√° inicializado, pulando...');
            } else {
                window.__migrar_localstorage_guard = true;

            let dadosEncontrados = [];

            // Fun√ß√£o para obter Liga ID da URL
            function getLigaIdFromURL() {
                // Tentar pegar do par√¢metro ?id=
                const urlParams = new URLSearchParams(window.location.search);
                const ligaIdFromParams = urlParams.get("id");

                if (ligaIdFromParams) {
                    return ligaIdFromParams;
                }

                // Se n√£o encontrou, tentar pelo pathname (√∫ltima parte da URL)
                const pathParts = window.location.pathname.split("/");
                const ligaIdFromPath = pathParts[pathParts.length - 1];

                if (
                    ligaIdFromPath &&
                    ligaIdFromPath !== "migrar-localstorage-mongodb.html"
                ) {
                    return ligaIdFromPath;
                }

                return null;
            }

            function addLog(message, type = "info") {
                const logContainer = document.getElementById("logContainer");
                const entry = document.createElement("div");
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            function updateStats(total, campos, migrados, erros) {
                document.getElementById("totalTimes").textContent = total;
                document.getElementById("totalCampos").textContent = campos;
                document.getElementById("migradosCount").textContent = migrados;
                document.getElementById("errosCount").textContent = erros;
            }

            function updateProgress(percent) {
                const progressBar = document.getElementById("progressBar");
                const progressFill = document.getElementById("progressFill");

                if (percent > 0) {
                    progressBar.classList.remove("hidden");
                } else {
                    progressBar.classList.add("hidden");
                }

                progressFill.style.width = `${percent}%`;
            }

            window.analisarLocalStorage = function () {
                addLog("üîç Iniciando an√°lise do localStorage...", "info");

                const ligaId = getLigaIdFromURL();
                if (!ligaId) {
                    addLog("‚ùå Liga ID n√£o encontrado na URL", "error");
                    addLog(
                        "üí° Acesse este script a partir de uma liga:",
                        "warning",
                    );
                    addLog(
                        "   Exemplo: /migrar-localstorage-mongodb.html?id=684cb1c8af923da7c7df51de",
                        "warning",
                    );
                    return;
                }

                addLog(`üìã Liga ID detectado: ${ligaId}`, "success");

                dadosEncontrados = [];
                let totalCampos = 0;

                // Buscar todas as chaves do localStorage relacionadas ao fluxo financeiro
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);

                    if (key.startsWith("fluxo_financeiro_")) {
                        const parts = key.split("_");
                        // fluxo_financeiro_{timeId}_{campo}_{tipo}

                        if (parts.length === 5) {
                            const timeId = parts[2];
                            const campoNome = parts[3]; // campo1, campo2, etc
                            const tipo = parts[4]; // nome ou valor

                            // Encontrar ou criar entrada para este time
                            let timeData = dadosEncontrados.find(
                                (t) => t.timeId === timeId,
                            );
                            if (!timeData) {
                                timeData = {
                                    timeId: timeId,
                                    campos: {},
                                };
                                dadosEncontrados.push(timeData);
                            }

                            // Inicializar campo se n√£o existir
                            if (!timeData.campos[campoNome]) {
                                timeData.campos[campoNome] = {
                                    nome: null,
                                    valor: null,
                                };
                            }

                            // Armazenar valor
                            const value = localStorage.getItem(key);
                            if (tipo === "nome") {
                                timeData.campos[campoNome].nome = value;
                            } else if (tipo === "valor") {
                                timeData.campos[campoNome].valor =
                                    parseFloat(value) || 0;
                            }

                            totalCampos++;
                        }
                    }
                }

                addLog(`‚úÖ An√°lise conclu√≠da!`, "success");
                addLog(
                    `üìä Encontrados ${dadosEncontrados.length} times com dados`,
                    "info",
                );
                addLog(
                    `üì¶ Total de ${totalCampos} campos no localStorage`,
                    "info",
                );

                // Mostrar detalhes
                dadosEncontrados.forEach((time) => {
                    const camposCount = Object.keys(time.campos).length;
                    addLog(
                        `  ‚Üí Time ${time.timeId}: ${camposCount} campos`,
                        "info",
                    );
                });

                updateStats(dadosEncontrados.length, totalCampos, 0, 0);

                // Habilitar bot√£o de migra√ß√£o se houver dados
                if (dadosEncontrados.length > 0) {
                    document.getElementById("btnMigrar").disabled = false;
                    addLog(
                        '‚ú® Pronto para migrar! Clique em "Migrar para MongoDB"',
                        "success",
                    );
                } else {
                    addLog(
                        "‚ö†Ô∏è Nenhum dado encontrado no localStorage",
                        "warning",
                    );
                }
            };

            window.iniciarMigracao = async function () {
                if (dadosEncontrados.length === 0) {
                    addLog("‚ùå Execute a an√°lise primeiro", "error");
                    return;
                }

                const confirmacao = await SuperModal.confirm({
                    message: `Confirma a migracao de ${dadosEncontrados.length} times para o MongoDB?\n\nEsta operacao NAO apaga os dados do localStorage.`,
                    confirmText: 'Migrar'
                });

                if (!confirmacao) {
                    addLog("Migracao cancelada pelo usuario", "warning");
                    return;
                }

                const ligaId = getLigaIdFromURL();
                let migrados = 0;
                let erros = 0;

                // Desabilitar bot√µes durante migra√ß√£o
                document.getElementById("btnAnalisar").disabled = true;
                document.getElementById("btnMigrar").disabled = true;

                addLog("üöÄ Iniciando migra√ß√£o...", "info");

                for (let i = 0; i < dadosEncontrados.length; i++) {
                    const time = dadosEncontrados[i];
                    const percent = Math.round(
                        ((i + 1) / dadosEncontrados.length) * 100,
                    );
                    updateProgress(percent);

                    try {
                        addLog(`üì§ Migrando time ${time.timeId}...`, "info");

                        // Converter objeto de campos em array
                        const camposArray = [];
                        for (let j = 1; j <= 4; j++) {
                            const campoKey = `campo${j}`;
                            const campo = time.campos[campoKey];

                            camposArray.push({
                                nome: campo?.nome || `Campo ${j}`,
                                valor: campo?.valor ?? 0,
                            });
                        }

                        // Salvar no MongoDB
                        await FluxoFinanceiroAPI.salvarCampos(
                            ligaId,
                            time.timeId,
                            camposArray,
                        );

                        migrados++;
                        addLog(
                            `‚úÖ Time ${time.timeId} migrado com sucesso!`,
                            "success",
                        );
                        updateStats(
                            dadosEncontrados.length,
                            Object.keys(time.campos).length *
                                dadosEncontrados.length,
                            migrados,
                            erros,
                        );
                    } catch (error) {
                        erros++;
                        addLog(
                            `‚ùå Erro ao migrar time ${time.timeId}: ${error.message}`,
                            "error",
                        );
                        updateStats(
                            dadosEncontrados.length,
                            Object.keys(time.campos).length *
                                dadosEncontrados.length,
                            migrados,
                            erros,
                        );
                    }

                    // Pequeno delay para n√£o sobrecarregar a API
                    await new Promise((resolve) => setTimeout(resolve, 100));
                }

                updateProgress(100);

                addLog("", "info");
                addLog("üéâ MIGRA√á√ÉO CONCLU√çDA!", "success");
                addLog(`‚úÖ Migrados: ${migrados}`, "success");
                if (erros > 0) {
                    addLog(`‚ùå Erros: ${erros}`, "error");
                }
                addLog("", "info");
                addLog(
                    "‚ö†Ô∏è IMPORTANTE: Verifique se os dados est√£o corretos no sistema",
                    "warning",
                );
                addLog(
                    "‚ö†Ô∏è Ap√≥s confirmar, voc√™ pode limpar o localStorage",
                    "warning",
                );

                // Habilitar bot√µes
                document.getElementById("btnAnalisar").disabled = false;
                document.getElementById("btnLimpar").disabled = false;

                // Recarregar ap√≥s 3 segundos
                setTimeout(async () => {
                    const recarregar = await SuperModal.confirm({
                        message: 'Migracao concluida! Deseja recarregar a pagina para verificar os dados?',
                        confirmText: 'Recarregar'
                    });
                    if (recarregar) {
                        window.location.reload();
                    }
                }, 2000);
            };

            window.limparLocalStorage = async function () {
                const confirmacao = await SuperModal.confirm({
                    message: 'ATENCAO: Esta acao ira APAGAR PERMANENTEMENTE todos os dados do Fluxo Financeiro do localStorage.\n\nCertifique-se de que a migracao foi bem-sucedida antes de prosseguir!\n\nDeseja continuar?',
                    variant: 'danger',
                    confirmText: 'Apagar Dados'
                });

                if (!confirmacao) {
                    addLog("Limpeza cancelada", "warning");
                    return;
                }

                addLog("üóëÔ∏è Removendo dados do localStorage...", "info");

                let removidos = 0;
                const keysToRemove = [];

                // Coletar todas as chaves para remover
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith("fluxo_financeiro_")) {
                        keysToRemove.push(key);
                    }
                }

                // Remover as chaves
                keysToRemove.forEach((key) => {
                    localStorage.removeItem(key);
                    removidos++;
                });

                addLog(
                    `‚úÖ ${removidos} chaves removidas do localStorage`,
                    "success",
                );
                addLog("üéâ LocalStorage limpo com sucesso!", "success");

                // Resetar interface
                dadosEncontrados = [];
                updateStats(0, 0, 0, 0);
                updateProgress(0);
                document.getElementById("btnMigrar").disabled = true;
                document.getElementById("btnLimpar").disabled = true;

                setTimeout(async () => {
                    const recarregar = await SuperModal.confirm({
                        message: 'Limpeza concluida! Deseja recarregar a pagina?',
                        confirmText: 'Recarregar'
                    });
                    if (recarregar) {
                        window.location.reload();
                    }
                }, 1500);
            };

            // Expor fun√ß√µes globalmente
            window.FluxoFinanceiroAPI = FluxoFinanceiroAPI;
            window.getLigaIdFromURL = getLigaIdFromURL;
            window.addLog = addLog;
            window.updateStats = updateStats;
            window.updateProgress = updateProgress;

            // Mostrar instru√ß√µes ao carregar
            addLog("üìã INSTRU√á√ïES:", "info");
            addLog("1Ô∏è‚É£  Adicione ?id=LIGA_ID na URL desta p√°gina", "info");
            addLog(
                "   Exemplo: migrar-localstorage-mongodb.html?id=684cb1c8af923da7c7df51de",
                "warning",
            );
            addLog('2Ô∏è‚É£  Clique em "Analisar Dados"', "info");
            addLog('3Ô∏è‚É£  Clique em "Migrar para MongoDB"', "info");
            addLog("", "info");

            // Tentar detectar Liga ID automaticamente
            const ligaId = getLigaIdFromURL();
            if (ligaId) {
                addLog(`‚úÖ Liga detectada: ${ligaId}`, "success");
                addLog("üëâ Pronto para an√°lise!", "success");
            } else {
                addLog("‚ö†Ô∏è  Nenhuma liga detectada na URL", "warning");
                addLog("üí° Adicione ?id=LIGA_ID √† URL e recarregue", "warning");
            }

            } // guard
        </script>
    </body>
</html>
