<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Repositório & Analytics - Super Cartola Manager</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="css/_admin-tokens.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="css/modules/github-analytics-unified.css" />
</head>
<body class="repo-page">
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <main class="app-main">
        <div class="repo-content">
            <!-- Header -->
            <div class="repo-header">
                <div class="repo-header-left">
                    <div class="repo-header-icon">
                        <span class="material-icons">merge_type</span>
                    </div>
                    <div>
                        <h1>Repositório & Analytics</h1>
                        <p>Branches, Pull Requests, sincronização e análise de funcionalidades</p>
                    </div>
                </div>
                <div class="repo-header-right">
                    <button class="repo-refresh-btn" id="refreshBtn">
                        <span class="material-icons">refresh</span>
                        Atualizar
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="repo-search-container">
                <div class="repo-search-box">
                    <span class="material-icons repo-search-icon">search</span>
                    <input
                        type="text"
                        id="repoSearchInput"
                        class="repo-search-input"
                        placeholder="Buscar branches, PRs, merges..."
                        autocomplete="off"
                    />
                    <button class="repo-search-clear" id="searchClearBtn" style="display: none;">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="repo-search-results" id="searchResultsCounter" style="display: none;">
                    <span class="repo-badge repo-badge-info" id="resultsCount">0 resultados</span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="repo-tabs">
                <button class="repo-tab active" data-tab="overview">Visão Geral</button>
                <button class="repo-tab" data-tab="branches">Branches</button>
                <button class="repo-tab" data-tab="prs">Pull Requests</button>
                <button class="repo-tab" data-tab="sync">Sincronização</button>
            </div>

            <!-- TAB 1: Visão Geral -->
            <div class="repo-tab-content active" id="tab-overview">
                <div class="repo-kpi-grid" id="kpiGrid">
                    <div class="repo-loading">
                        <div class="repo-spinner"></div>
                    </div>
                </div>

                <div class="repo-section">
                    <div class="repo-section-title">
                        <span class="material-icons">warning</span>
                        Branches em Risco
                    </div>
                    <div id="branchesRiscoContainer">
                        <div class="repo-loading">Carregando...</div>
                    </div>
                </div>

                <div class="repo-section">
                    <div class="repo-section-title">
                        <span class="material-icons">assignment</span>
                        Funcionalidades do BACKLOG
                    </div>
                    <div id="funcionalidadesContainer">
                        <div class="repo-loading">Carregando...</div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Branches -->
            <div class="repo-tab-content" id="tab-branches">
                <div class="repo-filters">
                    <button class="repo-filter-btn active" data-filter="all">Todas</button>
                    <button class="repo-filter-btn" data-filter="active">Ativas</button>
                    <button class="repo-filter-btn" data-filter="merged">Mergeadas</button>
                    <button class="repo-filter-btn" data-filter="orphan">Sem PR</button>
                </div>

                <div class="repo-section">
                    <div id="branchesContainer">
                        <div class="repo-loading">
                            <div class="repo-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: Pull Requests -->
            <div class="repo-tab-content" id="tab-prs">
                <div class="repo-filters">
                    <button class="repo-filter-btn active" data-filter-pr="all">Todos</button>
                    <button class="repo-filter-btn" data-filter-pr="open">Abertos</button>
                    <button class="repo-filter-btn" data-filter-pr="closed">Fechados</button>
                    <button class="repo-filter-btn" data-filter-pr="merged">Mergeados</button>
                </div>

                <div class="repo-section">
                    <div id="prsContainer">
                        <div class="repo-loading">
                            <div class="repo-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: Sincronização -->
            <div class="repo-tab-content" id="tab-sync">
                <div class="repo-sync-card">
                    <div class="repo-sync-status" id="syncStatusContainer">
                        <div class="repo-loading">Carregando status...</div>
                    </div>
                    <button class="repo-sync-trigger" id="syncTriggerBtn">
                        <span class="material-icons">sync</span>
                        Sincronizar Agora (git pull)
                    </button>
                </div>

                <div class="repo-section">
                    <div class="repo-section-title">
                        <span class="material-icons">dns</span>
                        Branches Locais
                    </div>
                    <div id="localBranchesContainer">
                        <div class="repo-loading">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // === SPA Guard ===
        if (window.repoAnalyticsLoaded) {
            console.warn('[REPO] Já carregado, ignorando re-execução');
        } else {
            window.repoAnalyticsLoaded = true;

            // === Layout Loading ===
            async function loadLayout() {
                try {
                    // Não recarregar se sidebar já existe (navegação SPA)
                    if (document.querySelector('.app-sidebar')) {
                        console.log('[REPO] Sidebar já existe, pulando loadLayout');
                        return;
                    }

                    const response = await fetch('layout.html');
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, 'text/html');

                    const sidebar = doc.querySelector('.app-sidebar');
                    if (sidebar && document.getElementById('sidebar-container')) {
                        document.getElementById('sidebar-container').appendChild(sidebar);
                    }

                    // Injetar scripts do layout na PRIMEIRA carga
                    if (!window.__layoutScriptsInjected) {
                        window.__layoutScriptsInjected = true;
                        const scripts = doc.querySelectorAll('script');
                        scripts.forEach((script) => {
                            if (script.textContent.trim()) {
                                const newScript = document.createElement('script');
                                newScript.textContent = `(function(){${script.textContent}})();`;
                                document.head.appendChild(newScript);
                            }
                        });
                    }

                    // Inicializar AccordionManager após scripts carregados
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error('[REPO] Erro ao carregar layout:', error);
                }
            }

            // === API Helper ===
            async function api(endpoint) {
                try {
                    const response = await fetch(endpoint);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`[REPO] Erro ao chamar ${endpoint}:`, error);
                    throw error;
                }
            }

            // === Tab Navigation ===
            function initTabs() {
                const tabs = document.querySelectorAll('.repo-tab');
                const contents = document.querySelectorAll('.repo-tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetId = tab.dataset.tab;

                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        document.getElementById(`tab-${targetId}`).classList.add('active');

                        // Carregar dados da aba se necessário
                        if (targetId === 'overview' && !window.overviewLoaded) {
                            carregarVisaoGeral();
                        } else if (targetId === 'branches' && !window.branchesLoaded) {
                            carregarBranches();
                        } else if (targetId === 'prs' && !window.prsLoaded) {
                            carregarPRs();
                        } else if (targetId === 'sync' && !window.syncLoaded) {
                            carregarSync();
                        }
                    });
                });
            }

            // === Visão Geral ===
            async function carregarVisaoGeral() {
                try {
                    const data = await api('/api/admin/analytics/resumo');
                    window.overviewLoaded = true;

                    // Renderizar KPIs
                    const kpiGrid = document.getElementById('kpiGrid');
                    kpiGrid.innerHTML = `
                        <div class="repo-kpi-card">
                            <div class="repo-kpi-label">Total Branches</div>
                            <div class="repo-kpi-value">${data.stats?.totalBranches || 0}</div>
                        </div>
                        <div class="repo-kpi-card">
                            <div class="repo-kpi-label">Ativas</div>
                            <div class="repo-kpi-value success">${data.stats?.branchesAtivas || 0}</div>
                        </div>
                        <div class="repo-kpi-card">
                            <div class="repo-kpi-label">Mergeadas</div>
                            <div class="repo-kpi-value info">${data.stats?.branchesMergeadas || 0}</div>
                        </div>
                        <div class="repo-kpi-card">
                            <div class="repo-kpi-label">Sem PR</div>
                            <div class="repo-kpi-value warning">${data.stats?.branchesOrfas || 0}</div>
                        </div>
                        <div class="repo-kpi-card">
                            <div class="repo-kpi-label">PRs Abertas</div>
                            <div class="repo-kpi-value">${data.stats?.prsAbertas || 0}</div>
                        </div>
                        <div class="repo-kpi-card">
                            <div class="repo-kpi-label">Em Risco</div>
                            <div class="repo-kpi-value danger">${data.stats?.branchesRisco || 0}</div>
                        </div>
                    `;

                    // Branches em Risco
                    const branchesRisco = (data.branches || []).filter(b =>
                        b.passivel_deletacao || b.desatualizada || b.orfa
                    ).slice(0, 5);

                    const riscoHtml = branchesRisco.length > 0 ? `
                        <table class="repo-table">
                            <thead>
                                <tr>
                                    <th>Branch</th>
                                    <th>Alertas</th>
                                    <th>Dias</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${branchesRisco.map(b => `
                                    <tr>
                                        <td><span class="repo-branch">${b.nome}</span></td>
                                        <td>
                                            <div class="repo-badges">
                                                ${b.orfa ? '<span class="repo-badge repo-badge-orphan">Falta PR</span>' : ''}
                                                ${b.passivel_deletacao ? '<span class="repo-badge repo-badge-warning">Deletável</span>' : ''}
                                                ${b.desatualizada ? '<span class="repo-badge repo-badge-warning">Desatualizada</span>' : ''}
                                            </div>
                                        </td>
                                        <td>${b.dias || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<div class="repo-empty">Nenhuma branch em risco</div>';

                    document.getElementById('branchesRiscoContainer').innerHTML = riscoHtml;

                    // Funcionalidades
                    const funcs = await api('/api/admin/analytics/funcionalidades');
                    const funcsHtml = funcs && funcs.length > 0 ? `
                        <table class="repo-table">
                            <thead>
                                <tr>
                                    <th>Funcionalidade</th>
                                    <th>Status</th>
                                    <th>Branch</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${funcs.slice(0, 10).map(f => `
                                    <tr>
                                        <td>${f.nome || 'N/A'}</td>
                                        <td><span class="repo-badge ${f.status === 'operante' ? 'repo-badge-open' : 'repo-badge-closed'}">${f.status || 'N/A'}</span></td>
                                        <td><span class="repo-branch">${f.branch || '-'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<div class="repo-empty">Nenhuma funcionalidade encontrada</div>';

                    document.getElementById('funcionalidadesContainer').innerHTML = funcsHtml;

                } catch (error) {
                    document.getElementById('kpiGrid').innerHTML = '<div class="repo-empty">Erro ao carregar dados</div>';
                }
            }

            // === Branches ===
            let allBranches = [];
            let currentFilter = 'all';
            let searchQuery = '';

            async function carregarBranches() {
                try {
                    const data = await api('/api/admin/analytics/resumo');
                    window.branchesLoaded = true;
                    allBranches = data.branches || [];
                    renderizarBranches();
                } catch (error) {
                    document.getElementById('branchesContainer').innerHTML = '<div class="repo-empty">Erro ao carregar branches</div>';
                }
            }

            function renderizarBranches() {
                let filtered = allBranches;

                if (currentFilter === 'active') {
                    filtered = allBranches.filter(b => !b.mergeada);
                } else if (currentFilter === 'merged') {
                    filtered = allBranches.filter(b => b.mergeada);
                } else if (currentFilter === 'orphan') {
                    filtered = allBranches.filter(b => b.orfa);
                }

                // Aplicar busca (SE houver query) - múltiplas palavras
                if (searchQuery.trim()) {
                    const keywords = searchQuery.toLowerCase().split(/\s+/).filter(k => k.length > 0);
                    filtered = filtered.filter(b => {
                        const nome = b.nome.toLowerCase();
                        return keywords.some(keyword => nome.includes(keyword));
                    });
                }

                const html = filtered.length > 0 ? `
                    <table class="repo-table">
                        <thead>
                            <tr>
                                <th>Branch</th>
                                <th>Status</th>
                                <th>PR</th>
                                <th>Dias</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(b => `
                                <tr>
                                    <td><span class="repo-branch">${b.nome}</span></td>
                                    <td>
                                        <div class="repo-badges">
                                            ${b.mergeada ? '<span class="repo-badge repo-badge-merged">Mergeada</span>' : '<span class="repo-badge repo-badge-active">Ativa</span>'}
                                            ${b.orfa ? '<span class="repo-badge repo-badge-orphan">Falta PR</span>' : ''}
                                        </div>
                                    </td>
                                    <td>${b.pr_url ? `<a href="${b.pr_url}" target="_blank" class="repo-link">#${b.pr_number || ''}</a>` : '-'}</td>
                                    <td>${b.dias || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<div class="repo-empty">Nenhuma branch encontrada</div>';

                document.getElementById('branchesContainer').innerHTML = html;
            }

            // === Pull Requests ===
            let allPRs = [];
            let currentPRFilter = 'all';

            async function carregarPRs() {
                try {
                    const data = await api('/api/admin/analytics/merges');
                    window.prsLoaded = true;
                    allPRs = data || [];
                    renderizarPRs();
                } catch (error) {
                    document.getElementById('prsContainer').innerHTML = '<div class="repo-empty">Erro ao carregar PRs</div>';
                }
            }

            function renderizarPRs() {
                let filtered = allPRs;

                if (currentPRFilter === 'open') {
                    filtered = allPRs.filter(pr => pr.state === 'open');
                } else if (currentPRFilter === 'closed') {
                    filtered = allPRs.filter(pr => pr.state === 'closed' && !pr.merged_at);
                } else if (currentPRFilter === 'merged') {
                    filtered = allPRs.filter(pr => pr.merged_at);
                }

                // Aplicar busca (SE houver query) - múltiplas palavras
                if (searchQuery.trim()) {
                    const keywords = searchQuery.toLowerCase().split(/\s+/).filter(k => k.length > 0);
                    filtered = filtered.filter(pr => {
                        const title = (pr.title || '').toLowerCase();
                        const branch = (pr.head?.ref || '').toLowerCase();
                        return keywords.some(keyword =>
                            title.includes(keyword) || branch.includes(keyword)
                        );
                    });
                }

                const html = filtered.length > 0 ? `
                    <table class="repo-table">
                        <thead>
                            <tr>
                                <th>PR</th>
                                <th>Título</th>
                                <th>Status</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(pr => `
                                <tr>
                                    <td><a href="${pr.url}" target="_blank" class="repo-link">#${pr.number}</a></td>
                                    <td>${pr.title || 'N/A'}</td>
                                    <td>
                                        ${pr.merged_at ? '<span class="repo-badge repo-badge-merged">Merged</span>' :
                                          pr.state === 'open' ? '<span class="repo-badge repo-badge-open">Open</span>' :
                                          '<span class="repo-badge repo-badge-closed">Closed</span>'}
                                    </td>
                                    <td>${pr.merged_at ? new Date(pr.merged_at).toLocaleDateString('pt-BR') :
                                          pr.created_at ? new Date(pr.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<div class="repo-empty">Nenhum PR encontrado</div>';

                document.getElementById('prsContainer').innerHTML = html;
            }

            // === Search Functionality ===
            function updateSearchCounter() {
                const query = searchQuery.toLowerCase().trim();
                if (!query) {
                    document.getElementById('searchResultsCounter').style.display = 'none';
                    return;
                }

                const keywords = query.split(/\s+/).filter(k => k.length > 0);

                // Contar resultados filtrados (múltiplas palavras)
                let branchCount = 0;
                let prCount = 0;

                if (allBranches.length > 0) {
                    branchCount = allBranches.filter(b => {
                        const nome = b.nome.toLowerCase();
                        return keywords.some(keyword => nome.includes(keyword));
                    }).length;
                }

                if (allPRs.length > 0) {
                    prCount = allPRs.filter(pr => {
                        const title = (pr.title || '').toLowerCase();
                        const branch = (pr.head?.ref || '').toLowerCase();
                        return keywords.some(keyword =>
                            title.includes(keyword) || branch.includes(keyword)
                        );
                    }).length;
                }

                const totalResults = branchCount + prCount;
                document.getElementById('resultsCount').textContent =
                    totalResults === 0 ? 'Nenhum resultado' :
                    totalResults === 1 ? '1 resultado' :
                    `${totalResults} resultados`;
                document.getElementById('searchResultsCounter').style.display = 'flex';
            }

            function applySearch() {
                updateSearchCounter();
                renderizarBranches();
                renderizarPRs();
            }

            function clearSearch() {
                searchQuery = '';
                document.getElementById('repoSearchInput').value = '';
                document.getElementById('searchClearBtn').style.display = 'none';
                applySearch();
            }

            // Debounce helper
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            const debouncedSearch = debounce(applySearch, 300);

            // === Sincronização ===
            async function carregarSync() {
                window.syncLoaded = true;
                // TODO: Implementar quando backend estiver pronto
                document.getElementById('syncStatusContainer').innerHTML = `
                    <div class="repo-sync-icon synced">
                        <span class="material-icons">check_circle</span>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #22c55e; margin-bottom: 4px;">Sincronizado</div>
                        <div style="font-size: 0.85rem; color: #9ca3af;">Branch atual está atualizada com origin</div>
                    </div>
                `;

                document.getElementById('localBranchesContainer').innerHTML = '<div class="repo-empty">Funcionalidade em desenvolvimento</div>';
            }

            // === Sync Trigger ===
            document.getElementById('syncTriggerBtn').addEventListener('click', async () => {
                const btn = document.getElementById('syncTriggerBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Sincronizando...';

                try {
                    // TODO: Chamar API de sync quando estiver pronta
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    alert('Sincronização concluída com sucesso!');
                    carregarSync();
                } catch (error) {
                    alert('Erro ao sincronizar: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-icons">sync</span> Sincronizar Agora (git pull)';
                }
            });

            // === Filters ===
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderizarBranches();
                });
            });

            document.querySelectorAll('[data-filter-pr]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-filter-pr]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPRFilter = btn.dataset.filterPr;
                    renderizarPRs();
                });
            });

            // === Refresh ===
            document.getElementById('refreshBtn').addEventListener('click', () => {
                const btn = document.getElementById('refreshBtn');
                btn.classList.add('syncing');

                // Recarregar aba ativa
                const activeTab = document.querySelector('.repo-tab.active').dataset.tab;

                if (activeTab === 'overview') {
                    window.overviewLoaded = false;
                    carregarVisaoGeral().finally(() => btn.classList.remove('syncing'));
                } else if (activeTab === 'branches') {
                    window.branchesLoaded = false;
                    carregarBranches().finally(() => btn.classList.remove('syncing'));
                } else if (activeTab === 'prs') {
                    window.prsLoaded = false;
                    carregarPRs().finally(() => btn.classList.remove('syncing'));
                } else if (activeTab === 'sync') {
                    window.syncLoaded = false;
                    carregarSync().finally(() => btn.classList.remove('syncing'));
                }
            });

            // === Init ===
            async function init() {
                await loadLayout();
                initTabs();

                // Search event listeners
                document.getElementById('repoSearchInput').addEventListener('input', (e) => {
                    searchQuery = e.target.value;
                    document.getElementById('searchClearBtn').style.display = searchQuery ? 'block' : 'none';
                    debouncedSearch();
                });

                document.getElementById('searchClearBtn').addEventListener('click', clearSearch);

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && searchQuery) {
                        clearSearch();
                    }
                });

                carregarVisaoGeral();
            }

            init();
        }

        // ✅ SPA: Reinicializar ao navegar via sidebar
        window.addEventListener('spa:navigated', (e) => {
            const { pageName } = e.detail || {};
            if (pageName === 'github-analytics-unified.html') {
                console.log('[REPO] Reinicializando após navegação SPA...');
                window.repoAnalyticsLoaded = false;
                init();
                window.repoAnalyticsLoaded = true;
            }
        });
    </script>
</body>
</html>
