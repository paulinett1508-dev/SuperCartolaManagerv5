<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Analisar Participantes - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/layout-horizontal.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link rel="stylesheet" href="css/modules/analisar-participantes.css" />
    </head>

    <body class="analisar-participantes-page">
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main analisar-page">
                <div class="analisar-content">
                    <!-- Header -->
                    <header class="analisar-header">
                        <div class="analisar-header-info">
                            <h1>Analisar Participantes</h1>
                            <p>Gestao unificada: senhas, status, diagnostico e dados dos participantes</p>
                        </div>
                        <a href="painel.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Stats Dashboard -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-icon"><span class="material-icons">people</span></div>
                            <div class="stat-value" id="statTotal">-</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card sucesso">
                            <div class="stat-icon"><span class="material-icons">check_circle</span></div>
                            <div class="stat-value" id="statAtivos">-</div>
                            <div class="stat-label">Ativos</div>
                        </div>
                        <div class="stat-card perigo">
                            <div class="stat-icon"><span class="material-icons">cancel</span></div>
                            <div class="stat-value" id="statInativos">-</div>
                            <div class="stat-label">Inativos</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-icon"><span class="material-icons">lock</span></div>
                            <div class="stat-value" id="statComSenha">-</div>
                            <div class="stat-label">Com Senha</div>
                        </div>
                        <div class="stat-card alerta">
                            <div class="stat-icon"><span class="material-icons">lock_open</span></div>
                            <div class="stat-value" id="statSemSenha">-</div>
                            <div class="stat-label">Sem Senha</div>
                        </div>
                        <div class="stat-card perigo">
                            <div class="stat-icon"><span class="material-icons">warning</span></div>
                            <div class="stat-value" id="statIncompletos">-</div>
                            <div class="stat-label">Incompletos</div>
                        </div>
                        <div class="stat-card premium">
                            <div class="stat-icon"><span class="material-icons">workspace_premium</span></div>
                            <div class="stat-value" id="statPremium">-</div>
                            <div class="stat-label">Premium</div>
                        </div>
                    </div>

                    <!-- Resumo por Liga -->
                    <div class="ligas-resumo" id="ligasResumo"></div>

                    <!-- Filtros -->
                    <div class="filtros-bar">
                        <div class="filtro-grupo">
                            <label>Liga</label>
                            <select class="filtro-select" id="filtroLiga">
                                <option value="">Todas</option>
                            </select>
                        </div>

                        <div class="filtro-grupo">
                            <label>Status</label>
                            <select class="filtro-select" id="filtroStatus">
                                <option value="">Todos</option>
                                <option value="ativo">Ativos</option>
                                <option value="inativo">Inativos</option>
                            </select>
                        </div>

                        <div class="filtro-grupo">
                            <label>Senha</label>
                            <select class="filtro-select" id="filtroSenha">
                                <option value="">Todos</option>
                                <option value="com">Com Senha</option>
                                <option value="sem">Sem Senha</option>
                            </select>
                        </div>

                        <div class="filtro-separator"></div>

                        <div class="filtro-grupo" style="flex: 1;">
                            <span class="material-icons" style="color: #6b7280; font-size: 18px;">search</span>
                            <input type="text" class="filtro-input" id="filtroBusca" placeholder="Buscar por nome, time ou ID..." style="flex: 1;" />
                        </div>

                        <div class="filtro-separator"></div>

                        <button class="btn-filtro-secundario" id="btnExportarCSV" title="Exportar lista">
                            <span class="material-icons">download</span>
                            CSV
                        </button>

                        <button class="btn-filtro-acao" id="btnSenhaLote" title="Definir senhas em lote">
                            <span class="material-icons">vpn_key</span>
                            Senhas em Lote
                        </button>
                    </div>

                    <!-- Tabela -->
                    <div class="tabela-container">
                        <div class="tabela-header">
                            <h3>Participantes</h3>
                            <span class="tabela-count" id="tabelaCount">0</span>
                        </div>
                        <div class="tabela-scroll">
                            <table class="participantes-table">
                                <thead>
                                    <tr>
                                        <th>Participante</th>
                                        <th>ID</th>
                                        <th>Liga</th>
                                        <th>Status</th>
                                        <th>Senha</th>
                                        <th>Dados</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaBody">
                                    <tr>
                                        <td colspan="7">
                                            <div class="loading-state">
                                                <div class="loading-spinner"></div>
                                                <div>Carregando participantes...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Modal Editar Senha -->
                    <div class="modal-overlay" id="modalSenha">
                        <div class="modal-content">
                            <h3 class="modal-title">
                                <span class="material-icons">vpn_key</span>
                                Definir Senha
                            </h3>
                            <div id="modalSenhaInfo" style="font-size: 0.8rem; color: #9ca3af; margin-bottom: 12px;"></div>
                            <div class="modal-field">
                                <label>Nova Senha</label>
                                <input type="text" id="modalSenhaInput" placeholder="Min. 3 caracteres" autocomplete="off" />
                            </div>
                            <div class="modal-actions">
                                <button class="modal-btn-primary" id="modalSenhaSalvar">Salvar</button>
                                <button class="modal-btn-secondary" id="modalSenhaFechar">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Senha em Lote -->
                    <div class="modal-overlay" id="modalSenhaLote">
                        <div class="modal-content">
                            <h3 class="modal-title">
                                <span class="material-icons">vpn_key</span>
                                Senhas em Lote
                            </h3>
                            <p style="font-size: 0.8rem; color: #9ca3af; margin-bottom: 12px;">
                                Aplica uma senha padrao para todos os participantes <strong>sem senha definida</strong> no filtro atual.
                            </p>
                            <div class="modal-field">
                                <label>Senha Padrao</label>
                                <input type="text" id="modalLoteSenhaInput" placeholder="Ex: cartola2026" autocomplete="off" />
                            </div>
                            <div id="modalLotePreview" style="font-size: 0.75rem; color: #6b7280; margin-bottom: 8px;"></div>
                            <div class="modal-actions">
                                <button class="modal-btn-primary" id="modalLoteSalvar">Aplicar</button>
                                <button class="modal-btn-secondary" id="modalLoteFechar">Cancelar</button>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- Scripts -->
        <script type="module">
            // Layout loader (padrão do projeto)
            async function loadLayout() {
                try {
                    // ✅ FIX: Não recarregar layout se já existe sidebar (navegação SPA)
                    if (document.querySelector('.app-sidebar')) {
                        console.log("[ANALISAR-PARTICIPANTES] Sidebar já existe, pulando loadLayout");
                        return;
                    }

                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document.getElementById("sidebar-placeholder")?.replaceWith(sidebar);
                    }

                    // ✅ FIX: Só injetar scripts do layout na PRIMEIRA carga
                    if (!window.__layoutScriptsInjected) {
                        window.__layoutScriptsInjected = true;
                        const scripts = doc.querySelectorAll("script");
                        scripts.forEach((script) => {
                            if (script.textContent.trim()) {
                                const newScript = document.createElement("script");
                                newScript.textContent = `(function(){${script.textContent}})();`;
                                document.head.appendChild(newScript);
                            }
                        });
                    }

                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            loadLayout();

            // ✅ FIX: Re-init na navegação SPA (script externo não re-executa)
            if (typeof window.__analisarParticipantesInit === 'function') {
                console.log("[ANALISAR-PARTICIPANTES] Re-init via SPA");
                window.__analisarParticipantesInit();
            }
        </script>

        <script src="js/analisar-participantes.js?v=2.1"></script>
    </body>
</html>
