<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Super Cartola Manager</title>
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <!-- Estilos Base -->
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    </head>
    <body>
        <!-- Botão Toggle Sidebar (Desktop) -->
        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="Recolher/Expandir menu">
            <span class="material-icons">chevron_left</span>
        </button>

        <!-- Sidebar Redesign -->
        <nav class="sidebar app-sidebar sidebar-redesign" id="appSidebar">
            <!-- Logo -->
            <div class="sidebar-logo-new" onclick="goToDashboard()" style="cursor: pointer;">
                <div class="sidebar-logo-icon">
                    <span class="material-icons">sports_soccer</span>
                </div>
                <div class="sidebar-logo-text">
                    <h1>Super Cartola</h1>
                    <p>Manager Profissional</p>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav-new">
                <!-- Links diretos (sempre visiveis) -->
                <div class="sidebar-section-new">
                    <ul class="sidebar-menu-new">
                        <li>
                            <a href="painel.html" class="sidebar-menu-item" data-page="painel.html">
                                <span class="material-icons">dashboard</span>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="participante/index.html" class="sidebar-menu-item sidebar-app-link" target="_blank">
                                <span class="material-icons">phone_android</span>
                                <span>App Participante</span>
                                <span class="material-icons" style="font-size: 14px; margin-left: auto; color: #9ca3af;">open_in_new</span>
                            </a>
                        </li>
                        <li>
                            <a href="ferramentas.html" class="sidebar-menu-item" data-page="ferramentas.html">
                                <span class="material-icons">build</span>
                                <span>Ferramentas</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- ========================================
                     LIGAS - Lista de Ligas Ativas
                     ======================================== -->
                <div class="sidebar-accordion" data-accordion="ligas">
                    <div class="sidebar-accordion-header">
                        <div class="sidebar-accordion-title">
                            <span class="material-icons">emoji_events</span>
                            <span>Ligas</span>
                        </div>
                        <span class="material-icons sidebar-accordion-arrow">expand_more</span>
                    </div>
                    <div class="sidebar-accordion-content">
                        <div id="ligasList">
                            <div class="sidebar-ligas-loading">
                                <span class="material-icons">sync</span>
                                Carregando...
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- User Section com Menu Dropup -->
            <div class="sidebar-user-new" id="sidebarUserSection">
                <!-- Menu Dropup (aparece ao clicar) -->
                <div class="sidebar-user-menu" id="userDropupMenu">
                    <button class="sidebar-user-menu-item" data-action="perfil">
                        <span class="material-icons">person</span>
                        <span>Meu Perfil</span>
                    </button>
                    <button class="sidebar-user-menu-item menu-super-admin-only" id="menuAdministradores" data-action="administradores" style="display: none;">
                        <span class="material-icons">admin_panel_settings</span>
                        <span>Administradores</span>
                    </button>
                    <div class="sidebar-user-menu-divider"></div>
                    <button class="sidebar-user-menu-item logout" data-action="logout">
                        <span class="material-icons">logout</span>
                        <span>Sair</span>
                    </button>
                </div>

                <!-- Area clicavel do usuario -->
                <div class="sidebar-user-inner" id="userMenuToggle">
                    <div class="sidebar-user-avatar">
                        <span class="material-icons">person</span>
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="userName">Admin</div>
                        <div class="sidebar-user-role">Administrador</div>
                    </div>
                </div>
            </div>
        </nav>

        <script>
            // === VERIFICAÇÃO DE SUPER ADMIN - FUNÇÃO SIMPLES ===
            // Esta função é chamada pelas páginas após injetar o layout
            window.verificarMenuSuperAdmin = async function() {
                console.log('[LAYOUT] verificarMenuSuperAdmin() iniciado');
                try {
                    console.log('[LAYOUT] Chamando API check-super...');
                    const response = await fetch('/api/admin/gestao/check-super', { credentials: 'include' });
                    if (!response.ok) return;
                    const data = await response.json();
                    const menuAdmin = document.getElementById('menuAdministradores');
                    if (menuAdmin) {
                        menuAdmin.style.cssText = data.isSuperAdmin
                            ? 'display: flex !important;'
                            : 'display: none !important;';
                    }
                } catch (e) {
                    console.warn('[LAYOUT] Erro ao verificar Super Admin:', e);
                }
            };

            // === MAPEAMENTO DE LOGOS DAS LIGAS ===
            function obterLogoLiga(nomeLiga) {
                const nome = (nomeLiga || '').toLowerCase();
                if (nome.includes('super')) return 'img/logo-supercartola.png';
                if (nome.includes('sobral') || nome.includes('cartoleiros')) return 'img/logo-cartoleirossobral.png';
                return null; // Sem logo especifica
            }

            // === SISTEMA DE ACCORDION ===

            window.AccordionManager = {
                STORAGE_KEY: 'sidebar_accordion_state',
                _initialized: false,

                init() {
                    if (this._initialized) return;
                    this.restoreState();
                    this.bindEvents();
                    this.autoExpandForCurrentPage();
                    this._initialized = true;
                },

                bindEvents() {
                    const headers = document.querySelectorAll('.sidebar-accordion-header');
                    headers.forEach((header) => {
                        // Evitar duplicar event listeners
                        if (header.dataset.accordionBound) return;
                        header.dataset.accordionBound = 'true';

                        header.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const accordion = header.closest('.sidebar-accordion');
                            window.AccordionManager.toggle(accordion);
                        });
                    });
                },

                toggle(accordion) {
                    if (!accordion) return;
                    const isOpen = accordion.classList.contains('open');

                    if (isOpen) {
                        accordion.classList.remove('open');
                    } else {
                        accordion.classList.add('open');
                    }

                    this.saveState();
                },

                open(accordion) {
                    if (accordion && !accordion.classList.contains('open')) {
                        accordion.classList.add('open');
                        this.saveState();
                    }
                },

                close(accordion) {
                    if (accordion && accordion.classList.contains('open')) {
                        accordion.classList.remove('open');
                        this.saveState();
                    }
                },

                saveState() {
                    const state = {};
                    document.querySelectorAll('.sidebar-accordion').forEach(acc => {
                        const key = acc.dataset.accordion;
                        if (key) {
                            state[key] = acc.classList.contains('open');
                        }
                    });
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(state));
                },

                restoreState() {
                    try {
                        const saved = localStorage.getItem(this.STORAGE_KEY);
                        if (!saved) return;

                        const state = JSON.parse(saved);
                        document.querySelectorAll('.sidebar-accordion').forEach(acc => {
                            const key = acc.dataset.accordion;
                            if (key && state[key] === true) {
                                acc.classList.add('open');
                            }
                        });
                    } catch (e) {
                        console.warn('Erro ao restaurar estado do accordion:', e);
                    }
                },

                autoExpandForCurrentPage() {
                    const currentPage = window.location.pathname.split('/').pop() || 'painel.html';

                    // Mapeamento de paginas para accordions
                    const pageToAccordion = {
                        // Ligas (dashboard da liga)
                        'detalhe-liga.html': 'ligas',
                        'editar-liga.html': 'ligas',
                        'preencher-liga.html': 'ligas',
                        'criar-liga.html': 'ligas',
                        'gerenciar.html': 'ligas',
                        'ferramentas-rodadas.html': 'ligas',
                        'fluxo-financeiro.html': 'ligas',
                        'admin.html': 'ligas'
                    };

                    const accordionKey = pageToAccordion[currentPage];
                    if (accordionKey) {
                        const accordion = document.querySelector(`[data-accordion="${accordionKey}"]`);
                        if (accordion) {
                            this.open(accordion);
                        }
                    }
                }
            };

            // === CARREGAMENTO DAS LIGAS NO SIDEBAR ===
            async function carregarLigasLayout() {
                const ligasList = document.getElementById("ligasList");
                if (!ligasList) return;

                // Obter ID da liga atual da URL
                const urlParams = new URLSearchParams(window.location.search);
                const ligaAtualId = urlParams.get("id");

                try {
                    const response = await fetch("/api/ligas");
                    const ligas = await response.json();

                    if (!Array.isArray(ligas) || ligas.length === 0) {
                        ligasList.innerHTML = `
                            <div class="sidebar-ligas-empty" style="margin: 0 0 8px 0;">
                                <span class="material-icons" style="font-size: 20px; margin-bottom: 6px; display: block;">folder_open</span>
                                Nenhuma liga
                            </div>
                        `;
                        return;
                    }

                    // Renderizar ligas com logos
                    ligasList.innerHTML = ligas
                        .map((liga) => {
                            const ligaId = liga._id || liga.id;
                            const isLigaAtual = ligaId === ligaAtualId;
                            const timesCount = liga.times?.length || 0;
                            const logoUrl = obterLogoLiga(liga.nome);

                            // Se tem logo, usa imagem; senao usa dot colorido
                            const logoHtml = logoUrl
                                ? `<img src="${logoUrl}" alt="" class="liga-logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" /><span class="liga-dot" style="display:none;"></span>`
                                : `<span class="liga-dot"></span>`;

                            return `
                                <a href="detalhe-liga.html?id=${ligaId}" class="sidebar-liga-item ${isLigaAtual ? 'active' : ''}" data-page="detalhe-liga.html">
                                    ${logoHtml}
                                    <div class="liga-info-sidebar">
                                        <div class="liga-name-sidebar">${liga.nome || "Liga sem nome"}</div>
                                    </div>
                                    <span class="liga-badge-count">${timesCount}</span>
                                </a>
                            `;
                        })
                        .join("");

                    // Se estamos em uma pagina de liga, expandir o accordion de ligas
                    if (ligaAtualId) {
                        const ligasAccordion = document.querySelector('[data-accordion="ligas"]');
                        if (ligasAccordion && window.AccordionManager) {
                            window.AccordionManager.open(ligasAccordion);
                        }
                    }
                } catch (error) {
                    ligasList.innerHTML = `
                        <div class="sidebar-ligas-empty" style="margin: 0 0 8px 0;">
                            <span class="material-icons" style="color: #ef4444; font-size: 20px; margin-bottom: 6px; display: block;">warning</span>
                            Erro ao carregar
                            <button onclick="carregarLigasLayout()" style="
                                margin-top: 6px;
                                padding: 4px 10px;
                                background: #FF5500;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                font-size: 10px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Tentar</button>
                        </div>
                    `;
                }
            }

            // === SISTEMA DE NAVEGAÇÃO ===
            class NavigationSystem {
                constructor() {
                    this.init();
                    this.loadLigas();
                    this.setActiveNavigation();
                }

                init() {
                    // Inicializar accordions
                    if (window.AccordionManager) {
                        window.AccordionManager.init();
                    }
                    // Set page title baseado na URL
                    this.updatePageTitle();
                }

                async loadLigas() {
                    await carregarLigasLayout();
                }

                updatePageTitle() {
                    const pageTitle = document.getElementById("pageTitle");
                    const pageSubtitle = document.getElementById("pageSubtitle");

                    if (!pageTitle) return;

                    const currentPage = window.location.pathname.split("/").pop() || "painel.html";

                    const titles = {
                        "painel.html": { title: "Dashboard", subtitle: "Visao Geral do Sistema" },
                        "gerenciar.html": { title: "Gerenciar Ligas", subtitle: "Ferramentas Administrativas" },
                        "criar-liga.html": { title: "Nova Liga", subtitle: "Criar Nova Liga" },
                        "preencher-liga.html": { title: "Nova Liga", subtitle: "Criar Nova Liga" },
                        "buscar-times.html": { title: "Buscar Times", subtitle: "Adicionar Times do Cartola FC" },
                        "admin.html": { title: "Admin", subtitle: "Popular Rodadas" },
                        "ferramentas-rodadas.html": { title: "Rodadas", subtitle: "Popular e Gerenciar Rodadas" },
                        "detalhe-liga.html": { title: "Detalhes da Liga", subtitle: "Visualizacao Completa" },
                        "editar-liga.html": { title: "Editar Liga", subtitle: "Modificar Times da Liga" },
                        "fluxo-financeiro.html": { title: "Fluxo Financeiro", subtitle: "Selecione uma Liga" },
                        "auditoria-extratos.html": { title: "Auditoria", subtitle: "Verificar Integridade dos Extratos" },
                        "admin-gestao.html": { title: "Administradores", subtitle: "Gerenciar Usuarios Admin" },
                        "historico-acessos.html": { title: "Historico de Acessos", subtitle: "Monitorar Acessos ao App" },
                        "ferramentas.html": { title: "Ferramentas", subtitle: "Hub de Gestao" },
                    };

                    const pageInfo = titles[currentPage] || {
                        title: "Super Cartola Manager",
                        subtitle: "Sistema de Gerenciamento",
                    };

                    pageTitle.textContent = pageInfo.title;
                    if (pageSubtitle) {
                        pageSubtitle.textContent = pageInfo.subtitle;
                    }
                }

                setActiveNavigation() {
                    const currentPage = window.location.pathname.split("/").pop() || "painel.html";
                    const currentUrl = window.location.href;

                    // Limpar todos os estados ativos
                    document.querySelectorAll(".sidebar-menu-item, .sidebar-liga-item, .sidebar-accordion-item, .sidebar-accordion-action").forEach(link => {
                        link.classList.remove("active");
                    });

                    // Marcar item ativo baseado na pagina atual
                    document.querySelectorAll("[data-page]").forEach(link => {
                        const pageName = link.dataset.page;
                        if (pageName === currentPage) {
                            link.classList.add("active");
                        }
                    });

                    // Para paginas de detalhe de liga, verificar o ID
                    if (currentPage === "detalhe-liga.html") {
                        const urlParams = new URLSearchParams(window.location.search);
                        const ligaId = urlParams.get("id");
                        if (ligaId) {
                            document.querySelectorAll(".sidebar-liga-item").forEach(link => {
                                if (link.href && link.href.includes(`id=${ligaId}`)) {
                                    link.classList.add("active");
                                }
                            });
                        }
                    }
                }
            }

            // === FUNÇÕES GLOBAIS ===
            function goToDashboard() {
                window.location.href = "painel.html";
            }

            // === TOGGLE SIDEBAR (DESKTOP) ===
            function toggleSidebar() {
                const sidebar = document.getElementById('appSidebar');
                const toggleBtn = document.getElementById('sidebarToggleBtn');
                const body = document.body;

                if (!sidebar) return;

                const isCollapsed = sidebar.classList.toggle('sidebar-collapsed');
                body.classList.toggle('sidebar-collapsed', isCollapsed);

                // Atualizar ícone do botão
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('.material-icons');
                    if (icon) {
                        icon.textContent = isCollapsed ? 'chevron_right' : 'chevron_left';
                    }
                }

                // Salvar estado
                localStorage.setItem('sidebar_collapsed', isCollapsed ? 'true' : 'false');
            }

            // Restaurar estado do sidebar ao carregar
            function restoreSidebarState() {
                const isCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
                if (isCollapsed) {
                    const sidebar = document.getElementById('appSidebar');
                    const toggleBtn = document.getElementById('sidebarToggleBtn');
                    const body = document.body;

                    if (sidebar) {
                        sidebar.classList.add('sidebar-collapsed');
                        body.classList.add('sidebar-collapsed');
                        if (toggleBtn) {
                            const icon = toggleBtn.querySelector('.material-icons');
                            if (icon) icon.textContent = 'chevron_right';
                        }
                    }
                }
            }

            // === MENU DROPUP DO PERFIL - INICIALIZAÇÃO ===
            function inicializarMenuPerfil() {
                const userSection = document.getElementById('sidebarUserSection');
                const userToggle = document.getElementById('userMenuToggle');
                const menuItems = document.querySelectorAll('#userDropupMenu .sidebar-user-menu-item');

                if (!userSection || !userToggle) return;

                // Evitar dupla inicialização (sidebar-menu.js pode ter inicializado primeiro)
                if (userToggle.dataset.initialized) {
                    console.log('[LAYOUT] Menu já inicializado por sidebar-menu.js');
                    return;
                }
                userToggle.dataset.initialized = 'true';

                // Toggle do menu
                userToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userSection.classList.toggle('menu-open');
                });

                // Ações do menu
                menuItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const action = this.getAttribute('data-action');

                        switch(action) {
                            case 'perfil':
                                abrirPerfilAdmin();
                                break;
                            case 'administradores':
                                window.location.href = 'admin-gestao.html';
                                break;
                            case 'logout':
                                fazerLogoutAdmin();
                                break;
                        }

                        userSection.classList.remove('menu-open');
                    });
                });

                // Fechar ao clicar fora
                document.addEventListener('click', function(e) {
                    if (userSection && !userSection.contains(e.target)) {
                        userSection.classList.remove('menu-open');
                    }
                });

                // Fechar com ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        userSection.classList.remove('menu-open');
                    }
                });
            }

            function abrirPerfilAdmin() {
                fetch('/api/admin/auth/session', { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => {
                        const nome = data.user?.name || data.user?.username || 'Admin';
                        const email = data.user?.email || 'Nao informado';
                        const provider = data.user?.provider || 'replit';
                        const isSuperAdmin = data.user?.superAdmin || false;

                        mostrarModalPerfil({
                            nome: nome,
                            email: email,
                            provider: provider,
                            isSuperAdmin: isSuperAdmin,
                            ultimoAcesso: new Date().toLocaleString('pt-BR')
                        });
                    })
                    .catch(() => {
                        mostrarModalPerfil({
                            nome: 'Admin',
                            email: 'Nao informado',
                            provider: 'local',
                            isSuperAdmin: false,
                            ultimoAcesso: new Date().toLocaleString('pt-BR')
                        });
                    });
            }

            function mostrarModalPerfil(dados) {
                // Remover modal anterior se existir
                const modalAnterior = document.getElementById('modalPerfilAdmin');
                if (modalAnterior) modalAnterior.remove();

                const roleText = dados.isSuperAdmin ? 'Super Administrador' : 'Administrador';
                const roleClass = dados.isSuperAdmin ? 'super-admin' : 'admin';
                const providerIcon = dados.provider === 'replit' ? 'cloud' : 'person';

                const modalHtml = `
                    <div id="modalPerfilAdmin" class="modal-perfil-overlay" onclick="fecharModalPerfil(event)">
                        <div class="modal-perfil-content" onclick="event.stopPropagation()">
                            <button class="modal-perfil-close" onclick="fecharModalPerfil()">
                                <span class="material-icons">close</span>
                            </button>

                            <div class="modal-perfil-header">
                                <div class="modal-perfil-avatar">
                                    <span class="material-icons">admin_panel_settings</span>
                                </div>
                                <h2>${dados.nome}</h2>
                                <span class="modal-perfil-badge ${roleClass}">
                                    <span class="material-icons">verified</span>
                                    ${roleText}
                                </span>
                            </div>

                            <div class="modal-perfil-info">
                                <div class="modal-perfil-item">
                                    <span class="material-icons">email</span>
                                    <div>
                                        <label>Email</label>
                                        <span>${dados.email}</span>
                                    </div>
                                </div>
                                <div class="modal-perfil-item">
                                    <span class="material-icons">${providerIcon}</span>
                                    <div>
                                        <label>Autenticacao</label>
                                        <span>${dados.provider === 'replit' ? 'Replit Auth (SSO)' : 'Local'}</span>
                                    </div>
                                </div>
                                <div class="modal-perfil-item">
                                    <span class="material-icons">schedule</span>
                                    <div>
                                        <label>Sessao Atual</label>
                                        <span>${dados.ultimoAcesso}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-perfil-footer">
                                <button class="btn-modal-secondary" onclick="fecharModalPerfil()">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Animar entrada
                requestAnimationFrame(() => {
                    document.getElementById('modalPerfilAdmin').classList.add('active');
                });
            }

            function fecharModalPerfil(event) {
                if (event && event.target !== event.currentTarget) return;
                const modal = document.getElementById('modalPerfilAdmin');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 200);
                }
            }

            // Expor funções globalmente para sidebar-menu.js
            window.abrirPerfilAdmin = abrirPerfilAdmin;
            window.fecharModalPerfil = fecharModalPerfil;
            window.mostrarModalPerfil = mostrarModalPerfil;

            function fazerLogoutAdmin() {
                if (confirm('Deseja realmente sair do sistema?')) {
                    fetch('/api/admin/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    })
                    .then(() => {
                        localStorage.removeItem('adminLogado');
                        localStorage.removeItem('ligaIdSelecionada');
                        window.location.href = '/';
                    })
                    .catch(() => {
                        localStorage.removeItem('adminLogado');
                        window.location.href = '/';
                    });
                }
            }

            // === CARREGAR DADOS DO ADMIN ===
            async function carregarDadosAdmin() {
                console.log('[LAYOUT] carregarDadosAdmin() chamado');
                try {
                    const response = await fetch('/api/admin/auth/session', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        console.log('[LAYOUT] Session data:', data);
                        // API retorna data.admin, não data.user
                        const admin = data.admin || data.user;
                        if (admin) {
                            const userName = document.getElementById('userName');
                            if (userName) {
                                // Usar primeiro nome se disponivel
                                const nome = admin.nome || admin.name || admin.email?.split('@')[0] || 'Admin';
                                const primeiroNome = nome.split(' ')[0];
                                userName.textContent = primeiroNome;
                                console.log('[LAYOUT] Nome do admin definido:', primeiroNome);
                            }
                        }
                    }

                    // Verificar se é Super Admin para mostrar menu Administradores
                    console.log('[LAYOUT] Chamando check-super...');
                    const superResponse = await fetch('/api/admin/gestao/check-super', { credentials: 'include' });
                    console.log('[LAYOUT] check-super response status:', superResponse.status);
                    if (superResponse.ok) {
                        const superData = await superResponse.json();
                        console.log('[LAYOUT] Check Super Admin result:', superData);

                        const menuAdmin = document.getElementById('menuAdministradores');
                        console.log('[LAYOUT] menuAdministradores element:', menuAdmin);
                        if (menuAdmin) {
                            if (superData.isSuperAdmin) {
                                // Super Admin - mostrar menu
                                menuAdmin.style.cssText = 'display: flex !important;';
                                console.log('[LAYOUT] Menu Administradores VISÍVEL (Super Admin)');
                            } else {
                                // Admin comum - esconder menu
                                menuAdmin.style.cssText = 'display: none !important;';
                                console.log('[LAYOUT] Menu Administradores OCULTO (Admin comum)');
                            }
                        } else {
                            console.warn('[LAYOUT] Elemento menuAdministradores não encontrado!');
                        }
                    } else {
                        console.warn('[LAYOUT] check-super falhou:', superResponse.status);
                    }
                } catch (error) {
                    // Silencioso - manter "Admin" como fallback
                    console.warn('[LAYOUT] Erro ao carregar dados admin:', error);
                }
            }

            // === INICIALIZAÇÃO ===
            function inicializarLayout() {
                console.log('[LAYOUT] Inicializando layout...');
                restoreSidebarState(); // Restaurar estado do sidebar
                window.navigationSystem = new NavigationSystem();
                carregarDadosAdmin();
                inicializarMenuPerfil();
                console.log('[LAYOUT] Layout inicializado');
            }

            // Flag para evitar inicialização duplicada
            let layoutInicializado = window._layoutInicializado || false;

            // Inicialização - verificar se sidebar já existe no DOM
            function tentarInicializarLayout() {
                if (layoutInicializado || window._layoutInicializado) {
                    console.log('[LAYOUT] Já inicializado, ignorando...');
                    return;
                }

                const sidebar = document.getElementById('appSidebar');
                if (sidebar) {
                    console.log('[LAYOUT] Sidebar encontrado, inicializando...');
                    layoutInicializado = true;
                    window._layoutInicializado = true;
                    inicializarLayout();
                } else {
                    console.log('[LAYOUT] Sidebar não encontrado, aguardando...');
                    setTimeout(tentarInicializarLayout, 100);
                }
            }

            // Expor função globalmente ANTES de qualquer inicialização
            window.carregarDadosAdmin = carregarDadosAdmin;
            window.inicializarLayout = inicializarLayout;
            window.tentarInicializarLayout = tentarInicializarLayout;

            // Inicialização automática - sempre executar após pequeno delay
            // para garantir que o DOM foi atualizado
            console.log('[LAYOUT] Agendando inicialização... readyState:', document.readyState);
            setTimeout(tentarInicializarLayout, 200);

            // Recarregar ao voltar para página
            window.addEventListener("pageshow", (event) => {
                if (event.persisted) {
                    setTimeout(carregarLigasLayout, 200);
                }
            });
        </script>

        <!-- PROTECAO CLIENT-SIDE -->
        <script>
            (function () {
                "use strict";
                var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (!isMobile) {
                    document.addEventListener("keydown", function (e) {
                        if (e.key === "F12" || e.keyCode === 123) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "i" || e.keyCode === 73)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && e.shiftKey && (e.key === "J" || e.key === "j" || e.keyCode === 74)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && e.shiftKey && (e.key === "C" || e.key === "c" || e.keyCode === 67)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && (e.key === "U" || e.key === "u" || e.keyCode === 85)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && (e.key === "S" || e.key === "s" || e.keyCode === 83)) {
                            e.preventDefault();
                            return false;
                        }
                    });
                    document.addEventListener("contextmenu", function (e) {
                        e.preventDefault();
                        return false;
                    });
                }
                if (window.self !== window.top) {
                    window.top.location = window.self.location;
                }
            })();
        </script>
    </body>
</html>
