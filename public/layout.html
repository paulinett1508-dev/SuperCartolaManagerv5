<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Super Cartola Manager</title>
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <!-- Estilos Base -->
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/base.css" />
        <link rel="stylesheet" href="css/performance.css" />
        <!-- Estilos de Páginas (SPA Navigation) -->
        <link rel="stylesheet" href="detalhe-liga.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/detalhe-liga-redesign.css" />
        <link rel="stylesheet" href="css/modules/fluxo-financeiro.css" />
        <link rel="stylesheet" href="css/modules/ferramentas-page.css" />
        <!-- Bootstrap (para modais e componentes) -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
        <!-- Fallback Material Icons -->
        <style>
            @font-face {
                font-family: "Material Icons";
                font-style: normal;
                font-weight: 400;
                src: url(https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format("woff2");
            }
            .material-icons {
                font-family: "Material Icons" !important;
                font-weight: normal;
                font-style: normal;
                font-size: 24px;
                line-height: 1;
                letter-spacing: normal;
                text-transform: none;
                display: inline-block;
                white-space: nowrap;
                word-wrap: normal;
                direction: ltr;
                -webkit-font-feature-settings: "liga";
                font-feature-settings: "liga";
                -webkit-font-smoothing: antialiased;
            }
        </style>
        <!-- Super Modal -->
        <link rel="stylesheet" href="css/modules/super-modal.css" />
        <!-- External Dependencies -->
        <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
        <script src="js/super-modal.js"></script>
    </head>
    <body>
        <!-- Botão Toggle Sidebar (Desktop) -->
        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="Recolher/Expandir menu">
            <span class="material-icons">chevron_left</span>
        </button>

        <!-- Sidebar Redesign -->
        <nav class="sidebar app-sidebar sidebar-redesign" id="appSidebar">
            <!-- Logo -->
            <div class="sidebar-logo-new" onclick="goToDashboard()" style="cursor: pointer;">
                <div class="sidebar-logo-icon">
                    <span class="material-icons">sports_soccer</span>
                </div>
                <div class="sidebar-logo-text">
                    <h1>Super <span>Cartola</span></h1>
                    <p>Manager Profissional</p>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav-new">
                <!-- Dashboard (link direto - sempre visivel) -->
                <div class="sidebar-section-new">
                    <ul class="sidebar-menu-new">
                        <li>
                            <a href="painel.html" class="sidebar-menu-item" data-page="painel.html" data-tooltip="Dashboard">
                                <span class="material-icons">dashboard</span>
                                <span>Dashboard</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- ========================================
                     LIGAS - Criar, Gerenciar e Lista Ativa
                     ======================================== -->
                <div class="sidebar-accordion" data-accordion="ligas">
                    <div class="sidebar-accordion-header" data-tooltip="Ligas">
                        <div class="sidebar-accordion-title">
                            <span class="material-icons">emoji_events</span>
                            <span>Ligas</span>
                        </div>
                        <span class="material-icons sidebar-accordion-arrow">expand_more</span>
                    </div>
                    <div class="sidebar-accordion-content">
                        <ul class="sidebar-accordion-menu">
                            <li>
                                <a href="criar-liga.html" class="sidebar-accordion-item" data-page="criar-liga.html">
                                    <span class="material-icons">add_circle_outline</span>
                                    <span>Criar Nova Liga</span>
                                </a>
                            </li>
                            <li>
                                <a href="gerenciar.html" class="sidebar-accordion-item" data-page="gerenciar.html">
                                    <span class="material-icons">tune</span>
                                    <span>Gerenciar Ligas</span>
                                </a>
                            </li>
                        </ul>
                        <div class="sidebar-submenu-divider"></div>
                        <!-- Temporadas: item de menu com lista expansível -->
                        <div class="sidebar-temporadas-wrapper">
                            <div class="sidebar-accordion-item sidebar-temporadas-toggle" id="temporadasToggle">
                                <span class="material-icons">calendar_today</span>
                                <span>Temporadas</span>
                                <span class="material-icons sidebar-temporadas-arrow">expand_more</span>
                            </div>
                            <div class="sidebar-temporadas-list" id="temporadasList">
                                <div id="ligasList">
                                    <div class="sidebar-ligas-loading">
                                        <span class="material-icons">sync</span>
                                        Carregando...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========================================
                     PARTICIPANTES
                     ======================================== -->
                <div class="sidebar-accordion" data-accordion="participantes">
                    <div class="sidebar-accordion-header" data-tooltip="Participantes">
                        <div class="sidebar-accordion-title">
                            <span class="material-icons">groups</span>
                            <span>Participantes</span>
                        </div>
                        <span class="material-icons sidebar-accordion-arrow">expand_more</span>
                    </div>
                    <div class="sidebar-accordion-content">
                        <ul class="sidebar-accordion-menu">
                            <li>
                                <a href="analisar-participantes.html" class="sidebar-accordion-item" data-page="analisar-participantes.html">
                                    <span class="material-icons">person_search</span>
                                    <span>Analisar Participantes</span>
                                </a>
                            </li>
                            <li>
                                <a href="historico-acessos.html" class="sidebar-accordion-item" data-page="historico-acessos.html">
                                    <span class="material-icons">history</span>
                                    <span>Histórico de Acessos</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="sidebar-accordion-item" onclick="abrirAdicionarParticipanteSidebar(event)">
                                    <span class="material-icons">group_add</span>
                                    <span>Adicionar Participante</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- ========================================
                     OPERAÇÕES
                     ======================================== -->
                <div class="sidebar-accordion" data-accordion="operacoes">
                    <div class="sidebar-accordion-header" data-tooltip="Operações">
                        <div class="sidebar-accordion-title">
                            <span class="material-icons">build</span>
                            <span>Operações</span>
                        </div>
                        <span class="material-icons sidebar-accordion-arrow">expand_more</span>
                    </div>
                    <div class="sidebar-accordion-content">
                        <ul class="sidebar-accordion-menu">
                            <li>
                                <a href="ferramentas-rodadas.html" class="sidebar-accordion-item" data-page="ferramentas-rodadas.html">
                                    <span class="material-icons">sports_score</span>
                                    <span>Popular Rodadas</span>
                                </a>
                            </li>
                            <li>
                                <a href="gerenciar.html" class="sidebar-accordion-item" data-page="gerenciar.html">
                                    <span class="material-icons">widgets</span>
                                    <span>Gerenciar Módulos</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="sidebar-accordion-item" id="sidebarModoManutencao" onclick="abrirModoManutencaoSidebar(event)">
                                    <span class="material-icons">engineering</span>
                                    <span>Modo Manutenção</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="sidebar-accordion-item" id="sidebarConsolidarRodada" onclick="abrirConsolidarRodadaSidebar(event)">
                                    <span class="material-icons">sync</span>
                                    <span>Consolidar Rodada</span>
                                </a>
                            </li>
                            <li>
                                <a href="notificador.html" class="sidebar-accordion-item" data-page="notificador.html">
                                    <span class="material-icons">notifications_active</span>
                                    <span>Notificador</span>
                                </a>
                            </li>
                            <li>
                                <a href="admin-orchestrator.html" class="sidebar-accordion-item" data-page="admin-orchestrator.html">
                                    <span class="material-icons">hub</span>
                                    <span>Orchestrator</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- ========================================
                     ANALYTICS
                     ======================================== -->
                <div class="sidebar-accordion" data-accordion="analytics">
                    <div class="sidebar-accordion-header" data-tooltip="Analytics">
                        <div class="sidebar-accordion-title">
                            <span class="material-icons">analytics</span>
                            <span>Analytics</span>
                        </div>
                        <span class="material-icons sidebar-accordion-arrow">expand_more</span>
                    </div>
                    <div class="sidebar-accordion-content">
                        <ul class="sidebar-accordion-menu">
                            <li>
                                <a href="github-analytics-unified.html" class="sidebar-accordion-item" data-page="github-analytics-unified.html">
                                    <span class="material-icons">merge_type</span>
                                    <span>Repositório</span>
                                </a>
                            </li>
                            <li>
                                <a href="api-football-analytics.html" class="sidebar-accordion-item" data-page="api-football-analytics.html">
                                    <span class="material-icons">api</span>
                                    <span>APIs</span>
                                </a>
                            </li>
                            <li>
                                <a href="dashboard-saude.html" class="sidebar-accordion-item" data-page="dashboard-saude.html">
                                    <span class="material-icons">health_and_safety</span>
                                    <span>Saúde</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- ========================================
                     ADMIN
                     ======================================== -->
                <div class="sidebar-accordion sidebar-admin-section" data-accordion="administracao" id="accordionAdmin" style="display: none;">
                    <div class="sidebar-accordion-header" data-tooltip="Admin">
                        <div class="sidebar-accordion-title">
                            <span class="material-icons">admin_panel_settings</span>
                            <span>Admin</span>
                        </div>
                        <span class="material-icons sidebar-accordion-arrow">expand_more</span>
                    </div>
                    <div class="sidebar-accordion-content">
                        <ul class="sidebar-accordion-menu">
                            <li>
                                <a href="admin-gestao.html" class="sidebar-accordion-item" data-page="admin-gestao.html">
                                    <span class="material-icons">shield</span>
                                    <span>Gestão de Admins</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- User Section com Menu Dropup -->
            <div class="sidebar-user-new" id="sidebarUserSection">
                <!-- Menu Dropup (aparece ao clicar) -->
                <div class="sidebar-user-menu" id="userDropupMenu">
                    <button class="sidebar-user-menu-item" data-action="perfil">
                        <span class="material-icons">person</span>
                        <span>Meu Perfil</span>
                    </button>
                    <button class="sidebar-user-menu-item menu-super-admin-only" id="menuAdministradores" data-action="administradores" style="display: none;">
                        <span class="material-icons">admin_panel_settings</span>
                        <span>Administradores</span>
                    </button>
                    <div class="sidebar-user-menu-divider"></div>
                    <button class="sidebar-user-menu-item" data-action="app-participante">
                        <span class="material-icons">phone_android</span>
                        <span>App Participante</span>
                        <span class="material-icons" style="font-size: 16px; margin-left: auto; color: #9ca3af;">open_in_new</span>
                    </button>
                    <button class="sidebar-user-menu-item" data-action="app-admin">
                        <span class="material-icons">tablet_android</span>
                        <span>App Admin</span>
                        <span class="material-icons" style="font-size: 16px; margin-left: auto; color: #9ca3af;">open_in_new</span>
                    </button>
                    <div class="sidebar-user-menu-divider"></div>
                    <button class="sidebar-user-menu-item logout" data-action="logout">
                        <span class="material-icons">logout</span>
                        <span>Sair</span>
                    </button>
                </div>

                <!-- Area clicavel do usuario -->
                <div class="sidebar-user-inner" id="userMenuToggle">
                    <div class="sidebar-user-avatar">
                        <span class="material-icons">person</span>
                        <div class="sidebar-user-status-dot"></div>
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="userName">Admin</div>
                        <div class="sidebar-user-role">Administrador</div>
                    </div>
                </div>
            </div>
        </nav>

        <script>
            // === GLOBAL LAYOUT STATE (Idempotency Guard) ===
            // ✅ v10.0: Previne re-execuções em navegação SPA
            if (typeof window.__layout_state === 'undefined') {
                window.__layout_state = {
                    initialized: false,
                    accordionBound: false,
                    ligasCarregadas: false,
                    version: '3.0'
                };
                console.log('[LAYOUT] Estado global inicializado');
            }

            // === SISTEMA DE CACHE LOCALSTORAGE ===
            // ✅ v9.2: Fix - CacheManager acessível mesmo após re-injeção SPA
            if (typeof window._layoutCacheManager === 'undefined') {
            window._layoutCacheManager = true;

            // TTL em minutos: sessao=5min, ligas=2min
            var CacheManager = {
                KEYS: {
                    SESSION: '_cache_admin_session',
                    SUPER_ADMIN: '_cache_super_admin',
                    LIGAS: '_cache_ligas'
                },
                TTL: {
                    SESSION: 5 * 60 * 1000,    // 5 minutos
                    SUPER_ADMIN: 5 * 60 * 1000, // 5 minutos
                    LIGAS: 2 * 60 * 1000        // 2 minutos
                },

                set(key, data, ttl) {
                    const item = {
                        data: data,
                        timestamp: Date.now(),
                        ttl: ttl
                    };
                    try {
                        localStorage.setItem(key, JSON.stringify(item));
                    } catch (e) {
                        console.warn('[CACHE] Erro ao salvar:', e);
                    }
                },

                get(key) {
                    try {
                        const item = localStorage.getItem(key);
                        if (!item) return null;

                        const parsed = JSON.parse(item);
                        const age = Date.now() - parsed.timestamp;

                        if (age > parsed.ttl) {
                            localStorage.removeItem(key);
                            return null; // Expirado
                        }

                        return parsed.data;
                    } catch (e) {
                        return null;
                    }
                },

                invalidate(key) {
                    if (key) {
                        localStorage.removeItem(key);
                    } else {
                        // Invalidar todos os caches
                        Object.values(this.KEYS).forEach(k => localStorage.removeItem(k));
                    }
                },

                // Invalidar ao fazer logout
                clear() {
                    this.invalidate();
                }
            };

            // Expor globalmente para debug/invalidação manual
            window.CacheManager = CacheManager;

            // === VERIFICAÇÃO DE SUPER ADMIN - COM CACHE ===
            // Esta função é chamada pelas páginas após injetar o layout
            window.verificarMenuSuperAdmin = async function() {
                console.log('[LAYOUT] verificarMenuSuperAdmin() iniciado');
                try {
                    // ✅ v9.2: Usar window.CacheManager para funcionar após re-injeção SPA
                    var _cm = window.CacheManager;
                    if (!_cm || !_cm.KEYS) {
                        console.warn('[LAYOUT] CacheManager não disponível, chamando API diretamente');
                        const response = await fetch('/api/admin/gestao/check-super', { credentials: 'include' });
                        if (!response.ok) return;
                        const fallbackData = await response.json();
                        const menuAdmin = document.getElementById('menuAdministradores');
                        if (menuAdmin) {
                            menuAdmin.style.cssText = fallbackData.isSuperAdmin
                                ? 'display: flex !important;'
                                : 'display: none !important;';
                        }
                        const accordionAdmin = document.getElementById('accordionAdmin');
                        if (accordionAdmin) {
                            accordionAdmin.style.cssText = fallbackData.isSuperAdmin
                                ? 'display: block !important;'
                                : 'display: none !important;';
                        }
                        return;
                    }

                    // Tentar cache primeiro
                    let data = _cm.get(_cm.KEYS.SUPER_ADMIN);

                    if (data) {
                        console.log('[LAYOUT] Super Admin (cache hit)');
                    } else {
                        console.log('[LAYOUT] Chamando API check-super...');
                        const response = await fetch('/api/admin/gestao/check-super', { credentials: 'include' });
                        if (!response.ok) return;
                        data = await response.json();
                        _cm.set(_cm.KEYS.SUPER_ADMIN, data, _cm.TTL.SUPER_ADMIN);
                    }

                    const menuAdmin = document.getElementById('menuAdministradores');
                    if (menuAdmin) {
                        menuAdmin.style.cssText = data.isSuperAdmin
                            ? 'display: flex !important;'
                            : 'display: none !important;';
                    }
                    const accordionAdmin = document.getElementById('accordionAdmin');
                    if (accordionAdmin) {
                        accordionAdmin.style.cssText = data.isSuperAdmin
                            ? 'display: block !important;'
                            : 'display: none !important;';
                    }
                } catch (e) {
                    console.warn('[LAYOUT] Erro ao verificar Super Admin:', e);
                }
            };

            // === LOGOS DAS LIGAS (Dinâmico via campo liga.logo) ===
            // Não mais hardcoded - usa campo 'logo' do banco de dados
            // Para configurar: PUT /api/ligas/:id/logo { logo: "img/nome.png" }

            // === SISTEMA DE ACCORDION ===

            window.AccordionManager = {
                STORAGE_KEY: 'sidebar_accordion_state',
                _initialized: false,

                init() {
                    if (this._initialized) {
                        console.log('[LAYOUT] AccordionManager já inicializado, pulando...');
                        return;
                    }
                    console.log('[LAYOUT] Inicializando AccordionManager...');
                    this.restoreState();
                    this.bindEvents();
                    this.autoExpandForCurrentPage();
                    this._initialized = true;
                    window.__layout_state.accordionBound = true;
                },

                bindEvents() {
                    // Bind accordions principais
                    const headers = document.querySelectorAll('.sidebar-accordion-header');
                    headers.forEach((header) => {
                        // Evitar duplicar event listeners
                        if (header.dataset.accordionBound) return;
                        header.dataset.accordionBound = 'true';

                        header.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const accordion = header.closest('.sidebar-accordion');
                            window.AccordionManager.toggle(accordion);
                        });
                    });

                    // Bind sub-accordions (Fase 1: hierarquia aninhada)
                    const subHeaders = document.querySelectorAll('.sidebar-sub-accordion-header');
                    subHeaders.forEach((subHeader) => {
                        if (subHeader.dataset.subAccordionBound) return;
                        subHeader.dataset.subAccordionBound = 'true';

                        subHeader.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const subAccordion = subHeader.closest('.sidebar-sub-accordion');
                            window.AccordionManager.toggleSubAccordion(subAccordion);
                        });
                    });

                    // Bind Temporadas toggle (item de menu expansível)
                    const temporadasToggle = document.getElementById('temporadasToggle');
                    if (temporadasToggle && !temporadasToggle.dataset.temporadasBound) {
                        temporadasToggle.dataset.temporadasBound = 'true';

                        temporadasToggle.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const wrapper = temporadasToggle.closest('.sidebar-temporadas-wrapper');
                            if (wrapper) {
                                wrapper.classList.toggle('open');
                                // Save state
                                localStorage.setItem('temporadas_open', wrapper.classList.contains('open'));
                            }
                        });

                        // Restore state
                        const temporadasOpen = localStorage.getItem('temporadas_open') === 'true';
                        if (temporadasOpen) {
                            const wrapper = document.querySelector('.sidebar-temporadas-wrapper');
                            if (wrapper) {
                                wrapper.classList.add('open');
                            }
                        }
                    }
                },

                toggleSubAccordion(subAccordion) {
                    if (!subAccordion) return;
                    const isOpen = subAccordion.classList.contains('open');

                    if (isOpen) {
                        subAccordion.classList.remove('open');
                    } else {
                        subAccordion.classList.add('open');
                    }

                    this.saveState();
                },

                toggle(accordion) {
                    if (!accordion) return;
                    const isOpen = accordion.classList.contains('open');

                    if (isOpen) {
                        accordion.classList.remove('open');
                    } else {
                        accordion.classList.add('open');
                    }

                    this.saveState();
                },

                open(accordion) {
                    if (accordion && !accordion.classList.contains('open')) {
                        accordion.classList.add('open');
                        this.saveState();
                    }
                },

                close(accordion) {
                    if (accordion && accordion.classList.contains('open')) {
                        accordion.classList.remove('open');
                        this.saveState();
                    }
                },

                saveState() {
                    const state = {};
                    // Salvar estado dos accordions principais
                    document.querySelectorAll('.sidebar-accordion').forEach(acc => {
                        const key = acc.dataset.accordion;
                        if (key) {
                            state[key] = acc.classList.contains('open');
                        }
                    });
                    // Salvar estado dos sub-accordions (Fase 1)
                    document.querySelectorAll('.sidebar-sub-accordion').forEach(subAcc => {
                        const key = subAcc.dataset.subAccordion;
                        if (key) {
                            state[`sub_${key}`] = subAcc.classList.contains('open');
                        }
                    });
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(state));
                },

                restoreState() {
                    try {
                        const saved = localStorage.getItem(this.STORAGE_KEY);
                        if (!saved) return;

                        const state = JSON.parse(saved);
                        // Restaurar accordions principais
                        document.querySelectorAll('.sidebar-accordion').forEach(acc => {
                            const key = acc.dataset.accordion;
                            if (key && state[key] === true) {
                                acc.classList.add('open');
                            }
                        });
                        // Restaurar sub-accordions (Fase 1)
                        document.querySelectorAll('.sidebar-sub-accordion').forEach(subAcc => {
                            const key = subAcc.dataset.subAccordion;
                            if (key && state[`sub_${key}`] === true) {
                                subAcc.classList.add('open');
                            }
                        });
                    } catch (e) {
                        console.warn('Erro ao restaurar estado do accordion:', e);
                    }
                },

                autoExpandForCurrentPage() {
                    const currentPage = window.location.pathname.split('/').pop() || 'painel.html';

                    // Mapeamento de paginas para accordions
                    const pageToAccordion = {
                        // Ligas
                        'detalhe-liga.html': 'ligas',
                        'editar-liga.html': 'ligas',
                        'preencher-liga.html': 'ligas',
                        'criar-liga.html': 'ligas',
                        'gerenciar.html': 'ligas',
                        'gerenciar-modulos.html': 'ligas',
                        'admin.html': 'ligas',
                        // Participantes
                        'analisar-participantes.html': 'participantes',
                        'historico-acessos.html': 'participantes',
                        // Operações
                        'ferramentas-rodadas.html': 'operacoes',
                        'admin-orchestrator.html': 'operacoes',
                        // Analytics
                        'github-analytics-unified.html': 'analytics',
                        'dashboard-saude.html': 'analytics',
                        'api-football-analytics.html': 'analytics',
                        // Administração
                        'admin-gestao.html': 'administracao'
                    };

                    const accordionKey = pageToAccordion[currentPage];
                    if (accordionKey) {
                        const accordion = document.querySelector(`[data-accordion="${accordionKey}"]`);
                        if (accordion) {
                            this.open(accordion);
                        }
                    }
                }
            };

            // === CARREGAMENTO DAS LIGAS NO SIDEBAR (v3.0 - Com Cache + Idempotency Guard) ===
            async function carregarLigasLayout(forceRefresh = false) {
                const ligasList = document.getElementById("ligasList");
                if (!ligasList) return;

                // ✅ GUARD: Evita re-execuções em navegação SPA (exceto se forceRefresh)
                if (!forceRefresh && window.__layout_state && window.__layout_state.ligasCarregadas) {
                    // Verificar se o DOM do sidebar realmente tem ligas renderizadas
                    if (!ligasList.querySelector('.sidebar-ligas-loading')) {
                        console.log('[LAYOUT] Ligas já carregadas, usando cache de estado...');
                        return;
                    }
                    // Se o DOM ainda mostra loading, forçar recarregamento
                    console.log('[LAYOUT] Guard ativo mas DOM em loading, forçando recarga...');
                }

                // Obter ID da liga atual da URL
                const urlParams = new URLSearchParams(window.location.search);
                const ligaAtualId = urlParams.get("id");

                try {
                    // Tentar cache primeiro (se não forçar refresh)
                    let ligas = !forceRefresh ? CacheManager.get(CacheManager.KEYS.LIGAS) : null;

                    if (ligas) {
                        console.log('[LAYOUT] Ligas (cache hit)', ligas.length);
                    } else {
                        console.log('[LAYOUT] Carregando ligas da API...');
                        const response = await fetch("/api/ligas");
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        ligas = await response.json();
                        CacheManager.set(CacheManager.KEYS.LIGAS, ligas, CacheManager.TTL.LIGAS);
                        console.log('[LAYOUT] Ligas carregadas da API:', ligas.length);
                    }

                    if (!Array.isArray(ligas) || ligas.length === 0) {
                        ligasList.innerHTML = `
                            <div class="sidebar-ligas-empty" style="margin: 0 0 8px 0;">
                                <span class="material-icons" style="font-size: 20px; margin-bottom: 6px; display: block;">folder_open</span>
                                Nenhuma liga
                            </div>
                        `;
                        return;
                    }

                    // ✅ v3.0: Agrupar ligas por temporada (multi-temporada: mesma liga aparece em várias temporadas)
                    const ligasPorTemporada = {};
                    ligas.forEach(liga => {
                        // Usar temporadas_com_dados se disponível, senão apenas temporada atual
                        const temporadas = liga.temporadas_com_dados || [liga.temporada || 2025];
                        temporadas.forEach(temporada => {
                            if (!ligasPorTemporada[temporada]) {
                                ligasPorTemporada[temporada] = [];
                            }
                            // Clonar liga com contexto de temporada para identificar histórico
                            ligasPorTemporada[temporada].push({
                                ...liga,
                                _temporada_contexto: temporada,
                                _is_historico: temporada !== liga.temporada
                            });
                        });
                    });

                    // Ordenar temporadas (mais recente primeiro)
                    const temporadasOrdenadas = Object.keys(ligasPorTemporada)
                        .map(Number)
                        .sort((a, b) => b - a);

                    // Renderizar grupos de temporada
                    let html = '';
                    temporadasOrdenadas.forEach((temporada, idx) => {
                        const ligasTemp = ligasPorTemporada[temporada];
                        const todasAposentadas = ligasTemp.every(l => l.ativa === false || l.status === 'aposentada');
                        const isExpanded = idx === 0; // Apenas primeira temporada (mais recente) expandida

                        // Header do grupo de temporada
                        html += `
                            <div class="sidebar-temporada-group ${isExpanded ? 'open' : ''}" data-temporada="${temporada}">
                                <div class="sidebar-temporada-header" onclick="toggleTemporadaGroup(this)">
                                    <span class="temporada-label">
                                        <span class="material-icons" style="font-size: 14px;">${todasAposentadas ? 'history' : 'sports_soccer'}</span>
                                        ${temporada}
                                    </span>
                                    <span class="temporada-meta">
                                        ${todasAposentadas ? '<span class="temporada-badge archived">Arquivo</span>' : ''}
                                        <span class="material-icons temporada-arrow">expand_more</span>
                                    </span>
                                </div>
                                <div class="sidebar-temporada-content">
                        `;

                        // Ligas da temporada
                        ligasTemp.forEach(liga => {
                            const ligaId = liga._id || liga.id;
                            const isLigaAtual = ligaId === ligaAtualId;
                            // ✅ v4.0 FIX: Usar timesCountPerSeason para a temporada específica
                            const timesCount = liga.timesCountPerSeason?.[temporada] ?? liga.timesCount ?? liga.times?.length ?? 0;
                            const logoUrl = liga.logo || null;  // ✅ Dinâmico via banco
                            const isAposentada = liga.ativa === false || liga.status === 'aposentada';
                            // ✅ v3.0: Detectar se é visualização histórica (temporada diferente da atual)
                            const isHistorico = liga._is_historico === true;
                            const temporadaContexto = liga._temporada_contexto || liga.temporada;

                            const logoHtml = logoUrl
                                ? `<img src="${logoUrl}" alt="" class="liga-logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" /><span class="liga-dot" style="display:none;"></span>`
                                : `<span class="liga-dot ${isAposentada ? 'archived' : ''} ${isHistorico ? 'historico' : ''}"></span>`;

                            // ✅ v3.0: Adicionar ?temporada= na URL para contexto histórico
                            const urlParams = isHistorico ? `id=${ligaId}&temporada=${temporadaContexto}` : `id=${ligaId}`;

                            html += `
                                <a href="detalhe-liga.html?${urlParams}" class="sidebar-liga-item ${isLigaAtual ? 'active' : ''} ${isAposentada ? 'aposentada' : ''} ${isHistorico ? 'historico' : ''}" data-page="detalhe-liga.html">
                                    ${logoHtml}
                                    <div class="liga-info-sidebar">
                                        <div class="liga-name-sidebar">${liga.nome || "Liga sem nome"}</div>
                                        ${isHistorico ? '<span class="liga-status-tag historico">Histórico</span>' : ''}
                                        ${isAposentada && !isHistorico ? '<span class="liga-status-tag">Arquivo</span>' : ''}
                                    </div>
                                    <span class="liga-badge-count">${timesCount}</span>
                                </a>
                            `;
                        });

                        html += `
                                </div>
                            </div>
                        `;
                    });

                    ligasList.innerHTML = html;

                    // Se estamos em uma pagina de liga, expandir o accordion de ligas
                    if (ligaAtualId) {
                        const ligasAccordion = document.querySelector('[data-accordion="ligas"]');
                        if (ligasAccordion && window.AccordionManager) {
                            window.AccordionManager.open(ligasAccordion);
                        }
                        // Também expandir o grupo da temporada da liga atual
                        const ligaItem = ligasList.querySelector(`.sidebar-liga-item.active`);
                        if (ligaItem) {
                            const grupo = ligaItem.closest('.sidebar-temporada-group');
                            if (grupo) grupo.classList.add('open');
                        }
                    }
                } catch (error) {
                    ligasList.innerHTML = `
                        <div class="sidebar-ligas-empty" style="margin: 0 0 8px 0;">
                            <span class="material-icons" style="color: #ef4444; font-size: 20px; margin-bottom: 6px; display: block;">warning</span>
                            Erro ao carregar
                            <button onclick="carregarLigasLayout()" style="
                                margin-top: 6px;
                                padding: 4px 10px;
                                background: #FF5500;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                font-size: 10px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Tentar</button>
                        </div>
                    `;
                }

                // ✅ Marcar ligas como carregadas (para guard de idempotência)
                if (window.__layout_state) {
                    window.__layout_state.ligasCarregadas = true;
                    console.log('[LAYOUT] Ligas carregadas e marcadas no estado global');
                }
            }

            // ✅ v2.0: Toggle de grupo de temporada
            function toggleTemporadaGroup(header) {
                const grupo = header.closest('.sidebar-temporada-group');
                if (grupo) {
                    grupo.classList.toggle('open');
                }
            }

            // === SISTEMA DE NAVEGAÇÃO ===
            class NavigationSystem {
                constructor() {
                    this.init();
                    this.loadLigas();
                    this.setActiveNavigation();
                }

                init() {
                    // Inicializar accordions
                    if (window.AccordionManager) {
                        window.AccordionManager.init();
                    }
                    // Set page title baseado na URL
                    this.updatePageTitle();
                }

                async loadLigas() {
                    await carregarLigasLayout();
                }

                updatePageTitle() {
                    const pageTitle = document.getElementById("pageTitle");
                    const pageSubtitle = document.getElementById("pageSubtitle");

                    if (!pageTitle) return;

                    const currentPage = window.location.pathname.split("/").pop() || "painel.html";

                    const titles = {
                        "painel.html": { title: "Dashboard", subtitle: "Visao Geral do Sistema" },
                        "gerenciar.html": { title: "Gerenciar Ligas", subtitle: "Ferramentas Administrativas" },
                        "criar-liga.html": { title: "Nova Liga", subtitle: "Criar Nova Liga" },
                        "preencher-liga.html": { title: "Nova Liga", subtitle: "Criar Nova Liga" },
                        "buscar-times.html": { title: "Buscar Times", subtitle: "Adicionar Times do Cartola FC" },
                        "admin.html": { title: "Admin", subtitle: "Popular Rodadas" },
                        "ferramentas-rodadas.html": { title: "Rodadas", subtitle: "Popular e Gerenciar Rodadas" },
                        "detalhe-liga.html": { title: "Detalhes da Liga", subtitle: "Visualizacao Completa" },
                        "editar-liga.html": { title: "Editar Liga", subtitle: "Modificar Times da Liga" },
                        "fluxo-financeiro.html": { title: "Fluxo Financeiro", subtitle: "Selecione uma Liga" },
                        "auditoria-extratos.html": { title: "Auditoria", subtitle: "Verificar Integridade dos Extratos" },
                        "admin-gestao.html": { title: "Administradores", subtitle: "Gerenciar Usuarios Admin" },
                        "historico-acessos.html": { title: "Historico de Acessos", subtitle: "Monitorar Acessos ao App" },
                        "analisar-participantes.html": { title: "Analisar Participantes", subtitle: "Gestao Unificada de Participantes" },
                        "admin-orchestrator.html": { title: "Orchestrator", subtitle: "Round-Market Orchestrator" },
                    };

                    const pageInfo = titles[currentPage] || {
                        title: "Super Cartola Manager",
                        subtitle: "Sistema de Gerenciamento",
                    };

                    pageTitle.textContent = pageInfo.title;
                    if (pageSubtitle) {
                        pageSubtitle.textContent = pageInfo.subtitle;
                    }
                }

                setActiveNavigation() {
                    const currentPage = window.location.pathname.split("/").pop() || "painel.html";
                    const currentUrl = window.location.href;

                    // Limpar todos os estados ativos
                    document.querySelectorAll(".sidebar-menu-item, .sidebar-liga-item, .sidebar-accordion-item, .sidebar-accordion-action").forEach(link => {
                        link.classList.remove("active");
                    });

                    // Marcar item ativo baseado na pagina atual
                    document.querySelectorAll("[data-page]").forEach(link => {
                        const pageName = link.dataset.page;
                        if (pageName === currentPage) {
                            link.classList.add("active");
                        }
                    });

                    // Para paginas de detalhe de liga, verificar o ID
                    if (currentPage === "detalhe-liga.html") {
                        const urlParams = new URLSearchParams(window.location.search);
                        const ligaId = urlParams.get("id");
                        if (ligaId) {
                            document.querySelectorAll(".sidebar-liga-item").forEach(link => {
                                if (link.href && link.href.includes(`id=${ligaId}`)) {
                                    link.classList.add("active");
                                }
                            });
                        }
                    }
                }
            }

            // === NAVEGAÇÃO SPA (Sidebar Fixo) ===
            const SPANavigation = {
                enabled: true,
                transitioning: false,

                // Páginas que suportam SPA (mesmo layout)
                supportedPages: [
                    'painel.html',
                    'detalhe-liga.html',
                    'ferramentas-rodadas.html',
                    'criar-liga.html',
                    'editar-liga.html',
                    'gerenciar.html',
                    'gerenciar-modulos.html',
                    'preencher-liga.html',
                    'analisar-participantes.html',
                    'fluxo-financeiro.html',
                    'admin-gestao.html',
                    'historico-acessos.html',
                    'auditoria-extratos.html',
                    'api-football-analytics.html',
                    'dashboard-analytics.html',
                    'dashboard-saude.html',
                    'admin-orchestrator.html'
                ],

                init() {
                    // Interceptar cliques no sidebar
                    document.addEventListener('click', (e) => {
                        const link = e.target.closest('a[href]');
                        if (!link) return;

                        // Ignorar links externos ou com target
                        if (link.target === '_blank' || link.href.startsWith('http') && !link.href.includes(location.host)) {
                            return;
                        }

                        // Verificar se é página suportada
                        const href = link.getAttribute('href');
                        const pageName = href?.split('?')[0]?.split('/').pop();

                        if (!this.supportedPages.includes(pageName)) {
                            return; // Navegação normal
                        }

                        // Verificar se está no sidebar
                        if (!link.closest('#appSidebar') && !link.closest('.sidebar')) {
                            return; // Só SPA para sidebar
                        }

                        e.preventDefault();
                        this.navigate(href);
                    });

                    // Suporte a botão voltar
                    window.addEventListener('popstate', (e) => {
                        if (e.state?.spa) {
                            this.navigate(location.href, false);
                        }
                    });

                    console.log('[SPA] Navegação SPA inicializada');
                },

                async navigate(url, pushState = true) {
                    if (this.transitioning) return;
                    this.transitioning = true;

                    const mainContent = document.querySelector('main') || document.querySelector('.main-content');
                    if (!mainContent) {
                        this.transitioning = false;
                        window.location.href = url;
                        return;
                    }

                    try {
                        // Fade out sutil
                        mainContent.style.opacity = '0.5';
                        mainContent.style.transition = 'opacity 0.15s ease';

                        // Fetch da nova página
                        const response = await fetch(url);
                        if (!response.ok) throw new Error('Fetch failed');

                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        // Extrair novo conteúdo
                        const newMain = doc.querySelector('main') || doc.querySelector('.main-content');
                        if (!newMain) throw new Error('No main content');

                        // ✅ Sincronizar CSS da nova página (evita layout quebrado ao navegar via SPA)
                        const newStyles = Array.from(doc.querySelectorAll('link[rel="stylesheet"]'));
                        newStyles.forEach((link) => {
                            const href = link.getAttribute('href');
                            if (!href) return;
                            if (!document.querySelector(`link[rel="stylesheet"][href="${href}"]`)) {
                                const newLink = document.createElement('link');
                                newLink.rel = 'stylesheet';
                                newLink.href = href;
                                document.head.appendChild(newLink);
                            }
                        });

                        // ✅ Sincronizar estilos inline do head (evita estilos críticos faltando no SPA)
                        const hashString = (str) => {
                            let hash = 0;
                            for (let i = 0; i < str.length; i++) {
                                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                                hash |= 0; // 32-bit
                            }
                            return Math.abs(hash);
                        };
                        const newInlineStyles = Array.from(doc.querySelectorAll('head style'));
                        newInlineStyles.forEach((styleEl) => {
                            const cssText = styleEl.textContent || '';
                            if (!cssText.trim()) return;
                            const hash = `spa-inline-style-${hashString(cssText)}`;
                            // Evitar duplicar o mesmo bloco de CSS
                            if (document.querySelector(`style[data-spa-inline="${hash}"]`)) return;
                            const newStyle = document.createElement('style');
                            newStyle.setAttribute('data-spa-inline', hash);
                            newStyle.textContent = cssText;
                            document.head.appendChild(newStyle);
                        });

                        // Extrair scripts inline da nova página (exceto o script de infraestrutura do layout.html)
                        const newScripts = Array.from(doc.querySelectorAll('script:not([src])')).filter(s => {
                            const text = s.textContent || '';
                            // Filtrar APENAS o script do layout.html (contém marcadores únicos de infraestrutura)
                            const isLayoutInfraScript = text.includes('__layout_state') || text.includes('SPANavigation');
                            return !isLayoutInfraScript;
                        });

                        // Extrair scripts externos específicos da página
                        const pageScripts = Array.from(doc.querySelectorAll('script[src]')).filter(s => {
                            const src = s.getAttribute('src') || '';
                            // Ignorar scripts do layout
                            return !src.includes('sidebar') && !src.includes('layout');
                        });

                        // Executar cleanups de página antes de trocar conteúdo
                        if (window.__adminShell) {
                            window.__adminShell.runCleanups();
                        }

                        // Substituir conteúdo + sincronizar classes do main
                        mainContent.innerHTML = newMain.innerHTML;
                        if (newMain.className && mainContent.className !== newMain.className) {
                            mainContent.className = newMain.className;
                        }

                        // Atualizar título
                        const newTitle = doc.querySelector('title')?.textContent;
                        if (newTitle) document.title = newTitle;

                        // Atualizar URL
                        if (pushState) {
                            history.pushState({ spa: true }, '', url);
                        }

                        // Fade in
                        requestAnimationFrame(() => {
                            mainContent.style.opacity = '1';
                        });

                        // Executar scripts da nova página
                        this.executeScripts(pageScripts, newScripts);

                        // Atualizar navegação ativa
                        if (window.navigationSystem) {
                            window.navigationSystem.setActiveNavigation();
                            window.navigationSystem.updatePageTitle();
                        }

                        // ✅ FIX: Limpar guards de página antes de reinicializar
                        const pageName = url?.split('?')[0]?.split('/').pop();

                        // Resetar guards de páginas específicas para permitir re-inicialização
                        if (window.__gerenciar_setup_done) {
                            window.__gerenciar_setup_done = false;
                        }
                        if (window.__gerenciar_state) {
                            window.__gerenciar_state.initRunning = false;
                            window.__gerenciar_state.initialized = false;
                            window.__gerenciar_state.lastInitTimestamp = 0;
                        }

                        setTimeout(() => {
                            window.dispatchEvent(new CustomEvent('spa:navigated', {
                                detail: { url, pageName }
                            }));
                        }, 100);

                        console.log('[SPA] Navegação concluída:', url);

                    } catch (error) {
                        console.warn('[SPA] Fallback para navegação normal:', error);
                        window.location.href = url;
                    } finally {
                        this.transitioning = false;
                    }
                },

                executeScripts(externalScripts, inlineScripts) {
                    // ✅ FIX: Remover scripts de módulos SPA da navegação anterior (previne acúmulo)
                    document.querySelectorAll('script[data-spa-injected="true"][type="module"]').forEach(s => s.remove());

                    // Carregar scripts externos
                    const loadScript = (scriptEl) => {
                        const src = scriptEl.getAttribute('src');
                        const isModule = scriptEl.getAttribute('type') === 'module';

                        return new Promise((resolve) => {
                            // Verificar se já carregado (inclusive módulos) para evitar dupla inicialização
                            if (document.querySelector(`script[src="${src}"]`)) {
                                resolve();
                                return;
                            }
                            const script = document.createElement('script');
                            script.src = src;
                            // ✅ FIX: Preservar type="module" para módulos ES
                            if (isModule) {
                                script.type = 'module';
                            }
                            script.onload = resolve;
                            script.onerror = resolve;
                            document.body.appendChild(script);
                        });
                    };

                    // Carregar externos primeiro (preservando type)
                    Promise.all(externalScripts.map(s => loadScript(s))).then(() => {
                        // Executar inline scripts
                        inlineScripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            const isModule = oldScript.getAttribute('type') === 'module';

                            // ✅ FIX: Preservar type="module" para inline modules
                            if (isModule) {
                                newScript.type = 'module';
                            }
                            // ✅ FIX: Marcar scripts SPA para cleanup na próxima navegação
                            newScript.setAttribute('data-spa-injected', 'true');
                            newScript.textContent = oldScript.textContent;
                            document.body.appendChild(newScript);

                            // ✅ FIX: Módulos ES6 são async e precisam de mais tempo
                            // Scripts normais podem ser removidos em 100ms
                            // Módulos com import precisam de mais tempo para resolver dependências
                            if (!isModule) {
                                setTimeout(() => newScript.remove(), 100);
                            }
                            // Módulos permanecem no DOM para manter contexto dos imports
                        });
                    });
                }
            };

            // Inicializar SPA após DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => SPANavigation.init());
            } else {
                SPANavigation.init();
            }

            // Expor globalmente
            window.SPANavigation = SPANavigation;

            // === FUNÇÕES GLOBAIS ===
            function goToDashboard() {
                if (SPANavigation.enabled) {
                    SPANavigation.navigate('painel.html');
                } else {
                    window.location.href = "painel.html";
                }
            }

            // === FUNÇÕES DO SIDEBAR - ATALHOS (Fase 1) ===
            // Estas funções são chamadas pelos itens do menu OPERAÇÕES

            function _injetarModalConsolidar() {
                // Injetar HTML do modal
                const modalHtml = `
                <div id="consolidarRodadaModal" class="modal-consolidar" style="display: none;">
                    <div class="modal-consolidar-overlay" onclick="fecharModalConsolidar()"></div>
                    <div class="modal-consolidar-container">
                        <div class="modal-consolidar-header">
                            <div class="modal-consolidar-title-group">
                                <span class="material-icons modal-consolidar-icon">sync</span>
                                <h2>Consolidar Rodada</h2>
                            </div>
                            <button class="modal-consolidar-close" onclick="fecharModalConsolidar()">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        <div class="modal-consolidar-body">
                            <div class="modal-consolidar-info">
                                <span class="material-icons" style="color: #3b82f6;">info</span>
                                <p>Selecione as rodadas que deseja consolidar. Rodadas já consolidadas serão reprocessadas.</p>
                            </div>
                            <div id="consolidarLoading" class="modal-consolidar-loading">
                                <div class="loading-spinner-consolidar"></div>
                                <p>Carregando informações...</p>
                            </div>
                            <div id="consolidarContent" style="display: none;">
                                <div class="modal-consolidar-status">
                                    <div class="status-item">
                                        <span class="status-label">Mercado:</span>
                                        <span id="statusMercado" class="status-value">-</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Rodada Atual:</span>
                                        <span id="rodadaAtual" class="status-value">-</span>
                                    </div>
                                </div>
                                <div class="modal-consolidar-rodadas" id="listaRodadas"></div>
                            </div>
                        </div>
                        <div class="modal-consolidar-footer">
                            <button class="btn-modal-secondary-consolidar" onclick="fecharModalConsolidar()">
                                <span class="material-icons">close</span>
                                Cancelar
                            </button>
                            <button id="btnConsolidarSelecionadas" class="btn-modal-primary-consolidar" onclick="consolidarRodadasSelecionadas()" disabled>
                                <span class="material-icons">sync</span>
                                Consolidar Selecionadas
                            </button>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Injetar estilos se ainda não existem
                if (!document.querySelector('style[data-consolidar-modal]')) {
                    const css = document.createElement('style');
                    css.setAttribute('data-consolidar-modal', 'true');
                    css.textContent = `
                        .modal-consolidar { position:fixed; top:0; left:0; right:0; bottom:0; z-index:10000; display:flex; align-items:center; justify-content:center; }
                        .modal-consolidar-overlay { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); }
                        .modal-consolidar-container { position:relative; background:var(--bg-card,#1a1a1a); border:1px solid var(--border-color,#2d2d2d); border-radius:12px; width:90%; max-width:700px; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.5); animation:modalSlideIn 0.3s ease-out; }
                        @keyframes modalSlideIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
                        .modal-consolidar-header { display:flex; align-items:center; justify-content:space-between; padding:20px 24px; border-bottom:1px solid var(--border-color,#2d2d2d); }
                        .modal-consolidar-title-group { display:flex; align-items:center; gap:12px; }
                        .modal-consolidar-icon { width:40px; height:40px; background:linear-gradient(135deg,#FF5500,#ff6b1a); border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; }
                        .modal-consolidar-title-group h2 { font-family:'Russo One',sans-serif; font-size:1.3rem; color:var(--text-white,#fff); margin:0; }
                        .modal-consolidar-close { width:36px; height:36px; background:transparent; border:1px solid var(--border-color,#2d2d2d); border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease; color:var(--text-muted,#9ca3af); }
                        .modal-consolidar-close:hover { background:var(--bg-secondary,#252525); border-color:var(--laranja,#FF5500); color:var(--laranja,#FF5500); }
                        .modal-consolidar-body { flex:1; overflow-y:auto; padding:20px 24px; }
                        .modal-consolidar-info { display:flex; align-items:flex-start; gap:12px; padding:14px 16px; background:rgba(59,130,246,0.05); border:1px solid rgba(59,130,246,0.15); border-radius:8px; margin-bottom:20px; }
                        .modal-consolidar-info p { margin:0; font-size:0.85rem; line-height:1.5; color:var(--text-muted,#9ca3af); }
                        .modal-consolidar-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; gap:16px; }
                        .loading-spinner-consolidar { width:40px; height:40px; border:4px solid var(--border-color,#2d2d2d); border-top-color:var(--laranja,#FF5500); border-radius:50%; animation:spin 0.8s linear infinite; }
                        .modal-consolidar-loading p { font-size:0.9rem; color:var(--text-muted,#9ca3af); margin:0; }
                        .modal-consolidar-status { display:flex; gap:20px; padding:16px; background:var(--bg-secondary,#252525); border-radius:8px; margin-bottom:20px; }
                        .status-item { display:flex; flex-direction:column; gap:4px; }
                        .status-label { font-size:0.75rem; color:var(--text-dim,#6b7280); text-transform:uppercase; font-weight:600; }
                        .status-value { font-size:0.95rem; color:var(--text-white,#fff); font-weight:600; }
                        .modal-consolidar-rodadas { display:flex; flex-direction:column; gap:10px; }
                        .rodada-item { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:var(--bg-secondary,#252525); border:1px solid var(--border-color,#2d2d2d); border-radius:8px; transition:all 0.2s ease; cursor:pointer; }
                        .rodada-item:hover { border-color:var(--laranja,#FF5500); background:var(--bg-elevated,#2a2a2a); }
                        .rodada-item.consolidada { border-color:#10b981; }
                        .rodada-item-info { display:flex; align-items:center; gap:12px; }
                        .rodada-item-numero { width:40px; height:40px; background:var(--bg-darker,#0d0d0d); border:1px solid var(--border-color,#2d2d2d); border-radius:8px; display:flex; align-items:center; justify-content:center; font-family:'Russo One',sans-serif; font-size:1rem; color:var(--text-white,#fff); }
                        .rodada-item.consolidada .rodada-item-numero { background:rgba(16,185,129,0.1); border-color:#10b981; color:#10b981; }
                        .rodada-item-detalhes h4 { font-size:0.9rem; font-weight:600; color:var(--text-white,#fff); margin:0 0 4px 0; }
                        .rodada-item-detalhes p { font-size:0.75rem; color:var(--text-muted,#9ca3af); margin:0; }
                        .rodada-item-checkbox { display:flex; align-items:center; }
                        .rodada-item-checkbox input[type="checkbox"] { width:20px; height:20px; accent-color:var(--laranja,#FF5500); cursor:pointer; }
                        .modal-consolidar-footer { display:flex; align-items:center; justify-content:flex-end; gap:12px; padding:16px 24px; border-top:1px solid var(--border-color,#2d2d2d); }
                        .btn-modal-secondary-consolidar, .btn-modal-primary-consolidar { padding:10px 20px; border:none; border-radius:8px; font-size:0.9rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; gap:8px; }
                        .btn-modal-secondary-consolidar { background:var(--bg-secondary,#252525); color:var(--text-muted,#9ca3af); border:1px solid var(--border-color,#2d2d2d); }
                        .btn-modal-secondary-consolidar:hover { background:var(--bg-elevated,#2a2a2a); border-color:var(--border-subtle,#333); }
                        .btn-modal-primary-consolidar { background:linear-gradient(135deg,#FF5500 0%,#ff6b1a 100%); color:white; }
                        .btn-modal-primary-consolidar:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 4px 12px rgba(255,85,0,0.3); }
                        .btn-modal-primary-consolidar:disabled { opacity:0.5; cursor:not-allowed; }
                    `;
                    document.head.appendChild(css);
                }
            }

            window.abrirConsolidarRodadaSidebar = async function(event) {
                event.preventDefault();
                event.stopPropagation();

                // Garantir que o modal existe no DOM (pode não existir quando carregado via loadLayout)
                if (!document.getElementById('consolidarRodadaModal')) {
                    _injetarModalConsolidar();
                }

                // Abrir modal de consolidação
                const modal = document.getElementById('consolidarRodadaModal');
                const loading = document.getElementById('consolidarLoading');
                const content = document.getElementById('consolidarContent');

                modal.style.display = 'flex';
                loading.style.display = 'flex';
                content.style.display = 'none';

                try {
                    // Carregar status do mercado
                    const statusRes = await fetch('/api/cartola/mercado/status');
                    const mercado = await statusRes.json();

                    // Atualizar status
                    document.getElementById('statusMercado').textContent =
                        mercado.status_mercado === 1 ? 'Aberto' :
                        mercado.status_mercado === 2 ? 'Fechado' : 'Encerrado';
                    document.getElementById('rodadaAtual').textContent = mercado.rodada_atual || '-';

                    // Buscar rodadas disponíveis (1 até rodada atual)
                    const rodadaAtual = mercado.rodada_atual || 1;
                    const listaRodadas = document.getElementById('listaRodadas');
                    listaRodadas.innerHTML = '';

                    // Buscar informações de consolidação
                    const consolidacaoRes = await fetch('/api/admin/rodadas/consolidadas');
                    const rodadasConsolidadas = consolidacaoRes.ok ? await consolidacaoRes.json() : [];
                    const setConsolidadas = new Set(rodadasConsolidadas.map(r => r.rodada));

                    // Gerar lista de rodadas (do atual até 1, ordem reversa)
                    for (let r = rodadaAtual; r >= 1; r--) {
                        const consolidada = setConsolidadas.has(r);
                        const rodadaEl = document.createElement('div');
                        rodadaEl.className = `rodada-item ${consolidada ? 'consolidada' : ''}`;
                        rodadaEl.innerHTML = `
                            <div class="rodada-item-info">
                                <div class="rodada-item-numero">${r}</div>
                                <div class="rodada-item-detalhes">
                                    <h4>Rodada ${r}</h4>
                                    <p>${consolidada ? '✓ Já consolidada' : 'Pendente de consolidação'}</p>
                                </div>
                            </div>
                            <div class="rodada-item-checkbox">
                                <input type="checkbox" class="rodada-checkbox" data-rodada="${r}" ${r === rodadaAtual ? 'checked' : ''}>
                            </div>
                        `;

                        // Click no item seleciona/desseleciona
                        rodadaEl.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                const checkbox = rodadaEl.querySelector('input[type="checkbox"]');
                                checkbox.checked = !checkbox.checked;
                                atualizarBotaoConsolidar();
                            }
                        });

                        // Change no checkbox
                        rodadaEl.querySelector('input[type="checkbox"]').addEventListener('change', atualizarBotaoConsolidar);

                        listaRodadas.appendChild(rodadaEl);
                    }

                    atualizarBotaoConsolidar();

                    loading.style.display = 'none';
                    content.style.display = 'block';
                } catch (error) {
                    console.error('[CONSOLIDAR] Erro ao carregar:', error);
                    loading.innerHTML = `
                        <span class="material-icons" style="color: #ef4444; font-size: 40px;">error</span>
                        <p style="color: #ef4444;">Erro ao carregar informações</p>
                        <p style="font-size: 0.8rem;">${error.message}</p>
                    `;
                }
            };

            function atualizarBotaoConsolidar() {
                const checkboxes = document.querySelectorAll('.rodada-checkbox:checked');
                const btn = document.getElementById('btnConsolidarSelecionadas');
                btn.disabled = checkboxes.length === 0;
                btn.innerHTML = `
                    <span class="material-icons">sync</span>
                    Consolidar ${checkboxes.length > 0 ? `(${checkboxes.length})` : 'Selecionadas'}
                `;
            }

            window.fecharModalConsolidar = function() {
                const modal = document.getElementById('consolidarRodadaModal');
                if (modal) modal.style.display = 'none';
            };

            window.consolidarRodadasSelecionadas = async function() {
                const checkboxes = document.querySelectorAll('.rodada-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('Selecione pelo menos uma rodada');
                    return;
                }

                const rodadas = Array.from(checkboxes).map(cb => parseInt(cb.dataset.rodada));
                const btn = document.getElementById('btnConsolidarSelecionadas');

                if (!confirm(`Confirma consolidação de ${rodadas.length} rodada(s)?\n\nRodadas: ${rodadas.join(', ')}\n\nEssa operação pode levar alguns minutos.`)) {
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = `
                    <div class="loading-spinner-consolidar" style="width: 20px; height: 20px; border-width: 2px;"></div>
                    Consolidando...
                `;

                try {
                    // Consolidar rodadas uma por uma
                    for (const rodada of rodadas) {
                        const response = await fetch('/api/admin/consolidar-rodada', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ rodada })
                        });

                        if (!response.ok) {
                            const error = await response.text();
                            throw new Error(`Erro na rodada ${rodada}: ${error}`);
                        }
                    }

                    alert(`✓ ${rodadas.length} rodada(s) consolidada(s) com sucesso!`);
                    fecharModalConsolidar();
                } catch (error) {
                    console.error('[CONSOLIDAR] Erro:', error);
                    alert('Erro ao consolidar rodadas: ' + error.message);
                    btn.disabled = false;
                    atualizarBotaoConsolidar();
                }
            };

            window.abrirModoManutencaoSidebar = function(event) {
                event.preventDefault();
                event.stopPropagation();

                // Navegar para página de Modo Manutenção
                if (SPANavigation.enabled) {
                    SPANavigation.navigate('modo-manutencao.html');
                } else {
                    window.location.href = 'modo-manutencao.html';
                }
            };

            window.abrirAdicionarParticipanteSidebar = function(event) {
                event.preventDefault();
                event.stopPropagation();

                // Redirecionar para página de gestão de liga
                alert('Para adicionar participantes:\n\n1. Acesse LIGAS → Gerenciar Ligas\n2. Selecione a liga desejada\n3. Clique em "Participantes" na aba\n4. Use o botão "Adicionar Participante"');
            };

            // === TOGGLE SIDEBAR (DESKTOP) ===
            function toggleSidebar() {
                const sidebar = document.getElementById('appSidebar');
                const toggleBtn = document.getElementById('sidebarToggleBtn');
                const body = document.body;

                if (!sidebar) return;

                const isCollapsed = sidebar.classList.toggle('sidebar-collapsed');
                body.classList.toggle('sidebar-collapsed', isCollapsed);

                // Atualizar ícone do botão
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('.material-icons');
                    if (icon) {
                        icon.textContent = isCollapsed ? 'chevron_right' : 'chevron_left';
                    }
                }

                // Salvar estado
                localStorage.setItem('sidebar_collapsed', isCollapsed ? 'true' : 'false');
            }

            // Restaurar estado do sidebar ao carregar
            function restoreSidebarState() {
                const isCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
                if (isCollapsed) {
                    const sidebar = document.getElementById('appSidebar');
                    const toggleBtn = document.getElementById('sidebarToggleBtn');
                    const body = document.body;

                    if (sidebar) {
                        sidebar.classList.add('sidebar-collapsed');
                        body.classList.add('sidebar-collapsed');
                        if (toggleBtn) {
                            const icon = toggleBtn.querySelector('.material-icons');
                            if (icon) icon.textContent = 'chevron_right';
                        }
                    }
                }
            }

            // === MENU DROPUP DO PERFIL - INICIALIZAÇÃO ===
            function inicializarMenuPerfil() {
                const userSection = document.getElementById('sidebarUserSection');
                const userToggle = document.getElementById('userMenuToggle');
                const menuItems = document.querySelectorAll('#userDropupMenu .sidebar-user-menu-item');

                if (!userSection || !userToggle) return;

                // Guard contra dupla inicialização
                if (userToggle.dataset.initialized) return;
                userToggle.dataset.initialized = 'true';

                // Toggle do menu
                userToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userSection.classList.toggle('menu-open');
                });

                // Ações do menu
                menuItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const action = this.getAttribute('data-action');

                        switch(action) {
                            case 'perfil':
                                abrirPerfilAdmin();
                                break;
                            case 'administradores':
                                window.location.href = 'admin-gestao.html';
                                break;
                            case 'app-participante':
                                window.open('participante/index.html', '_blank');
                                break;
                            case 'app-admin':
                                window.open('admin-mobile/', '_blank');
                                break;
                            case 'logout':
                                fazerLogoutAdmin();
                                break;
                        }

                        userSection.classList.remove('menu-open');
                    });
                });

                // Fechar ao clicar fora
                document.addEventListener('click', function(e) {
                    if (userSection && !userSection.contains(e.target)) {
                        userSection.classList.remove('menu-open');
                    }
                });

                // Fechar com ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        userSection.classList.remove('menu-open');
                    }
                });
            }

            function abrirPerfilAdmin() {
                fetch('/api/admin/auth/session', { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => {
                        const nome = data.user?.name || data.user?.username || 'Admin';
                        const email = data.user?.email || 'Nao informado';
                        const provider = data.user?.provider || 'replit';
                        const isSuperAdmin = data.user?.superAdmin || false;

                        mostrarModalPerfil({
                            nome: nome,
                            email: email,
                            provider: provider,
                            isSuperAdmin: isSuperAdmin,
                            ultimoAcesso: new Date().toLocaleString('pt-BR')
                        });
                    })
                    .catch(() => {
                        mostrarModalPerfil({
                            nome: 'Admin',
                            email: 'Nao informado',
                            provider: 'local',
                            isSuperAdmin: false,
                            ultimoAcesso: new Date().toLocaleString('pt-BR')
                        });
                    });
            }

            function mostrarModalPerfil(dados) {
                // Remover modal anterior se existir
                const modalAnterior = document.getElementById('modalPerfilAdmin');
                if (modalAnterior) modalAnterior.remove();

                const roleText = dados.isSuperAdmin ? 'Super Administrador' : 'Administrador';
                const roleClass = dados.isSuperAdmin ? 'super-admin' : 'admin';
                const providerIcon = dados.provider === 'replit' ? 'cloud' : 'person';

                const modalHtml = `
                    <div id="modalPerfilAdmin" class="modal-perfil-overlay" onclick="fecharModalPerfil(event)">
                        <div class="modal-perfil-content" onclick="event.stopPropagation()">
                            <button class="modal-perfil-close" onclick="fecharModalPerfil()">
                                <span class="material-icons">close</span>
                            </button>

                            <div class="modal-perfil-header">
                                <div class="modal-perfil-avatar">
                                    <span class="material-icons">admin_panel_settings</span>
                                </div>
                                <h2>${dados.nome}</h2>
                                <span class="modal-perfil-badge ${roleClass}">
                                    <span class="material-icons">verified</span>
                                    ${roleText}
                                </span>
                            </div>

                            <div class="modal-perfil-info">
                                <div class="modal-perfil-item">
                                    <span class="material-icons">email</span>
                                    <div>
                                        <label>Email</label>
                                        <span>${dados.email}</span>
                                    </div>
                                </div>
                                <div class="modal-perfil-item">
                                    <span class="material-icons">${providerIcon}</span>
                                    <div>
                                        <label>Autenticacao</label>
                                        <span>${dados.provider === 'replit' ? 'Replit Auth (SSO)' : 'Local'}</span>
                                    </div>
                                </div>
                                <div class="modal-perfil-item">
                                    <span class="material-icons">schedule</span>
                                    <div>
                                        <label>Sessao Atual</label>
                                        <span>${dados.ultimoAcesso}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-perfil-footer">
                                <button class="btn-modal-secondary" onclick="fecharModalPerfil()">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Animar entrada
                requestAnimationFrame(() => {
                    document.getElementById('modalPerfilAdmin').classList.add('active');
                });
            }

            function fecharModalPerfil(event) {
                if (event && event.target !== event.currentTarget) return;
                const modal = document.getElementById('modalPerfilAdmin');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 200);
                }
            }

            // Expor funções globalmente
            window.abrirPerfilAdmin = abrirPerfilAdmin;
            window.fecharModalPerfil = fecharModalPerfil;
            window.mostrarModalPerfil = mostrarModalPerfil;

            function fazerLogoutAdmin() {
                if (confirm('Deseja realmente sair do sistema?')) {
                    fetch('/api/admin/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    })
                    .then(() => {
                        CacheManager.clear(); // Limpar cache ao sair
                        localStorage.removeItem('adminLogado');
                        localStorage.removeItem('ligaIdSelecionada');
                        window.location.href = '/';
                    })
                    .catch(() => {
                        CacheManager.clear(); // Limpar cache ao sair
                        localStorage.removeItem('adminLogado');
                        window.location.href = '/';
                    });
                }
            }

            // === CARREGAR DADOS DO ADMIN - COM CACHE ===
            async function carregarDadosAdmin() {
                console.log('[LAYOUT] carregarDadosAdmin() chamado');
                try {
                    // Tentar cache de sessão primeiro
                    let sessionData = CacheManager.get(CacheManager.KEYS.SESSION);

                    if (sessionData) {
                        console.log('[LAYOUT] Session (cache hit)');
                    } else {
                        console.log('[LAYOUT] Carregando sessão da API...');
                        const response = await fetch('/api/admin/auth/session', { credentials: 'include' });
                        if (response.ok) {
                            sessionData = await response.json();
                            CacheManager.set(CacheManager.KEYS.SESSION, sessionData, CacheManager.TTL.SESSION);
                        }
                    }

                    if (sessionData) {
                        // API retorna data.admin, não data.user
                        const admin = sessionData.admin || sessionData.user;
                        if (admin) {
                            const userName = document.getElementById('userName');
                            if (userName) {
                                // Usar primeiro nome se disponivel
                                const nome = admin.nome || admin.name || admin.email?.split('@')[0] || 'Admin';
                                const primeiroNome = nome.split(' ')[0];
                                userName.textContent = primeiroNome;
                                console.log('[LAYOUT] Nome do admin definido:', primeiroNome);
                            }
                        }
                    }

                    // Verificar Super Admin (também usa cache)
                    let superData = CacheManager.get(CacheManager.KEYS.SUPER_ADMIN);

                    if (superData) {
                        console.log('[LAYOUT] Super Admin (cache hit)');
                    } else {
                        console.log('[LAYOUT] Chamando check-super...');
                        const superResponse = await fetch('/api/admin/gestao/check-super', { credentials: 'include' });
                        if (superResponse.ok) {
                            superData = await superResponse.json();
                            CacheManager.set(CacheManager.KEYS.SUPER_ADMIN, superData, CacheManager.TTL.SUPER_ADMIN);
                        }
                    }

                    if (superData) {
                        const menuAdmin = document.getElementById('menuAdministradores');
                        if (menuAdmin) {
                            menuAdmin.style.cssText = superData.isSuperAdmin
                                ? 'display: flex !important;'
                                : 'display: none !important;';
                            console.log('[LAYOUT] Menu Administradores:', superData.isSuperAdmin ? 'VISÍVEL' : 'OCULTO');
                        }
                        // Mostrar/ocultar accordion de Administração no sidebar
                        const accordionAdmin = document.getElementById('accordionAdmin');
                        if (accordionAdmin) {
                            accordionAdmin.style.cssText = superData.isSuperAdmin
                                ? 'display: block !important;'
                                : 'display: none !important;';
                        }
                    }
                } catch (error) {
                    // Silencioso - manter "Admin" como fallback
                    console.warn('[LAYOUT] Erro ao carregar dados admin:', error);
                }
            }

            // === INICIALIZAÇÃO ===
            function inicializarLayout() {
                console.log('[LAYOUT] Inicializando layout...');
                restoreSidebarState(); // Restaurar estado do sidebar
                window.navigationSystem = new NavigationSystem();
                carregarDadosAdmin();
                inicializarMenuPerfil();
                console.log('[LAYOUT] Layout inicializado');
            }

            // Flag para evitar inicialização duplicada
            let layoutInicializado = window._layoutInicializado || false;

            // Inicialização - verificar se sidebar já existe no DOM
            function tentarInicializarLayout() {
                if (layoutInicializado || window._layoutInicializado) {
                    console.log('[LAYOUT] Já inicializado, ignorando...');
                    return;
                }

                const sidebar = document.getElementById('appSidebar');
                if (sidebar) {
                    console.log('[LAYOUT] Sidebar encontrado, inicializando...');
                    layoutInicializado = true;
                    window._layoutInicializado = true;
                    inicializarLayout();
                } else {
                    console.log('[LAYOUT] Sidebar não encontrado, aguardando...');
                    setTimeout(tentarInicializarLayout, 100);
                }
            }

            // Expor função globalmente ANTES de qualquer inicialização
            window.carregarDadosAdmin = carregarDadosAdmin;
            window.carregarLigasLayout = carregarLigasLayout;
            window.inicializarLayout = inicializarLayout;
            window.tentarInicializarLayout = tentarInicializarLayout;

            // Função para forçar refresh (após criar/editar liga)
            window.refreshLigasSidebar = function() {
                CacheManager.invalidate(CacheManager.KEYS.LIGAS);
                carregarLigasLayout(true);
            };

            // Inicialização automática - sempre executar após pequeno delay
            // para garantir que o DOM foi atualizado
            console.log('[LAYOUT] Agendando inicialização... readyState:', document.readyState);
            setTimeout(tentarInicializarLayout, 200);

            // Recarregar ao voltar para página
            window.addEventListener("pageshow", (event) => {
                if (event.persisted) {
                    setTimeout(carregarLigasLayout, 200);
                }
            });

            // ✅ v9.4 Safety net: se ligasList ainda mostra loading após 4s, forçar reload
            setTimeout(() => {
                const ligasList = document.getElementById("ligasList");
                if (ligasList && ligasList.querySelector('.sidebar-ligas-loading')) {
                    console.warn('[LAYOUT] Safety net: sidebar ainda em loading, forçando carregamento...');
                    if (typeof window.carregarLigasLayout === 'function') {
                        window.carregarLigasLayout(true);
                    }
                }
            }, 4000);
            } else {
                // ✅ v9.4 FIX: Scripts já carregados - RECARREGAR LIGAS diretamente
                // IMPORTANTE: usar window.carregarLigasLayout (referência global explícita)
                // para evitar shadowing por hoisting de function declaration no bloco if
                console.log('[LAYOUT] Scripts já carregados, recarregando ligas...');
                setTimeout(() => {
                    // Recarregar ligas no sidebar (função global definida na 1a execução)
                    if (typeof window.carregarLigasLayout === 'function') {
                        window.carregarLigasLayout();
                    } else {
                        console.warn('[LAYOUT] carregarLigasLayout não disponível globalmente!');
                    }
                    // Atualizar navegação ativa
                    if (window.navigationSystem) {
                        window.navigationSystem.setActiveNavigation();
                    }
                }, 200);
            } // ✅ Fecha o if de proteção contra redeclaração (linha 119)
        </script>

        <!-- PROTECAO CLIENT-SIDE -->
        <script>
            (function () {
                "use strict";
                var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (!isMobile) {
                    document.addEventListener("keydown", function (e) {
                        if (e.key === "F12" || e.keyCode === 123) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "i" || e.keyCode === 73)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && e.shiftKey && (e.key === "J" || e.key === "j" || e.keyCode === 74)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && e.shiftKey && (e.key === "C" || e.key === "c" || e.keyCode === 67)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && (e.key === "U" || e.key === "u" || e.keyCode === 85)) {
                            e.preventDefault();
                            return false;
                        }
                        if (e.ctrlKey && (e.key === "S" || e.key === "s" || e.keyCode === 83)) {
                            e.preventDefault();
                            return false;
                        }
                    });
                    document.addEventListener("contextmenu", function (e) {
                        e.preventDefault();
                        return false;
                    });
                }
                if (window.self !== window.top) {
                    window.top.location = window.self.location;
                }
            })();
        </script>

        <!-- External JS Dependencies (SPA Navigation) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Modal Consolidar Rodada -->
    <div id="consolidarRodadaModal" class="modal-consolidar" style="display: none;">
        <div class="modal-consolidar-overlay" onclick="fecharModalConsolidar()"></div>
        <div class="modal-consolidar-container">
            <div class="modal-consolidar-header">
                <div class="modal-consolidar-title-group">
                    <span class="material-icons modal-consolidar-icon">sync</span>
                    <h2>Consolidar Rodada</h2>
                </div>
                <button class="modal-consolidar-close" onclick="fecharModalConsolidar()">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <div class="modal-consolidar-body">
                <div class="modal-consolidar-info">
                    <span class="material-icons" style="color: #3b82f6;">info</span>
                    <p>Selecione as rodadas que deseja consolidar. Rodadas já consolidadas serão reprocessadas.</p>
                </div>

                <div id="consolidarLoading" class="modal-consolidar-loading">
                    <div class="loading-spinner-consolidar"></div>
                    <p>Carregando informações...</p>
                </div>

                <div id="consolidarContent" style="display: none;">
                    <div class="modal-consolidar-status">
                        <div class="status-item">
                            <span class="status-label">Mercado:</span>
                            <span id="statusMercado" class="status-value">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Rodada Atual:</span>
                            <span id="rodadaAtual" class="status-value">-</span>
                        </div>
                    </div>

                    <div class="modal-consolidar-rodadas" id="listaRodadas">
                        <!-- Rodadas serão inseridas aqui -->
                    </div>
                </div>
            </div>

            <div class="modal-consolidar-footer">
                <button class="btn-modal-secondary-consolidar" onclick="fecharModalConsolidar()">
                    <span class="material-icons">close</span>
                    Cancelar
                </button>
                <button id="btnConsolidarSelecionadas" class="btn-modal-primary-consolidar" onclick="consolidarRodadasSelecionadas()" disabled>
                    <span class="material-icons">sync</span>
                    Consolidar Selecionadas
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal-consolidar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-consolidar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal-consolidar-container {
            position: relative;
            background: var(--bg-card, #1a1a1a);
            border: 1px solid var(--border-color, #2d2d2d);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-consolidar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color, #2d2d2d);
        }

        .modal-consolidar-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-consolidar-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FF5500, #ff6b1a);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .modal-consolidar-title-group h2 {
            font-family: 'Russo One', sans-serif;
            font-size: 1.3rem;
            color: var(--text-white, #ffffff);
            margin: 0;
        }

        .modal-consolidar-close {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-color, #2d2d2d);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-muted, #9ca3af);
        }

        .modal-consolidar-close:hover {
            background: var(--bg-secondary, #252525);
            border-color: var(--laranja, #FF5500);
            color: var(--laranja, #FF5500);
        }

        .modal-consolidar-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        .modal-consolidar-info {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .modal-consolidar-info p {
            margin: 0;
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-muted, #9ca3af);
        }

        .modal-consolidar-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 16px;
        }

        .loading-spinner-consolidar {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color, #2d2d2d);
            border-top-color: var(--laranja, #FF5500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .modal-consolidar-loading p {
            font-size: 0.9rem;
            color: var(--text-muted, #9ca3af);
            margin: 0;
        }

        .modal-consolidar-status {
            display: flex;
            gap: 20px;
            padding: 16px;
            background: var(--bg-secondary, #252525);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-dim, #6b7280);
            text-transform: uppercase;
            font-weight: 600;
        }

        .status-value {
            font-size: 0.95rem;
            color: var(--text-white, #ffffff);
            font-weight: 600;
        }

        .modal-consolidar-rodadas {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rodada-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-secondary, #252525);
            border: 1px solid var(--border-color, #2d2d2d);
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .rodada-item:hover {
            border-color: var(--laranja, #FF5500);
            background: var(--bg-elevated, #2a2a2a);
        }

        .rodada-item.consolidada {
            border-color: #10b981;
        }

        .rodada-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rodada-item-numero {
            width: 40px;
            height: 40px;
            background: var(--bg-darker, #0d0d0d);
            border: 1px solid var(--border-color, #2d2d2d);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Russo One', sans-serif;
            font-size: 1rem;
            color: var(--text-white, #ffffff);
        }

        .rodada-item.consolidada .rodada-item-numero {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #10b981;
        }

        .rodada-item-detalhes h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white, #ffffff);
            margin: 0 0 4px 0;
        }

        .rodada-item-detalhes p {
            font-size: 0.75rem;
            color: var(--text-muted, #9ca3af);
            margin: 0;
        }

        .rodada-item-checkbox {
            display: flex;
            align-items: center;
        }

        .rodada-item-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--laranja, #FF5500);
            cursor: pointer;
        }

        .modal-consolidar-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color, #2d2d2d);
        }

        .btn-modal-secondary-consolidar,
        .btn-modal-primary-consolidar {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-modal-secondary-consolidar {
            background: var(--bg-secondary, #252525);
            color: var(--text-muted, #9ca3af);
            border: 1px solid var(--border-color, #2d2d2d);
        }

        .btn-modal-secondary-consolidar:hover {
            background: var(--bg-elevated, #2a2a2a);
            border-color: var(--border-subtle, #333);
        }

        .btn-modal-primary-consolidar {
            background: linear-gradient(135deg, #FF5500 0%, #ff6b1a 100%);
            color: white;
        }

        .btn-modal-primary-consolidar:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 85, 0, 0.3);
        }

        .btn-modal-primary-consolidar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    </body>
</html>
