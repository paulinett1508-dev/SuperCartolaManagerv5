<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Fluxo Financeiro - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <style>
            /* ============================================================
               TESOURARIA GERAL - v2.0
               Painel financeiro centralizado para todas as ligas
               ============================================================ */

            .tesouraria-page {
                background: #121212;
                min-height: 100vh;
            }

            .tesouraria-content {
                padding: 20px 16px;
            }

            /* Header */
            .tesouraria-header {
                background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
                border-radius: 10px;
                padding: 18px 20px;
                margin-bottom: 20px;
                border: 1px solid #10b981;
                position: relative;
                overflow: hidden;
            }

            .tesouraria-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #10b981, #34d399, #10b981);
            }

            .header-top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
                flex-wrap: wrap;
                gap: 10px;
            }

            /* Botão Voltar (modo liga-específica) */
            .btn-voltar-liga {
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 6px 12px;
                background: rgba(255, 85, 0, 0.1);
                border: 1px solid rgba(255, 85, 0, 0.3);
                border-radius: 6px;
                color: #FF5500;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .btn-voltar-liga:hover {
                background: rgba(255, 85, 0, 0.2);
                border-color: #FF5500;
            }

            .btn-voltar-liga .material-icons {
                font-size: 16px;
            }

            .header-title {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .header-title .material-icons {
                font-size: 28px;
                color: #10b981;
            }

            .tesouraria-header h1 {
                font-size: 1.35rem;
                font-weight: 700;
                color: #ffffff;
                margin: 0;
            }

            .header-badge {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .tesouraria-header p {
                font-size: 0.8rem;
                color: #9ca3af;
                margin: 0;
            }

            /* Stats Cards */
            .stats-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
                margin-bottom: 20px;
            }

            .stat-card {
                background: #1a1a1a;
                border-radius: 10px;
                border: 1px solid #2d2d2d;
                padding: 14px;
                text-align: center;
            }

            .stat-card.highlight-green { border-color: rgba(16, 185, 129, 0.3); }
            .stat-card.highlight-red { border-color: rgba(239, 68, 68, 0.3); }
            .stat-card.highlight-blue { border-color: rgba(59, 130, 246, 0.3); }
            .stat-card.highlight-gray { border-color: rgba(156, 163, 175, 0.3); }

            .stat-card-icon {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 8px;
            }

            .stat-card-icon.green { background: rgba(16, 185, 129, 0.15); color: #10b981; }
            .stat-card-icon.red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
            .stat-card-icon.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
            .stat-card-icon.gray { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }

            .stat-card-icon .material-icons { font-size: 18px; }

            .stat-card-value {
                font-size: 1.4rem;
                font-weight: 700;
                color: #ffffff;
                margin-bottom: 2px;
            }

            .stat-card-value.green { color: #10b981; }
            .stat-card-value.red { color: #ef4444; }

            .stat-card-label {
                font-size: 0.65rem;
                color: #9ca3af;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            /* Filtros */
            .filtros-section {
                background: #1a1a1a;
                border-radius: 10px;
                border: 1px solid #2d2d2d;
                padding: 14px 16px;
                margin-bottom: 16px;
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                align-items: center;
            }

            .filtro-group {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                height: 36px;
            }

            .filtro-group label {
                font-size: 0.75rem;
                color: #9ca3af;
                font-weight: 500;
                white-space: nowrap;
            }

            .filtro-group select,
            .filtro-group input {
                background: #252525;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 8px 12px;
                font-size: 0.8rem;
                color: #ffffff;
                outline: none;
                min-width: 130px;
                height: 36px;
                box-sizing: border-box;
            }

            .filtro-group select:focus,
            .filtro-group input:focus {
                border-color: #10b981;
            }

            .filtro-group input[type="text"] {
                width: 180px;
            }

            .btn-filtrar {
                background: #10b981;
                color: #000;
                border: none;
                border-radius: 6px;
                padding: 0 16px;
                font-size: 0.8rem;
                font-weight: 600;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                margin-left: auto;
                height: 36px;
                box-sizing: border-box;
            }

            .btn-filtrar:hover {
                background: #34d399;
            }

            .btn-filtrar .material-icons {
                font-size: 16px;
                line-height: 1;
            }

            /* Tabela */
            .tabela-container {
                background: #1a1a1a;
                border-radius: 10px;
                border: 1px solid #2d2d2d;
                overflow: hidden;
            }

            .tabela-header {
                padding: 14px 16px;
                border-bottom: 1px solid #2d2d2d;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .tabela-header h3 {
                font-size: 0.95rem;
                font-weight: 700;
                color: #ffffff;
                margin: 0;
            }

            .tabela-header span {
                font-size: 0.75rem;
                color: #9ca3af;
            }

            .tabela-scroll {
                overflow-x: auto;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            thead {
                background: #252525;
            }

            th {
                padding: 12px 16px;
                text-align: left;
                font-size: 0.7rem;
                font-weight: 600;
                color: #9ca3af;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                white-space: nowrap;
            }

            th.sortable {
                cursor: pointer;
                user-select: none;
            }

            th.sortable:hover {
                color: #10b981;
            }

            th.sortable .material-icons {
                font-size: 14px;
                vertical-align: middle;
                margin-left: 4px;
            }

            th:last-child {
                width: 100px;
                min-width: 100px;
                text-align: center;
            }

            td {
                padding: 12px 16px;
                font-size: 0.85rem;
                color: #e5e7eb;
                border-bottom: 1px solid #2d2d2d;
                vertical-align: middle;
            }

            tr:last-child td {
                border-bottom: none;
            }

            tr:hover {
                background: rgba(255, 255, 255, 0.02);
            }

            /* Participante cell */
            .participante-cell {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .participante-escudo {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                object-fit: cover;
                background: #333;
            }

            .participante-info h4 {
                font-size: 0.85rem;
                font-weight: 600;
                color: #ffffff;
                margin: 0 0 2px 0;
            }

            .participante-info span {
                font-size: 0.7rem;
                color: #6b7280;
            }

            /* Saldo cells */
            .saldo-positivo {
                color: #10b981;
                font-weight: 600;
            }

            .saldo-negativo {
                color: #ef4444;
                font-weight: 600;
            }

            .saldo-zero {
                color: #9ca3af;
            }

            /* Status badges */
            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .status-badge.credor {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
            }

            .status-badge.devedor {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            .status-badge.quitado {
                background: rgba(156, 163, 175, 0.15);
                color: #9ca3af;
            }

            /* Acoes */
            td:last-child {
                width: 100px;
                min-width: 100px;
            }

            .acoes-cell {
                display: flex;
                flex-direction: row;
                gap: 12px;
                align-items: center;
                justify-content: center;
                white-space: nowrap;
            }

            .btn-acao {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                flex-shrink: 0;
                flex-grow: 0;
            }

            .btn-acao .material-icons {
                font-size: 18px;
                line-height: 1;
            }

            .btn-acao.pagamento {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
            }

            .btn-acao.pagamento:hover {
                background: #10b981;
                color: #fff;
            }

            .btn-acao.recebimento {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            .btn-acao.recebimento:hover {
                background: #ef4444;
                color: #fff;
            }

            .btn-acao.acerto {
                background: rgba(59, 130, 246, 0.15);
                color: #3b82f6;
            }

            .btn-acao.acerto:hover {
                background: #3b82f6;
                color: #fff;
            }

            .btn-acao.historico {
                background: rgba(156, 163, 175, 0.15);
                color: #9ca3af;
            }

            .btn-acao.historico:hover {
                background: #6b7280;
                color: #fff;
            }

            .btn-acao.extrato {
                background: rgba(255, 85, 0, 0.15);
                color: #FF5500;
            }

            .btn-acao.extrato:hover {
                background: #FF5500;
                color: #fff;
            }

            /* Empty state */
            .empty-state {
                padding: 60px 20px;
                text-align: center;
            }

            .empty-state .material-icons {
                font-size: 64px;
                color: #333;
                margin-bottom: 16px;
            }

            .empty-state h3 {
                font-size: 1.1rem;
                color: #ffffff;
                margin: 0 0 8px 0;
            }

            .empty-state p {
                font-size: 0.85rem;
                color: #6b7280;
                margin: 0;
            }

            /* Loading */
            .loading-overlay {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 60px 20px;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(16, 185, 129, 0.2);
                border-top: 3px solid #10b981;
                border-radius: 50%;
                animation: admin-spin 1s linear infinite;
                margin-bottom: 16px;
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }

            .modal-overlay.active {
                display: flex;
            }

            .modal-content {
                background: #1a1a1a;
                border-radius: 12px;
                border: 1px solid #2d2d2d;
                width: 90%;
                max-width: 480px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 16px 20px;
                border-bottom: 1px solid #2d2d2d;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .modal-header h3 {
                font-size: 1.1rem;
                font-weight: 700;
                color: #ffffff;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .modal-header h3 .material-icons {
                font-size: 22px;
            }

            .modal-close {
                background: none;
                border: none;
                color: #6b7280;
                cursor: pointer;
                padding: 4px;
            }

            .modal-close:hover {
                color: #ffffff;
            }

            .modal-body {
                padding: 20px;
            }

            /* Participante Info no Modal */
            .modal-participante-info {
                background: #252525;
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .modal-participante-info img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                background: #333;
            }

            .modal-participante-info .info h4 {
                font-size: 0.9rem;
                font-weight: 600;
                color: #ffffff;
                margin: 0 0 2px 0;
            }

            .modal-participante-info .info span {
                font-size: 0.75rem;
                color: #9ca3af;
            }

            .modal-participante-info .saldo {
                margin-left: auto;
                text-align: right;
            }

            .modal-participante-info .saldo .label {
                font-size: 0.65rem;
                color: #6b7280;
                text-transform: uppercase;
            }

            .modal-participante-info .saldo .valor {
                font-size: 1.1rem;
                font-weight: 700;
            }

            /* Form no Modal */
            .modal-form-group {
                margin-bottom: 16px;
            }

            .modal-form-group label {
                display: block;
                font-size: 0.8rem;
                font-weight: 500;
                color: #9ca3af;
                margin-bottom: 6px;
            }

            .modal-form-group input,
            .modal-form-group textarea,
            .modal-form-group select {
                width: 100%;
                background: #252525;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 10px 12px;
                font-size: 0.85rem;
                color: #ffffff;
                outline: none;
                box-sizing: border-box;
            }

            .modal-form-group input:focus,
            .modal-form-group textarea:focus,
            .modal-form-group select:focus {
                border-color: #10b981;
            }

            .modal-form-group textarea {
                resize: vertical;
                min-height: 70px;
            }

            .modal-form-group .input-prefix {
                position: relative;
            }

            .modal-form-group .input-prefix::before {
                content: 'R$';
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #6b7280;
                font-size: 0.85rem;
            }

            .modal-form-group .input-prefix input {
                padding-left: 36px;
            }

            /* Tipo de Acerto (Radio buttons) */
            .tipo-acerto-options {
                display: flex;
                gap: 12px;
            }

            .tipo-acerto-option {
                flex: 1;
                padding: 12px;
                border-radius: 8px;
                border: 2px solid #333;
                cursor: pointer;
                text-align: center;
                transition: all 0.2s ease;
            }

            .tipo-acerto-option:hover {
                border-color: #555;
            }

            .tipo-acerto-option.selected.pagamento {
                border-color: #10b981;
                background: rgba(16, 185, 129, 0.1);
            }

            .tipo-acerto-option.selected.recebimento {
                border-color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }

            .tipo-acerto-option .material-icons {
                font-size: 24px;
                margin-bottom: 4px;
            }

            .tipo-acerto-option.pagamento .material-icons { color: #10b981; }
            .tipo-acerto-option.recebimento .material-icons { color: #ef4444; }

            .tipo-acerto-option span {
                display: block;
                font-size: 0.75rem;
                font-weight: 600;
            }

            .tipo-acerto-option.pagamento span { color: #10b981; }
            .tipo-acerto-option.recebimento span { color: #ef4444; }

            /* Botao Zerar Saldo */
            .btn-zerar-saldo {
                width: 100%;
                background: rgba(59, 130, 246, 0.15);
                color: #3b82f6;
                border: 1px dashed #3b82f6;
                border-radius: 6px;
                padding: 10px;
                font-size: 0.8rem;
                font-weight: 600;
                cursor: pointer;
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }

            .btn-zerar-saldo:hover {
                background: rgba(59, 130, 246, 0.25);
            }

            .btn-zerar-saldo .material-icons {
                font-size: 18px;
            }

            .modal-footer {
                padding: 16px 20px;
                border-top: 1px solid #2d2d2d;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                align-items: center;
            }

            .btn-modal {
                padding: 0 20px;
                height: 40px;
                border-radius: 6px;
                font-size: 0.85rem;
                font-weight: 600;
                cursor: pointer;
                border: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                box-sizing: border-box;
            }

            .btn-modal.cancelar {
                background: #333;
                color: #9ca3af;
            }

            .btn-modal.confirmar {
                background: #10b981;
                color: #000;
            }

            .btn-modal:hover {
                opacity: 0.9;
            }

            .btn-modal .material-icons {
                font-size: 18px;
                line-height: 1;
            }

            /* Modal Historico */
            .historico-lista {
                max-height: 300px;
                overflow-y: auto;
            }

            /* Sistema de Abas do Modal v8.0 */
            .modal-tab {
                transition: all 0.2s ease;
            }
            .modal-tab:hover {
                background: rgba(255,255,255,0.05) !important;
            }
            .modal-tab.active {
                background: rgba(16,185,129,0.1) !important;
                border-bottom: 2px solid #10b981 !important;
                color: #10b981 !important;
            }

            .historico-item {
                padding: 12px;
                border-bottom: 1px solid #2d2d2d;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .historico-item:last-child {
                border-bottom: none;
            }

            .historico-item .info {
                flex: 1;
            }

            .historico-item .info .descricao {
                font-size: 0.85rem;
                color: #ffffff;
                margin-bottom: 2px;
            }

            .historico-item .info .data {
                font-size: 0.7rem;
                color: #6b7280;
            }

            .historico-item .valor {
                font-weight: 600;
            }

            .historico-item .valor.positivo { color: #10b981; }
            .historico-item .valor.negativo { color: #ef4444; }

            /* ========================================
               v2.0: BADGES FINANCEIROS DINAMICOS
               ======================================== */

            .badges-cell {
                display: flex;
                gap: 6px;
                flex-wrap: wrap;
                align-items: center;
                max-width: 280px;
            }

            .badge-financeiro {
                display: inline-flex;
                align-items: center;
                gap: 3px;
                padding: 3px 8px;
                border-radius: 12px;
                font-size: 0.7rem;
                font-weight: 600;
                white-space: nowrap;
            }

            .badge-financeiro .material-icons {
                font-size: 12px;
            }

            .badge-financeiro.ganho {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
            }

            .badge-financeiro.perda {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            .badge-financeiro.neutro {
                background: rgba(156, 163, 175, 0.15);
                color: #9ca3af;
            }

            .no-badges {
                color: #6b7280;
                font-size: 0.7rem;
                font-style: italic;
            }

            /* Voltar button */
            .btn-voltar {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                color: #9ca3af;
                text-decoration: none;
                font-size: 0.8rem;
                margin-bottom: 16px;
            }

            .btn-voltar:hover {
                color: #ffffff;
            }

            .btn-voltar .material-icons {
                font-size: 18px;
            }
        </style>
    </head>

    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main tesouraria-page">
                <div class="tesouraria-content">
                    <!-- Voltar -->
                    <a href="painel.html" class="btn-voltar">
                        <span class="material-icons">arrow_back</span>
                        Voltar ao Dashboard
                    </a>

                    <!-- Header -->
                    <header class="tesouraria-header">
                        <div class="header-top">
                            <div class="header-title">
                                <span class="material-icons">account_balance_wallet</span>
                                <h1>Fluxo Financeiro</h1>
                            </div>
                            <span class="header-badge">Temporada 2025</span>
                        </div>
                        <p>Gerencie os saldos financeiros de todos os participantes de todas as ligas em um so lugar.</p>
                    </header>

                    <!-- Stats Row -->
                    <div class="stats-row">
                        <div class="stat-card highlight-red">
                            <div class="stat-card-icon red">
                                <span class="material-icons">trending_down</span>
                            </div>
                            <div class="stat-card-value red" id="statTotalAPagar">R$ 0</div>
                            <div class="stat-card-label">Total a Pagar</div>
                        </div>
                        <div class="stat-card highlight-green">
                            <div class="stat-card-icon green">
                                <span class="material-icons">trending_up</span>
                            </div>
                            <div class="stat-card-value green" id="statTotalAReceber">R$ 0</div>
                            <div class="stat-card-label">Total a Receber</div>
                        </div>
                        <div class="stat-card highlight-red">
                            <div class="stat-card-icon red">
                                <span class="material-icons">person_off</span>
                            </div>
                            <div class="stat-card-value" id="statDevedores">0</div>
                            <div class="stat-card-label">Devedores</div>
                        </div>
                        <div class="stat-card highlight-green">
                            <div class="stat-card-icon green">
                                <span class="material-icons">person</span>
                            </div>
                            <div class="stat-card-value" id="statCredores">0</div>
                            <div class="stat-card-label">Credores</div>
                        </div>
                        <div class="stat-card highlight-gray">
                            <div class="stat-card-icon gray">
                                <span class="material-icons">done_all</span>
                            </div>
                            <div class="stat-card-value" id="statQuitados">0</div>
                            <div class="stat-card-label">Quitados</div>
                        </div>
                        <div class="stat-card highlight-blue">
                            <div class="stat-card-icon blue">
                                <span class="material-icons">groups</span>
                            </div>
                            <div class="stat-card-value" id="statTotal">0</div>
                            <div class="stat-card-label">Total</div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filtros-section">
                        <div class="filtro-group">
                            <label>Temporada:</label>
                            <select id="filtroTemporada" onchange="trocarTemporada()">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label>Liga:</label>
                            <select id="filtroLiga">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label>Situacao:</label>
                            <select id="filtroSituacao">
                                <option value="">Todos</option>
                                <option value="devedor">Devedores</option>
                                <option value="credor">Credores</option>
                                <option value="quitado">Quitados</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <input type="text" id="filtroBusca" placeholder="Buscar participante...">
                        </div>
                        <button class="btn-filtrar" onclick="aplicarFiltros()">
                            <span class="material-icons">filter_list</span>
                            Filtrar
                        </button>
                    </div>

                    <!-- Tabela -->
                    <div class="tabela-container">
                        <div class="tabela-header">
                            <h3>Participantes</h3>
                            <span id="totalExibidos">0 participantes</span>
                        </div>
                        <div class="tabela-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="ordenarPor('nomeTime')">
                                            Participante
                                            <span class="material-icons" id="sortParticipante">unfold_more</span>
                                        </th>
                                        <th id="colLigaHeader">Liga</th>
                                        <th>Movimentações</th>
                                        <th class="sortable" onclick="ordenarPor('saldoFinal')">
                                            Saldo Final
                                            <span class="material-icons" id="sortFinal">unfold_more</span>
                                        </th>
                                        <th>Situação</th>
                                        <th>Extrato</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaBody">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Loading -->
                        <div class="loading-overlay" id="loadingOverlay">
                            <div class="loading-spinner"></div>
                            <p style="color: #9ca3af;">Carregando participantes...</p>
                        </div>

                        <!-- Empty State -->
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <span class="material-icons">inbox</span>
                            <h3>Nenhum participante encontrado</h3>
                            <p>Ajuste os filtros ou verifique se existem ligas cadastradas.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal de Acerto - v8.0: Com Sistema de Abas (Novo Acerto + Histórico) -->
        <div class="modal-overlay" id="modalAcerto">
            <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <h3>
                        <span class="material-icons" style="color: #fbbf24;">payments</span>
                        Acertos Financeiros
                    </h3>
                    <button class="modal-close" onclick="fecharModal('modalAcerto')">
                        <span class="material-icons">close</span>
                    </button>
                </div>

                <!-- Info do Participante (sempre visível) -->
                <div class="modal-participante-info" style="margin: 0 20px; border-radius: 8px 8px 0 0;">
                    <img id="modalEscudo" src="" alt="">
                    <div class="info">
                        <h4 id="modalNomeTime">-</h4>
                        <span id="modalLiga">-</span>
                    </div>
                    <div class="saldo">
                        <div class="label">Saldo Atual</div>
                        <div class="valor" id="modalSaldoAtual">R$ 0,00</div>
                    </div>
                </div>

                <!-- Sistema de Abas -->
                <div class="modal-tabs" style="display: flex; border-bottom: 1px solid #2d2d2d; flex-shrink: 0;">
                    <button id="tabNovoAcertoGR" onclick="trocarAbaAcertoGR('novo')" class="modal-tab active"
                            style="flex: 1; padding: 12px 16px; background: rgba(16,185,129,0.1); border: none; border-bottom: 2px solid #10b981; color: #10b981; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span class="material-icons" style="font-size: 18px;">add_circle</span>
                        Novo Acerto
                    </button>
                    <button id="tabHistoricoGR" onclick="trocarAbaAcertoGR('historico')" class="modal-tab"
                            style="flex: 1; padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.5); font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span class="material-icons" style="font-size: 18px;">history</span>
                        Histórico
                    </button>
                </div>

                <!-- Conteúdo das Abas -->
                <div style="flex: 1; overflow-y: auto;">

                    <!-- Aba: Novo Acerto -->
                    <div id="conteudoNovoAcertoGR" class="modal-body" style="display: block;">
                        <!-- Botao Zerar Saldo (so aparece se tiver saldo) -->
                        <button class="btn-zerar-saldo" id="btnZerarSaldo" onclick="zerarSaldo()" style="display: none;">
                            <span class="material-icons">balance</span>
                            Acertar valor exato para zerar saldo
                        </button>

                        <!-- Tipo de Acerto -->
                        <div class="modal-form-group">
                            <label>Tipo de Acerto</label>
                            <div class="tipo-acerto-options">
                                <div class="tipo-acerto-option pagamento selected" onclick="selecionarTipo('pagamento')">
                                    <span class="material-icons">arrow_downward</span>
                                    <span>Pagamento</span>
                                    <small style="font-size: 0.65rem; color: #6b7280;">Participante pagou</small>
                                </div>
                                <div class="tipo-acerto-option recebimento" onclick="selecionarTipo('recebimento')">
                                    <span class="material-icons">arrow_upward</span>
                                    <span>Recebimento</span>
                                    <small style="font-size: 0.65rem; color: #6b7280;">Participante recebeu</small>
                                </div>
                            </div>
                        </div>

                        <!-- Valor com Máscara Monetária -->
                        <div class="modal-form-group">
                            <label>Valor (R$)</label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 16px; font-weight: 700;">R$</span>
                                <input type="text" id="modalValorDisplay" placeholder="0,00" oninput="formatarCampoMonetarioGR(this)"
                                       style="padding-left: 42px; font-size: 20px; font-weight: 700; text-align: right;">
                                <input type="hidden" id="modalValor" value="0">
                            </div>
                        </div>

                        <!-- Metodo + Data (lado a lado) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="modal-form-group" style="margin-bottom: 0;">
                                <label>Método</label>
                                <select id="modalMetodo">
                                    <option value="pix">PIX</option>
                                    <option value="transferencia">Transferência</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div class="modal-form-group" style="margin-bottom: 0;">
                                <label>Data</label>
                                <input type="date" id="modalDataAcerto">
                            </div>
                        </div>

                        <!-- Descricao -->
                        <div class="modal-form-group">
                            <label>Descrição</label>
                            <input type="text" id="modalDescricao" placeholder="Ex: Acerto mensalidade janeiro">
                        </div>

                        <!-- Observacoes -->
                        <div class="modal-form-group">
                            <label>Observações (opcional)</label>
                            <textarea id="modalObservacoes" placeholder="Informações adicionais..."></textarea>
                        </div>

                        <!-- Botões do formulário -->
                        <div class="modal-footer" style="padding: 16px 0 0 0; border-top: none;">
                            <button class="btn-modal cancelar" onclick="fecharModal('modalAcerto')">Cancelar</button>
                            <button class="btn-modal confirmar" onclick="confirmarAcerto()">
                                <span class="material-icons">check</span>
                                Registrar
                            </button>
                        </div>
                    </div>

                    <!-- Aba: Histórico -->
                    <div id="conteudoHistoricoGR" style="display: none; padding: 20px;">
                        <div id="historicoAcertosListaGR" style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.4);">
                                <span class="material-icons" style="font-size: 48px; margin-bottom: 12px;">hourglass_empty</span>
                                <p style="margin: 0;">Carregando histórico...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ✅ v11.0: Modal de Histórico REMOVIDO - agora usa redirect para detalhe-liga.html -->

        <!-- Scripts -->
        <script type="module">
            // Estado global
            let participantes = [];
            let participantesFiltrados = [];
            let ligasDisponiveis = [];
            let participanteSelecionado = null;
            let tipoAcertoSelecionado = 'pagamento';
            let ordenacaoAtual = { campo: 'saldoFinal', direcao: 'asc' };
            let temporadaAtual = 2025; // Default: 2025 (onde estao os dados financeiros)

            // Contexto: se veio de detalhe-liga.html, mostra apenas essa liga
            const urlParams = new URLSearchParams(window.location.search);
            const ligaIdFiltro = urlParams.get('ligaId');
            let ligaNomeFiltro = null; // Será preenchido após carregar dados

            // Carregar layout (sidebar)
            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document.getElementById("sidebar-placeholder")?.replaceWith(sidebar);
                    }

                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });

                    // Garantir que AccordionManager seja inicializado apos scripts carregados
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            // Trocar temporada
            window.trocarTemporada = function() {
                const select = document.getElementById('filtroTemporada');
                temporadaAtual = parseInt(select.value);
                console.log('[TESOURARIA] Trocando para temporada:', temporadaAtual);
                carregarDados();
            };

            // Carregar dados
            async function carregarDados() {
                const loading = document.getElementById('loadingOverlay');
                loading.style.display = 'flex';

                try {
                    // v3.0: Usar endpoint dedicado quando ligaIdFiltro está presente
                    const endpoint = ligaIdFiltro
                        ? `/api/tesouraria/liga/${ligaIdFiltro}?temporada=${temporadaAtual}`
                        : `/api/tesouraria/participantes?temporada=${temporadaAtual}`;

                    const response = await fetch(endpoint);
                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    participantes = data.participantes || [];

                    // Atualizar temporadaAtual da resposta
                    if (data.temporada) {
                        temporadaAtual = Number(data.temporada);
                        console.log('[TESOURARIA] Temporada carregada:', temporadaAtual);
                        // Sincronizar seletor
                        const select = document.getElementById('filtroTemporada');
                        if (select) select.value = temporadaAtual;
                    }

                    // v3.0: Modo liga-específica (vindo de detalhe-liga.html)
                    if (ligaIdFiltro && participantes.length > 0) {
                        ligaNomeFiltro = data.ligaNome || participantes[0]?.ligaNome;

                        // Atualizar header para contexto de liga única
                        const headerTitle = document.querySelector('.tesouraria-header h1');
                        const headerDesc = document.querySelector('.tesouraria-header p');
                        if (headerTitle) headerTitle.textContent = `Financeiro - ${ligaNomeFiltro}`;
                        if (headerDesc) headerDesc.textContent = 'Gestão financeira desta liga';

                        // Esconder filtro de ligas (já estamos em uma liga específica)
                        const filtroLigaGroup = document.getElementById('filtroLiga')?.closest('.filter-group');
                        if (filtroLigaGroup) filtroLigaGroup.style.display = 'none';

                        // ✅ FIX: Ocultar coluna Liga (header e células)
                        document.getElementById('colLigaHeader')?.style.setProperty('display', 'none');

                        // Mostrar botão Voltar
                        mostrarBotaoVoltar();

                        // ✅ FIX: Adicionar ligaId, ligaNome E modulosAtivos aos participantes
                        const modulosAtivos = data.modulosAtivos || {};
                        participantes = participantes.map(p => ({
                            ...p,
                            ligaId: ligaIdFiltro,
                            ligaNome: ligaNomeFiltro,
                            modulosAtivos: modulosAtivos
                        }));
                    } else {
                        // Extrair ligas únicas (modo todas as ligas)
                        ligasDisponiveis = [...new Set(participantes.map(p => p.ligaNome))];
                        popularFiltroLigas();
                    }

                    atualizarEstatisticas(data.totais);
                    aplicarFiltros();

                } catch (error) {
                    console.error('[TESOURARIA] Erro:', error);
                    mostrarEmptyState();
                } finally {
                    loading.style.display = 'none';
                }
            }

            // Mostrar botão Voltar (quando em modo liga-específica)
            function mostrarBotaoVoltar() {
                const headerTop = document.querySelector('.header-top');
                if (!headerTop) return;

                const btnVoltar = document.createElement('button');
                btnVoltar.className = 'btn-voltar-liga';
                btnVoltar.innerHTML = `
                    <span class="material-icons">arrow_back</span>
                    Voltar
                `;
                btnVoltar.onclick = () => {
                    window.location.href = `detalhe-liga.html?id=${ligaIdFiltro}`;
                };
                headerTop.insertBefore(btnVoltar, headerTop.firstChild);
            }

            // Popular filtro de ligas
            function popularFiltroLigas() {
                const select = document.getElementById('filtroLiga');
                select.innerHTML = '<option value="">Todas</option>';
                ligasDisponiveis.forEach(liga => {
                    select.innerHTML += `<option value="${liga}">${liga}</option>`;
                });
            }

            // Atualizar estatisticas
            function atualizarEstatisticas(totais) {
                document.getElementById('statTotalAPagar').textContent = formatarMoeda(totais.totalAPagar);
                document.getElementById('statTotalAReceber').textContent = formatarMoeda(totais.totalAReceber);
                document.getElementById('statDevedores').textContent = totais.quantidadeDevedores;
                document.getElementById('statCredores').textContent = totais.quantidadeCredores;
                document.getElementById('statQuitados').textContent = totais.quantidadeQuitados;
                document.getElementById('statTotal').textContent = totais.totalParticipantes;
            }

            // Aplicar filtros
            window.aplicarFiltros = function() {
                const liga = document.getElementById('filtroLiga').value;
                const situacao = document.getElementById('filtroSituacao').value;
                const busca = document.getElementById('filtroBusca').value.toLowerCase();

                participantesFiltrados = participantes.filter(p => {
                    if (liga && p.ligaNome !== liga) return false;
                    if (situacao && p.situacao !== situacao) return false;
                    if (busca) {
                        const nome = (p.nomeTime || '').toLowerCase();
                        const cartola = (p.nomeCartola || '').toLowerCase();
                        if (!nome.includes(busca) && !cartola.includes(busca)) return false;
                    }
                    return true;
                });

                ordenarLista();
                renderizarTabela();
            }

            // Ordenar por campo
            window.ordenarPor = function(campo) {
                if (ordenacaoAtual.campo === campo) {
                    ordenacaoAtual.direcao = ordenacaoAtual.direcao === 'asc' ? 'desc' : 'asc';
                } else {
                    ordenacaoAtual.campo = campo;
                    ordenacaoAtual.direcao = 'asc';
                }
                ordenarLista();
                renderizarTabela();
                atualizarIconesOrdenacao();
            }

            // ✅ v11.0: Ordenação com suporte a strings (nomeTime) e números
            function ordenarLista() {
                participantesFiltrados.sort((a, b) => {
                    const valorA = a[ordenacaoAtual.campo];
                    const valorB = b[ordenacaoAtual.campo];

                    // Se for string (nomeTime), usar localeCompare
                    if (typeof valorA === 'string' && typeof valorB === 'string') {
                        const cmp = valorA.localeCompare(valorB, 'pt-BR', { sensitivity: 'base' });
                        return ordenacaoAtual.direcao === 'asc' ? cmp : -cmp;
                    }

                    // Se for número
                    const numA = valorA || 0;
                    const numB = valorB || 0;
                    return ordenacaoAtual.direcao === 'asc' ? numA - numB : numB - numA;
                });
            }

            function atualizarIconesOrdenacao() {
                // Resetar todos os ícones
                ['Participante', 'Temporada', 'Acertos', 'Final'].forEach(tipo => {
                    const icon = document.getElementById(`sort${tipo}`);
                    if (icon) icon.textContent = 'unfold_more';
                });

                const campoMap = {
                    nomeTime: 'Participante',
                    saldoTemporada: 'Temporada',
                    saldoAcertos: 'Acertos',
                    saldoFinal: 'Final'
                };

                const icon = document.getElementById(`sort${campoMap[ordenacaoAtual.campo]}`);
                if (icon) {
                    icon.textContent = ordenacaoAtual.direcao === 'asc' ? 'arrow_upward' : 'arrow_downward';
                }
            }

            // ✅ v2.0: Configuração dos badges financeiros
            const badgeConfig = {
                banco: { icon: 'casino', label: 'Rodada' },
                pontosCorridos: { icon: 'emoji_events', label: 'Pt.Corridos' },
                mataMata: { icon: 'sports_mma', label: 'Mata-Mata' },
                top10: { icon: 'stars', label: 'Top10' },
                melhorMes: { icon: 'calendar_month', label: 'Melhor Mes' },
                artilheiro: { icon: 'sports_soccer', label: 'Artilheiro' },
                luvaOuro: { icon: 'sports_handball', label: 'Luva Ouro' },
                campos: { icon: 'edit_note', label: 'Ajustes' },
            };

            // ✅ v2.0: Renderizar badges financeiros dinâmicos
            function renderizarBadges(breakdown, modulosAtivos) {
                if (!breakdown) return '<span class="no-badges">Sem dados</span>';

                const badges = [];
                const ordem = ['banco', 'pontosCorridos', 'mataMata', 'top10', 'melhorMes', 'artilheiro', 'luvaOuro', 'campos'];

                for (const modulo of ordem) {
                    // Verificar se módulo está ativo (exceto campos)
                    const ativo = modulo === 'campos' || (modulosAtivos && modulosAtivos[modulo]);
                    if (!ativo) continue;

                    const valor = breakdown[modulo] || 0;
                    if (Math.abs(valor) < 0.01) continue;

                    const config = badgeConfig[modulo];
                    if (!config) continue;

                    const colorClass = valor > 0 ? 'ganho' : valor < 0 ? 'perda' : 'neutro';
                    const sinal = valor >= 0 ? '+' : '';
                    const valorStr = `${sinal}${valor.toFixed(0)}`;

                    badges.push(`
                        <span class="badge-financeiro ${colorClass}" title="${config.label}: R$ ${valor.toFixed(2).replace('.', ',')}">
                            <span class="material-icons">${config.icon}</span>
                            ${valorStr}
                        </span>
                    `);
                }

                return badges.length > 0 ? badges.join('') : '<span class="no-badges">Sem movimentacoes</span>';
            }

            // ✅ v10.0: Cache global para dados dos participantes (evita problemas de escape JSON)
            window.participantesCache = new Map();

            // Renderizar tabela
            function renderizarTabela() {
                const tbody = document.getElementById('tabelaBody');
                const emptyState = document.getElementById('emptyState');
                const totalExibidos = document.getElementById('totalExibidos');

                if (participantesFiltrados.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    totalExibidos.textContent = '0 participantes';
                    return;
                }

                emptyState.style.display = 'none';
                totalExibidos.textContent = `${participantesFiltrados.length} participante${participantesFiltrados.length > 1 ? 's' : ''}`;

                // ✅ FIX: Determinar se deve mostrar coluna Liga
                const mostrarColunaLiga = !ligaIdFiltro;

                // ✅ v10.0: Limpar cache antes de popular
                window.participantesCache.clear();

                tbody.innerHTML = participantesFiltrados.map(p => {
                    const escudo = p.escudo || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"%3E%3Ccircle cx="12" cy="12" r="10" fill="%23333"/%3E%3C/svg%3E';

                    // ✅ v2.0: Renderizar badges financeiros
                    const badgesHtml = renderizarBadges(p.breakdown, p.modulosAtivos);

                    // ✅ FIX: Coluna Liga condicional
                    const colunaLigaHtml = mostrarColunaLiga ? `<td>${p.ligaNome || '-'}</td>` : '';

                    // ✅ v10.0: Chave única para o cache
                    const cacheKey = `${p.ligaId}_${p.timeId}`;
                    window.participantesCache.set(cacheKey, p);

                    return `
                        <tr>
                            <td>
                                <div class="participante-cell">
                                    <img src="${escudo}" alt="" class="participante-escudo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%23333%22/%3E%3C/svg%3E'">
                                    <div class="participante-info">
                                        <h4>${p.nomeTime || 'Sem nome'}</h4>
                                        <span>${p.nomeCartola || ''}</span>
                                    </div>
                                </div>
                            </td>
                            ${colunaLigaHtml}
                            <td><div class="badges-cell">${badgesHtml}</div></td>
                            <td class="${getSaldoClass(p.saldoFinal)}"><strong>${formatarMoedaComSinal(p.saldoFinal)}</strong></td>
                            <td><span class="status-badge ${p.situacao}">${p.situacao}</span></td>
                            <td>
                                <div class="acoes-cell">
                                    <button class="btn-acao extrato" title="Ver extrato completo" onclick="abrirModalExtrato('${cacheKey}')">
                                        <span class="material-icons">receipt_long</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Helpers
            function formatarMoeda(valor) {
                return `R$ ${Math.abs(valor || 0).toFixed(2).replace('.', ',')}`;
            }

            function formatarMoedaComSinal(valor) {
                if (!valor || Math.abs(valor) < 0.01) return 'R$ 0,00';
                const sinal = valor > 0 ? '+' : '-';
                return `${sinal}R$ ${Math.abs(valor).toFixed(2).replace('.', ',')}`;
            }

            function getSaldoClass(valor) {
                if (!valor || Math.abs(valor) < 0.01) return 'saldo-zero';
                return valor > 0 ? 'saldo-positivo' : 'saldo-negativo';
            }

            // Mostrar empty state
            function mostrarEmptyState() {
                document.getElementById('tabelaBody').innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
            }

            // =============================================================================
            // ✅ v8.0: MODAL DE ACERTO COM ABAS (Novo Acerto + Histórico)
            // =============================================================================

            /**
             * Formata campo monetário com máscara brasileira (1.234,56)
             */
            window.formatarCampoMonetarioGR = function(input) {
                let valor = input.value.replace(/\D/g, '');
                if (!valor) {
                    input.value = '';
                    document.getElementById('modalValor').value = '0';
                    return;
                }
                let valorNumerico = parseInt(valor, 10) / 100;
                if (valorNumerico > 999999.99) valorNumerico = 999999.99;
                const formatado = valorNumerico.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                input.value = formatado;
                document.getElementById('modalValor').value = valorNumerico.toFixed(2);
            };

            /**
             * Troca entre abas do modal (Novo Acerto / Histórico)
             */
            window.trocarAbaAcertoGR = function(aba) {
                const tabNovo = document.getElementById('tabNovoAcertoGR');
                const tabHistorico = document.getElementById('tabHistoricoGR');
                const conteudoNovo = document.getElementById('conteudoNovoAcertoGR');
                const conteudoHistorico = document.getElementById('conteudoHistoricoGR');

                if (aba === 'novo') {
                    tabNovo.style.cssText = 'flex: 1; padding: 12px 16px; background: rgba(16,185,129,0.1); border: none; border-bottom: 2px solid #10b981; color: #10b981; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;';
                    tabHistorico.style.cssText = 'flex: 1; padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.5); font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;';
                    conteudoNovo.style.display = 'block';
                    conteudoHistorico.style.display = 'none';
                } else {
                    tabHistorico.style.cssText = 'flex: 1; padding: 12px 16px; background: rgba(16,185,129,0.1); border: none; border-bottom: 2px solid #10b981; color: #10b981; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;';
                    tabNovo.style.cssText = 'flex: 1; padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.5); font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;';
                    conteudoNovo.style.display = 'none';
                    conteudoHistorico.style.display = 'block';
                }
            };

            /**
             * ✅ v8.0: Carrega histórico completo na aba Histórico do modal
             * - Card resumo com saldo
             * - Seção "Movimentação por Rodada" (accordion)
             * - Seção "Acertos Financeiros" (accordion)
             */
            async function carregarHistoricoAcertosGR(ligaId, timeId) {
                const container = document.getElementById('historicoAcertosListaGR');
                if (!container) return;

                try {
                    // ✅ v8.1 FIX: Usar mesmo endpoint de acertos do fluxo-financeiro.js
                    const temporada = temporadaAtual || 2025;
                    const [acertosResp, extratoResp] = await Promise.all([
                        fetch(`/api/acertos/${ligaId}/${timeId}?temporada=${temporada}`),
                        fetch(`/api/extrato-cache/${ligaId}/times/${timeId}?temporada=${temporada}`)
                    ]);

                    const acertosData = await acertosResp.json();
                    const extratoData = await extratoResp.json();

                    const acertos = acertosData.success ? (acertosData.acertos || []) : [];
                    const rodadas = extratoData.rodadas || [];
                    const resumo = extratoData.resumo || {};

                    // Calcular saldos
                    const saldoFinal = parseFloat(resumo.saldo) || parseFloat(resumo.saldo_final) || participanteSelecionado?.saldoFinal || 0;
                    const saldoTemporada = parseFloat(resumo.saldo_temporada) || saldoFinal;
                    const totalPago = acertosData.resumo?.totalPago || 0;
                    const totalRecebido = acertosData.resumo?.totalRecebido || 0;
                    const saldoAcertos = totalPago - totalRecebido;

                    // Status do saldo
                    let txtSaldo, corSaldo;
                    if (Math.abs(saldoFinal) < 0.01) {
                        txtSaldo = 'QUITADO'; corSaldo = '#a3a3a3';
                    } else if (saldoFinal > 0) {
                        txtSaldo = 'A RECEBER'; corSaldo = '#34d399';
                    } else {
                        txtSaldo = 'DEVE'; corSaldo = '#f87171';
                    }

                    // Filtrar rodadas com movimentação
                    const rodadasComMov = rodadas.filter(r => {
                        const s = (r.bonusOnus||0) + (r.pontosCorridos||0) + (r.mataMata||0) + (r.top10||0);
                        return s !== 0 || r.posicao;
                    }).sort((a,b) => b.rodada - a.rodada);

                    // Montar HTML
                    let html = `
                        <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
                            <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">${txtSaldo}</div>
                            <div style="font-size: 28px; font-weight: 700; color: ${corSaldo};">${Math.abs(saldoFinal) < 0.01 ? '✓' : 'R$ ' + Math.abs(saldoFinal).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); text-align: left; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                    <span style="color: rgba(255,255,255,0.6);">Saldo Jogo:</span>
                                    <span style="color: ${saldoTemporada >= 0 ? '#34d399' : '#f87171'}; font-weight: 600;">${saldoTemporada >= 0 ? '+' : '-'}R$ ${Math.abs(saldoTemporada).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                    <span style="color: rgba(255,255,255,0.6);">Acertos (${acertos.length}):</span>
                                    <span style="color: ${saldoAcertos >= 0 ? '#34d399' : '#f87171'}; font-weight: 600;">${saldoAcertos >= 0 ? '+' : '-'}R$ ${Math.abs(saldoAcertos).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    // Seção: Rodadas
                    if (rodadasComMov.length > 0) {
                        html += `
                            <div style="margin-bottom: 16px;">
                                <button onclick="toggleAccordionHistGR('rodadas')" style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="material-icons" style="font-size: 18px; color: #fbbf24;">sports_soccer</span>
                                        <span style="font-size: 13px; font-weight: 600; color: #fff;">Movimentação por Rodada</span>
                                        <span style="font-size: 11px; color: rgba(255,255,255,0.5);">(${rodadasComMov.length})</span>
                                    </div>
                                    <span class="material-icons" id="iconAccordHistGRRodadas" style="font-size: 18px; color: rgba(255,255,255,0.5); transition: transform 0.2s;">expand_more</span>
                                </button>
                                <div id="accordHistGRRodadas" style="display: none; margin-top: 8px; max-height: 300px; overflow-y: auto;">
                                    ${renderizarRodadasHistGR(rodadasComMov)}
                                </div>
                            </div>
                        `;
                    }

                    // Seção: Acertos Financeiros
                    html += `
                        <div style="margin-bottom: 8px;">
                            <button onclick="toggleAccordionHistGR('acertos')" style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons" style="font-size: 18px; color: #34d399;">payments</span>
                                    <span style="font-size: 13px; font-weight: 600; color: #fff;">Acertos Financeiros</span>
                                    <span style="font-size: 11px; color: rgba(255,255,255,0.5);">(${acertos.length})</span>
                                </div>
                                <span class="material-icons" id="iconAccordHistGRAcertos" style="font-size: 18px; color: rgba(255,255,255,0.5); transition: transform 0.2s; transform: rotate(180deg);">expand_more</span>
                            </button>
                            <div id="accordHistGRAcertos" style="display: block; margin-top: 8px; max-height: 300px; overflow-y: auto;">
                    `;

                    if (acertos.length === 0) {
                        html += `
                            <div style="text-align: center; padding: 24px 16px; color: rgba(255,255,255,0.4);">
                                <span class="material-icons" style="font-size: 32px; margin-bottom: 8px;">receipt_long</span>
                                <p style="margin: 0; font-size: 13px;">Nenhum acerto registrado</p>
                            </div>
                        `;
                    } else {
                        acertos.forEach(a => {
                            const isPag = a.tipo === 'pagamento';
                            const cor = isPag ? '#34d399' : '#f87171';
                            const icone = isPag ? 'arrow_upward' : 'arrow_downward';
                            const sinal = isPag ? '+' : '-';
                            const dt = a.dataAcerto ? new Date(a.dataAcerto).toLocaleDateString('pt-BR') : '--';
                            const metodo = a.metodoPagamento ? a.metodoPagamento.toUpperCase() : '';

                            html += `
                                <div style="background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; border-left: 3px solid ${cor}; display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: ${isPag ? 'rgba(52,211,153,0.15)' : 'rgba(248,113,113,0.15)'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span class="material-icons" style="font-size: 16px; color: ${cor};">${icone}</span>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 13px; color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${a.descricao || 'Acerto'}</div>
                                        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 2px;">${dt} ${metodo ? '• ' + metodo : ''}</div>
                                    </div>
                                    <div style="font-size: 14px; font-weight: 700; color: ${cor};">${sinal}R$ ${a.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                                </div>
                            `;
                        });
                    }

                    html += '</div></div>';
                    container.innerHTML = html;

                } catch (error) {
                    console.error('[ACERTOS-GR] Erro ao carregar histórico:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.4);">
                            <span class="material-icons" style="font-size: 48px; margin-bottom: 12px; color: #f87171;">error</span>
                            <p style="margin: 0; font-size: 14px;">Erro ao carregar histórico</p>
                        </div>
                    `;
                }
            }

            /**
             * Renderiza cards de rodadas no histórico (estilo compacto)
             */
            function renderizarRodadasHistGR(rodadas) {
                if (!rodadas || rodadas.length === 0) {
                    return `
                        <div style="text-align: center; padding: 24px 16px; color: rgba(255,255,255,0.4);">
                            <span class="material-icons" style="font-size: 32px; margin-bottom: 8px;">sports_soccer</span>
                            <p style="margin: 0; font-size: 13px;">Nenhuma movimentação</p>
                        </div>
                    `;
                }

                return rodadas.map(r => {
                    const banco = r.bonusOnus || r.banco || 0;
                    const pc = r.pontosCorridos || 0;
                    const mm = r.mataMata || 0;
                    const top10 = r.top10 || 0;
                    const saldo = banco + pc + mm + top10;
                    const positivo = saldo >= 0;
                    const cor = positivo ? '#34d399' : '#f87171';
                    const bgCor = positivo ? 'rgba(52,211,153,0.08)' : 'rgba(248,113,113,0.08)';
                    const borderCor = positivo ? 'rgba(52,211,153,0.3)' : 'rgba(248,113,113,0.3)';

                    let badges = [];
                    if (banco !== 0) badges.push(`<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(251,191,36,0.15); color: ${banco >= 0 ? '#fbbf24' : '#f87171'}; font-weight: 600;">BANCO ${banco >= 0 ? '+' : ''}${banco}</span>`);
                    if (pc !== 0) badges.push(`<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(52,211,153,0.15); color: ${pc >= 0 ? '#34d399' : '#f87171'}; font-weight: 600;">PC ${pc >= 0 ? '+' : ''}${pc}</span>`);
                    if (mm !== 0) badges.push(`<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(167,139,250,0.15); color: ${mm >= 0 ? '#a78bfa' : '#f87171'}; font-weight: 600;">MM ${mm >= 0 ? '+' : ''}${mm}</span>`);
                    if (top10 !== 0) {
                        const isMito = top10 > 0;
                        badges.push(`<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: ${isMito ? 'rgba(251,191,36,0.15)' : 'rgba(248,113,113,0.15)'}; color: ${isMito ? '#fbbf24' : '#f87171'}; font-weight: 600;">${isMito ? 'MITO' : 'MICO'} ${top10 >= 0 ? '+' : ''}${top10}</span>`);
                    }

                    return `
                        <div style="background: ${bgCor}; border-radius: 8px; padding: 10px 12px; border-left: 3px solid ${borderCor}; margin-bottom: 6px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 12px; font-weight: 700; color: #fff;">R${r.rodada}</span>
                                    <span style="font-size: 10px; color: rgba(255,255,255,0.5);">${r.posicao ? r.posicao + 'º lugar' : '-'}</span>
                                </div>
                                <span style="font-size: 14px; font-weight: 700; color: ${cor};">${positivo ? '+' : ''}R$ ${Math.abs(saldo).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">${badges.join('')}</div>
                        </div>
                    `;
                }).join('');
            }

            /**
             * Toggle accordion no histórico (versão GR)
             */
            window.toggleAccordionHistGR = function(tipo) {
                const el = document.getElementById(`accordHistGR${tipo === 'rodadas' ? 'Rodadas' : 'Acertos'}`);
                const icon = document.getElementById(`iconAccordHistGR${tipo === 'rodadas' ? 'Rodadas' : 'Acertos'}`);
                if (!el || !icon) return;
                const vis = el.style.display !== 'none';
                el.style.display = vis ? 'none' : 'block';
                icon.style.transform = vis ? 'rotate(0deg)' : 'rotate(180deg)';
            };

            // Modal de Acerto
            window.abrirModalAcerto = function(p) {
                participanteSelecionado = p;

                document.getElementById('modalEscudo').src = p.escudo || '';
                document.getElementById('modalNomeTime').textContent = p.nomeTime;
                document.getElementById('modalLiga').textContent = p.ligaNome;

                const saldoAtual = document.getElementById('modalSaldoAtual');
                saldoAtual.textContent = formatarMoedaComSinal(p.saldoFinal);
                saldoAtual.className = `valor ${getSaldoClass(p.saldoFinal)}`;

                // Mostrar botao zerar se tiver saldo
                const btnZerar = document.getElementById('btnZerarSaldo');
                btnZerar.style.display = Math.abs(p.saldoFinal) > 0.01 ? 'flex' : 'none';

                // Resetar form
                document.getElementById('modalValor').value = '0';
                document.getElementById('modalValorDisplay').value = '';
                document.getElementById('modalDescricao').value = '';
                document.getElementById('modalObservacoes').value = '';
                document.getElementById('modalMetodo').value = 'pix';
                document.getElementById('modalDataAcerto').value = new Date().toISOString().split('T')[0];
                selecionarTipo('pagamento');

                // Resetar para aba "Novo Acerto"
                trocarAbaAcertoGR('novo');

                document.getElementById('modalAcerto').classList.add('active');

                // Pré-carregar histórico em background
                carregarHistoricoAcertosGR(p.ligaId, p.timeId);
            }

            window.selecionarTipo = function(tipo) {
                tipoAcertoSelecionado = tipo;
                document.querySelectorAll('.tipo-acerto-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.classList.contains(tipo)) {
                        opt.classList.add('selected');
                    }
                });
            }

            window.zerarSaldo = function() {
                if (!participanteSelecionado) return;

                const saldo = participanteSelecionado.saldoFinal;
                if (Math.abs(saldo) < 0.01) return;

                // Se devedor (saldo negativo), precisa pagar
                // Se credor (saldo positivo), precisa receber
                const valorAbs = Math.abs(saldo);
                const valorFormatado = valorAbs.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                if (saldo < 0) {
                    selecionarTipo('pagamento');
                    document.getElementById('modalValor').value = valorAbs.toFixed(2);
                    document.getElementById('modalValorDisplay').value = valorFormatado;
                    document.getElementById('modalDescricao').value = 'Quitação de dívida';
                } else {
                    selecionarTipo('recebimento');
                    document.getElementById('modalValor').value = valorAbs.toFixed(2);
                    document.getElementById('modalValorDisplay').value = valorFormatado;
                    document.getElementById('modalDescricao').value = 'Resgate de crédito';
                }
            }

            window.confirmarAcerto = async function() {
                if (!participanteSelecionado) return;

                const valor = parseFloat(document.getElementById('modalValor').value);
                const descricao = document.getElementById('modalDescricao').value;
                const observacoes = document.getElementById('modalObservacoes').value;
                const metodo = document.getElementById('modalMetodo').value;
                const dataAcerto = document.getElementById('modalDataAcerto')?.value;

                if (!valor || isNaN(valor) || valor <= 0) {
                    alert('Informe um valor válido');
                    return;
                }

                try {
                    const response = await fetch('/api/tesouraria/acerto', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ligaId: participanteSelecionado.ligaId,
                            timeId: participanteSelecionado.timeId,
                            nomeTime: participanteSelecionado.nomeTime,
                            tipo: tipoAcertoSelecionado,
                            valor,
                            descricao: descricao || `Acerto via Tesouraria - ${tipoAcertoSelecionado}`,
                            metodoPagamento: metodo,
                            observacoes,
                            dataAcerto: dataAcerto || new Date().toISOString(),
                            temporada: temporadaAtual, // Usa temporada dinamica da API
                        })
                    });

                    const data = await response.json();

                    if (!data.success) throw new Error(data.error);

                    // Mostrar mensagem de sucesso
                    let msg = data.message;
                    if (data.troco) {
                        msg += `\n\n${data.troco.mensagem}`;
                    }
                    alert(msg);

                    // Recarregar histórico no modal (atualiza aba Histórico)
                    await carregarHistoricoAcertosGR(participanteSelecionado.ligaId, participanteSelecionado.timeId);

                    // Recarregar dados da tabela principal
                    await carregarDados();

                    // Atualizar saldo exibido no modal
                    const novoParticipante = participantesFiltrados.find(p => p.timeId === participanteSelecionado.timeId && p.ligaId === participanteSelecionado.ligaId);
                    if (novoParticipante) {
                        participanteSelecionado = novoParticipante;
                        const saldoAtual = document.getElementById('modalSaldoAtual');
                        saldoAtual.textContent = formatarMoedaComSinal(novoParticipante.saldoFinal);
                        saldoAtual.className = `valor ${getSaldoClass(novoParticipante.saldoFinal)}`;
                        
                        // Atualizar botão zerar saldo
                        const btnZerar = document.getElementById('btnZerarSaldo');
                        btnZerar.style.display = Math.abs(novoParticipante.saldoFinal) > 0.01 ? 'flex' : 'none';
                    }

                    // Limpar formulário para novo acerto
                    document.getElementById('modalValor').value = '0';
                    document.getElementById('modalValorDisplay').value = '';
                    document.getElementById('modalDescricao').value = '';
                    document.getElementById('modalObservacoes').value = '';

                    // Mudar para aba Histórico após registrar
                    trocarAbaAcertoGR('historico');

                } catch (error) {
                    alert('Erro: ' + error.message);
                }
            }

            // ✅ v11.0: Redirect para extrato completo (sem modal)
            window.abrirModalExtrato = function(cacheKey) {
                // Buscar dados do cache
                const p = window.participantesCache.get(cacheKey);
                if (!p) {
                    console.error('[EXTRATO] Participante não encontrado no cache:', cacheKey);
                    alert('Erro: Dados do participante não encontrados. Recarregue a página.');
                    return;
                }

                console.log('[EXTRATO] Redirecionando para extrato completo:', p.nomeTime);

                // ✅ Redirect direto para página de fluxo financeiro com participante selecionado
                window.location.href = `detalhe-liga.html?id=${p.ligaId}&section=fluxo-financeiro&timeId=${p.timeId}`;
            };

            // [DEPRECATED] Funções antigas mantidas para compatibilidade
            window.abrirModalHistorico = async function(p) {
                document.getElementById('histEscudo').src = p.escudo || '';
                document.getElementById('histNomeTime').textContent = p.nomeTime;
                document.getElementById('histLiga').textContent = p.ligaNome;

                const lista = document.getElementById('historicoLista');
                lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">Carregando extrato completo...</div>';

                document.getElementById('modalHistorico').classList.add('active');

                try {
                    // v7.2 FIX: URL correta com /cache no final + fallback para dados já disponíveis
                    const [acertosResp, extratoResp] = await Promise.all([
                        fetch(`/api/tesouraria/participante/${p.ligaId}/${p.timeId}?temporada=${temporadaAtual}`),
                        fetch(`/api/extrato-cache/${p.ligaId}/times/${p.timeId}/cache?temporada=${temporadaAtual}`)
                    ]);

                    const acertosData = await acertosResp.json();

                    // v7.2 FIX: Tratar 404 do cache - usar dados já disponíveis em 'p'
                    let extratoData = { rodadas: [], resumo: {} };
                    if (extratoResp.ok) {
                        extratoData = await extratoResp.json();
                    } else if (extratoResp.status === 404) {
                        // Cache não existe - montar resumo a partir dos dados que já temos
                        console.log('[TESOURARIA] Cache 404 - usando dados locais');
                        extratoData = {
                            rodadas: [],
                            resumo: {
                                saldo: p.saldoFinal || 0,
                                saldo_temporada: p.saldoTemporada || p.saldoFinal || 0,
                                saldo_final: p.saldoFinal || 0
                            }
                        };
                    }

                    const acertos = acertosData.success ? (acertosData.acertos || []) : [];
                    const rodadas = extratoData.rodadas || [];
                    const resumo = extratoData.resumo || {};

                    // Calcular saldos
                    const saldoFinal = parseFloat(resumo.saldo) || parseFloat(resumo.saldo_final) || p.saldoFinal || 0;
                    const saldoTemporada = parseFloat(resumo.saldo_temporada) || saldoFinal;
                    const totalPago = acertosData.resumo?.totalPago || 0;
                    const totalRecebido = acertosData.resumo?.totalRecebido || 0;
                    const saldoAcertos = totalPago - totalRecebido;

                    // Status do saldo
                    let txtSaldo, corSaldo;
                    if (Math.abs(saldoFinal) < 0.01) {
                        txtSaldo = 'QUITADO'; corSaldo = '#a3a3a3';
                    } else if (saldoFinal > 0) {
                        txtSaldo = 'A RECEBER'; corSaldo = '#34d399';
                    } else {
                        txtSaldo = 'DEVE'; corSaldo = '#f87171';
                    }

                    // Filtrar rodadas com movimentação
                    const rodadasComMov = rodadas.filter(r => {
                        const s = (r.bonusOnus||0) + (r.pontosCorridos||0) + (r.mataMata||0) + (r.top10||0);
                        return s !== 0 || r.posicao;
                    }).sort((a,b) => b.rodada - a.rodada);

                    // Montar HTML
                    let html = `
                        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 14px; margin-bottom: 14px; text-align: center;">
                            <div style="font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 4px;">${txtSaldo}</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${corSaldo};">${Math.abs(saldoFinal) < 0.01 ? '✓' : 'R$ ' + Math.abs(saldoFinal).toFixed(2).replace('.', ',')}</div>
                            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); text-align: left; font-size: 11px;">
                                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                                    <span style="color: rgba(255,255,255,0.6);">Saldo Jogo:</span>
                                    <span style="color: ${saldoTemporada >= 0 ? '#34d399' : '#f87171'}; font-weight: 600;">${saldoTemporada >= 0 ? '+' : '-'}R$ ${Math.abs(saldoTemporada).toFixed(2).replace('.', ',')}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                                    <span style="color: rgba(255,255,255,0.6);">Acertos (${acertos.length}):</span>
                                    <span style="color: ${saldoAcertos >= 0 ? '#34d399' : '#f87171'}; font-weight: 600;">${saldoAcertos >= 0 ? '+' : '-'}R$ ${Math.abs(saldoAcertos).toFixed(2).replace('.', ',')}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    // Seção: Rodadas
                    if (rodadasComMov.length > 0) {
                        html += `
                            <div style="margin-bottom: 12px;">
                                <button onclick="toggleAccordionHist('rodadas')" style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span class="material-icons" style="font-size: 16px; color: #fbbf24;">sports_soccer</span>
                                        <span style="font-size: 12px; font-weight: 600; color: #fff;">Movimentação por Rodada</span>
                                        <span style="font-size: 10px; color: rgba(255,255,255,0.5);">(${rodadasComMov.length})</span>
                                    </div>
                                    <span class="material-icons" id="iconAccordHistRodadas" style="font-size: 16px; color: rgba(255,255,255,0.5);">expand_more</span>
                                </button>
                                <div id="accordHistRodadas" style="display: none; margin-top: 6px; max-height: 200px; overflow-y: auto;">
                                    ${renderizarRodadasHist(rodadasComMov)}
                                </div>
                            </div>
                        `;
                    }

                    // Seção: Acertos
                    html += `
                        <div>
                            <button onclick="toggleAccordionHist('acertos')" style="width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.3); border-radius: 8px; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 16px; color: #34d399;">payments</span>
                                    <span style="font-size: 12px; font-weight: 600; color: #fff;">Acertos Financeiros</span>
                                    <span style="font-size: 10px; color: rgba(255,255,255,0.5);">(${acertos.length})</span>
                                </div>
                                <span class="material-icons" id="iconAccordHistAcertos" style="font-size: 16px; color: rgba(255,255,255,0.5); transform: rotate(180deg);">expand_more</span>
                            </button>
                            <div id="accordHistAcertos" style="display: block; margin-top: 6px; max-height: 200px; overflow-y: auto;">
                    `;

                    if (acertos.length === 0) {
                        html += '<div style="text-align: center; padding: 16px; color: rgba(255,255,255,0.4); font-size: 12px;">Nenhum acerto registrado</div>';
                    } else {
                        acertos.forEach(a => {
                            const isPag = a.tipo === 'pagamento';
                            const cor = isPag ? '#34d399' : '#f87171';
                            const sinal = isPag ? '+' : '-';
                            const dt = a.dataAcerto ? new Date(a.dataAcerto).toLocaleDateString('pt-BR') : '--';
                            html += `
                                <div style="background: rgba(255,255,255,0.03); border-radius: 6px; padding: 10px; border-left: 3px solid ${cor}; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 12px; color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${a.descricao || 'Acerto'}</div>
                                        <div style="font-size: 10px; color: rgba(255,255,255,0.5);">${dt} ${a.metodoPagamento ? '• ' + a.metodoPagamento.toUpperCase() : ''}</div>
                                    </div>
                                    <div style="font-size: 13px; font-weight: 700; color: ${cor};">${sinal}R$ ${a.valor.toFixed(2).replace('.', ',')}</div>
                                </div>
                            `;
                        });
                    }
                    html += '</div></div>';

                    lista.innerHTML = html;

                } catch (error) {
                    lista.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">Erro: ${error.message}</div>`;
                }
            }

            // Helper: Renderizar rodadas
            function renderizarRodadasHist(rodadas) {
                return rodadas.map(r => {
                    const banco = r.bonusOnus || r.banco || 0;
                    const pc = r.pontosCorridos || 0;
                    const mm = r.mataMata || 0;
                    const top10 = r.top10 || 0;
                    const saldo = banco + pc + mm + top10;
                    const positivo = saldo >= 0;
                    const cor = positivo ? '#34d399' : '#f87171';

                    let badges = [];
                    if (banco !== 0) badges.push(`<span style="font-size: 9px; padding: 2px 5px; border-radius: 3px; background: rgba(251,191,36,0.15); color: ${banco >= 0 ? '#fbbf24' : '#f87171'}; font-weight: 600;">BANCO ${banco >= 0 ? '+' : ''}${banco}</span>`);
                    if (pc !== 0) badges.push(`<span style="font-size: 9px; padding: 2px 5px; border-radius: 3px; background: rgba(52,211,153,0.15); color: ${pc >= 0 ? '#34d399' : '#f87171'}; font-weight: 600;">PC ${pc >= 0 ? '+' : ''}${pc}</span>`);
                    if (mm !== 0) badges.push(`<span style="font-size: 9px; padding: 2px 5px; border-radius: 3px; background: rgba(167,139,250,0.15); color: ${mm >= 0 ? '#a78bfa' : '#f87171'}; font-weight: 600;">MM ${mm >= 0 ? '+' : ''}${mm}</span>`);
                    if (top10 !== 0) {
                        const isMito = top10 > 0;
                        badges.push(`<span style="font-size: 9px; padding: 2px 5px; border-radius: 3px; background: ${isMito ? 'rgba(251,191,36,0.15)' : 'rgba(248,113,113,0.15)'}; color: ${isMito ? '#fbbf24' : '#f87171'}; font-weight: 600;">${isMito ? 'MITO' : 'MICO'} ${top10 >= 0 ? '+' : ''}${top10}</span>`);
                    }

                    return `
                        <div style="background: ${positivo ? 'rgba(52,211,153,0.08)' : 'rgba(248,113,113,0.08)'}; border-radius: 6px; padding: 8px 10px; border-left: 3px solid ${positivo ? 'rgba(52,211,153,0.3)' : 'rgba(248,113,113,0.3)'}; margin-bottom: 4px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 11px; font-weight: 700; color: #fff;">R${r.rodada}</span>
                                    <span style="font-size: 9px; color: rgba(255,255,255,0.5);">${r.posicao ? r.posicao + 'º' : '-'}</span>
                                </div>
                                <span style="font-size: 12px; font-weight: 700; color: ${cor};">${positivo ? '+' : ''}R$ ${Math.abs(saldo).toFixed(2).replace('.', ',')}</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 3px;">${badges.join('')}</div>
                        </div>
                    `;
                }).join('');
            }

            // Toggle accordion
            window.toggleAccordionHist = function(tipo) {
                const el = document.getElementById(`accordHist${tipo === 'rodadas' ? 'Rodadas' : 'Acertos'}`);
                const icon = document.getElementById(`iconAccordHist${tipo === 'rodadas' ? 'Rodadas' : 'Acertos'}`);
                if (!el) return;
                const vis = el.style.display !== 'none';
                el.style.display = vis ? 'none' : 'block';
                icon.style.transform = vis ? 'rotate(0deg)' : 'rotate(180deg)';
            }

            window.fecharModal = function(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            // Event: busca em tempo real
            document.getElementById('filtroBusca').addEventListener('input', () => {
                aplicarFiltros();
            });

            // Fechar modais com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                }
            });

            // Fechar modal clicando fora
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Inicialização
            document.addEventListener("DOMContentLoaded", () => {
                loadLayout();
                carregarDados();
            });
        </script>

        <!-- Menu do Perfil Admin -->
        <script src="js/core/sidebar-menu.js"></script>
    </body>
</html>
