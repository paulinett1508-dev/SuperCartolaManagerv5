<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar Módulos - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <!-- Bootstrap 5.3 (necessário para modais) -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- jsPDF para exportação PDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    </head>
    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main modulos-page">
                <div class="modulos-content">
                    <!-- Header -->
                    <header class="modulos-header">
                        <div class="modulos-header-info">
                            <h1>Gerenciar Módulos</h1>
                            <p>Liga: <span class="liga-name" id="ligaNome">Carregando...</span></p>
                        </div>
                        <a href="gerenciar.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Status Message -->
                    <div id="statusMessage" class="status-message"></div>

                    <!-- Base Modules Section -->
                    <div class="section-title">
                        <span class="material-icons">lock</span>
                        <h2>Módulos Base</h2>
                        <span class="badge">Sempre Ativos</span>
                    </div>
                    <div class="modulos-grid" id="modulosBaseGrid"></div>

                    <!-- Optional Modules Section -->
                    <div class="section-title">
                        <span class="material-icons">widgets</span>
                        <h2>Módulos Opcionais</h2>
                    </div>
                    <div class="modulos-grid" id="modulosOpcionaisGrid"></div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <a href="gerenciar.html" class="btn-secondary">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                        <button class="btn-outline" id="btnExportarPDF" title="Exportar relatório de parametrizações em PDF">
                            <span class="material-icons">picture_as_pdf</span>
                            Exportar PDF
                        </button>
                        <button class="btn-primary" id="salvarBtn">
                            <span class="material-icons">save</span>
                            Salvar Configurações
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            // Importar sistema de configuração de módulos
            import '/js/modules/module-config-modal.js?v=20260128-1';
            // Importar exportação PDF
            import '/js/modules/module-config-pdf.js';

            let ligaId = null;
            let modulosState = {};

            // Opcional: configura tamanho dos blocos no grid de valores do modal
            // window.MODAL_GRID_CHUNK_SIZE = 8;

            // ✅ Guards para evitar dupla inicialização em SPA
            if (!window.__gm_state) {
                window.__gm_state = {
                    initRunning: false,
                    listenersBound: false
                };
            }

            const MODULOS_CONFIG = {
                extrato: {
                    icon: 'account_balance_wallet',
                    titulo: 'Extrato Financeiro',
                    descricao: 'Controle de mensalidades e pagamentos',
                    base: true,
                    backendId: 'extrato' // ✅ ID no backend
                },
                ranking: {
                    icon: 'leaderboard',
                    titulo: 'Ranking Geral',
                    descricao: 'Classificação geral da liga',
                    base: true,
                    backendId: 'ranking_geral' // ✅ Mapeia para ranking_geral
                },
                rodadas: {
                    icon: 'event',
                    titulo: 'Por Rodadas',
                    descricao: 'Visualização rodada a rodada',
                    base: true,
                    backendId: 'ranking_rodada' // ✅ Mapeia para ranking_rodada
                },
                top10: {
                    icon: 'military_tech',
                    titulo: 'TOP 10',
                    descricao: 'Melhores e piores pontuações',
                    base: false,
                    backendId: 'top_10'
                },
                melhorMes: {
                    icon: 'calendar_month',
                    titulo: 'Melhor do Mês',
                    descricao: 'Competição mensal',
                    base: false,
                    backendId: 'melhor_mes'
                },
                pontosCorridos: {
                    icon: 'format_list_numbered',
                    titulo: 'Pontos Corridos',
                    descricao: 'Sistema de pontos corridos',
                    base: false,
                    backendId: 'pontos_corridos'
                },
                mataMata: {
                    icon: 'swords',
                    titulo: 'Mata-Mata',
                    descricao: 'Competição eliminatória',
                    base: false,
                    backendId: 'mata_mata'
                },
                artilheiro: {
                    icon: 'sports_soccer',
                    titulo: 'Artilheiro',
                    descricao: 'Ranking de artilheiros',
                    base: false,
                    backendId: 'artilheiro'
                },
                luvaOuro: {
                    icon: 'sports_mma',
                    titulo: 'Luva de Ouro',
                    descricao: 'Ranking de goleiros',
                    base: false,
                    backendId: 'luva_ouro'
                },
                capitaoLuxo: {
                    icon: 'military_tech',
                    titulo: 'Capitão de Luxo',
                    descricao: 'Ranking dos melhores capitães',
                    base: false,
                    backendId: 'capitao_luxo'
                },
                campinho: {
                    icon: 'stadium',
                    titulo: 'Campinho Virtual',
                    descricao: 'Visualização da escalação no campo',
                    base: false,
                    backendId: 'campinho'
                },
                dicas: {
                    icon: 'lightbulb',
                    titulo: 'Dicas Premium',
                    descricao: 'Análises avançadas e sugestão de escalação',
                    base: false,
                    backendId: 'dicas'
                }
            };

            async function init() {
                if (window.__gm_state.initRunning) return;
                window.__gm_state.initRunning = true;
                const urlParams = new URLSearchParams(window.location.search);
                ligaId = urlParams.get('id');

                if (!ligaId) {
                    showMessage('ID da liga não fornecido', 'error');
                    window.__gm_state.initRunning = false;
                    return;
                }

                try {
                    await loadLayout();
                    await loadLiga();
                    await loadModulos();
                } finally {
                    window.__gm_state.initRunning = false;
                }
            }

            async function loadLayout() {
                try {
                    const response = await fetch('layout.html');
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const sidebar = doc.querySelector('.app-sidebar');
                    if (sidebar) {
                        document.getElementById('sidebar-placeholder')?.replaceWith(sidebar);
                    }

                    // Injetar scripts do layout
                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = `(function(){${script.textContent}})();`;
                            document.head.appendChild(newScript);
                        }
                    });

                    // Garantir que AccordionManager seja inicializado e dados do admin carregados
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error('Erro ao carregar layout:', error);
                }
            }

            async function loadLiga() {
                try {
                    const response = await fetch(`/api/ligas/${ligaId}`);
                    const liga = await response.json();
                    document.getElementById('ligaNome').textContent = liga.nome;
                } catch (error) {
                    console.error('Erro ao carregar liga:', error);
                    document.getElementById('ligaNome').textContent = 'Erro ao carregar';
                }
            }

            async function loadModulos() {
                try {
                    const response = await fetch(`/api/ligas/${ligaId}/modulos-ativos`);
                    const data = await response.json();
                    modulosState = data.modulos;
                    renderModulos();
                } catch (error) {
                    console.error('Erro ao carregar módulos:', error);
                    showMessage('Erro ao carregar módulos', 'error');
                }
            }

            function renderModulos() {
                const baseGrid = document.getElementById('modulosBaseGrid');
                const opcionaisGrid = document.getElementById('modulosOpcionaisGrid');
                baseGrid.innerHTML = '';
                opcionaisGrid.innerHTML = '';

                Object.entries(MODULOS_CONFIG).forEach(([key, config]) => {
                    const isAtivo = modulosState[key] !== false;
                    const card = document.createElement('div');

                    let cardClass = 'modulo-card';
                    if (config.base) cardClass += ' base ativo';
                    else cardClass += isAtivo ? ' ativo' : ' inativo';

                    card.className = cardClass;
                    card.dataset.moduloKey = key; // Adicionar data attribute

                    card.innerHTML = `
                        <div class="modulo-card-header">
                            <div class="modulo-card-info">
                                <div class="modulo-icon">
                                    <span class="material-icons">${config.icon}</span>
                                </div>
                                <span class="modulo-title">
                                    ${config.titulo}
                                    ${config.base ? '<span class="badge-base">Base</span>' : ''}
                                </span>
                            </div>
                            <label class="toggle-switch" onclick="event.stopPropagation();">
                                <input type="checkbox"
                                       ${isAtivo ? 'checked' : ''}
                                       data-modulo="${key}">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="modulo-desc">${config.descricao}${config.base && !isAtivo ? ' <strong style="color:#ff5500">⚙ Em manutenção</strong>' : ''}</div>
                    `;

                    // Evento de toggle (todos os módulos, incluindo base)
                    {
                        const toggle = card.querySelector('input[type="checkbox"]');
                        toggle.addEventListener('change', (e) => {
                            e.stopPropagation();
                            modulosState[key] = e.target.checked;
                            if (config.base) {
                                card.className = `modulo-card base ${e.target.checked ? 'ativo' : 'inativo'}`;
                                const desc = card.querySelector('.modulo-desc');
                                desc.innerHTML = e.target.checked
                                    ? config.descricao
                                    : `${config.descricao} <strong style="color:#ff5500">⚙ Em manutenção</strong>`;
                            } else {
                                card.className = `modulo-card ${e.target.checked ? 'ativo' : 'inativo'}`;
                            }
                        });
                    }

                    // Evento de clique no card (para configuração)
                    card.addEventListener('click', () => onCardClick(key));
                    card.style.cursor = 'pointer';

                    if (config.base) {
                        baseGrid.appendChild(card);
                    } else {
                        opcionaisGrid.appendChild(card);
                    }
                });
            }

            async function salvarModulos() {
                const btn = document.getElementById('salvarBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Salvando...';

                try {
                    const response = await fetch(`/api/ligas/${ligaId}/modulos-ativos`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulos: modulosState })
                    });

                    if (!response.ok) throw new Error('Erro ao salvar');

                    // ✅ FIX: Atualizar estado com resposta do servidor
                    const data = await response.json();
                    modulosState = data.modulos;

                    // ✅ FIX: Re-renderizar cards para refletir novo estado
                    renderModulos();

                    showMessage('Configurações salvas com sucesso!', 'success');

                    setTimeout(() => {
                        // Manter usuário na tela atual para navegação mais fluida
                        if (typeof window.refreshLigasSidebar === 'function') {
                            window.refreshLigasSidebar();
                        }
                    }, 600);

                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    showMessage('Erro ao salvar configurações', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-icons">save</span> Salvar Configurações';
                }
            }

            // Tornar showMessage global para que module-config-modal.js possa acessar
            window.showMessage = function(text, type) {
                const msg = document.getElementById('statusMessage');
                const icon = type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'error';
                msg.innerHTML = `<span class="material-icons">${icon}</span> ${text}`;
                msg.className = `status-message ${type}`;

                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        msg.className = 'status-message';
                    }, 3000);
                }
            };

            /**
             * Verifica se módulo pode ser configurado
             */
            function isModuloConfiguravel(moduloKey) {
                const config = MODULOS_CONFIG[moduloKey];

                // Módulos base SÃO configuráveis (mudança: base também configura)
                // Módulos opcionais só se estiverem ativos
                if (config.base) return true;
                return modulosState[moduloKey] === true;
            }

            /**
             * Abre modal de configuração ao clicar no card
             */
            async function onCardClick(moduloKey) {
                const config = MODULOS_CONFIG[moduloKey];
                const estaAtivo = config.base || modulosState[moduloKey] !== false;

                // Verificar se pode configurar
                if (!estaAtivo) {
                    showMessage('Ative o módulo primeiro usando o toggle', 'warning');
                    return;
                }

                // Mapear para ID do backend
                const backendId = config.backendId || moduloKey;

                // Abrir modal de configuração
                console.log(`[GERENCIAR-MODULOS] Abrindo configuração: ${moduloKey} → ${backendId}`);

                try {
                    const modal = new window.ModuleConfigModal();
                    await modal.init(ligaId, backendId); // ✅ Usa backendId
                } catch (error) {
                    console.error('[GERENCIAR-MODULOS] Erro ao abrir modal:', error);
                    showMessage('Erro ao carregar configuração', 'error');
                }
            }

            if (!window.__gm_state.listenersBound) {
                window.__gm_state.listenersBound = true;
                document.getElementById('salvarBtn')?.addEventListener('click', salvarModulos);
                document.getElementById('btnExportarPDF')?.addEventListener('click', () => {
                    if (window.exportarParametrizacoesPDF) {
                        window.exportarParametrizacoesPDF(ligaId);
                    } else {
                        showMessage('Módulo de exportação PDF não carregado', 'error');
                    }
                });
            }

            if (!window.__gm_domcontent_guard) {
                window.__gm_domcontent_guard = true;
                document.addEventListener('DOMContentLoaded', () => {
                    if (!window.location.pathname.includes('gerenciar-modulos.html')) return;
                    init();
                    // Re-bind do botão após init
                    const btn = document.getElementById('salvarBtn');
                    if (btn && !btn._bound) {
                        btn.addEventListener('click', salvarModulos);
                        btn._bound = true;
                    }
                });
            }

            // ✅ FIX: Reinicializar após navegação SPA
            if (!window.__gm_spa_guard) {
                window.__gm_spa_guard = true;
                window.addEventListener('spa:navigated', (e) => {
                    const { pageName } = e.detail || {};
                    if (pageName === 'gerenciar-modulos.html') {
                        console.log('[GERENCIAR-MODULOS] Reinicializando após navegação SPA...');
                        init();
                        const btn = document.getElementById('salvarBtn');
                        if (btn && !btn._bound) {
                            btn.addEventListener('click', salvarModulos);
                            btn._bound = true;
                        }
                    }
                });
            }

            // ✅ FIX: Inicializar se DOM já pronto (navegação SPA)
            if (!window.__gm_ready_guard) {
                window.__gm_ready_guard = true;
                if (document.readyState !== 'loading' && window.location.pathname.includes('gerenciar-modulos.html')) {
                    init();
                }
            }
        </script>
    </body>
</html>
