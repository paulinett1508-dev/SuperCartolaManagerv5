<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar Módulos - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    </head>
    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main modulos-page">
                <div class="modulos-content">
                    <!-- Header -->
                    <header class="modulos-header">
                        <div class="modulos-header-info">
                            <h1>Gerenciar Módulos</h1>
                            <p>Liga: <span class="liga-name" id="ligaNome">Carregando...</span></p>
                        </div>
                        <a href="gerenciar.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Status Message -->
                    <div id="statusMessage" class="status-message"></div>

                    <!-- Base Modules Section -->
                    <div class="section-title">
                        <span class="material-icons">lock</span>
                        <h2>Módulos Base</h2>
                        <span class="badge">Sempre Ativos</span>
                    </div>
                    <div class="modulos-grid" id="modulosBaseGrid"></div>

                    <!-- Optional Modules Section -->
                    <div class="section-title">
                        <span class="material-icons">widgets</span>
                        <h2>Módulos Opcionais</h2>
                    </div>
                    <div class="modulos-grid" id="modulosOpcionaisGrid"></div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <a href="gerenciar.html" class="btn-secondary">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                        <button class="btn-primary" id="salvarBtn">
                            <span class="material-icons">save</span>
                            Salvar Configurações
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            let ligaId = null;
            let modulosState = {};

            const MODULOS_CONFIG = {
                extrato: {
                    icon: 'account_balance_wallet',
                    titulo: 'Extrato Financeiro',
                    descricao: 'Controle de mensalidades e pagamentos',
                    base: true
                },
                ranking: {
                    icon: 'leaderboard',
                    titulo: 'Ranking Geral',
                    descricao: 'Classificação geral da liga',
                    base: true
                },
                rodadas: {
                    icon: 'event',
                    titulo: 'Por Rodadas',
                    descricao: 'Visualização rodada a rodada',
                    base: true
                },
                top10: {
                    icon: 'military_tech',
                    titulo: 'TOP 10',
                    descricao: 'Melhores e piores pontuações',
                    base: false
                },
                melhorMes: {
                    icon: 'calendar_month',
                    titulo: 'Melhor do Mês',
                    descricao: 'Competição mensal',
                    base: false
                },
                pontosCorridos: {
                    icon: 'format_list_numbered',
                    titulo: 'Pontos Corridos',
                    descricao: 'Sistema de pontos corridos',
                    base: false
                },
                mataMata: {
                    icon: 'swords',
                    titulo: 'Mata-Mata',
                    descricao: 'Competição eliminatória',
                    base: false
                },
                artilheiro: {
                    icon: 'sports_soccer',
                    titulo: 'Artilheiro',
                    descricao: 'Ranking de artilheiros',
                    base: false
                },
                luvaOuro: {
                    icon: 'sports_mma',
                    titulo: 'Luva de Ouro',
                    descricao: 'Ranking de goleiros',
                    base: false
                }
            };

            async function init() {
                const urlParams = new URLSearchParams(window.location.search);
                ligaId = urlParams.get('id');

                if (!ligaId) {
                    showMessage('ID da liga não fornecido', 'error');
                    return;
                }

                await loadLayout();
                await loadLiga();
                await loadModulos();
            }

            async function loadLayout() {
                try {
                    const response = await fetch('layout.html');
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const sidebar = doc.querySelector('.app-sidebar');
                    if (sidebar) {
                        document.getElementById('sidebar-placeholder').replaceWith(sidebar);
                    }

                    // Injetar scripts do layout
                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });

                    // Garantir que AccordionManager seja inicializado e dados do admin carregados
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error('Erro ao carregar layout:', error);
                }
            }

            async function loadLiga() {
                try {
                    const response = await fetch(`/api/ligas/${ligaId}`);
                    const liga = await response.json();
                    document.getElementById('ligaNome').textContent = liga.nome;
                } catch (error) {
                    console.error('Erro ao carregar liga:', error);
                    document.getElementById('ligaNome').textContent = 'Erro ao carregar';
                }
            }

            async function loadModulos() {
                try {
                    const response = await fetch(`/api/ligas/${ligaId}/modulos-ativos`);
                    const data = await response.json();
                    modulosState = data.modulos;
                    renderModulos();
                } catch (error) {
                    console.error('Erro ao carregar módulos:', error);
                    showMessage('Erro ao carregar módulos', 'error');
                }
            }

            function renderModulos() {
                const baseGrid = document.getElementById('modulosBaseGrid');
                const opcionaisGrid = document.getElementById('modulosOpcionaisGrid');
                baseGrid.innerHTML = '';
                opcionaisGrid.innerHTML = '';

                Object.entries(MODULOS_CONFIG).forEach(([key, config]) => {
                    const isAtivo = modulosState[key] !== false;
                    const card = document.createElement('div');

                    let cardClass = 'modulo-card';
                    if (config.base) cardClass += ' base ativo';
                    else cardClass += isAtivo ? ' ativo' : ' inativo';

                    card.className = cardClass;

                    card.innerHTML = `
                        <div class="modulo-card-header">
                            <div class="modulo-card-info">
                                <div class="modulo-icon">
                                    <span class="material-icons">${config.icon}</span>
                                </div>
                                <span class="modulo-title">
                                    ${config.titulo}
                                    ${config.base ? '<span class="badge-base">Base</span>' : ''}
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox"
                                       ${isAtivo ? 'checked' : ''}
                                       ${config.base ? 'disabled' : ''}
                                       data-modulo="${key}">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="modulo-desc">${config.descricao}</div>
                    `;

                    if (!config.base) {
                        const toggle = card.querySelector('input[type="checkbox"]');
                        toggle.addEventListener('change', (e) => {
                            modulosState[key] = e.target.checked;
                            card.className = `modulo-card ${e.target.checked ? 'ativo' : 'inativo'}`;
                        });
                    }

                    if (config.base) {
                        baseGrid.appendChild(card);
                    } else {
                        opcionaisGrid.appendChild(card);
                    }
                });
            }

            async function salvarModulos() {
                const btn = document.getElementById('salvarBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Salvando...';

                try {
                    const response = await fetch(`/api/ligas/${ligaId}/modulos-ativos`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulos: modulosState })
                    });

                    if (!response.ok) throw new Error('Erro ao salvar');

                    showMessage('Configurações salvas com sucesso!', 'success');

                    setTimeout(() => {
                        window.location.href = 'gerenciar.html';
                    }, 1500);

                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    showMessage('Erro ao salvar configurações', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-icons">save</span> Salvar Configurações';
                }
            }

            function showMessage(text, type) {
                const msg = document.getElementById('statusMessage');
                const icon = type === 'success' ? 'check_circle' : 'error';
                msg.innerHTML = `<span class="material-icons">${icon}</span> ${text}`;
                msg.className = `status-message ${type}`;

                if (type === 'success') {
                    setTimeout(() => {
                        msg.className = 'status-message';
                    }, 3000);
                }
            }

            document.getElementById('salvarBtn').addEventListener('click', salvarModulos);
            document.addEventListener('DOMContentLoaded', init);
        </script>

        <script src="js/core/sidebar-menu.js"></script>
    </body>
</html>
