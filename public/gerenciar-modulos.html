<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar M√≥dulos - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <!-- Bootstrap 5.3 (necess√°rio para modais) -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- jsPDF para exporta√ß√£o PDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    </head>
    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main modulos-page">
                <div class="modulos-content">
                    <!-- Header -->
                    <header class="modulos-header">
                        <div class="modulos-header-info">
                            <h1>Gerenciar M√≥dulos</h1>
                            <p>Liga: <span class="liga-name" id="ligaNome">Carregando...</span></p>
                        </div>
                        <a href="gerenciar.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Status Message -->
                    <div id="statusMessage" class="status-message"></div>

                    <!-- Base Modules Section -->
                    <div class="section-title">
                        <span class="material-icons">lock</span>
                        <h2>M√≥dulos Base</h2>
                        <span class="badge">Sempre Ativos</span>
                    </div>
                    <div class="modulos-grid" id="modulosBaseGrid"></div>

                    <!-- Optional Modules Section -->
                    <div class="section-title">
                        <span class="material-icons">widgets</span>
                        <h2>M√≥dulos Opcionais</h2>
                    </div>
                    <div class="modulos-grid" id="modulosOpcionaisGrid"></div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <a href="gerenciar.html" class="btn-secondary">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                        <button class="btn-outline" id="btnExportarPDF" title="Exportar relat√≥rio de parametriza√ß√µes em PDF">
                            <span class="material-icons">picture_as_pdf</span>
                            Exportar PDF
                        </button>
                        <button class="btn-primary" id="salvarBtn">
                            <span class="material-icons">save</span>
                            Salvar Configura√ß√µes
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            // Importar sistema de configura√ß√£o de m√≥dulos
            import '/js/modules/module-config-modal.js?v=20260128-1';
            // Importar exporta√ß√£o PDF
            import '/js/modules/module-config-pdf.js';

            let ligaId = null;
            let modulosState = {};

            // Opcional: configura tamanho dos blocos no grid de valores do modal
            // window.MODAL_GRID_CHUNK_SIZE = 8;

            // ‚úÖ Guards para evitar dupla inicializa√ß√£o em SPA
            if (!window.__gm_state) {
                window.__gm_state = {
                    initRunning: false,
                    listenersBound: false
                };
            }

            const MODULOS_CONFIG = {
                extrato: {
                    icon: 'account_balance_wallet',
                    titulo: 'Extrato Financeiro',
                    descricao: 'Controle de mensalidades e pagamentos',
                    base: false, // Pode ser desativado (modo manuten√ß√£o)
                    backendId: 'extrato'
                },
                ranking: {
                    icon: 'leaderboard',
                    titulo: 'Ranking Geral',
                    descricao: 'Classifica√ß√£o geral da liga',
                    base: true,
                    backendId: 'ranking_geral' // ‚úÖ Mapeia para ranking_geral
                },
                rodadas: {
                    icon: 'event',
                    titulo: 'Por Rodadas',
                    descricao: 'Visualiza√ß√£o rodada a rodada',
                    base: true,
                    backendId: 'ranking_rodada' // ‚úÖ Mapeia para ranking_rodada
                },
                top10: {
                    icon: 'military_tech',
                    titulo: 'TOP 10',
                    descricao: 'Melhores e piores pontua√ß√µes',
                    base: false,
                    backendId: 'top_10'
                },
                melhorMes: {
                    icon: 'calendar_month',
                    titulo: 'Melhor do M√™s',
                    descricao: 'Competi√ß√£o mensal',
                    base: false,
                    backendId: 'melhor_mes'
                },
                pontosCorridos: {
                    icon: 'format_list_numbered',
                    titulo: 'Pontos Corridos',
                    descricao: 'Sistema de pontos corridos',
                    base: false,
                    backendId: 'pontos_corridos'
                },
                mataMata: {
                    icon: 'swords',
                    titulo: 'Mata-Mata',
                    descricao: 'Competi√ß√£o eliminat√≥ria',
                    base: false,
                    backendId: 'mata_mata'
                },
                artilheiro: {
                    icon: 'sports_soccer',
                    titulo: 'Artilheiro',
                    descricao: 'Ranking de artilheiros',
                    base: false,
                    backendId: 'artilheiro'
                },
                luvaOuro: {
                    icon: 'sports_mma',
                    titulo: 'Luva de Ouro',
                    descricao: 'Ranking de goleiros',
                    base: false,
                    backendId: 'luva_ouro'
                },
                capitaoLuxo: {
                    icon: 'military_tech',
                    titulo: 'Capit√£o de Luxo',
                    descricao: 'Ranking dos melhores capit√£es',
                    base: false,
                    backendId: 'capitao_luxo',
                    status: 'active'  // ‚úÖ Implementado no backend
                },
                campinho: {
                    icon: 'stadium',
                    titulo: 'Campinho Virtual',
                    descricao: 'Visualiza√ß√£o da escala√ß√£o no campo',
                    base: false,
                    backendId: 'campinho',
                    status: 'active',      // ‚úÖ M√≥dulo FUNCIONA no participante
                    hasWizard: false       // ‚ö†Ô∏è Sem wizard de configura√ß√£o (usa defaults)
                },
                dicas: {
                    icon: 'lightbulb',
                    titulo: 'Dicas Premium',
                    descricao: 'An√°lises avan√ßadas e sugest√£o de escala√ß√£o',
                    base: false,
                    backendId: 'dicas',
                    status: 'planned'  // ‚úÖ FIX CRIT-001: M√≥dulo planejado
                }
            };

            async function init() {
                if (window.__gm_state.initRunning) return;
                window.__gm_state.initRunning = true;
                const urlParams = new URLSearchParams(window.location.search);
                ligaId = urlParams.get('id');

                if (!ligaId) {
                    showMessage('ID da liga n√£o fornecido', 'error');
                    window.__gm_state.initRunning = false;
                    return;
                }

                try {
                    await loadLayout();

                    // ‚úÖ FIX CR√çTICO: Recarregar ligas do sidebar ap√≥s navega√ß√£o SPA
                    // BUG: loadLayout() pula inje√ß√£o se sidebar existe, mas n√£o recarrega ligas
                    // Resultado: sidebar fica travado em "Carregando ligas..." ao navegar de volta
                    if (typeof window.carregarLigasLayout === 'function') {
                        console.log('[GERENCIAR-MODULOS] Recarregando ligas do sidebar ap√≥s navega√ß√£o SPA...');
                        await window.carregarLigasLayout();
                    }

                    await loadLiga();
                    await loadModulos();
                } finally {
                    window.__gm_state.initRunning = false;
                }
            }

            async function loadLayout() {
                try {
                    // ‚úÖ FIX: N√£o recarregar layout se j√° existe sidebar (navega√ß√£o SPA)
                    if (document.querySelector('.app-sidebar')) {
                        console.log('[GERENCIAR-MODULOS] Sidebar j√° existe, pulando loadLayout');
                        return;
                    }

                    const response = await fetch('layout.html');
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const sidebar = doc.querySelector('.app-sidebar');
                    if (sidebar) {
                        document.getElementById('sidebar-placeholder')?.replaceWith(sidebar);
                    }

                    // ‚úÖ FIX: S√≥ injetar scripts do layout na PRIMEIRA carga
                    // Em navega√ß√£o SPA, os scripts j√° est√£o no DOM
                    if (!window.__layoutScriptsInjected) {
                        window.__layoutScriptsInjected = true;
                        const scripts = doc.querySelectorAll("script");
                        scripts.forEach((script) => {
                            if (script.textContent.trim()) {
                                const newScript = document.createElement("script");
                                newScript.textContent = `(function(){${script.textContent}})();`;
                                document.head.appendChild(newScript);
                            }
                        });
                    }

                    // Garantir que AccordionManager seja inicializado e dados do admin carregados
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error('Erro ao carregar layout:', error);
                }
            }

            async function loadLiga() {
                try {
                    const response = await fetch(`/api/ligas/${ligaId}`);
                    const liga = await response.json();
                    document.getElementById('ligaNome').textContent = liga.nome;
                } catch (error) {
                    console.error('Erro ao carregar liga:', error);
                    document.getElementById('ligaNome').textContent = 'Erro ao carregar';
                }
            }

            async function loadModulos() {
                try {
                    const response = await fetch(`/api/ligas/${ligaId}/modulos-ativos`);
                    const data = await response.json();

                    // Garantir que todas as keys do MODULOS_CONFIG existam em modulosState
                    // Evita que undefined seja tratado como true no render
                    const defaults = {};
                    Object.keys(MODULOS_CONFIG).forEach(key => {
                        defaults[key] = MODULOS_CONFIG[key].base ? true : false;
                    });
                    modulosState = { ...defaults, ...data.modulos };

                    renderModulos();
                } catch (error) {
                    console.error('Erro ao carregar m√≥dulos:', error);
                    showMessage('Erro ao carregar m√≥dulos', 'error');
                }
            }

            function renderModulos() {
                const baseGrid = document.getElementById('modulosBaseGrid');
                const opcionaisGrid = document.getElementById('modulosOpcionaisGrid');
                baseGrid.innerHTML = '';
                opcionaisGrid.innerHTML = '';

                Object.entries(MODULOS_CONFIG).forEach(([key, config]) => {
                    const isAtivo = modulosState[key] !== false;
                    const card = document.createElement('div');

                    let cardClass = 'modulo-card';
                    if (config.base) cardClass += ' base ativo';
                    else cardClass += isAtivo ? ' ativo' : ' inativo';

                    card.className = cardClass;
                    card.dataset.moduloKey = key; // Adicionar data attribute

                    card.innerHTML = `
                        <div class="modulo-card-header">
                            <div class="modulo-card-info">
                                <div class="modulo-icon">
                                    <span class="material-icons">${config.icon}</span>
                                </div>
                                <span class="modulo-title">
                                    ${config.titulo}
                                    ${config.base ? '<span class="badge-base">Base</span>' : ''}
                                    ${config.status === 'planned' ? '<span class="badge-planned" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">Em Breve</span>' : ''}
                                    ${config.hasWizard === false && !config.base ? '<span class="badge-no-config" style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">Sem Config</span>' : ''}
                                </span>
                            </div>
                            <label class="toggle-switch" onclick="event.stopPropagation();">
                                <input type="checkbox"
                                       ${isAtivo ? 'checked' : ''}
                                       ${config.base || config.status === 'planned' ? 'disabled' : ''}
                                       data-modulo="${key}">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="modulo-desc">
                            ${config.descricao}
                            ${config.base ? ' <span class="badge-always-active" style="color:#22c55e; font-weight: 600;">‚úì Sempre Ativo</span>' : ''}
                            ${config.status === 'planned' ? '<br><small style="color: #60a5fa; font-size: 0.75rem; margin-top: 4px; display: inline-block;">üöÄ M√≥dulo em desenvolvimento</small>' : ''}
                            ${config.hasWizard === false && !config.base ? '<br><small style="color: #9ca3af; font-size: 0.75rem; margin-top: 4px; display: inline-block;">‚öôÔ∏è Usa configura√ß√µes padr√£o</small>' : ''}
                        </div>
                    `;

                    // ‚úÖ FIX: Evento de toggle apenas para m√≥dulos opcionais (n√£o base)
                    if (!config.base) {
                        const toggle = card.querySelector('input[type="checkbox"]');
                        toggle.addEventListener('change', (e) => {
                            e.stopPropagation();
                            modulosState[key] = e.target.checked;
                            card.className = `modulo-card ${e.target.checked ? 'ativo' : 'inativo'}`;
                        });
                    }

                    // ‚úÖ FIX CRIT-001: Evento de clique baseado em status e hasWizard
                    if (config.status === 'planned' || config.status === 'deprecated') {
                        // M√≥dulos planejados/deprecated n√£o s√£o clic√°veis
                        card.style.cursor = 'not-allowed';
                        card.style.opacity = '0.7';
                    } else {
                        // M√≥dulos ativos s√£o clic√°veis (mesmo sem wizard, para mostrar aviso)
                        card.addEventListener('click', () => onCardClick(key));
                        card.style.cursor = 'pointer';
                    }

                    if (config.base) {
                        baseGrid.appendChild(card);
                    } else {
                        opcionaisGrid.appendChild(card);
                    }
                });
            }

            async function salvarModulos() {
                const btn = document.getElementById('salvarBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Salvando...';

                // For√ßar m√≥dulos base sempre ativos antes de enviar
                Object.keys(MODULOS_CONFIG).forEach(key => {
                    if (MODULOS_CONFIG[key].base) {
                        modulosState[key] = true;
                    }
                });

                try {
                    console.log('[FRONTEND] Salvando m√≥dulos:', modulosState);
                    const response = await fetch(`/api/ligas/${ligaId}/modulos-ativos`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulos: modulosState })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('[FRONTEND] Erro do servidor:', errorData);
                        throw new Error(errorData.erro || errorData.error || 'Erro ao salvar');
                    }

                    // ‚úÖ FIX: Atualizar estado com resposta do servidor
                    const data = await response.json();
                    modulosState = data.modulos;

                    // ‚úÖ FIX: Re-renderizar cards para refletir novo estado
                    renderModulos();

                    showMessage('‚úÖ Configura√ß√µes salvas! Mudan√ßas refletir√£o no app dos participantes em at√© 30 segundos.', 'success');

                    setTimeout(() => {
                        // Manter usu√°rio na tela atual para navega√ß√£o mais fluida
                        if (typeof window.refreshLigasSidebar === 'function') {
                            window.refreshLigasSidebar();
                        }
                    }, 600);

                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    showMessage('Erro ao salvar configura√ß√µes', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-icons">save</span> Salvar Configura√ß√µes';
                }
            }

            // Tornar showMessage global para que module-config-modal.js possa acessar
            window.showMessage = function(text, type) {
                const msg = document.getElementById('statusMessage');
                const icon = type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'error';
                msg.innerHTML = `<span class="material-icons">${icon}</span> ${text}`;
                msg.className = `status-message ${type}`;

                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        msg.className = 'status-message';
                    }, 3000);
                }
            };

            /**
             * Verifica se m√≥dulo pode ser configurado
             */
            function isModuloConfiguravel(moduloKey) {
                const config = MODULOS_CONFIG[moduloKey];

                // M√≥dulos base S√ÉO configur√°veis (mudan√ßa: base tamb√©m configura)
                // M√≥dulos opcionais s√≥ se estiverem ativos
                if (config.base) return true;
                return modulosState[moduloKey] === true;
            }

            /**
             * Abre modal de configura√ß√£o ao clicar no card
             */
            async function onCardClick(moduloKey) {
                const config = MODULOS_CONFIG[moduloKey];
                const estaAtivo = config.base || modulosState[moduloKey] !== false;

                // ‚úÖ FIX CRIT-001: Verificar status do m√≥dulo antes de qualquer a√ß√£o
                if (config.status === 'planned') {
                    showMessage('‚è≥ Este m√≥dulo est√° em desenvolvimento e ser√° lan√ßado em breve!', 'info');
                    return;
                }

                if (config.status === 'deprecated') {
                    showMessage('‚ö†Ô∏è Este m√≥dulo foi descontinuado', 'warning');
                    return;
                }

                // ‚úÖ Verificar se m√≥dulo tem wizard de configura√ß√£o
                if (config.hasWizard === false) {
                    showMessage('‚ÑπÔ∏è Este m√≥dulo funciona com configura√ß√µes padr√£o. Use o toggle para ativar/desativar.', 'info');
                    return;
                }

                // Verificar se pode configurar
                if (!estaAtivo) {
                    showMessage('Ative o m√≥dulo primeiro usando o toggle', 'warning');
                    return;
                }

                // Mapear para ID do backend
                const backendId = config.backendId || moduloKey;

                // Abrir modal de configura√ß√£o
                console.log(`[GERENCIAR-MODULOS] Abrindo configura√ß√£o: ${moduloKey} ‚Üí ${backendId}`);

                try {
                    const modal = new window.ModuleConfigModal();
                    await modal.init(ligaId, backendId); // ‚úÖ Usa backendId
                } catch (error) {
                    console.error('[GERENCIAR-MODULOS] Erro ao abrir modal:', error);

                    // ‚úÖ FIX CRIT-001: Mensagem mais espec√≠fica baseada no tipo de erro
                    let errorMsg = 'Erro ao carregar configura√ß√£o';
                    if (error.message?.includes('400')) {
                        errorMsg = 'M√≥dulo n√£o dispon√≠vel para configura√ß√£o. Verifique se est√° implementado no backend.';
                    } else if (error.message?.includes('Timeout')) {
                        errorMsg = 'Timeout: servidor n√£o respondeu a tempo';
                    }

                    showMessage(errorMsg, 'error');
                }
            }

            if (!window.__gm_state.listenersBound) {
                window.__gm_state.listenersBound = true;
                document.getElementById('salvarBtn')?.addEventListener('click', salvarModulos);
                document.getElementById('btnExportarPDF')?.addEventListener('click', () => {
                    if (window.exportarParametrizacoesPDF) {
                        window.exportarParametrizacoesPDF(ligaId);
                    } else {
                        showMessage('M√≥dulo de exporta√ß√£o PDF n√£o carregado', 'error');
                    }
                });
            }

            if (!window.__gm_domcontent_guard) {
                window.__gm_domcontent_guard = true;
                document.addEventListener('DOMContentLoaded', () => {
                    if (!window.location.pathname.includes('gerenciar-modulos.html')) return;
                    init();
                    // Re-bind do bot√£o ap√≥s init
                    const btn = document.getElementById('salvarBtn');
                    if (btn && !btn._bound) {
                        btn.addEventListener('click', salvarModulos);
                        btn._bound = true;
                    }
                });
            }

            // ‚úÖ FIX: Reinicializar ap√≥s navega√ß√£o SPA
            if (!window.__gm_spa_guard) {
                window.__gm_spa_guard = true;
                window.addEventListener('spa:navigated', (e) => {
                    const { pageName } = e.detail || {};
                    if (pageName === 'gerenciar-modulos.html') {
                        console.log('[GERENCIAR-MODULOS] Reinicializando ap√≥s navega√ß√£o SPA...');
                        init();
                        const btn = document.getElementById('salvarBtn');
                        if (btn && !btn._bound) {
                            btn.addEventListener('click', salvarModulos);
                            btn._bound = true;
                        }
                    }
                });

                // ‚úÖ FIX: Recarregar estado ap√≥s salvar configura√ß√£o do modal
                window.addEventListener('modulo-config-saved', async (e) => {
                    console.log('[GERENCIAR-MODULOS] Configura√ß√£o salva via modal, recarregando estado...');
                    await loadModulos();
                    showMessage('M√≥dulo configurado e ativado com sucesso!', 'success');
                });
            }

            // ‚úÖ FIX: Inicializar se DOM j√° pronto (navega√ß√£o SPA)
            if (!window.__gm_ready_guard) {
                window.__gm_ready_guard = true;
                if (document.readyState !== 'loading' && window.location.pathname.includes('gerenciar-modulos.html')) {
                    init();
                }
            }
        </script>
    </body>
</html>
