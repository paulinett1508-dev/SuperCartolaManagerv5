<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerir Senhas - Participantes</title>
  <link rel="stylesheet" href="/css/base.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .page-header {
      background: #2a2a2a;
      border-left: 4px solid #ff4500;
      padding: 20px 24px;
      margin-bottom: 24px;
      border-radius: 4px;
    }

    .page-header h1 {
      font-size: 20px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .page-header p {
      font-size: 13px;
      color: #888;
    }

    /* Liga Selector */
    .liga-selector {
      margin-bottom: 24px;
    }

    .liga-selector label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #aaa;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .liga-selector select {
      width: 100%;
      max-width: 400px;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      background: #2a2a2a;
      color: #fff;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .liga-selector select:hover,
    .liga-selector select:focus {
      border-color: #ff4500;
      outline: none;
    }

    /* Table */
    .participantes-table {
      background: #2a2a2a;
      border-radius: 4px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #333;
      border-bottom: 2px solid #ff4500;
    }

    thead th {
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tbody tr {
      border-bottom: 1px solid #333;
      transition: background-color 0.15s;
    }

    tbody tr:hover {
      background: rgba(255, 69, 0, 0.05);
    }

    tbody td {
      padding: 14px 16px;
      font-size: 13px;
      color: #e0e0e0;
    }

    .participante-nome {
      font-weight: 500;
      color: #fff;
    }

    .participante-time {
      color: #888;
      font-size: 12px;
      margin-top: 2px;
    }

    .time-id {
      display: inline-block;
      background: rgba(255, 69, 0, 0.15);
      color: #ff4500;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .senha-input {
      width: 100%;
      max-width: 200px;
      padding: 8px 10px;
      border: 1px solid #3a3a3a;
      border-radius: 3px;
      background: #1a1a1a;
      color: #fff;
      font-size: 13px;
      font-family: 'Courier New', monospace;
      transition: border-color 0.2s;
    }

    .senha-input:focus {
      border-color: #ff4500;
      outline: none;
    }

    .btn-salvar {
      background: #ff4500;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
      font-weight: 500;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .btn-salvar:hover {
      background: #e63e00;
    }

    .btn-salvar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.definida {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .status-badge.nao-definida {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #888;
      font-size: 14px;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #333;
      border-top-color: #ff4500;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Stats */
    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #2a2a2a;
      padding: 16px 20px;
      border-radius: 4px;
      flex: 1;
      border-left: 3px solid #ff4500;
    }

    .stat-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
    }

    /* Senha Geral */
    .senha-geral-section {
      margin-bottom: 24px;
    }

    .senha-geral-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      border-left: 4px solid #ff4500;
      padding: 20px;
      border-radius: 4px;
    }

    .senha-geral-card h3 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
    }

    .senha-geral-card p {
      font-size: 13px;
      color: #888;
      margin-bottom: 16px;
    }

    .senha-geral-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .senha-geral-controls .senha-input {
      flex: 1;
      max-width: none;
    }

    .btn-gerar, .btn-aplicar {
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-gerar {
      background: #444;
      color: white;
    }

    .btn-gerar:hover {
      background: #555;
    }

    .btn-aplicar {
      background: #ff4500;
      color: white;
    }

    .btn-aplicar:hover {
      background: #e63e00;
    }

    .btn-aplicar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Busca */
    .busca-section {
      margin-bottom: 24px;
    }

    .busca-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      border-left: 4px solid #4CAF50;
      padding: 20px;
      border-radius: 4px;
    }

    .busca-card h3 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
    }

    .busca-card p {
      font-size: 13px;
      color: #888;
      margin-bottom: 16px;
    }

    .busca-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    .busca-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid #3a3a3a;
      border-radius: 3px;
      background: #1a1a1a;
      color: #fff;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .busca-input:focus {
      border-color: #4CAF50;
      outline: none;
    }

    .btn-limpar-busca {
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      background: #444;
      color: white;
    }

    .btn-limpar-busca:hover {
      background: #555;
    }

    .resultados-busca {
      font-size: 12px;
      color: #888;
      padding: 8px 12px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 3px;
      display: none;
    }

    .resultados-busca.visible {
      display: block;
    }

    .participante-card.hidden-by-search {
      display: none;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .participantes-table {
        overflow-x: auto;
      }

      table {
        min-width: 800px;
      }

      .stats {
        flex-direction: column;
      }

      .senha-geral-controls, .busca-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-gerar, .btn-aplicar, .btn-limpar-busca {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>Gerir Senhas dos Participantes</h1>
      <p>Configure senhas de acesso ao app para cada participante</p>
    </div>

    <div class="stats" id="statsContainer" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Total de Participantes</div>
        <div class="stat-value" id="totalParticipantes">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Com Senha Definida</div>
        <div class="stat-value" id="comSenha">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sem Senha</div>
        <div class="stat-value" id="semSenha">0</div>
      </div>
    </div>

    <div class="liga-selector">
      <label for="ligaSelect">Liga</label>
      <select id="ligaSelect" onchange="carregarParticipantes()">
        <option value="">Selecione uma liga...</option>
      </select>
    </div>

    <div class="senha-geral-section" id="senhaGeralSection" style="display: none;">
      <div class="senha-geral-card">
        <h3>üîë Senha Geral para Todos os Participantes</h3>
        <p>Gere e aplique a mesma senha para todos os participantes desta liga</p>
        <div class="senha-geral-controls">
          <input 
            type="text" 
            id="senhaGeral" 
            class="senha-input" 
            placeholder="Digite ou gere uma senha"
            maxlength="20"
          >
          <button class="btn-gerar" onclick="gerarSenhaGeral()">
            üé≤ Gerar Senha
          </button>
          <button class="btn-aplicar" onclick="aplicarSenhaGeral()">
            ‚ú® Aplicar a Todos
          </button>
        </div>
      </div>
    </div>

    <div class="busca-section" id="buscaSection" style="display: none;">
      <div class="busca-card">
        <h3>üîç Buscar Participante</h3>
        <p>Encontre rapidamente por ID do time, nome do cartoleiro ou nome do time</p>
        <div class="busca-controls">
          <input 
            type="text" 
            id="buscaParticipante" 
            class="busca-input" 
            placeholder="Digite para buscar..."
            oninput="buscarParticipante()"
          >
          <button class="btn-limpar-busca" onclick="limparBusca()">
            ‚úñ Limpar
          </button>
        </div>
        <div id="resultadosBusca" class="resultados-busca"></div>
      </div>
    </div>

    <div id="participantesContainer">
      <div class="loading">
        <div class="loading-spinner"></div>
        Selecione uma liga para come√ßar
      </div>
    </div>
  </div>

  <script>
    // Carregar ligas
    async function carregarLigas() {
      try {
        const response = await fetch('/api/ligas');
        const ligas = await response.json();

        const select = document.getElementById('ligaSelect');
        select.innerHTML = '<option value="">Selecione uma liga...</option>';

        ligas.forEach(liga => {
          const option = document.createElement('option');
          option.value = liga._id;
          option.textContent = liga.nome;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar ligas:', error);
        alert('Erro ao carregar ligas');
      }
    }

    // Carregar participantes
    async function carregarParticipantes() {
      const ligaId = document.getElementById('ligaSelect').value;
      const container = document.getElementById('participantesContainer');
      const statsContainer = document.getElementById('statsContainer');

      if (!ligaId) {
        container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Selecione uma liga para come√ßar</div>';
        statsContainer.style.display = 'none';
        document.getElementById('senhaGeralSection').style.display = 'none';
        document.getElementById('buscaSection').style.display = 'none';
        return;
      }

      // Mostrar se√ß√µes de senha geral e busca
      document.getElementById('senhaGeralSection').style.display = 'block';
      document.getElementById('buscaSection').style.display = 'block';

      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Carregando participantes...</div>';

      try {
        const response = await fetch(`/api/ligas/${ligaId}`);
        const liga = await response.json();

        if (!liga.times || liga.times.length === 0) {
          container.innerHTML = '<div class="loading">Nenhum participante encontrado</div>';
          statsContainer.style.display = 'none';
          return;
        }

        const participantesData = await Promise.all(
          liga.times.map(async (timeId) => {
            try {
              const response = await fetch(`/api/times/${timeId}`);
              if (!response.ok) return null;
              const data = await response.json();
              
              // Buscar senha do array participantes da liga
              const participanteLiga = liga.participantes?.find(p => p.time_id === timeId);
              const senha = participanteLiga?.senha_acesso || '';
              
              return {
                time_id: timeId,
                nome_cartola: data.nome_cartoleiro || 'N/D',
                nome_time: data.nome_time || 'Time N/A',
                senha_acesso: senha
              };
            } catch {
              return null;
            }
          })
        );

        const participantes = participantesData
          .filter(p => p !== null)
          .sort((a, b) => a.nome_cartola.localeCompare(b.nome_cartola));

        if (participantes.length === 0) {
          container.innerHTML = '<div class="loading">Nenhum participante encontrado</div>';
          statsContainer.style.display = 'none';
          return;
        }

        // Atualizar stats
        const comSenha = participantes.filter(p => p.senha_acesso).length;
        const semSenha = participantes.length - comSenha;

        document.getElementById('totalParticipantes').textContent = participantes.length;
        document.getElementById('comSenha').textContent = comSenha;
        document.getElementById('semSenha').textContent = semSenha;
        statsContainer.style.display = 'flex';

        // Renderizar tabela
        container.innerHTML = `
          <div class="participantes-table">
            <table>
              <thead>
                <tr>
                  <th>Participante</th>
                  <th>Time ID</th>
                  <th>Status</th>
                  <th>Senha</th>
                  <th>A√ß√£o</th>
                </tr>
              </thead>
              <tbody id="participantesTableBody"></tbody>
            </table>
          </div>
        `;

        const tbody = document.getElementById('participantesTableBody');
        participantes.forEach(p => {
          const temSenha = p.senha_acesso && p.senha_acesso.length > 0;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <div class="participante-nome">${p.nome_cartola}</div>
              <div class="participante-time">${p.nome_time}</div>
            </td>
            <td>
              <span class="time-id">${p.time_id}</span>
            </td>
            <td>
              <span class="status-badge ${temSenha ? 'definida' : 'nao-definida'}">
                ${temSenha ? 'Definida' : 'Pendente'}
              </span>
            </td>
            <td>
              <input 
                type="text" 
                class="senha-input" 
                placeholder="Digite a senha"
                value="${p.senha_acesso}"
                id="senha-${p.time_id}"
                maxlength="20"
              >
            </td>
            <td>
              <button 
                class="btn-salvar" 
                onclick="salvarSenha(${p.time_id}, '${ligaId}')"
              >
                Salvar
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });

      } catch (error) {
        console.error('Erro ao carregar participantes:', error);
        container.innerHTML = '<div class="loading">Erro ao carregar participantes</div>';
        statsContainer.style.display = 'none';
      }
    }

    // Atualizar estat√≠sticas do painel superior
    async function atualizarEstatisticas(ligaId) {
      try {
        const response = await fetch(`/api/ligas/${ligaId}`);
        if (!response.ok) {
          throw new Error('Erro ao buscar liga');
        }

        const liga = await response.json();
        console.log('Liga para estat√≠sticas:', liga);

        const totalParticipantes = liga.times?.length || 0;
        let comSenha = 0;
        let semSenha = 0;

        // Verificar senhas no array participantes da liga
        if (liga.participantes && Array.isArray(liga.participantes)) {
          comSenha = liga.participantes.filter(p => 
            p.senha_acesso && p.senha_acesso.trim() !== ''
          ).length;
          semSenha = totalParticipantes - comSenha;
        } else {
          semSenha = totalParticipantes;
        }

        console.log(`Estat√≠sticas: Total=${totalParticipantes}, ComSenha=${comSenha}, SemSenha=${semSenha}`);

        document.getElementById('totalParticipantes').textContent = totalParticipantes;
        document.getElementById('comSenha').textContent = comSenha;
        document.getElementById('semSenha').textContent = semSenha;

      } catch (error) {
        console.error('Erro ao atualizar estat√≠sticas:', error);
      }
    }

    // Salvar senha
    async function salvarSenha(timeId, ligaId) {
      const senhaInput = document.getElementById(`senha-${timeId}`);
      const senha = senhaInput.value.trim();

      if (!senha || senha.length < 4) {
        alert('A senha deve ter no m√≠nimo 4 caracteres');
        return;
      }

      try {
        const response = await fetch(`/api/ligas/${ligaId}/participante/${timeId}/senha`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ senha })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.erro || 'Erro ao salvar senha');
        }

        // Atualizar visualmente antes de mostrar o alerta
        senhaInput.value = senha;
        const row = senhaInput.closest('tr');
        const statusBadge = row.querySelector('.status-badge');
        if (statusBadge) {
          statusBadge.className = 'status-badge definida';
          statusBadge.textContent = 'Definida';
        }

        alert('‚úÖ Senha salva com sucesso!');

        // Atualizar estat√≠sticas do painel
        await atualizarEstatisticas(ligaId);

      } catch (error) {
        console.error('Erro ao salvar senha:', error);
        alert(`‚ùå Erro: ${error.message}`);
      }
    }

    // Gerar senha geral aleat√≥ria
    function gerarSenhaGeral() {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let senha = '';
      for (let i = 0; i < 8; i++) {
        senha += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      const input = document.getElementById('senhaGeral');
      if (input) {
        input.value = senha;
        input.select();
      }
    }

    // Aplicar senha geral a todos os participantes
    async function aplicarSenhaGeral() {
      const ligaId = document.getElementById('ligaSelect').value;
      const senhaGeral = document.getElementById('senhaGeral').value.trim();

      if (!ligaId) {
        alert('Selecione uma liga primeiro');
        return;
      }

      if (!senhaGeral || senhaGeral.length < 4) {
        alert('A senha deve ter no m√≠nimo 4 caracteres');
        return;
      }

      const confirmacao = confirm(
        `üîê ATEN√á√ÉO!\n\n` +
        `Voc√™ est√° prestes a aplicar a senha "${senhaGeral}" para TODOS os participantes desta liga.\n\n` +
        `Esta a√ß√£o ir√° sobrescrever as senhas existentes.\n\n` +
        `Deseja continuar?`
      );

      if (!confirmacao) return;

      try {
        const response = await fetch(`/api/ligas/${ligaId}`);
        const liga = await response.json();

        if (!liga.times || liga.times.length === 0) {
          alert('Nenhum participante encontrado nesta liga');
          return;
        }

        const btnAplicar = document.querySelector('.btn-aplicar');
        if (btnAplicar) {
          btnAplicar.disabled = true;
          btnAplicar.textContent = '‚è≥ Aplicando...';
        }

        let sucessos = 0;
        let falhas = 0;

        // Aplicar senha para cada time
        for (const timeId of liga.times) {
          try {
            const response = await fetch(`/api/ligas/${ligaId}/participante/${timeId}/senha`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ senha: senhaGeral })
            });

            if (response.ok) {
              sucessos++;
            } else {
              falhas++;
            }
          } catch (error) {
            console.error(`Erro ao aplicar senha para time ${timeId}:`, error);
            falhas++;
          }
        }

        if (btnAplicar) {
          btnAplicar.disabled = false;
          btnAplicar.textContent = '‚ú® Aplicar a Todos';
        }

        alert(
          `‚úÖ Processo conclu√≠do!\n\n` +
          `Sucessos: ${sucessos}\n` +
          `Falhas: ${falhas}\n\n` +
          `Senha aplicada: ${senhaGeral}`
        );

        // Recarregar participantes para atualizar a interface
        await carregarParticipantes();

        // Atualizar estat√≠sticas do painel superior
        await atualizarEstatisticas(ligaId);

      } catch (error) {
        console.error('Erro ao aplicar senha geral:', error);
        alert(`‚ùå Erro: ${error.message}`);
        
        const btnAplicar = document.querySelector('.btn-aplicar');
        if (btnAplicar) {
          btnAplicar.disabled = false;
          btnAplicar.textContent = '‚ú® Aplicar a Todos';
        }
      }
    }

    // Buscar participante
    function buscarParticipante() {
      const termo = document.getElementById('buscaParticipante').value.toLowerCase().trim();
      const rows = document.querySelectorAll('#participantesTableBody tr');
      const resultadosDiv = document.getElementById('resultadosBusca');

      if (!termo) {
        // Mostrar todos
        rows.forEach(row => {
          row.classList.remove('hidden-by-search');
        });
        resultadosDiv.classList.remove('visible');
        return;
      }

      let countVisible = 0;

      rows.forEach(row => {
        const nomeCartola = row.querySelector('.participante-nome')?.textContent.toLowerCase() || '';
        const nomeTime = row.querySelector('.participante-time')?.textContent.toLowerCase() || '';
        const timeId = row.querySelector('.time-id')?.textContent.toLowerCase() || '';

        const matches = 
          nomeCartola.includes(termo) ||
          nomeTime.includes(termo) ||
          timeId.includes(termo);

        if (matches) {
          row.classList.remove('hidden-by-search');
          countVisible++;
        } else {
          row.classList.add('hidden-by-search');
        }
      });

      // Mostrar resultado da busca
      if (countVisible === 0) {
        resultadosDiv.textContent = `‚ùå Nenhum participante encontrado para "${termo}"`;
      } else if (countVisible === 1) {
        resultadosDiv.textContent = `‚úÖ 1 participante encontrado`;
      } else {
        resultadosDiv.textContent = `‚úÖ ${countVisible} participantes encontrados`;
      }
      resultadosDiv.classList.add('visible');
    }

    // Limpar busca
    function limparBusca() {
      const input = document.getElementById('buscaParticipante');
      input.value = '';
      
      const rows = document.querySelectorAll('#participantesTableBody tr');
      rows.forEach(row => {
        row.classList.remove('hidden-by-search');
      });

      const resultadosDiv = document.getElementById('resultadosBusca');
      resultadosDiv.classList.remove('visible');
      
      input.focus();
    }

    // Inicializar
    carregarLigas();
  </script>
</body>
</html>