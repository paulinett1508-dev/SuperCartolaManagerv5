<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Times da Liga</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      h2 {
        text-align: center;
        color: #2c3e50;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: center;
        font-size: 14px;
      }
      th {
        background-color: #2c3e50;
        color: white;
        padding: 8px;
      }
      input[type="text"] {
        width: 90%;
        padding: 4px;
        font-size: 14px;
      }
      select {
        width: 90%;
        padding: 4px;
        font-size: 14px;
      }
      img {
        max-height: 30px;
        max-width: 30px;
        object-fit: contain;
      }
      .btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 2px;
        color: white;
        font-size: 12px;
      }
      .btn-voltar {
        background: #34495e;
        display: block;
        margin: 10px auto 20px;
        font-size: 14px;
      }
      .btn-success {
        background-color: #27ae60;
      }
      .btn-danger {
        background-color: #e74c3c;
      }
      .btn-warning {
        background-color: #f39c12;
      }
      .btn-add {
        background-color: #2980b9;
      }
      .btn-save-all {
        background-color: #ff9800;
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
      }
      .status.ok {
        color: green;
        font-weight: bold;
      }
      .status.error {
        color: red;
        font-weight: bold;
      }
      .index-column {
        width: 40px;
        font-weight: bold;
      }
      .id-column {
        width: 80px;
      }
      .error-message {
        color: red;
        text-align: center;
        margin: 10px 0;
      }
      .time-coracao-result {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <h2 id="tituloLiga">üõ† Editar Times da Liga</h2>
    <button
      class="btn btn-voltar"
      onclick="window.history.back()"
      aria-label="Voltar para a p√°gina anterior"
    >
      ‚¨Ö Voltar
    </button>

    <div id="errorMessage" class="error-message" style="display: none"></div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ID</th>
          <th>Cartoleiro</th>
          <th>Bras√£o do Time</th>
          <th>Time do Cora√ß√£o</th>
          <th>‚ù§Ô∏è</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaTimes"></tbody>
    </table>

    <button class="btn btn-save-all" onclick="salvarTudo()">
      üíæ Salvar Tudo
    </button>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const ligaId = urlParams.get("id");
      let ligaAtual = null;
      let clubes = [];

      async function carregarClubes() {
        try {
          const res = await fetch("/api/cartola/clubes"); // Ajustado para a rota correta
          if (!res.ok) {
            throw new Error(`Erro ao buscar clubes: ${res.statusText}`);
          }
          const data = await res.json();
          if (!data || typeof data !== "object")
            throw new Error("Dados de clubes inv√°lidos");
          clubes = Object.keys(data).map((id) => ({
            id: parseInt(id),
            nome: data[id].nome,
            escudo_url: data[id].escudos["30x30"] || "",
          }));
          console.log("Clubes carregados:", clubes);
          return true;
        } catch (err) {
          console.error("Erro ao carregar clubes:", err.message);
          document.getElementById("errorMessage").textContent =
            `Erro ao carregar clubes: ${err.message}`;
          document.getElementById("errorMessage").style.display = "block";
          clubes = []; // Garante que clubes seja um array vazio em caso de erro
          return false;
        }
      }

      async function buscarDadosCartola(id, span, nomeCell) {
        if (!id) {
          span.textContent = "‚ùå";
          span.className = "status error";
          nomeCell.innerHTML = "N/D";
          return null;
        }
        try {
          const res = await fetch(`/api/cartola/time/${id}`);
          if (!res.ok) {
            throw new Error(`Erro ao buscar time ${id}: ${res.statusText}`);
          }
          const data = await res.json();
          span.textContent = data.nome_cartoleiro || "N/D";
          span.className = data.nome_cartoleiro ? "status ok" : "status error";
          nomeCell.innerHTML = data.url_escudo_png
            ? `<img src="${data.url_escudo_png}" alt="Bras√£o do Time" title="Bras√£o do Time" style="max-height: 30px;" />`
            : "N/D";
          return data;
        } catch (err) {
          console.error(`Erro ao buscar dados do time ${id}:`, err.message);
          span.textContent = "‚ùå N√£o encontrado";
          nomeCell.innerHTML = "N/D";
          span.className = "status error";
          document.getElementById("errorMessage").textContent =
            `Erro ao buscar dados do time ${id}: ${err.message}`;
          document.getElementById("errorMessage").style.display = "block";
          return null;
        }
      }

      async function carregarTimes() {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.style.display = "none";

        try {
          if (!ligaId) {
            throw new Error("ID da liga n√£o fornecido na URL");
          }
          console.log(`Buscando liga com ID: ${ligaId}`);
          const res = await fetch(`/api/ligas/${ligaId}`);
          if (!res.ok) {
            throw new Error(`Erro ao buscar liga: ${res.statusText}`);
          }
          ligaAtual = await res.json();

          if (!ligaAtual || !ligaAtual.nome) {
            throw new Error("Liga n√£o encontrada ou dados inv√°lidos");
          }

          document.getElementById("tituloLiga").textContent =
            `üõ† Editar Times da Liga: ${ligaAtual.nome}`;
          const tabela = document.getElementById("tabelaTimes");
          tabela.innerHTML = "";

          const timesIds = ligaAtual.times || [];
          if (!Array.isArray(timesIds)) {
            console.error("Times n√£o √© um array:", timesIds);
            errorMessage.textContent = "Erro: Dados dos times inv√°lidos.";
            errorMessage.style.display = "block";
            adicionarLinhaNova();
            return;
          }

          const timesComNomes = await Promise.all(
            timesIds.map(async (timeId, index) => {
              const row = document.createElement("tr");
              const span = document.createElement("span");
              const nomeCell = document.createElement("span");
              const timeData = await buscarDadosCartola(timeId, span, nomeCell);
              const clubeId = timeData ? timeData.clube_id : null;
              const clube = clubes.find((c) => c.id === clubeId);
              return {
                id: timeId,
                nome_cartoleiro: span.textContent,
                brasao: nomeCell.innerHTML,
                clube_id: clubeId,
                timeDoCoracao: clube ? clube.escudo_url : "",
                timeDoCoracaoNome: clube ? clube.nome : "N/D",
                index: index,
              };
            }),
          );

          timesComNomes.sort((a, b) =>
            a.nome_cartoleiro.localeCompare(b.nome_cartoleiro),
          );
          ligaAtual.times = timesComNomes.map((t) => t.id);

          timesComNomes.forEach((time) => {
            const row = document.createElement("tr");
            const options =
              clubes.length > 0
                ? clubes
                    .map(
                      (clube) =>
                        `<option value="${clube.id}" data-escudo="${clube.escudo_url}" data-nome="${clube.nome}" ${time.clube_id === clube.id ? "selected" : ""}>${clube.id} - ${clube.nome}</option>`,
                    )
                    .join("")
                : `<option value="">Nenhum clube dispon√≠vel</option>`;
            row.innerHTML = `
              <td class="index-column">${time.index + 1}</td>
              <td class="id-column"><input type="text" value="${time.id}" onchange="atualizarCartoleiro(this, ${time.index})" style="width: 60px;" /></td>
              <td><span class="cartoleiro">${time.nome_cartoleiro}</span></td>
              <td><span class="nome-time">${time.brasao}</span></td>
              <td>
                <select onchange="atualizarClube(this, ${time.index})">
                  <option value="">Selecione um clube</option>
                  ${options}
                </select>
              </td>
              <td>
                <span class="time-coracao-result">
                  <img id="timeCoracaoResult_${time.index}" src="${time.timeDoCoracao || ""}" alt="Escudo do Time do Cora√ß√£o (30x30)" title="Escudo do Time do Cora√ß√£o" style="max-height: 30px; display: ${time.timeDoCoracao ? "block" : "none"};" />
                </span>
              </td>
              <td>
                <button class="btn btn-success" onclick="atualizarTime(${time.index})">Alterar</button>
                <button class="btn btn-warning" onclick="limparLinha(${time.index})">Limpar Campos</button>
                <button class="btn btn-danger" onclick="removerTime(${time.index})">Excluir</button>
              </td>
            `;
            tabela.appendChild(row);
          });

          adicionarLinhaNova();
        } catch (err) {
          console.error("Erro ao carregar times:", err.message);
          document.getElementById("errorMessage").textContent =
            `Erro ao carregar a liga: ${err.message}`;
          document.getElementById("errorMessage").style.display = "block";
          ligaAtual = { times: [] };
          adicionarLinhaNova();
        }
      }

      function adicionarLinhaNova() {
        const tabela = document.getElementById("tabelaTimes");
        const row = document.createElement("tr");
        const options =
          clubes.length > 0
            ? clubes
                .map(
                  (clube) =>
                    `<option value="${clube.id}" data-escudo="${clube.escudo_url}" data-nome="${clube.nome}">${clube.id} - ${clube.nome}</option>`,
                )
                .join("")
            : `<option value="">Nenhum clube dispon√≠vel</option>`;
        row.innerHTML = `
          <td class="index-column">-</td>
          <td class="id-column"><input type="text" id="novoId" placeholder="Novo ID" style="width: 60px;" /></td>
          <td><span id="novoCartoleiro" class="status"></span></td>
          <td><span id="novoNomeTime">N/D</span></td>
          <td>
            <select id="novoClube" onchange="atualizarNovoEscudo(this)">
              <option value="">Selecione um clube</option>
              ${options}
            </select>
          </td>
          <td>
            <span class="time-coracao-result">
              <img id="novoTimeCoracaoResult" style="max-height: 30px; display: none;" alt="Escudo do Time do Cora√ß√£o (30x30)" title="Escudo do Time do Cora√ß√£o" />
            </span>
          </td>
          <td>
            <button class="btn btn-add" onclick="adicionarNovoTime()">Adicionar</button>
            <button class="btn btn-warning" onclick="limparCampos()">Limpar Campos</button>
            <button class="btn btn-danger" onclick="excluirNovoTime()">Excluir</button>
          </td>
        `;
        tabela.appendChild(row);

        document.getElementById("novoId").addEventListener("input", () => {
          const id = document.getElementById("novoId").value.trim();
          const span = document.getElementById("novoCartoleiro");
          const nomeCell = document.getElementById("novoNomeTime");
          buscarDadosCartola(id, span, nomeCell);
        });
      }

      async function atualizarTime(index) {
        const row = document.getElementById("tabelaTimes").rows[index];
        const id = row.cells[1].querySelector("input").value.trim();

        if (ligaAtual.times.some((t, i) => t === id && i !== index)) {
          alert("‚ùå Este ID j√° foi adicionado!");
          return;
        }
        ligaAtual.times[index] = parseInt(id);
        try {
          const res = await fetch(`/api/ligas/${ligaId}/times`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ times: ligaAtual.times }),
          });
          if (!res.ok) throw new Error("Erro ao atualizar o time na liga");
          await carregarTimes();
        } catch (err) {
          console.error("Erro ao atualizar time:", err.message);
          document.getElementById("errorMessage").textContent =
            `Erro ao atualizar time: ${err.message}`;
          document.getElementById("errorMessage").style.display = "block";
        }
      }

      async function adicionarNovoTime() {
        const id = document.getElementById("novoId").value.trim();

        if (!id) return alert("Informe o ID do time.");
        if (
          ligaAtual &&
          ligaAtual.times &&
          ligaAtual.times.includes(parseInt(id))
        ) {
          alert("‚ùå Este ID j√° est√° na lista!");
          return;
        }

        try {
          const newTimes = [...(ligaAtual.times || []), parseInt(id)];
          const res = await fetch(`/api/ligas/${ligaId}/times`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ times: newTimes }),
          });

          if (!res.ok) throw new Error("Erro ao adicionar o time √† liga");
          alert("Time adicionado com sucesso!");
          ligaAtual.times = newTimes;
          await carregarTimes();
        } catch (err) {
          console.error("Erro ao adicionar time:", err.message);
          document.getElementById("errorMessage").textContent =
            `Erro ao adicionar time: ${err.message}`;
          document.getElementById("errorMessage").style.display = "block";
        }
      }

      function limparCampos() {
        document.getElementById("novoId").value = "";
        document.getElementById("novoCartoleiro").textContent = "";
        document.getElementById("novoNomeTime").textContent = "N/D";
        document.getElementById("novoClube").value = "";
        const resultImg = document.getElementById("novoTimeCoracaoResult");
        resultImg.src = "";
        resultImg.style.display = "none";
      }

      function excluirNovoTime() {
        limparCampos();
      }

      async function salvarTudo() {
        if (!confirm("Tem certeza que deseja salvar todas as altera√ß√µes?"))
          return;
        try {
          const res = await fetch(`/api/ligas/${ligaId}/times`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ times: ligaAtual.times || [] }),
          });

          if (!res.ok) throw new Error("Erro ao salvar as altera√ß√µes");
          alert("Altera√ß√µes salvas com sucesso!");
          await carregarTimes();
        } catch (err) {
          alert(`Erro ao salvar: ${err.message}`);
        }
      }

      async function removerTime(index) {
        if (!confirm("Tem certeza que deseja excluir este time da liga?"))
          return;
        const timeId = ligaAtual.times[index];
        try {
          const res = await fetch(`/api/ligas/${ligaId}/times/${timeId}`, {
            method: "DELETE",
          });
          if (!res.ok) throw new Error("Erro ao remover o time da liga");
          ligaAtual.times.splice(index, 1);
          await carregarTimes();
        } catch (err) {
          console.error("Erro ao remover time:", err.message);
          document.getElementById("errorMessage").textContent =
            `Erro ao remover time: ${err.message}`;
          document.getElementById("errorMessage").style.display = "block";
        }
      }

      function limparLinha(index) {
        const row = document.getElementById("tabelaTimes").rows[index];
        row.cells[1].querySelector("input").value = "";
        row.cells[2].querySelector("span").innerHTML = "";
        row.cells[3].querySelector("span").innerHTML = "N/D";
        row.cells[4].querySelector("select").value = "";
        const resultImg = row.cells[5].querySelector("img");
        resultImg.src = "";
        resultImg.style.display = "none";
      }

      function atualizarCartoleiro(input, index) {
        const row = document.getElementById("tabelaTimes").rows[index];
        const span = row.cells[2].querySelector("span");
        const nomeCell = row.cells[3].querySelector("span");
        buscarDadosCartola(input.value.trim(), span, nomeCell);
      }

      function atualizarClube(select, index) {
        const row = document.getElementById("tabelaTimes").rows[index];
        const resultImg = row.cells[5].querySelector("img");
        const selectedOption = select.options[select.selectedIndex];
        const escudoUrl = selectedOption.getAttribute("data-escudo") || "";
        resultImg.src = escudoUrl;
        resultImg.style.display = escudoUrl ? "block" : "none";
      }

      function atualizarNovoEscudo(select) {
        const selectedOption = select.options[select.selectedIndex];
        const escudoUrl = selectedOption.getAttribute("data-escudo") || "";
        const resultImg = document.getElementById("novoTimeCoracaoResult");
        resultImg.src = escudoUrl;
        resultImg.style.display = escudoUrl ? "block" : "none";
      }

      carregarClubes().then(() => carregarTimes());
    </script>
  </body>
</html>
