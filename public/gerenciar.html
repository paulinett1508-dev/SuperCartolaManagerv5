<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar Ligas - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link rel="stylesheet" href="css/modules/super-modal.css" />
        <script src="js/super-modal.js"></script>
    </head>
    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main gerenciar-page">
                <div class="gerenciar-content">
                    <!-- Header -->
                    <header class="gerenciar-header">
                        <div class="gerenciar-header-info">
                            <h1>Gerenciar Ligas & Módulos</h1>
                            <p>Administre ligas e configure módulos</p>
                        </div>
                        <a href="painel.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Stats Bar -->
                    <div class="stats-bar" id="statsBar" style="display: none;">
                        <div class="stat-chip">
                            <div class="stat-chip-icon">
                                <span class="material-icons">emoji_events</span>
                            </div>
                            <div class="stat-chip-content">
                                <span class="stat-chip-value" id="totalLigas">0</span>
                                <span class="stat-chip-label">Ligas</span>
                            </div>
                        </div>
                        <div class="stat-chip">
                            <div class="stat-chip-icon">
                                <span class="material-icons">people</span>
                            </div>
                            <div class="stat-chip-content">
                                <span class="stat-chip-value" id="totalParticipantes">0</span>
                                <span class="stat-chip-label">Participantes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="search-container">
                        <span class="search-icon">
                            <span class="material-icons">search</span>
                        </span>
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input"
                            placeholder="Buscar liga por nome ou ID..."
                        />
                    </div>

                    <!-- Liga List -->
                    <div id="ligasContainer">
                        <div class="liga-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Carregando ligas...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal de Configuração de Módulos -->
        <div id="modulosModal" class="modal-overlay" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-header-content">
                        <div class="modal-icon">
                            <span class="material-icons">widgets</span>
                        </div>
                        <div class="modal-title-group">
                            <h2 class="modal-title">Configurar Módulos</h2>
                            <p class="modal-subtitle" id="modalLigaNome">Liga sem nome</p>
                        </div>
                    </div>
                    <button class="modal-close" id="btnFecharModal">
                        <span class="material-icons">close</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="modal-loading" id="modalLoading">
                        <div class="loading-spinner"></div>
                        <p class="loading-text">Carregando módulos...</p>
                    </div>

                    <div id="modalContent" style="display: none;">
                        <!-- Conteúdo será carregado dinamicamente -->
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-modal-secondary" id="btnAbrirPaginaCompleta">
                        <span class="material-icons">open_in_new</span>
                        Abrir Página Completa
                    </button>
                    <button class="btn-modal-primary" id="btnConcluir">
                        <span class="material-icons">check</span>
                        Concluído
                    </button>
                </div>
            </div>
        </div>

        <script type="module">
            import {
                carregarLigas as carregarLigasAPI,
                deletarLiga,
            } from "./js/gerenciar-ligas.js";

            window.ligasData = [];

            // Opcional: configura tamanho dos blocos no grid de valores do modal
            // window.MODAL_GRID_CHUNK_SIZE = 8;

            // ✅ Guards SPA para evitar dupla inicialização
            if (!window.__gerenciar_state) {
                window.__gerenciar_state = {
                    initRunning: false,
                    domBound: false,
                    spaBound: false,
                    inputBound: false,
                    readyChecked: false,
                    lastInitTimestamp: 0
                };
                console.log('[GERENCIAR] Estado inicial criado');
            }

            // Reset do estado de inicialização ao carregar o script
            // ✅ FIX: Adicionar debounce para evitar múltiplas chamadas simultâneas
            const agora = Date.now();
            if (agora - window.__gerenciar_state.lastInitTimestamp < 100) {
                console.warn('[GERENCIAR] Script recarregado muito rápido, aguardando...');
            } else {
                window.__gerenciar_state.initRunning = false;
                console.log('[GERENCIAR] Guard resetado no carregamento do script');
            }

            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document.getElementById("sidebar-placeholder")?.replaceWith(sidebar);
                    }

                    // Injetar scripts do layout
                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = `(function(){${script.textContent}})();`;
                            document.head.appendChild(newScript);
                        }
                    });

                    // Garantir que AccordionManager seja inicializado
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            async function carregarListaLigas() {
                const container = document.getElementById("ligasContainer");

                try {
                    const ligas = await carregarLigasAPI();
                    window.ligasData = ligas;

                    if (!ligas || ligas.length === 0) {
                        container.innerHTML = `
                            <div class="liga-list">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <span class="material-icons">folder_open</span>
                                    </div>
                                    <div class="empty-title">Nenhuma liga criada</div>
                                    <div class="empty-subtitle">Comece criando sua primeira liga</div>
                                    <a href="criar-liga.html" class="btn-criar">
                                        <span class="material-icons">add</span>
                                        Criar Liga
                                    </a>
                                </div>
                            </div>
                        `;
                        document.getElementById("statsBar").style.display = "none";
                        return;
                    }

                    const totalParticipantes = ligas.reduce(
                        (sum, liga) => sum + (liga.timesCount || 0),
                        0,
                    );

                    document.getElementById("totalLigas").textContent = ligas.length;
                    document.getElementById("totalParticipantes").textContent = totalParticipantes;
                    document.getElementById("statsBar").style.display = "flex";

                    renderizarLigas(ligas);
                } catch (error) {
                    console.error("Erro ao carregar ligas:", error);
                    container.innerHTML = `
                        <div class="liga-list">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <span class="material-icons">error_outline</span>
                                </div>
                                <div class="empty-title">Erro ao carregar</div>
                                <div class="empty-subtitle">Não foi possível carregar as ligas</div>
                                <button onclick="location.reload()" class="btn-criar">
                                    <span class="material-icons">refresh</span>
                                    Tentar Novamente
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            function renderizarLigas(ligas) {
                const container = document.getElementById("ligasContainer");

                let html = '<div class="liga-list">';

                ligas.forEach((liga) => {
                    const timesCount = liga.times ? liga.times.length : 0;
                    const idCurto = liga._id ? liga._id.substring(0, 8) : "";
                    const nomeLiga = liga.nome || "Liga sem nome";

                    html += `
                        <div class="liga-item" data-id="${liga._id}" data-nome="${nomeLiga}">
                            <div class="liga-info">
                                <h4>${nomeLiga}</h4>
                                <p>ID: ${idCurto}... · ${timesCount} participantes</p>
                            </div>
                            <div class="liga-actions">
                                <a href="editar-liga.html?id=${liga._id}" class="btn-action btn-edit">
                                    <span class="material-icons">edit</span>
                                    Editar
                                </a>
                                <button class="btn-action btn-modules" data-liga-id="${liga._id}" data-liga-nome="${nomeLiga}">
                                    <span class="material-icons">widgets</span>
                                    Módulos
                                </button>
                                <button class="btn-action btn-delete" onclick="excluirLiga('${liga._id}', '${nomeLiga.replace(/'/g, "\\'")}')">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += "</div>";
                container.innerHTML = html;
            }

            window.excluirLiga = async function (id, nome) {
                if (!await SuperModal.confirm({ title: 'Excluir liga', message: `Excluir a liga "${nome}"?\n\nEsta ação é irreversível.`, confirmText: 'Excluir', variant: 'danger' })) {
                    return;
                }

                try {
                    await deletarLiga(id);
                    await carregarListaLigas();
                } catch (error) {
                    SuperModal.toast.error(`Erro ao excluir liga: ${error.message}`);
                }
            };

            if (!window.__gerenciar_state.inputBound) {
                window.__gerenciar_state.inputBound = true;
                document.addEventListener("input", function (e) {
                    if (e.target.id === "searchInput") {
                        const searchTerm = e.target.value.toLowerCase();
                        const items = document.querySelectorAll(".liga-item");

                        items.forEach((item) => {
                            const nome = item.dataset.nome.toLowerCase();
                            const id = item.dataset.id.toLowerCase();
                            const visible = nome.includes(searchTerm) || id.includes(searchTerm);
                            item.style.display = visible ? "flex" : "none";
                        });
                    }
                });
            }

            // Função de inicialização reutilizável
            async function initGerenciar() {
                const timestamp = Date.now();
                if (window.__gerenciar_state.initRunning) {
                    const elapsed = timestamp - window.__gerenciar_state.lastInitTimestamp;
                    console.warn("[GERENCIAR] Inicialização já em andamento, ignorando... (elapsed:", elapsed, "ms)");
                    return;
                }
                window.__gerenciar_state.initRunning = true;
                window.__gerenciar_state.lastInitTimestamp = timestamp;
                console.log("[GERENCIAR] Inicializando página...");
                try {
                    await loadLayout();
                    console.log("[GERENCIAR] Layout carregado");
                    await carregarListaLigas();
                    console.log("[GERENCIAR] Lista de ligas carregada");
                    console.log("[GERENCIAR] ✅ Inicialização concluída com sucesso");
                } catch (error) {
                    console.error("[GERENCIAR] ❌ Erro durante inicialização:", error);
                    // Mostrar erro ao usuário
                    const container = document.getElementById("ligasContainer");
                    if (container) {
                        container.innerHTML = `
                            <div class="liga-list">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <span class="material-icons">error_outline</span>
                                    </div>
                                    <div class="empty-title">Erro ao carregar</div>
                                    <div class="empty-subtitle">${error.message}</div>
                                    <button onclick="location.reload()" class="btn-criar">
                                        <span class="material-icons">refresh</span>
                                        Recarregar Página
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                } finally {
                    const duration = Date.now() - timestamp;
                    window.__gerenciar_state.initRunning = false;
                    console.log("[GERENCIAR] Guard resetado para false (duração:", duration, "ms)");
                }
            }

            if (!window.__gerenciar_state.domBound) {
                window.__gerenciar_state.domBound = true;
                document.addEventListener("DOMContentLoaded", async () => {
                    if (!window.location.pathname.includes('gerenciar.html')) return;
                    await initGerenciar();
                });
            }

            // ✅ FIX: Reinicializar após navegação SPA
            if (!window.__gerenciar_state.spaBound) {
                window.__gerenciar_state.spaBound = true;
                console.log('[GERENCIAR] Listener spa:navigated registrado');
                window.addEventListener('spa:navigated', async (e) => {
                    console.log('[GERENCIAR] Evento spa:navigated recebido:', e.detail);
                    const { pageName } = e.detail || {};
                    if (pageName === 'gerenciar.html') {
                        console.log('[GERENCIAR] Reinicializando após navegação SPA...');
                        // ✅ FIX CRÍTICO: Forçar reset do guard antes de reinicializar
                        window.__gerenciar_state.initRunning = false;
                        console.log('[GERENCIAR] Guard resetado, iniciando...');
                        await initGerenciar();
                    } else {
                        console.log('[GERENCIAR] Página diferente, ignorando:', pageName);
                    }
                });
            }

            // ✅ FIX: Inicializar se DOM já pronto (navegação SPA)
            if (!window.__gerenciar_state.readyChecked) {
                window.__gerenciar_state.readyChecked = true;
                console.log('[GERENCIAR] Verificando inicialização imediata, readyState:', document.readyState);
                if (document.readyState !== 'loading' && window.location.pathname.includes('gerenciar.html')) {
                    console.log('[GERENCIAR] DOM pronto, inicializando...');
                    window.__gerenciar_state.initRunning = false; // Reset antes de inicializar
                    initGerenciar();
                }
            }

            // ✅ FALLBACK: Garantir inicialização após 500ms se ainda não ocorreu
            setTimeout(() => {
                if (window.location.pathname.includes('gerenciar.html')) {
                    const container = document.getElementById('ligasContainer');
                    const isLoading = container && container.querySelector('.loading-state');
                    if (isLoading) {
                        console.warn('[GERENCIAR] FALLBACK: Página ainda em loading após 500ms!');
                        console.warn('[GERENCIAR] Estado atual:', {
                            initRunning: window.__gerenciar_state.initRunning,
                            domBound: window.__gerenciar_state.domBound,
                            spaBound: window.__gerenciar_state.spaBound,
                            readyChecked: window.__gerenciar_state.readyChecked
                        });
                        // ✅ FIX CRÍTICO: Forçar reset e retry
                        window.__gerenciar_state.initRunning = false;
                        console.warn('[GERENCIAR] Forçando inicialização de emergência...');
                        initGerenciar();
                    }
                }
            }, 500);

            // === MODAL DE MÓDULOS ===
            if (!window.__gerenciar_state.modalBound) {
                window.__gerenciar_state.modalBound = true;
                window.currentLigaId = null;

                // Event delegation para botões de módulos
                document.addEventListener('click', function(e) {
                    const btnModulos = e.target.closest('.btn-modules');
                    if (btnModulos) {
                        e.preventDefault();
                        e.stopPropagation();
                        const ligaId = btnModulos.dataset.ligaId;
                        const nomeLiga = btnModulos.dataset.ligaNome;
                        if (ligaId && nomeLiga) {
                            window.abrirModalModulos(ligaId, nomeLiga);
                        }
                    }
                });

                // Event delegation para toggles de módulos
                document.addEventListener('change', function(e) {
                    if (e.target.classList.contains('toggle-modulo')) {
                        const moduloKey = e.target.dataset.moduloKey;
                        const ativo = e.target.checked;
                        if (moduloKey) {
                            window.toggleModuloModal(moduloKey, ativo);
                        }
                    }
                });

                // Fechar modal ao clicar no overlay (fora do conteúdo)
                document.addEventListener('click', function(e) {
                    const modalOverlay = document.getElementById('modulosModal');
                    if (e.target === modalOverlay && modalOverlay.style.display !== 'none') {
                        window.fecharModalModulos();
                    }
                });

                // Fechar modal com ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('modulosModal');
                        if (modal && modal.style.display !== 'none') {
                            window.fecharModalModulos();
                        }
                    }
                });
            }

            window.abrirModalModulos = async function(ligaId, nomeLiga) {
                window.currentLigaId = ligaId;
                const modal = document.getElementById('modulosModal');
                const modalLoading = document.getElementById('modalLoading');
                const modalContent = document.getElementById('modalContent');
                const modalLigaNome = document.getElementById('modalLigaNome');

                // Atualizar título
                modalLigaNome.textContent = nomeLiga;

                // Mostrar modal
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Resetar estado
                modalLoading.style.display = 'block';
                modalContent.style.display = 'none';

                try {
                    // Carregar módulos da liga
                    const response = await fetch(`/api/ligas/${ligaId}`);
                    const liga = await response.json();

                    // Renderizar módulos
                    renderizarModulosModal(liga);

                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                } catch (error) {
                    console.error('Erro ao carregar módulos:', error);
                    modalContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <span class="material-icons">error_outline</span>
                            </div>
                            <div class="empty-title">Erro ao carregar</div>
                            <div class="empty-subtitle">Não foi possível carregar os módulos</div>
                        </div>
                    `;
                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                }
            };

            window.fecharModalModulos = function() {
                const modal = document.getElementById('modulosModal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
                window.currentLigaId = null;
            };

            // Event listeners para botões do modal (quando DOM estiver pronto)
            function initModalButtons() {
                // Botão fechar (X)
                const btnFechar = document.getElementById('btnFecharModal');
                if (btnFechar) {
                    btnFechar.addEventListener('click', window.fecharModalModulos);
                }

                // Botão concluir
                const btnConcluir = document.getElementById('btnConcluir');
                if (btnConcluir) {
                    btnConcluir.addEventListener('click', window.fecharModalModulos);
                }

                // Botão abrir página completa
                const btnAbrirPagina = document.getElementById('btnAbrirPaginaCompleta');
                if (btnAbrirPagina) {
                    btnAbrirPagina.addEventListener('click', function() {
                        if (window.currentLigaId) {
                            window.location.href = 'gerenciar-modulos.html?id=' + window.currentLigaId;
                        }
                    });
                }
            }

            // Inicializar botões quando DOM estiver pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initModalButtons);
            } else {
                initModalButtons();
            }

            function renderizarModulosModal(liga) {
                const modalContent = document.getElementById('modalContent');
                const modulosAtivos = liga.modulos_ativos || {};

                // Módulos base (sempre ativos)
                const modulosBase = [
                    { key: 'extrato', nome: 'Extrato', icon: 'account_balance_wallet' },
                    { key: 'ranking', nome: 'Ranking', icon: 'leaderboard' },
                    { key: 'rodadas', nome: 'Rodadas', icon: 'calendar_today' },
                    { key: 'historico', nome: 'Hall da Fama', icon: 'military_tech' }
                ];

                // Módulos opcionais
                const modulosOpcionais = [
                    { key: 'top10', nome: 'Top 10', icon: 'emoji_events' },
                    { key: 'melhorMes', nome: 'Melhor Mês', icon: 'calendar_month' },
                    { key: 'pontosCorridos', nome: 'Pontos Corridos', icon: 'format_list_numbered' },
                    { key: 'mataMata', nome: 'Mata-Mata', icon: 'sports' },
                    { key: 'artilheiro', nome: 'Artilheiro', icon: 'sports_soccer' },
                    { key: 'luvaOuro', nome: 'Luva de Ouro', icon: 'sports_handball' },
                    { key: 'campinho', nome: 'Campinho', icon: 'grid_on' },
                    { key: 'dicas', nome: 'Dicas', icon: 'lightbulb' }
                ];

                let html = '';

                // Seção Base
                html += `
                    <div class="section-title">
                        <span class="material-icons">shield</span>
                        <h2>Módulos Base</h2>
                        <span class="badge">${modulosBase.length}</span>
                    </div>
                    <div class="modulos-grid">
                `;

                modulosBase.forEach(modulo => {
                    const isAtivo = modulosAtivos[modulo.key] !== false;
                    html += `
                        <div class="modulo-card base ${isAtivo ? 'ativo' : 'inativo'}">
                            <div class="modulo-card-header">
                                <div class="modulo-card-info">
                                    <div class="modulo-icon">
                                        <span class="material-icons">${modulo.icon}</span>
                                    </div>
                                    <span class="modulo-title">${modulo.nome}</span>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        class="toggle-modulo"
                                        data-modulo-key="${modulo.key}"
                                        ${isAtivo ? 'checked' : ''}
                                    >
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="modulo-desc">${isAtivo ? 'Base' : '<strong style="color:#ff5500">⚙ Em manutenção</strong>'}</p>
                        </div>
                    `;
                });

                html += `
                    </div>
                    <div class="section-title" style="margin-top: var(--space-5);">
                        <span class="material-icons">extension</span>
                        <h2>Módulos Opcionais</h2>
                        <span class="badge">${modulosOpcionais.length}</span>
                    </div>
                    <div class="modulos-grid">
                `;

                modulosOpcionais.forEach(modulo => {
                    const isAtivo = modulosAtivos[modulo.key] === true;
                    html += `
                        <div class="modulo-card ${isAtivo ? 'ativo' : 'inativo'}">
                            <div class="modulo-card-header">
                                <div class="modulo-card-info">
                                    <div class="modulo-icon">
                                        <span class="material-icons">${modulo.icon}</span>
                                    </div>
                                    <span class="modulo-title">${modulo.nome}</span>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        class="toggle-modulo"
                                        data-modulo-key="${modulo.key}"
                                        ${isAtivo ? 'checked' : ''}
                                    >
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="modulo-desc">${isAtivo ? 'Ativo' : 'Inativo'}</p>
                        </div>
                    `;
                });

                html += '</div>';
                modalContent.innerHTML = html;
            }

            window.toggleModuloModal = async function(moduloKey, ativo) {
                if (!window.currentLigaId) return;

                try {
                    // Buscar estado atual dos módulos
                    const ligaRes = await fetch(`/api/ligas/${window.currentLigaId}`);
                    const ligaData = await ligaRes.json();
                    const modulosAtuais = ligaData.modulos_ativos || {};

                    // Atualizar apenas o módulo alterado
                    modulosAtuais[moduloKey] = ativo;

                    const response = await fetch(`/api/ligas/${window.currentLigaId}/modulos-ativos`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulos: modulosAtuais })
                    });

                    if (!response.ok) throw new Error('Erro ao atualizar módulo');

                    // Recarregar dados
                    const ligaResponse = await fetch(`/api/ligas/${window.currentLigaId}`);
                    const liga = await ligaResponse.json();
                    renderizarModulosModal(liga);
                } catch (error) {
                    console.error('Erro ao atualizar módulo:', error);
                    SuperModal.toast.error('Erro ao atualizar módulo. Tente novamente.');
                }
            };

        </script>
    </body>
</html>
