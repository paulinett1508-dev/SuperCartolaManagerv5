<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar Ligas - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link rel="stylesheet" href="css/modules/super-modal.css" />
        <script src="js/super-modal.js"></script>
    </head>
    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main gerenciar-page">
                <div class="gerenciar-content">
                    <!-- Header -->
                    <header class="gerenciar-header">
                        <div class="gerenciar-header-info">
                            <h1>Gerenciar Ligas & Módulos</h1>
                            <p>Administre ligas e configure módulos</p>
                        </div>
                        <a href="painel.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Stats Bar -->
                    <div class="stats-bar" id="statsBar" style="display: none;">
                        <div class="stat-chip">
                            <div class="stat-chip-icon">
                                <span class="material-icons">emoji_events</span>
                            </div>
                            <div class="stat-chip-content">
                                <span class="stat-chip-value" id="totalLigas">0</span>
                                <span class="stat-chip-label">Ligas</span>
                            </div>
                        </div>
                        <div class="stat-chip">
                            <div class="stat-chip-icon">
                                <span class="material-icons">people</span>
                            </div>
                            <div class="stat-chip-content">
                                <span class="stat-chip-value" id="totalParticipantes">0</span>
                                <span class="stat-chip-label">Participantes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Tools -->
                    <div class="admin-tools-bar" style="margin: 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span class="material-icons" style="color: #fbbf24; font-size: 28px;">build_circle</span>
                                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: white;">Ferramentas de Administração</h3>
                                </div>
                                <p style="margin: 0; font-size: 0.85rem; color: rgba(255, 255, 255, 0.8); padding-left: 2.5rem;">
                                    Validação e correção de extratos financeiros
                                </p>
                            </div>
                            <a href="admin-validacao-migracao.html"
                               style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; color: #1e3a8a; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"
                               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'">
                                <span class="material-icons">verified</span>
                                Validação de Migração PC/MM/Top10
                            </a>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="search-container">
                        <span class="search-icon">
                            <span class="material-icons">search</span>
                        </span>
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input"
                            placeholder="Buscar liga por nome ou ID..."
                        />
                    </div>

                    <!-- Liga List -->
                    <div id="ligasContainer">
                        <div class="liga-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Carregando ligas...</div>
                                <!-- ✅ FIX CRIT-003: Timeout visual após 10s -->
                                <div id="loadingTimeout" style="display: none; margin-top: 1.5rem; text-align: center;">
                                    <p style="color: var(--text-muted, #9ca3af); font-size: 0.85rem; margin-bottom: 0.75rem;">
                                        ⏱️ Está demorando mais que o esperado...
                                    </p>
                                    <button onclick="location.reload()" class="btn-criar">
                                        <span class="material-icons">refresh</span>
                                        Recarregar Página
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de Configuração de Módulos (dentro do main para SPA) -->
                <div id="modulosModal" class="modal-overlay" style="display: none;">
                    <div class="modal-container">
                        <div class="modal-header">
                            <div class="modal-header-content">
                                <div class="modal-icon">
                                    <span class="material-icons">widgets</span>
                                </div>
                                <div class="modal-title-group">
                                    <h2 class="modal-title">Configurar Módulos</h2>
                                    <p class="modal-subtitle" id="modalLigaNome">Liga sem nome</p>
                                </div>
                            </div>
                            <button class="modal-close" id="btnFecharModal">
                                <span class="material-icons">close</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <div class="modal-loading" id="modalLoading">
                                <div class="loading-spinner"></div>
                                <p class="loading-text">Carregando módulos...</p>
                            </div>

                            <div id="modalContent" style="display: none;">
                                <!-- Conteúdo será carregado dinamicamente -->
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button class="btn-modal-secondary" id="btnAbrirPaginaCompleta">
                                <span class="material-icons">open_in_new</span>
                                Abrir Página Completa
                            </button>
                            <button class="btn-modal-primary" id="btnConcluir">
                                <span class="material-icons">check</span>
                                Concluído
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            import {
                carregarLigas as carregarLigasAPI,
                deletarLiga,
            } from "./js/gerenciar-ligas.js";

            window.ligasData = [];

            // ✅ FIX CRIT-002: Helper para timeout em fetch
            async function fetchWithTimeout(url, options = {}, timeoutMs = 8000) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error(`Timeout: servidor não respondeu em ${timeoutMs / 1000}s`);
                    }
                    throw error;
                }
            }

            // Opcional: configura tamanho dos blocos no grid de valores do modal
            // window.MODAL_GRID_CHUNK_SIZE = 8;

            // ✅ FIX CRIT-001: Sistema de guards simplificado e robusto
            if (!window.__gerenciar_state) {
                window.__gerenciar_state = {
                    initialized: false,  // Página já foi inicializada alguma vez
                    initRunning: false,  // Inicialização em andamento
                    lastInitTimestamp: 0,
                    eventHandlers: {}    // Armazenar handlers para cleanup
                };
            }

            const DEBOUNCE_MS = 500; // Debounce robusto de 500ms
            const DEBUG = localStorage.getItem('debug-mode') === 'true';

            // Logger com níveis (FIX IMPT-002)
            const log = {
                debug: (...args) => DEBUG && console.log('[GERENCIAR]', ...args),
                warn: (...args) => console.warn('[GERENCIAR]', ...args),
                error: (...args) => console.error('[GERENCIAR]', ...args)
            };

            async function loadLayout() {
                try {
                    // ✅ FIX: Não recarregar layout se já existe sidebar (navegação SPA)
                    if (document.querySelector('.app-sidebar')) {
                        log.debug('Sidebar já existe, pulando loadLayout');
                        return;
                    }

                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document.getElementById("sidebar-placeholder")?.replaceWith(sidebar);
                    }

                    // ✅ FIX: Só injetar scripts do layout na PRIMEIRA carga
                    if (!window.__layoutScriptsInjected) {
                        window.__layoutScriptsInjected = true;
                        const scripts = doc.querySelectorAll("script");
                        scripts.forEach((script) => {
                            if (script.textContent.trim()) {
                                const newScript = document.createElement("script");
                                newScript.textContent = `(function(){${script.textContent}})();`;
                                document.head.appendChild(newScript);
                            }
                        });
                    }

                    // Garantir que AccordionManager seja inicializado
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            async function carregarListaLigas() {
                const container = document.getElementById("ligasContainer");

                try {
                    const ligas = await carregarLigasAPI();
                    window.ligasData = ligas;

                    if (!ligas || ligas.length === 0) {
                        container.innerHTML = `
                            <div class="liga-list">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <span class="material-icons">folder_open</span>
                                    </div>
                                    <div class="empty-title">Nenhuma liga criada</div>
                                    <div class="empty-subtitle">Comece criando sua primeira liga</div>
                                    <a href="criar-liga.html" class="btn-criar">
                                        <span class="material-icons">add</span>
                                        Criar Liga
                                    </a>
                                </div>
                            </div>
                        `;
                        document.getElementById("statsBar").style.display = "none";
                        return;
                    }

                    const totalParticipantes = ligas.reduce(
                        (sum, liga) => sum + (liga.timesCount || 0),
                        0,
                    );

                    document.getElementById("totalLigas").textContent = ligas.length;
                    document.getElementById("totalParticipantes").textContent = totalParticipantes;
                    document.getElementById("statsBar").style.display = "flex";

                    renderizarLigas(ligas);
                } catch (error) {
                    console.error("Erro ao carregar ligas:", error);
                    container.innerHTML = `
                        <div class="liga-list">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <span class="material-icons">error_outline</span>
                                </div>
                                <div class="empty-title">Erro ao carregar</div>
                                <div class="empty-subtitle">Não foi possível carregar as ligas</div>
                                <button onclick="location.reload()" class="btn-criar">
                                    <span class="material-icons">refresh</span>
                                    Tentar Novamente
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            function renderizarLigas(ligas) {
                const container = document.getElementById("ligasContainer");

                let html = '<div class="liga-list">';

                ligas.forEach((liga) => {
                    const timesCount = liga.times ? liga.times.length : 0;
                    const idCurto = liga._id ? liga._id.substring(0, 8) : "";
                    const nomeLiga = liga.nome || "Liga sem nome";

                    html += `
                        <div class="liga-item" data-id="${liga._id}" data-nome="${nomeLiga}">
                            <div class="liga-info">
                                <h4>${nomeLiga}</h4>
                                <p>ID: ${idCurto}... · ${timesCount} participantes</p>
                            </div>
                            <div class="liga-actions">
                                <a href="editar-liga.html?id=${liga._id}" class="btn-action btn-edit">
                                    <span class="material-icons">edit</span>
                                    Editar
                                </a>
                                <button class="btn-action btn-modules" data-liga-id="${liga._id}" data-liga-nome="${nomeLiga}">
                                    <span class="material-icons">widgets</span>
                                    Módulos
                                </button>
                                <button class="btn-action btn-delete" onclick="excluirLiga('${liga._id}', '${nomeLiga.replace(/'/g, "\\'")}')">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += "</div>";
                container.innerHTML = html;
            }

            window.excluirLiga = async function (id, nome) {
                if (!await SuperModal.confirm({ title: 'Excluir liga', message: `Excluir a liga "${nome}"?\n\nEsta ação é irreversível.`, confirmText: 'Excluir', variant: 'danger' })) {
                    return;
                }

                try {
                    await deletarLiga(id);
                    await carregarListaLigas();
                } catch (error) {
                    SuperModal.toast.error(`Erro ao excluir liga: ${error.message}`);
                }
            };

            // ✅ FIX CRIT-001: Event listener de busca (mantido)
            function setupSearchListener() {
                if (window.__gerenciar_state.eventHandlers.search) return;

                window.__gerenciar_state.eventHandlers.search = function (e) {
                    if (e.target.id === "searchInput") {
                        const searchTerm = e.target.value.toLowerCase();
                        const items = document.querySelectorAll(".liga-item");

                        items.forEach((item) => {
                            const nome = item.dataset.nome.toLowerCase();
                            const id = item.dataset.id.toLowerCase();
                            const visible = nome.includes(searchTerm) || id.includes(searchTerm);
                            item.style.display = visible ? "flex" : "none";
                        });
                    }
                };

                document.addEventListener("input", window.__gerenciar_state.eventHandlers.search);
            }

            // ✅ FIX CRIT-001: Função de inicialização robusta e consolidada
            async function initGerenciar() {
                const now = Date.now();
                const elapsed = now - window.__gerenciar_state.lastInitTimestamp;

                // Debounce rigoroso
                if (elapsed < DEBOUNCE_MS) {
                    log.warn('Debounce ativo, ignorando inicialização (elapsed:', elapsed, 'ms)');
                    return;
                }

                // Guard simples
                if (window.__gerenciar_state.initRunning) {
                    log.warn('Inicialização já em andamento, ignorando...');
                    return;
                }

                // Marcar como iniciando
                window.__gerenciar_state.initRunning = true;
                window.__gerenciar_state.lastInitTimestamp = now;
                log.debug('Inicializando página...');

                try {
                    await loadLayout();
                    log.debug('Layout carregado');

                    await carregarListaLigas();
                    log.debug('Lista de ligas carregada');

                    // ✅ FIX CRIT-003: Remover timeout visual se existir
                    const loadingTimeout = document.getElementById('loadingTimeout');
                    if (loadingTimeout) {
                        loadingTimeout.style.display = 'none';
                    }

                    window.__gerenciar_state.initialized = true;
                    log.debug('✅ Inicialização concluída com sucesso');
                } catch (error) {
                    log.error('❌ Erro durante inicialização:', error);

                    // Mostrar erro ao usuário
                    const container = document.getElementById("ligasContainer");
                    if (container) {
                        container.innerHTML = `
                            <div class="liga-list">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <span class="material-icons">error_outline</span>
                                    </div>
                                    <div class="empty-title">Erro ao carregar</div>
                                    <div class="empty-subtitle">${error.message}</div>
                                    <button onclick="location.reload()" class="btn-criar">
                                        <span class="material-icons">refresh</span>
                                        Recarregar Página
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                } finally {
                    // GARANTIR reset do guard mesmo em caso de erro
                    window.__gerenciar_state.initRunning = false;
                    const duration = Date.now() - now;
                    log.debug('Guard resetado (duração:', duration, 'ms)');
                }
            }

            // ✅ FIX CRIT-001: Sistema de inicialização consolidado e único
            function setupGerenciarPage() {
                // Prevenir múltiplas execuções
                if (window.__gerenciar_setup_done) {
                    log.debug('Setup já realizado, ignorando...');
                    return;
                }
                window.__gerenciar_setup_done = true;
                log.debug('Configurando página gerenciar.html...');

                // Listener para navegação SPA
                window.addEventListener('spa:navigated', (e) => {
                    const { pageName } = e.detail || {};
                    if (pageName === 'gerenciar.html') {
                        log.debug('Navegação SPA detectada, reinicializando...');
                        // ✅ FIX: Primeiro fazer cleanup dos listeners antigos
                        cleanupModalListeners();
                        // ✅ FIX: Resetar guards para permitir reinicialização
                        window.__gerenciar_state.initRunning = false;
                        initGerenciar();
                        // ✅ FIX: Re-inicializar botões e listeners do modal após navegação SPA
                        setTimeout(() => {
                            initModalButtons();
                            setupModalListeners();
                        }, 150);
                    }
                });

                // Configurar listeners de busca
                setupSearchListener();

                // Inicializar se DOM já estiver pronto
                if (document.readyState !== 'loading') {
                    log.debug('DOM pronto, inicializando...');
                    initGerenciar();
                } else {
                    document.addEventListener('DOMContentLoaded', () => {
                        log.debug('DOMContentLoaded, inicializando...');
                        initGerenciar();
                    }, { once: true });
                }

                // ✅ FIX CRIT-003: Timeout visual após 10s
                setTimeout(() => {
                    const container = document.getElementById('ligasContainer');
                    const isLoading = container?.querySelector('.loading-state');
                    if (isLoading) {
                        log.warn('Carregamento demorou mais que 10s, mostrando timeout visual...');
                        const timeoutEl = document.getElementById('loadingTimeout');
                        if (timeoutEl) {
                            timeoutEl.style.display = 'block';
                        }
                    }
                }, 10000);
            }

            // ✅ FIX IMPT-001: Função de cleanup completa
            function cleanupGerenciar() {
                const handlers = window.__gerenciar_state.eventHandlers;

                // Remover event listener de busca
                if (handlers.search) {
                    document.removeEventListener('input', handlers.search);
                    handlers.search = null;
                }

                // Remover event listeners do modal
                if (handlers.modalClick) {
                    document.removeEventListener('click', handlers.modalClick);
                    handlers.modalClick = null;
                }
                if (handlers.modalChange) {
                    document.removeEventListener('change', handlers.modalChange);
                    handlers.modalChange = null;
                }
                if (handlers.modalOverlay) {
                    document.removeEventListener('click', handlers.modalOverlay);
                    handlers.modalOverlay = null;
                }
                if (handlers.modalEsc) {
                    document.removeEventListener('keydown', handlers.modalEsc);
                    handlers.modalEsc = null;
                }

                // Fechar modal se estiver aberto
                const modal = document.getElementById('modulosModal');
                if (modal && modal.style.display !== 'none') {
                    window.fecharModalModulos();
                }

                // Resetar flags
                window.__gerenciar_state.initialized = false;
                window.__gerenciar_setup_done = false;

                log.debug('Cleanup completo - todos listeners removidos');
            }

            // Executar setup se estivermos na página correta
            if (window.location.pathname.includes('gerenciar.html')) {
                setupGerenciarPage();
            }

            // ✅ FIX: Cleanup de listeners do modal (necessário para navegação SPA)
            function cleanupModalListeners() {
                if (!window.__gerenciar_state) return;
                const handlers = window.__gerenciar_state.eventHandlers || {};
                if (handlers.modalClick) {
                    document.removeEventListener('click', handlers.modalClick);
                }
                if (handlers.modalChange) {
                    document.removeEventListener('change', handlers.modalChange);
                }
                if (handlers.modalOverlay) {
                    document.removeEventListener('click', handlers.modalOverlay);
                }
                if (handlers.modalEsc) {
                    document.removeEventListener('keydown', handlers.modalEsc);
                }
                // Resetar referências
                window.__gerenciar_state.eventHandlers = {};
                log.debug('Modal listeners removidos');
            }

            // ✅ FIX IMPT-001: Modal de módulos com event listeners gerenciáveis
            function setupModalListeners() {
                if (window.__gerenciar_state.eventHandlers.modalClick) return;

                window.currentLigaId = null;

                // Event delegation para botões de módulos
                window.__gerenciar_state.eventHandlers.modalClick = function(e) {
                    const btnModulos = e.target.closest('.btn-modules');
                    if (btnModulos) {
                        e.preventDefault();
                        e.stopPropagation();
                        const ligaId = btnModulos.dataset.ligaId;
                        const nomeLiga = btnModulos.dataset.ligaNome;
                        if (ligaId && nomeLiga) {
                            window.abrirModalModulos(ligaId, nomeLiga);
                        }
                    }
                };

                // Event delegation para toggles
                window.__gerenciar_state.eventHandlers.modalChange = function(e) {
                    if (e.target.classList.contains('toggle-modulo')) {
                        const moduloKey = e.target.dataset.moduloKey;
                        const ativo = e.target.checked;
                        if (moduloKey) {
                            window.toggleModuloModal(moduloKey, ativo);
                        }
                    }
                };

                // Fechar modal ao clicar no overlay
                window.__gerenciar_state.eventHandlers.modalOverlay = function(e) {
                    const modalOverlay = document.getElementById('modulosModal');
                    if (e.target === modalOverlay && modalOverlay.style.display !== 'none') {
                        window.fecharModalModulos();
                    }
                };

                // Fechar modal com ESC
                window.__gerenciar_state.eventHandlers.modalEsc = function(e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('modulosModal');
                        if (modal && modal.style.display !== 'none') {
                            window.fecharModalModulos();
                        }
                    }
                };

                document.addEventListener('click', window.__gerenciar_state.eventHandlers.modalClick);
                document.addEventListener('change', window.__gerenciar_state.eventHandlers.modalChange);
                document.addEventListener('click', window.__gerenciar_state.eventHandlers.modalOverlay);
                document.addEventListener('keydown', window.__gerenciar_state.eventHandlers.modalEsc);
            }

            // Configurar listeners do modal
            setupModalListeners();

            window.abrirModalModulos = async function(ligaId, nomeLiga) {
                window.currentLigaId = ligaId;
                const modal = document.getElementById('modulosModal');
                const modalLoading = document.getElementById('modalLoading');
                const modalContent = document.getElementById('modalContent');
                const modalLigaNome = document.getElementById('modalLigaNome');

                // Atualizar título
                modalLigaNome.textContent = nomeLiga;

                // Mostrar modal
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Resetar estado
                modalLoading.style.display = 'block';
                modalContent.style.display = 'none';

                try {
                    // ✅ FIX CRIT-002: Timeout de 8s no fetch
                    const response = await fetchWithTimeout(`/api/ligas/${ligaId}`, {}, 8000);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const liga = await response.json();

                    // Renderizar módulos
                    renderizarModulosModal(liga);

                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                } catch (error) {
                    log.error('Erro ao carregar módulos:', error);

                    const isTimeout = error.message.includes('Timeout');
                    modalContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <span class="material-icons">${isTimeout ? 'schedule' : 'error_outline'}</span>
                            </div>
                            <div class="empty-title">${isTimeout ? 'Timeout' : 'Erro ao carregar'}</div>
                            <div class="empty-subtitle">${error.message}</div>
                            <button onclick="window.abrirModalModulos('${ligaId}', '${nomeLiga}')" class="btn-criar" style="margin-top: 1rem;">
                                <span class="material-icons">refresh</span>
                                Tentar Novamente
                            </button>
                        </div>
                    `;
                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                }
            };

            window.fecharModalModulos = function() {
                const modal = document.getElementById('modulosModal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
                window.currentLigaId = null;
            };

            // Event listeners para botões do modal (quando DOM estiver pronto)
            function initModalButtons() {
                // Botão fechar (X)
                const btnFechar = document.getElementById('btnFecharModal');
                if (btnFechar) {
                    btnFechar.addEventListener('click', window.fecharModalModulos);
                }

                // Botão concluir
                const btnConcluir = document.getElementById('btnConcluir');
                if (btnConcluir) {
                    btnConcluir.addEventListener('click', window.fecharModalModulos);
                }

                // Botão abrir página completa
                const btnAbrirPagina = document.getElementById('btnAbrirPaginaCompleta');
                if (btnAbrirPagina) {
                    btnAbrirPagina.addEventListener('click', function() {
                        if (window.currentLigaId) {
                            window.location.href = 'gerenciar-modulos.html?id=' + window.currentLigaId;
                        }
                    });
                }
            }

            // Inicializar botões quando DOM estiver pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initModalButtons);
            } else {
                initModalButtons();
            }

            function renderizarModulosModal(liga) {
                const modalContent = document.getElementById('modalContent');
                const modulosAtivos = liga.modulos_ativos || {};

                // Módulos base (sempre ativos)
                const modulosBase = [
                    { key: 'extrato', nome: 'Extrato', icon: 'account_balance_wallet' },
                    { key: 'ranking', nome: 'Ranking', icon: 'leaderboard' },
                    { key: 'rodadas', nome: 'Rodadas', icon: 'calendar_today' },
                    { key: 'historico', nome: 'Hall da Fama', icon: 'military_tech' }
                ];

                // Módulos opcionais
                const modulosOpcionais = [
                    { key: 'top10', nome: 'Top 10', icon: 'emoji_events' },
                    { key: 'melhorMes', nome: 'Melhor Mês', icon: 'calendar_month' },
                    { key: 'pontosCorridos', nome: 'Pontos Corridos', icon: 'format_list_numbered' },
                    { key: 'mataMata', nome: 'Mata-Mata', icon: 'sports' },
                    { key: 'artilheiro', nome: 'Artilheiro', icon: 'sports_soccer' },
                    { key: 'luvaOuro', nome: 'Luva de Ouro', icon: 'sports_handball' },
                    { key: 'campinho', nome: 'Campinho', icon: 'grid_on' },
                    { key: 'dicas', nome: 'Dicas', icon: 'lightbulb' }
                ];

                let html = '';

                // Seção Base
                html += `
                    <div class="section-title">
                        <span class="material-icons">shield</span>
                        <h2>Módulos Base</h2>
                        <span class="badge">${modulosBase.length}</span>
                    </div>
                    <div class="modulos-grid">
                `;

                modulosBase.forEach(modulo => {
                    const isAtivo = modulosAtivos[modulo.key] !== false;
                    html += `
                        <div class="modulo-card base ${isAtivo ? 'ativo' : 'inativo'}">
                            <div class="modulo-card-header">
                                <div class="modulo-card-info">
                                    <div class="modulo-icon">
                                        <span class="material-icons">${modulo.icon}</span>
                                    </div>
                                    <span class="modulo-title">${modulo.nome}</span>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        class="toggle-modulo"
                                        data-modulo-key="${modulo.key}"
                                        ${isAtivo ? 'checked' : ''}
                                    >
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="modulo-desc">${isAtivo ? 'Base' : '<strong style="color:#ff5500">⚙ Em manutenção</strong>'}</p>
                        </div>
                    `;
                });

                html += `
                    </div>
                    <div class="section-title" style="margin-top: var(--space-5);">
                        <span class="material-icons">extension</span>
                        <h2>Módulos Opcionais</h2>
                        <span class="badge">${modulosOpcionais.length}</span>
                    </div>
                    <div class="modulos-grid">
                `;

                modulosOpcionais.forEach(modulo => {
                    const isAtivo = modulosAtivos[modulo.key] === true;
                    html += `
                        <div class="modulo-card ${isAtivo ? 'ativo' : 'inativo'}">
                            <div class="modulo-card-header">
                                <div class="modulo-card-info">
                                    <div class="modulo-icon">
                                        <span class="material-icons">${modulo.icon}</span>
                                    </div>
                                    <span class="modulo-title">${modulo.nome}</span>
                                </div>
                                <label class="toggle-switch">
                                    <input
                                        type="checkbox"
                                        class="toggle-modulo"
                                        data-modulo-key="${modulo.key}"
                                        ${isAtivo ? 'checked' : ''}
                                    >
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="modulo-desc">${isAtivo ? 'Ativo' : 'Inativo'}</p>
                        </div>
                    `;
                });

                html += '</div>';
                modalContent.innerHTML = html;
            }

            window.toggleModuloModal = async function(moduloKey, ativo) {
                if (!window.currentLigaId) return;

                try {
                    // ✅ FIX CRIT-002: Buscar estado atual com timeout
                    const ligaRes = await fetchWithTimeout(`/api/ligas/${window.currentLigaId}`, {}, 8000);
                    const ligaData = await ligaRes.json();
                    const modulosAtuais = ligaData.modulos_ativos || {};

                    // Atualizar apenas o módulo alterado
                    modulosAtuais[moduloKey] = ativo;

                    // ✅ FIX CRIT-002: Atualizar com timeout de 10s (operação de escrita)
                    const response = await fetchWithTimeout(`/api/ligas/${window.currentLigaId}/modulos-ativos`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ modulos: modulosAtuais })
                    }, 10000);

                    if (!response.ok) throw new Error('Erro ao atualizar módulo');

                    // ✅ FIX CRIT-002: Recarregar dados com timeout
                    const ligaResponse = await fetchWithTimeout(`/api/ligas/${window.currentLigaId}`, {}, 8000);
                    const liga = await ligaResponse.json();
                    renderizarModulosModal(liga);

                    SuperModal.toast.success('Módulo atualizado com sucesso!');
                } catch (error) {
                    log.error('Erro ao atualizar módulo:', error);
                    const errorMsg = error.message.includes('Timeout')
                        ? 'Timeout: servidor não respondeu a tempo'
                        : 'Erro ao atualizar módulo';
                    SuperModal.toast.error(errorMsg + '. Tente novamente.');
                }
            };

        </script>
    </body>
</html>
