<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar Ligas - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    </head>
    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main gerenciar-page">
                <div class="gerenciar-content">
                    <!-- Header -->
                    <header class="gerenciar-header">
                        <div class="gerenciar-header-info">
                            <h1>Gerenciar Ligas</h1>
                            <p>Administre suas ligas do Cartola FC</p>
                        </div>
                        <a href="ferramentas.html" class="btn-voltar">
                            <span class="material-icons">arrow_back</span>
                            Voltar
                        </a>
                    </header>

                    <!-- Stats Bar -->
                    <div class="stats-bar" id="statsBar" style="display: none;">
                        <div class="stat-chip">
                            <div class="stat-chip-icon">
                                <span class="material-icons">emoji_events</span>
                            </div>
                            <div class="stat-chip-content">
                                <span class="stat-chip-value" id="totalLigas">0</span>
                                <span class="stat-chip-label">Ligas</span>
                            </div>
                        </div>
                        <div class="stat-chip">
                            <div class="stat-chip-icon">
                                <span class="material-icons">people</span>
                            </div>
                            <div class="stat-chip-content">
                                <span class="stat-chip-value" id="totalParticipantes">0</span>
                                <span class="stat-chip-label">Participantes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="search-container">
                        <span class="search-icon">
                            <span class="material-icons">search</span>
                        </span>
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input"
                            placeholder="Buscar liga por nome ou ID..."
                        />
                    </div>

                    <!-- Liga List -->
                    <div id="ligasContainer">
                        <div class="liga-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Carregando ligas...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            import {
                carregarLigas as carregarLigasAPI,
                deletarLiga,
            } from "./js/gerenciar-ligas.js";

            window.ligasData = [];

            // ✅ Guards SPA para evitar dupla inicialização
            if (!window.__gerenciar_state) {
                window.__gerenciar_state = {
                    initRunning: false,
                    domBound: false,
                    spaBound: false,
                    inputBound: false,
                    readyChecked: false
                };
            }

            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document.getElementById("sidebar-placeholder")?.replaceWith(sidebar);
                    }

                    // Injetar scripts do layout
                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });

                    // Garantir que AccordionManager seja inicializado
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        if (typeof window.verificarMenuSuperAdmin === 'function') {
                            window.verificarMenuSuperAdmin();
                        }
                    }, 150);
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            async function carregarListaLigas() {
                const container = document.getElementById("ligasContainer");

                try {
                    const ligas = await carregarLigasAPI();
                    window.ligasData = ligas;

                    if (!ligas || ligas.length === 0) {
                        container.innerHTML = `
                            <div class="liga-list">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <span class="material-icons">folder_open</span>
                                    </div>
                                    <div class="empty-title">Nenhuma liga criada</div>
                                    <div class="empty-subtitle">Comece criando sua primeira liga</div>
                                    <a href="criar-liga.html" class="btn-criar">
                                        <span class="material-icons">add</span>
                                        Criar Liga
                                    </a>
                                </div>
                            </div>
                        `;
                        document.getElementById("statsBar").style.display = "none";
                        return;
                    }

                    const totalParticipantes = ligas.reduce(
                        (sum, liga) => sum + (liga.timesCount || 0),
                        0,
                    );

                    document.getElementById("totalLigas").textContent = ligas.length;
                    document.getElementById("totalParticipantes").textContent = totalParticipantes;
                    document.getElementById("statsBar").style.display = "flex";

                    renderizarLigas(ligas);
                } catch (error) {
                    console.error("Erro ao carregar ligas:", error);
                    container.innerHTML = `
                        <div class="liga-list">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <span class="material-icons">error_outline</span>
                                </div>
                                <div class="empty-title">Erro ao carregar</div>
                                <div class="empty-subtitle">Não foi possível carregar as ligas</div>
                                <button onclick="location.reload()" class="btn-criar">
                                    <span class="material-icons">refresh</span>
                                    Tentar Novamente
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            function renderizarLigas(ligas) {
                const container = document.getElementById("ligasContainer");

                let html = '<div class="liga-list">';

                ligas.forEach((liga) => {
                    const timesCount = liga.times ? liga.times.length : 0;
                    const idCurto = liga._id ? liga._id.substring(0, 8) : "";
                    const nomeLiga = liga.nome || "Liga sem nome";

                    html += `
                        <div class="liga-item" data-id="${liga._id}" data-nome="${nomeLiga}">
                            <div class="liga-info">
                                <h4>${nomeLiga}</h4>
                                <p>ID: ${idCurto}... · ${timesCount} participantes</p>
                            </div>
                            <div class="liga-actions">
                                <a href="editar-liga.html?id=${liga._id}" class="btn-action btn-edit">
                                    <span class="material-icons">edit</span>
                                    Editar
                                </a>
                                <button class="btn-action btn-modules" onclick="window.location.href='gerenciar-modulos.html?id=${liga._id}'">
                                    <span class="material-icons">widgets</span>
                                    Módulos
                                </button>
                                <button class="btn-action btn-delete" onclick="excluirLiga('${liga._id}', '${nomeLiga.replace(/'/g, "\\'")}')">
                                    <span class="material-icons">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += "</div>";
                container.innerHTML = html;
            }

            window.excluirLiga = async function (id, nome) {
                if (!confirm(`Excluir a liga "${nome}"?\n\nEsta ação é irreversível.`)) {
                    return;
                }

                try {
                    await deletarLiga(id);
                    await carregarListaLigas();
                } catch (error) {
                    alert(`Erro ao excluir liga: ${error.message}`);
                }
            };

            if (!window.__gerenciar_state.inputBound) {
                window.__gerenciar_state.inputBound = true;
                document.addEventListener("input", function (e) {
                    if (e.target.id === "searchInput") {
                        const searchTerm = e.target.value.toLowerCase();
                        const items = document.querySelectorAll(".liga-item");

                        items.forEach((item) => {
                            const nome = item.dataset.nome.toLowerCase();
                            const id = item.dataset.id.toLowerCase();
                            const visible = nome.includes(searchTerm) || id.includes(searchTerm);
                            item.style.display = visible ? "flex" : "none";
                        });
                    }
                });
            }

            // Função de inicialização reutilizável
            async function initGerenciar() {
                if (window.__gerenciar_state.initRunning) return;
                window.__gerenciar_state.initRunning = true;
                console.log("[GERENCIAR] Inicializando página...");
                try {
                    await loadLayout();
                    setTimeout(() => carregarListaLigas(), 100);
                } finally {
                    window.__gerenciar_state.initRunning = false;
                }
            }

            if (!window.__gerenciar_state.domBound) {
                window.__gerenciar_state.domBound = true;
                document.addEventListener("DOMContentLoaded", async () => {
                    if (!window.location.pathname.includes('gerenciar.html')) return;
                    await initGerenciar();
                });
            }

            // ✅ FIX: Reinicializar após navegação SPA
            if (!window.__gerenciar_state.spaBound) {
                window.__gerenciar_state.spaBound = true;
                window.addEventListener('spa:navigated', async (e) => {
                    const { pageName } = e.detail || {};
                    if (pageName === 'gerenciar.html') {
                        console.log('[GERENCIAR] Reinicializando após navegação SPA...');
                        await initGerenciar();
                    }
                });
            }

            // ✅ FIX: Inicializar se DOM já pronto (navegação SPA)
            if (!window.__gerenciar_state.readyChecked) {
                window.__gerenciar_state.readyChecked = true;
                if (document.readyState !== 'loading' && window.location.pathname.includes('gerenciar.html')) {
                    initGerenciar();
                }
            }
        </script>
    </body>
</html>
