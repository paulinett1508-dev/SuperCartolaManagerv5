<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gerenciar Ligas - Super Cartola Manager</title>
        <link rel="stylesheet" href="style.css" />
        <style>
            /* Container principal sem padding extra */
            .page-content {
                padding: 20px;
            }

            /* Bot√£o voltar adicionado */
            .voltar-button {
                margin-bottom: 20px;
            }

            .btn-voltar {
                padding: 10px 20px;
                background: var(--bg-card);
                color: var(--text-secondary);
                border: 1px solid var(--border-primary);
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-voltar:hover {
                background: var(--bg-card-hover);
                border-color: var(--laranja);
                color: var(--laranja);
            }

            /* T√≠tulo da p√°gina */
            .page-title {
                font-size: 24px;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 8px;
            }

            .page-subtitle {
                font-size: 14px;
                color: var(--text-muted);
                margin-bottom: 25px;
            }

            /* Estat√≠sticas compactas */
            .stats-bar {
                display: flex;
                gap: 30px;
                margin-bottom: 20px;
                padding: 15px 20px;
                background: rgba(255, 69, 0, 0.05);
                border-radius: 8px;
                border: 1px solid rgba(255, 69, 0, 0.2);
            }

            .stat-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .stat-label {
                font-size: 13px;
                color: var(--text-muted);
                font-weight: 500;
            }

            .stat-value {
                font-size: 18px;
                color: var(--laranja);
                font-weight: 700;
            }

            /* Busca */
            .search-container {
                max-width: 500px;
                margin-bottom: 20px;
                position: relative;
            }

            .search-input {
                width: 100%;
                padding: 12px 20px 12px 45px;
                background: var(--bg-card);
                border: 1px solid var(--border-primary);
                border-radius: 25px;
                color: var(--text-primary);
                font-size: 14px;
                outline: none;
                transition: all 0.3s ease;
            }

            .search-input:focus {
                border-color: var(--laranja);
                box-shadow: 0 0 0 3px var(--laranja-alpha);
            }

            .search-icon {
                position: absolute;
                left: 18px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 16px;
                color: var(--laranja);
            }

            /* Lista de ligas */
            .liga-list {
                background: var(--bg-card);
                border-radius: 12px;
                border: 1px solid var(--border-primary);
                overflow: hidden;
                box-shadow: var(--shadow-md);
            }

            .liga-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 18px 20px;
                border-bottom: 1px solid var(--border-secondary);
                transition: all 0.3s ease;
            }

            .liga-item:hover {
                background: rgba(255, 69, 0, 0.05);
            }

            .liga-item:last-child {
                border-bottom: none;
            }

            .liga-info {
                flex: 1;
            }

            .liga-info h4 {
                color: var(--text-primary);
                font-size: 15px;
                margin: 0 0 4px 0;
                font-weight: 600;
            }

            .liga-info p {
                font-size: 12px;
                color: var(--text-muted);
                margin: 0;
            }

            .liga-actions {
                display: flex;
                gap: 8px;
            }

            .btn-action {
                padding: 8px 14px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                border: none;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .btn-edit {
                background: rgba(59, 130, 246, 0.1);
                color: #3b82f6;
                border: 1px solid rgba(59, 130, 246, 0.3);
            }

            .btn-edit:hover {
                background: rgba(59, 130, 246, 0.2);
                transform: translateY(-1px);
            }

            .btn-rodadas {
                background: var(--gradient-primary);
                color: white;
                box-shadow: 0 2px 8px rgba(255, 69, 0, 0.3);
            }

            .btn-rodadas:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 69, 0, 0.4);
            }

            .btn-delete {
                background: rgba(239, 68, 68, 0.1);
                color: #ef4444;
                border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .btn-delete:hover {
                background: rgba(239, 68, 68, 0.2);
                transform: translateY(-1px);
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-muted);
            }

            .empty-icon {
                font-size: 48px;
                margin-bottom: 16px;
                opacity: 0.5;
            }

            .empty-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--text-secondary);
                margin-bottom: 8px;
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <!-- Sidebar ser√° injetado aqui -->
            <div id="sidebar-placeholder"></div>

            <!-- Conte√∫do principal -->
            <main class="app-main">
                <!-- Conte√∫do da p√°gina -->
                <div class="page-content">
                    <!-- Bot√£o Voltar -->
                    <div class="voltar-button">
                        <a href="ferramentas.html" class="btn-voltar">
                            ‚Üê Voltar para Ferramentas
                        </a>
                    </div>

                    <!-- T√≠tulo da p√°gina -->
                    <h1 class="page-title">Gerenciar Ligas</h1>
                    <p class="page-subtitle">
                        Administre suas ligas do Cartola FC
                    </p>

                    <!-- Estat√≠sticas -->
                    <div class="stats-bar" id="statsBar" style="display: none">
                        <div class="stat-item">
                            <span class="stat-label">Total de Ligas:</span>
                            <span class="stat-value" id="totalLigas">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label"
                                >Total de Participantes:</span
                            >
                            <span class="stat-value" id="totalParticipantes"
                                >0</span
                            >
                        </div>
                    </div>

                    <!-- Busca -->
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input"
                            placeholder="Buscar liga por nome ou ID..."
                        />
                    </div>

                    <!-- Container de Ligas -->
                    <div id="ligasContainer">
                        <div class="loading">Carregando ligas...</div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            import {
                carregarLigas,
                deletarLiga,
            } from "./js/gerenciar-ligas.js";

            // Vari√°vel global para armazenar ligas
            window.ligasData = [];

            // === CARREGAR LAYOUT (SEM HEADER) ===
            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    // Injetar apenas sidebar
                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document
                            .getElementById("sidebar-placeholder")
                            .replaceWith(sidebar);
                    }

                    // Executar scripts do layout
                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            // === CARREGAR LIGAS ===
            async function carregarListaLigas() {
                const container = document.getElementById("ligasContainer");

                try {
                    // Usar fun√ß√£o do m√≥dulo que tem cache e tratamento de erros
                    const ligas = await carregarLigas();
                    window.ligasData = ligas;

                    console.log(`${ligas.length} ligas carregadas com sucesso`);

                    if (!ligas || ligas.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üìã</div>
                                <div class="empty-title">Nenhuma liga criada</div>
                                <a href="criar-liga.html" class="btn-action btn-rodadas" style="margin-top: 20px;">
                                    ‚ûï Criar Primeira Liga
                                </a>
                            </div>
                        `;
                        document.getElementById("statsBar").style.display =
                            "none";
                        return;
                    }

                    // Atualizar estat√≠sticas usando timesCount j√° processado
                    const totalParticipantes = ligas.reduce(
                        (sum, liga) => sum + (liga.timesCount || 0),
                        0,
                    );

                    document.getElementById("totalLigas").textContent =
                        ligas.length;
                    document.getElementById("totalParticipantes").textContent =
                        totalParticipantes;
                    document.getElementById("statsBar").style.display = "flex";

                    // Renderizar ligas
                    renderizarLigas(ligas);
                } catch (error) {
                    console.error("Erro ao carregar ligas:", error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Erro ao carregar ligas</div>
                            <button onclick="location.reload()" class="btn-action btn-rodadas" style="margin-top: 20px;">
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }

            // === RENDERIZAR LIGAS ===
            function renderizarLigas(ligas) {
                const container = document.getElementById("ligasContainer");

                let html = '<div class="liga-list">';

                ligas.forEach((liga) => {
                    const timesCount = liga.times ? liga.times.length : 0;
                    const idCurto = liga._id ? liga._id.substring(0, 8) : "";
                    const nomeLiga = liga.nome || "Liga sem nome";

                    html += `
                        <div class="liga-item" data-id="${liga._id}" data-nome="${nomeLiga}">
                            <div class="liga-info">
                                <h4>${nomeLiga}</h4>
                                <p>ID: ${idCurto}... ‚Ä¢ ${timesCount} participantes</p>
                            </div>
                            <div class="liga-actions">
                                <a href="editar-liga.html?id=${liga._id}" class="btn-action btn-edit">
                                    ‚úèÔ∏è Editar
                                </a>
                                <button
                                    class="btn btn-primary"
                                    onclick="window.location.href='gerenciar-modulos.html?id=${liga._id}'"
                                    style="background: var(--gradient-primary);"
                                >
                                    ‚öôÔ∏è M√≥dulos
                                </button>
                                <button class="btn-action btn-delete" onclick="excluirLiga('${liga._id}', '${nomeLiga.replace(/'/g, "\\'")}')">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += "</div>";
                container.innerHTML = html;
            }

            // === EXCLUIR LIGA ===
            window.excluirLiga = async function (id, nome) {
                if (
                    !confirm(
                        `Tem certeza que deseja excluir a liga "${nome}"?\n\nEsta a√ß√£o √© irrevers√≠vel.`,
                    )
                ) {
                    return;
                }

                try {
                    // Usar fun√ß√£o do m√≥dulo que limpa cache automaticamente
                    await deletarLiga(id);

                    // Recarregar ligas com force refresh para garantir atualiza√ß√£o
                    await carregarListaLigas();
                } catch (error) {
                    alert(`Erro ao excluir liga: ${error.message}`);
                }
            };

            // === FILTRAR LIGAS ===
            document.addEventListener("input", function (e) {
                if (e.target.id === "searchInput") {
                    const searchTerm = e.target.value.toLowerCase();
                    const items = document.querySelectorAll(".liga-item");

                    items.forEach((item) => {
                        const nome = item.dataset.nome.toLowerCase();
                        const id = item.dataset.id.toLowerCase();
                        const visible =
                            nome.includes(searchTerm) ||
                            id.includes(searchTerm);
                        item.style.display = visible ? "flex" : "none";
                    });
                }
            });

            // === INICIALIZA√á√ÉO ===
            document.addEventListener("DOMContentLoaded", async () => {
                await loadLayout();
                // Delay para garantir que o layout est√° carregado
                setTimeout(() => carregarListaLigas(), 100);
            });
        </script>
    </body>
</html>