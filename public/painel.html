<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dashboard - Super Cartola Manager</title>
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="css/modules/dashboard.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/dashboard-unified.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link rel="stylesheet" href="css/modules/super-modal.css" />
        <script src="js/super-modal.js"></script>
    </head>
    <body>
        <div class="app-container">
            <!-- Sidebar será injetado aqui -->
            <div id="sidebar-placeholder"></div>

            <!-- Conteúdo principal -->
            <main class="app-main dashboard-redesign">
                <!-- Conteúdo da página -->
                <div class="page-content">
                    <!-- Header Analítico -->
                    <header class="dashboard-header">
                        <div class="dashboard-header-content">
                            <!-- Linha 1: Saudação + Status do Mercado -->
                            <div class="dashboard-header-top">
                                <div class="dashboard-header-greeting">
                                    <h2 id="dashboardGreeting">Bom dia</h2>
                                    <span class="dashboard-header-separator">|</span>
                                    <div class="dashboard-header-mercado" id="dashboardMercado">
                                        <span class="mercado-dot" id="mercadoDot"></span>
                                        <span id="mercadoLabel">Carregando...</span>
                                    </div>
                                    <span class="dashboard-header-separator">|</span>
                                    <div class="dashboard-header-rodada" id="dashboardRodada">
                                        <span class="material-icons" style="font-size: 16px;">sports_soccer</span>
                                        <span id="rodadaLabel">Rodada --</span>
                                    </div>
                                </div>
                                <div class="dashboard-header-actions">
                                    <button class="btn-secondary-new btn-sm" onclick="carregarDadosLigas()" title="Atualizar dados">
                                        <span class="material-icons">refresh</span>
                                    </button>
                                    <a href="preencher-liga.html" class="btn-primary-new btn-sm">
                                        <span class="material-icons">add</span>
                                        Nova Liga
                                    </a>
                                </div>
                            </div>

                            <!-- Linha 2: Barra de progresso da temporada -->
                            <div class="dashboard-header-progress" id="dashboardProgress">
                                <div class="progress-info">
                                    <span class="progress-label">Temporada <strong id="progressTemporada">--</strong></span>
                                    <span class="progress-percent" id="progressPercent">--%</span>
                                </div>
                                <div class="progress-bar-track">
                                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Linha 3: Alertas contextuais (aparecem se houver) -->
                            <div class="dashboard-header-alerts" id="dashboardAlerts" style="display: none;">
                                <!-- Preenchido dinamicamente -->
                            </div>
                        </div>
                    </header>

                    <!-- Estatísticas Globais - IDs MANTIDOS para JavaScript -->
                    <div class="dashboard-stats-new">
                        <div class="stat-card-new green">
                            <div class="stat-card-header">
                                <div class="stat-card-content">
                                    <p class="stat-label-new">Ligas Ativas</p>
                                    <h3 class="stat-number-new" id="totalLigas">0</h3>
                                </div>
                                <div class="stat-icon-new green">
                                    <span class="material-icons">emoji_events</span>
                                </div>
                            </div>
                            <div class="stat-card-footer positive">
                                <span class="material-icons">trending_up</span>
                                Campeonato ativo
                            </div>
                        </div>

                        <div class="stat-card-new blue">
                            <div class="stat-card-header">
                                <div class="stat-card-content">
                                    <p class="stat-label-new">Total Participantes</p>
                                    <h3 class="stat-number-new" id="totalParticipantes">0</h3>
                                </div>
                                <div class="stat-icon-new blue">
                                    <span class="material-icons">groups</span>
                                </div>
                            </div>
                            <div class="stat-card-footer">
                                <span class="stat-badge">32</span> na principal
                            </div>
                        </div>

                        <div class="stat-card-new yellow">
                            <div class="stat-card-header">
                                <div class="stat-card-content">
                                    <p class="stat-label-new">Clube Popular</p>
                                    <h3 class="stat-number-new text-lg" id="clubeMaisPopular">-</h3>
                                </div>
                                <div class="stat-icon-new yellow">
                                    <span class="material-icons">star</span>
                                </div>
                            </div>
                            <div class="stat-card-footer">
                                <span class="material-icons">favorite</span>
                                Mais torcido
                            </div>
                        </div>

                        <div class="stat-card-new purple">
                            <div class="stat-card-header">
                                <div class="stat-card-content">
                                    <p class="stat-label-new">Times Diferentes</p>
                                    <h3 class="stat-number-new" id="clubesUnicos">0</h3>
                                </div>
                                <div class="stat-icon-new purple">
                                    <span class="material-icons">category</span>
                                </div>
                            </div>
                            <div class="stat-card-footer">
                                Diversidade de clubes
                            </div>
                        </div>

                        <!-- Card Usuários Online - Clicável para abrir histórico -->
                        <div class="stat-card-new usuarios-online clicavel" id="cardUsuariosOnline" onclick="abrirModalHistoricoAcessos()" title="Clique para ver historico de acessos">
                            <div class="stat-card-header">
                                <div class="stat-card-content">
                                    <p class="stat-label-new">
                                        <span class="live-indicator"></span>
                                        Usuarios Online
                                    </p>
                                    <h3 class="stat-number-new" id="totalUsuariosOnline">0</h3>
                                </div>
                                <div class="stat-icon-new online">
                                    <span class="material-icons">visibility</span>
                                </div>
                            </div>
                            <div class="usuarios-online-lista" id="listaUsuariosOnline">
                                <div class="usuarios-online-empty">
                                    <span class="material-icons">hourglass_empty</span>
                                    <span>Carregando...</span>
                                </div>
                            </div>
                            <div class="stat-card-footer">
                                <span class="material-icons">schedule</span>
                                Ultimos 5 minutos
                            </div>
                        </div>
                    </div>

                    <!-- ========================================
                         SAÚDE DO SISTEMA - Colapsável (Fase 2)
                         ======================================== -->
                    <section class="health-section" id="healthSection">
                        <div class="health-section-header" onclick="toggleHealthSection()">
                            <div class="health-section-title">
                                <span class="material-icons">health_and_safety</span>
                                <span>Saúde do Sistema</span>
                            </div>
                            <div class="health-section-meta">
                                <div class="health-score-badge" id="healthScoreBadge">
                                    <span id="healthScoreValue">--</span>
                                </div>
                                <span class="material-icons health-toggle-icon">expand_more</span>
                            </div>
                        </div>
                        <div class="health-section-content">
                            <div class="health-section-inner">
                                <div id="healthComponentsContainer">
                                    <div class="health-loading">
                                        <span class="material-icons">hourglass_empty</span>
                                        <span>Carregando status...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- ========================================
                         ATALHOS RÁPIDOS (Fase 2)
                         ======================================== -->
                    <section class="quick-actions-section">
                        <div class="quick-actions-header">
                            <span class="material-icons">bolt</span>
                            <h3 class="quick-actions-title">Atalhos Rápidos</h3>
                        </div>
                        <div class="quick-actions-grid">
                            <a href="ferramentas-rodadas.html" class="quick-action-card">
                                <div class="quick-action-icon">
                                    <span class="material-icons">sports_score</span>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-label">Popular Rodadas</div>
                                    <div class="quick-action-description">Sincronizar dados da API</div>
                                </div>
                            </a>

                            <a href="fluxo-financeiro.html" class="quick-action-card">
                                <div class="quick-action-icon">
                                    <span class="material-icons">swap_horiz</span>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-label">Fluxo Financeiro</div>
                                    <div class="quick-action-description">Acertos e pagamentos</div>
                                </div>
                            </a>

                            <a href="analisar-participantes.html" class="quick-action-card">
                                <div class="quick-action-icon">
                                    <span class="material-icons">person_search</span>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-label">Participantes</div>
                                    <div class="quick-action-description">Análise e gestão</div>
                                </div>
                            </a>

                            <a href="criar-liga.html" class="quick-action-card">
                                <div class="quick-action-icon">
                                    <span class="material-icons">add_circle_outline</span>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-label">Nova Liga</div>
                                    <div class="quick-action-description">Criar competição</div>
                                </div>
                            </a>
                        </div>
                    </section>

                    <!-- Seção de Busca - ID MANTIDO -->
                    <div class="search-section-new">
                        <div class="search-icon-new">
                            <span class="material-icons">search</span>
                        </div>
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input-new"
                            placeholder="Pesquisar ligas, times ou cartoleiros..."
                            oninput="filtrarLigas()"
                        />
                    </div>

                    <!-- Container de Ligas - ID MANTIDO -->
                    <div id="ligasContainer">
                        <div class="loading-container-new">
                            <div class="loading-spinner-new"></div>
                            <div class="loading-text-new">Carregando suas ligas</div>
                            <div class="loading-subtitle-new">
                                Aguarde enquanto sincronizamos os dados<br />
                                do Super Cartola Manager...
                            </div>
                        </div>
                    </div>

                    <!-- Estado de erro - IDs MANTIDOS -->
                    <div
                        id="errorContainer"
                        class="error-container-new"
                        style="display: none"
                    >
                        <div class="error-icon-new">
                            <span class="material-icons">warning</span>
                        </div>
                        <div class="error-title-new">Erro ao Carregar Ligas</div>
                        <div class="error-message-new" id="errorMessage"></div>
                        <button
                            class="retry-btn-new"
                            onclick="carregarDadosLigas()"
                        >
                            <span class="material-icons">refresh</span>
                            Tentar Novamente
                        </button>
                    </div>

                    <!-- Estado vazio - ID MANTIDO -->
                    <div
                        id="emptyState"
                        class="empty-state-new"
                        style="display: none"
                    >
                        <div class="empty-icon-new">
                            <span class="material-icons">emoji_events</span>
                        </div>
                        <div class="empty-title-new">Nenhuma Liga Encontrada</div>
                        <div class="empty-subtitle-new">
                            Voce ainda nao criou nenhuma liga.<br />
                            Comece criando sua primeira liga do Cartola FC!
                        </div>
                        <a href="wizard-primeira-liga.html" class="empty-action-new">
                            <span class="material-icons">rocket_launch</span>
                            Criar Minha Primeira Liga
                        </a>
                    </div>
                </div>
            </main>

            <!-- Modal Histórico de Acessos -->
            <div class="modal-historico-overlay" id="modalHistoricoAcessos" style="display: none;">
                <div class="modal-historico-content">
                    <div class="modal-historico-header">
                        <div class="modal-historico-title">
                            <span class="material-icons">analytics</span>
                            <h3>Historico de Acessos</h3>
                        </div>
                        <button class="modal-historico-close" onclick="fecharModalHistorico()">
                            <span class="material-icons">close</span>
                        </button>
                    </div>

                    <div class="modal-historico-filtros">
                        <select id="filtroLigaHistorico" onchange="carregarHistoricoAcessos()">
                            <option value="">Todas as Ligas</option>
                        </select>
                        <div class="modal-historico-periodo">
                            <span class="material-icons">date_range</span>
                            <span>Ultimos 30 dias</span>
                        </div>
                    </div>

                    <div class="modal-historico-stats" id="statsHistorico">
                        <div class="stat-box">
                            <span class="stat-value" id="totalAcessosHistorico">0</span>
                            <span class="stat-label">Acessos</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value" id="totalUsuariosHistorico">0</span>
                            <span class="stat-label">Usuarios</span>
                        </div>
                    </div>

                    <div class="modal-historico-lista" id="listaHistoricoAcessos">
                        <div class="modal-historico-loading">
                            <span class="material-icons">hourglass_empty</span>
                            <span>Carregando historico...</span>
                        </div>
                    </div>

                    <div class="modal-historico-footer" id="footerHistorico" style="display: none;">
                        <button class="btn-carregar-mais" id="btnCarregarMais" onclick="carregarMaisHistorico()">
                            <span class="material-icons">expand_more</span>
                            Carregar mais
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import { carregarLigas as carregarLigasAPI } from "./js/gerenciar-ligas.js";
            import { cacheManager } from "./js/core/cache-manager.js";

            let ligasData = [];
            let estatisticasGlobais = {
                clubesDistribuicao: {},
                temposCadastro: [],
                totalParticipantes: 0,
            };

            // ✅ Guards SPA para evitar dupla inicialização
            if (!window.__painel_state) {
                window.__painel_state = {
                    initRunning: false,
                    domBound: false,
                    spaBound: false,
                    modalBound: false,
                    readyChecked: false
                };
            }

            // === CARREGAR LAYOUT ===
            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    // Injetar sidebar (com proteção contra re-execução)
                    const sidebar = doc.querySelector(".app-sidebar");
                    const placeholder = document.getElementById("sidebar-placeholder");
                    if (sidebar && placeholder) {
                        placeholder.replaceWith(sidebar);
                    } else if (sidebar && !placeholder) {
                        console.log("[PAINEL] Sidebar já injetado, pulando...");
                    }

                    // Injetar scripts do layout para accordions funcionarem
                    const scripts = doc.querySelectorAll("script");
                    console.log("[PAINEL] Scripts encontrados no layout:", scripts.length);
                    scripts.forEach((script, index) => {
                        if (script.textContent.trim()) {
                            console.log("[PAINEL] Injetando script", index + 1, "- primeiros 100 chars:", script.textContent.substring(0, 100));
                            const newScript = document.createElement("script");
                            newScript.textContent = `(function(){${script.textContent}})();`;
                            document.head.appendChild(newScript);
                        }
                    });
                    console.log("[PAINEL] verificarMenuSuperAdmin disponível?", typeof window.verificarMenuSuperAdmin);

                    // Garantir que AccordionManager seja inicializado
                    setTimeout(() => {
                        if (window.AccordionManager && !window.AccordionManager._initialized) {
                            window.AccordionManager.init();
                        }
                        // Verificar Super Admin para menu Administradores
                        verificarSuperAdminDireto();
                    }, 200);

                    // Função local para verificar Super Admin
                    async function verificarSuperAdminDireto() {
                        try {
                            console.log('[PAINEL] Verificando Super Admin...');
                            const response = await fetch('/api/admin/gestao/check-super', { credentials: 'include' });
                            if (!response.ok) {
                                console.log('[PAINEL] check-super falhou:', response.status);
                                return;
                            }
                            const data = await response.json();
                            console.log('[PAINEL] check-super result:', data);
                            const menuAdmin = document.getElementById('menuAdministradores');
                            if (menuAdmin) {
                                if (data.isSuperAdmin) {
                                    menuAdmin.style.cssText = 'display: list-item !important;';
                                    console.log('[PAINEL] Menu Administradores VISÍVEL');
                                } else {
                                    menuAdmin.style.cssText = 'display: none !important;';
                                    console.log('[PAINEL] Menu Administradores OCULTO');
                                }
                            } else {
                                console.log('[PAINEL] Elemento menuAdministradores não encontrado');
                            }
                        } catch (e) {
                            console.error('[PAINEL] Erro ao verificar Super Admin:', e);
                        }
                    }

                    // Definir funções de logo após injetar sidebar
                    definirFuncoesLogo();

                    // ✅ v9.5 FIX: Remoção de chamada duplicada
                    // NavigationSystem do layout.html já chama carregarLigasLayout() automaticamente
                    // Não chamar aqui para evitar dupla requisição
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            // === LOGOS DAS LIGAS (Dinâmico via campo liga.logo) ===
            // Não mais hardcoded - usa campo 'logo' do banco de dados

            // === FUNÇÕES DE LOGO ===
            function definirFuncoesLogo() {
                const logoTentativas = [
                    "img/logo-supercartola.png",
                    "../public/img/logo-supercartola.png",
                    "./public/img/logo-supercartola.png",
                ];
                let logoIndiceAtual = 0;

                window.tentarProximoCaminho = function (img) {
                    logoIndiceAtual++;
                    if (logoIndiceAtual < logoTentativas.length) {
                        img.src = logoTentativas[logoIndiceAtual];
                    } else {
                        const fallback =
                            document.getElementById("logoFallback");
                        if (fallback) fallback.style.display = "inline-block";
                        img.style.display = "none";
                    }
                };

                window.logoCarregada = function (img) {
                    const fallback = document.getElementById("logoFallback");
                    if (fallback) fallback.style.display = "none";
                    img.style.display = "block";
                };

                window.goToDashboard = function () {
                    window.location.href = "painel.html";
                };
            }

            // === BUSCAR DETALHES DOS TIMES (OTIMIZADO - BATCH) ===
            async function buscarDetalhesCompletos(ligas) {
                // Coletar todos os IDs de times de todas as ligas
                const todosTimeIds = [];
                const timeIdToLiga = new Map();

                for (const liga of ligas) {
                    const times = liga.times || [];
                    times.forEach(timeId => {
                        todosTimeIds.push(timeId);
                        timeIdToLiga.set(timeId, { ligaNome: liga.nome, ligaId: liga._id });
                    });
                }

                if (todosTimeIds.length === 0) return [];

                try {
                    // UMA UNICA requisicao batch ao inves de N requisicoes
                    const res = await fetch('/api/times/batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timeIds: todosTimeIds })
                    });

                    if (!res.ok) throw new Error('Batch failed');

                    const timesBatch = await res.json();
                    const timesMap = new Map(timesBatch.map(t => [t.id, t]));

                    // Montar resultado com dados da liga
                    return todosTimeIds.map(timeId => {
                        const ligaInfo = timeIdToLiga.get(timeId);
                        const timeData = timesMap.get(timeId);

                        if (timeData) {
                            return { ...timeData, ...ligaInfo };
                        }
                        return {
                            id: timeId,
                            nome_time: `Time ${timeId}`,
                            nome_cartoleiro: "N/D",
                            clube_id: null,
                            url_escudo_png: "",
                            ...ligaInfo
                        };
                    });
                } catch (error) {
                    console.warn('Batch fallback - usando dados basicos');
                    return todosTimeIds.map(timeId => ({
                        id: timeId,
                        nome_time: `Time ${timeId}`,
                        nome_cartoleiro: "N/D",
                        clube_id: null,
                        url_escudo_png: "",
                        ...timeIdToLiga.get(timeId)
                    }));
                }
            }

            // === CALCULAR ESTATÍSTICAS AVANÇADAS ===
            async function calcularEstatisticasAvancadas(ligas) {
                const timesDetalhados = await buscarDetalhesCompletos(ligas);

                const clubesCount = {};
                const tempos = [];

                timesDetalhados.forEach((time) => {
                    if (time.clube_id) {
                        const clubeNome = obterNomeClube(time.clube_id);
                        clubesCount[clubeNome] =
                            (clubesCount[clubeNome] || 0) + 1;
                    }

                    if (
                        time.cadastrado_em ||
                        time.created_at ||
                        time.data_criacao
                    ) {
                        const dataCadastro = new Date(
                            time.cadastrado_em ||
                                time.created_at ||
                                time.data_criacao,
                        );
                        const agora = new Date();
                        const diasAtras = Math.floor(
                            (agora - dataCadastro) / (1000 * 60 * 60 * 24),
                        );
                        tempos.push(diasAtras);
                    }
                });

                const clubeMaisPopular =
                    Object.keys(clubesCount).length > 0
                        ? Object.entries(clubesCount).sort(
                              (a, b) => b[1] - a[1],
                          )[0]
                        : ["Nenhum", 0];

                return {
                    clubesDistribuicao: clubesCount,
                    clubeMaisPopular: clubeMaisPopular,
                    clubesUnicos: Object.keys(clubesCount).length,
                    totalParticipantes: timesDetalhados.length,
                };
            }

            // === HELPER PARA NOMES DOS CLUBES ===
            function obterNomeClube(clubeId) {
                const clubes = {
                    262: "Flamengo",
                    263: "Botafogo",
                    264: "Corinthians",
                    266: "Fluminense",
                    267: "Vasco",
                    275: "Palmeiras",
                    276: "Sao Paulo",
                    277: "Santos",
                    283: "Cruzeiro",
                    292: "Atletico-MG",
                    344: "Atletico-GO",
                };
                return clubes[clubeId] || `Clube ${clubeId}`;
            }

            // === RENDERIZAR INSIGHTS ===
            function renderizarInsights(stats) {
                const clubesContainer =
                    document.getElementById("clubesDistribuicao");
                if (clubesContainer) {
                    const todosOsClubes = Object.entries(
                        stats.clubesDistribuicao,
                    ).sort((a, b) => b[1] - a[1]);

                    if (todosOsClubes.length === 0) {
                        clubesContainer.innerHTML = `
                            <div class="clube-stat-item vazio">
                                <span class="clube-nome">Nenhum clube do coracao definido ainda</span>
                            </div>
                        `;
                        return;
                    }

                    clubesContainer.innerHTML = todosOsClubes
                        .map(
                            ([clube, count], index) => `
                        <div class="clube-stat-item">
                            <span class="clube-posicao">${index + 1}o</span>
                            <span class="clube-nome">${clube}</span>
                            <span class="clube-count">${count}</span>
                        </div>
                    `,
                        )
                        .join("");
                }
            }

            // === CARREGAR DADOS DAS LIGAS ===
            async function carregarDadosLigas() {
                const container = document.getElementById("ligasContainer");
                const errorContainer =
                    document.getElementById("errorContainer");
                const emptyState = document.getElementById("emptyState");

                errorContainer.style.display = "none";
                emptyState.style.display = "none";

                container.innerHTML = `
                    <div class="loading-container-new">
                        <div class="loading-spinner-new"></div>
                        <div class="loading-text-new">Carregando suas ligas</div>
                        <div class="loading-subtitle-new">
                            Aguarde enquanto sincronizamos os dados<br>
                            do Super Cartola Manager...
                        </div>
                    </div>
                `;

                try {
                    const cacheKey = 'dashboard_ligas_{"all":true}';

                    ligasData = await cacheManager.get(
                        "ligas",
                        cacheKey,
                        async () => {
                            return await carregarLigasAPI();
                        },
                        { ttl: 86400000 },
                    );

                    // Se nao tem ligas, mostrar estado vazio (nao redirecionar)
                    if (ligasData.length === 0) {
                        console.log("[DASHBOARD] Nenhuma liga encontrada - exibindo estado vazio");
                        // O estado vazio ja esta no HTML (#emptyState)
                    }

                    estatisticasGlobais =
                        await calcularEstatisticasAvancadas(ligasData);

                    renderizarLigas(ligasData);
                    atualizarEstatisticasGlobais(estatisticasGlobais);
                } catch (error) {
                    console.error("Erro ao carregar ligas:", error);
                    container.innerHTML = "";
                    document.getElementById("errorMessage").textContent =
                        `Falha ao carregar ligas: ${error.message}`;
                    errorContainer.style.display = "block";
                    atualizarEstatisticas(0, 0);
                }
            }

            // === ATUALIZAR ESTATÍSTICAS GLOBAIS ===
            function atualizarEstatisticasGlobais(stats) {
                document.getElementById("totalLigas").textContent =
                    ligasData.length;
                document.getElementById("totalParticipantes").textContent =
                    stats.totalParticipantes;

                document.getElementById("clubesUnicos").textContent =
                    stats.clubesUnicos;

                const clubeElement =
                    document.getElementById("clubeMaisPopular");
                if (stats.clubeMaisPopular[0] !== "Nenhum") {
                    clubeElement.textContent = stats.clubeMaisPopular[0];
                    clubeElement.title = `${stats.clubeMaisPopular[1]} participantes`;
                } else {
                    clubeElement.textContent = "-";
                }
            }

            // === ATUALIZAR ESTATÍSTICAS (COMPATIBILIDADE) ===
            function atualizarEstatisticas(totalLigas, totalTimes) {
                console.log(
                    `Dashboard: ${totalLigas} ligas, ${totalTimes} participantes`,
                );
            }

            // === RENDERIZAR LIGAS (NOVO DESIGN) ===
            function renderizarLigas(ligas) {
                const container = document.getElementById("ligasContainer");

                if (ligas.length === 0) {
                    container.innerHTML = "";
                    document.getElementById("emptyState").style.display =
                        "block";
                    return;
                }

                // Separar liga principal (SuperCartola) das outras
                const ligaPrincipal = ligas.find(l => l.nome && l.nome.toLowerCase().includes('super'));
                const outrasLigas = ligas.filter(l => l !== ligaPrincipal);

                let html = '';

                // Renderizar Liga Principal em destaque (se existir)
                if (ligaPrincipal) {
                    const timesCount = ligaPrincipal.times?.length || ligaPrincipal.participantes?.length || 0;
                    const ligaId = ligaPrincipal._id;

                    html += `
                        <section class="liga-section">
                            <div class="liga-section-header">
                                <h3 class="liga-section-title">
                                    <span class="accent-bar"></span>
                                    ${ligaPrincipal.nome}
                                </h3>
                                <span class="liga-status-badge active">Em andamento</span>
                            </div>
                            <div class="liga-card-featured liga-card" data-liga-id="${ligaId}" data-participantes="${timesCount}">
                                <div class="liga-card-featured-content">
                                    <div class="liga-card-featured-inner">
                                        <div class="liga-icon-large">
                                            <span class="material-icons">emoji_events</span>
                                        </div>
                                        <div class="liga-card-info">
                                            <h4>${ligaPrincipal.nome}</h4>
                                            <p>A maior competicao da temporada. Premiacao por rodada e campeonato geral.</p>
                                            <div class="liga-card-tags">
                                                <span class="liga-tag">
                                                    <span class="material-icons">groups</span>
                                                    ${timesCount} Participantes
                                                </span>
                                                <span class="liga-tag">
                                                    <span class="material-icons">payments</span>
                                                    Sistema Financeiro
                                                </span>
                                                <span class="liga-tag">
                                                    <span class="material-icons">event</span>
                                                    38 Rodadas
                                                </span>
                                            </div>
                                        </div>
                                        <div class="liga-card-action">
                                            <a href="detalhe-liga.html?id=${ligaId}" class="btn-liga-details">
                                                Ver Detalhes da Liga
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="liga-card-featured-footer">
                                    <div class="liga-leader-info">
                                        <span class="label">Liga principal:</span>
                                        <div class="leader">
                                            <span class="material-icons">emoji_events</span>
                                            <span class="leader-name">${timesCount} times competindo</span>
                                        </div>
                                    </div>
                                    <div class="liga-update-info" id="clube-predominante-${ligaId}">
                                        <span class="meta-value">Carregando...</span>
                                    </div>
                                </div>
                            </div>
                        </section>
                    `;
                }

                // Renderizar outras ligas se existirem
                if (outrasLigas.length > 0) {
                    html += `
                        <section class="liga-section">
                            <div class="liga-section-header">
                                <h3 class="liga-section-title">
                                    <span class="accent-bar gray"></span>
                                    Outras Ligas
                                </h3>
                            </div>
                            <div class="ligas-grid ligas-grid-new">
                    `;

                    outrasLigas.forEach(liga => {
                        const timesCount = liga.times?.length || liga.participantes?.length || 0;
                        const ligaId = liga._id;
                        const iniciais = (liga.nome || 'LG').substring(0, 2).toUpperCase();

                        html += `
                            <div class="liga-card liga-card-new" data-liga-id="${ligaId}" data-participantes="${timesCount}">
                                <div class="liga-card-new-header">
                                    <div class="liga-card-avatar">${iniciais}</div>
                                    <span class="liga-card-type-badge ativa">Ativa</span>
                                </div>
                                <h4>${liga.nome}</h4>
                                <p>Liga com ${timesCount} participantes competindo.</p>
                                <div class="liga-card-new-footer">
                                    <div class="liga-card-date" id="clube-predominante-${ligaId}">
                                        <span class="material-icons">sports_soccer</span>
                                        <span class="meta-value">${timesCount} times</span>
                                    </div>
                                    <a href="detalhe-liga.html?id=${ligaId}" class="liga-card-link">Acessar &rarr;</a>
                                </div>
                            </div>
                        `;
                    });

                    // Card para criar nova liga
                    html += `
                            <a href="preencher-liga.html" class="liga-card-create">
                                <div class="liga-card-create-icon">
                                    <span class="material-icons">add</span>
                                </div>
                                <h4>Criar Nova Liga</h4>
                                <p>Comece uma nova competicao</p>
                            </a>
                        </div>
                    </section>
                    `;
                }

                // Se só tem liga principal, adicionar seção de criar liga
                if (!outrasLigas.length && ligaPrincipal) {
                    html += `
                        <section class="liga-section">
                            <div class="liga-section-header">
                                <h3 class="liga-section-title">
                                    <span class="accent-bar gray"></span>
                                    Outras Ligas
                                </h3>
                            </div>
                            <div class="ligas-grid ligas-grid-new">
                                <a href="preencher-liga.html" class="liga-card-create">
                                    <div class="liga-card-create-icon">
                                        <span class="material-icons">add</span>
                                    </div>
                                    <h4>Criar Nova Liga</h4>
                                    <p>Comece uma nova competicao</p>
                                </a>
                            </div>
                        </section>
                    `;
                }

                container.innerHTML = html;
                carregarDetalhesEspecificosLigas(ligas);
            }

            // === CARREGAR DETALHES ESPECÍFICOS (OTIMIZADO - USA CACHE) ===
            async function carregarDetalhesEspecificosLigas(ligas) {
                // Coletar todos os IDs de times
                const todosTimeIds = [];
                ligas.forEach(liga => {
                    (liga.times || []).forEach(id => todosTimeIds.push(id));
                });

                if (todosTimeIds.length === 0) return;

                // Buscar todos de uma vez via batch
                let timesMap = new Map();
                try {
                    const res = await fetch('/api/times/batch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timeIds: todosTimeIds })
                    });
                    if (res.ok) {
                        const timesBatch = await res.json();
                        timesMap = new Map(timesBatch.map(t => [t.id, t]));
                    }
                } catch (e) {
                    console.warn('Batch error:', e);
                }

                // Processar cada liga com os dados ja carregados
                for (const liga of ligas) {
                    const ligaId = liga._id;
                    const times = liga.times || [];
                    if (times.length === 0) continue;

                    const clubesLiga = {};
                    times.forEach(timeId => {
                        const time = timesMap.get(timeId);
                        if (time?.clube_id) {
                            const clube = obterNomeClube(time.clube_id);
                            clubesLiga[clube] = (clubesLiga[clube] || 0) + 1;
                        }
                    });

                    const clubePredominante =
                        Object.keys(clubesLiga).length > 0
                            ? Object.entries(clubesLiga).sort((a, b) => b[1] - a[1])[0]
                            : null;

                    const clubeElement = document.getElementById(`clube-predominante-${ligaId}`);
                    if (clubeElement && clubePredominante) {
                        const metaValue = clubeElement.querySelector(".meta-value");
                        if (metaValue) {
                            metaValue.textContent = `Clube top: ${clubePredominante[0]} (${clubePredominante[1]})`;
                        }
                    }
                }
            }

            // === FILTRO DE BUSCA ===
            window.filtrarLigas = function () {
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase()
                    .trim();
                const ligaCards = document.querySelectorAll(".liga-card");

                ligaCards.forEach((card) => {
                    const nomeLiga = card.querySelector("h4")?.textContent.toLowerCase() ||
                                     card.querySelector("h3")?.textContent.toLowerCase() || "";
                    const idLiga = card
                        .getAttribute("data-liga-id")?.toLowerCase() || "";
                    const timesCount = card.getAttribute("data-participantes") || "";
                    const clubeTop =
                        card
                            .querySelector(
                                '[id^="clube-predominante-"] .meta-value',
                            )
                            ?.textContent.toLowerCase() || "";

                    const isVisible =
                        nomeLiga.includes(searchTerm) ||
                        idLiga.includes(searchTerm) ||
                        timesCount.includes(searchTerm) ||
                        clubeTop.includes(searchTerm);

                    // Esconder a section inteira se for liga featured
                    const section = card.closest('.liga-section');
                    if (card.classList.contains('liga-card-featured')) {
                        if (section) section.style.display = isVisible ? "block" : "none";
                    } else {
                        card.style.display = isVisible ? "block" : "none";
                    }
                });
            };

            // === Funções auxiliares para gerenciar estados da UI ===
            function mostrarEstado(estado) {
                const container = document.getElementById("ligasContainer");
                const errorContainer =
                    document.getElementById("errorContainer");
                const emptyState = document.getElementById("emptyState");

                container.style.display = "none";
                errorContainer.style.display = "none";
                emptyState.style.display = "none";

                switch (estado) {
                    case "loading":
                        container.innerHTML = `
                            <div class="loading-container-new">
                                <div class="loading-spinner-new"></div>
                                <div class="loading-text-new">Carregando suas ligas</div>
                                <div class="loading-subtitle-new">
                                    Aguarde enquanto sincronizamos os dados<br>
                                    do Super Cartola Manager...
                                </div>
                            </div>
                        `;
                        container.style.display = "block";
                        break;
                    case "empty":
                        emptyState.style.display = "block";
                        break;
                    case "error":
                        errorContainer.style.display = "block";
                        break;
                    case "loaded":
                        container.style.display = "block";
                        break;
                }
            }

            // === VERIFICAR AUTENTICAÇÃO ===
            async function verificarAutenticacao() {
                try {
                    console.log("[DASHBOARD] Verificando autenticacao...");
                    const response = await fetch("/api/admin/auth/session", {
                        credentials: "include",
                    });

                    console.log(
                        "[DASHBOARD] Response status:",
                        response.status,
                    );

                    if (!response.ok) {
                        console.log(
                            "[DASHBOARD] Nao autenticado, redirecionando para login",
                        );
                        window.location.href = "/";
                        return false;
                    }

                    const data = await response.json();
                    console.log("[DASHBOARD] Auth data:", data);

                    if (!data.authenticated) {
                        console.log("[DASHBOARD] Usuario nao autenticado");
                        window.location.href = "/";
                        return false;
                    }

                    const userNameElement = document.getElementById("userName");
                    if (userNameElement && data.admin) {
                        userNameElement.textContent =
                            data.admin.nome || "Admin";
                    }

                    console.log("[DASHBOARD] Autenticacao confirmada");
                    return true;
                } catch (error) {
                    console.error(
                        "[DASHBOARD] Erro ao verificar autenticacao:",
                        error,
                    );
                    window.location.href = "/";
                    return false;
                }
            }

            // === CARREGAR USUÁRIOS ONLINE ===
            let usuariosOnlineInterval = null;

            async function carregarUsuariosOnline() {
                try {
                    const response = await fetch('/api/admin/usuarios-online', {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Erro ao buscar');

                    const data = await response.json();
                    const totalEl = document.getElementById('totalUsuariosOnline');
                    const listaEl = document.getElementById('listaUsuariosOnline');

                    if (totalEl) totalEl.textContent = data.total || 0;

                    if (listaEl) {
                        if (!data.usuarios || data.usuarios.length === 0) {
                            listaEl.innerHTML = `
                                <div class="usuarios-online-empty">
                                    <span class="material-icons">person_off</span>
                                    <span>Nenhum usuario online</span>
                                </div>
                            `;
                        } else {
                            listaEl.innerHTML = data.usuarios.slice(0, 5).map(u => `
                                <div class="usuario-online-item">
                                    <div class="usuario-avatar">
                                        ${u.escudo
                                            ? `<img src="${u.escudo}" alt="" onerror="this.outerHTML='<span class=\\'material-icons\\'>person</span>'" />`
                                            : '<span class="material-icons">person</span>'
                                        }
                                    </div>
                                    <div class="usuario-info">
                                        <span class="usuario-nome">${u.nome_time || 'Time'}</span>
                                        <span class="usuario-liga">${u.liga_nome || ''}</span>
                                    </div>
                                    <div class="usuario-meta">
                                        <span class="usuario-modulo">${formatarModulo(u.modulo_atual)}</span>
                                        <span class="usuario-tempo">${u.tempo_online}</span>
                                    </div>
                                </div>
                            `).join('');
                        }
                    }
                } catch (error) {
                    console.error('[UsuariosOnline] Erro:', error);
                }
            }

            function formatarModulo(modulo) {
                const modulos = {
                    'home': 'Inicio',
                    'extrato': 'Extrato',
                    'ranking': 'Ranking',
                    'rodadas': 'Rodadas',
                    'top10': 'Top 10',
                    'mata-mata': 'Mata-Mata',
                    'pontos-corridos': 'Pontos Corridos',
                    'artilheiro': 'Artilheiro',
                    'luva-de-ouro': 'Luva de Ouro',
                    'melhor-mes': 'Melhor Mes'
                };
                return modulos[modulo] || modulo || 'App';
            }

            function iniciarAtualizacaoUsuariosOnline() {
                carregarUsuariosOnline();
                if (usuariosOnlineInterval) clearInterval(usuariosOnlineInterval);
                usuariosOnlineInterval = setInterval(carregarUsuariosOnline, 30000);
            }

            // === HISTÓRICO DE ACESSOS ===
            let historicoPage = 1;
            let historicoHasMore = false;
            let ligasHistorico = [];

            async function abrirModalHistoricoAcessos() {
                const modal = document.getElementById('modalHistoricoAcessos');
                if (!modal) return;

                modal.style.display = 'flex';
                historicoPage = 1;

                // Carregar ligas para o filtro
                await carregarLigasHistorico();

                // Carregar histórico
                await carregarHistoricoAcessos();
            }

            function fecharModalHistorico() {
                const modal = document.getElementById('modalHistoricoAcessos');
                if (modal) modal.style.display = 'none';
            }

            async function carregarLigasHistorico() {
                try {
                    const response = await fetch('/api/admin/usuarios-online/ligas', {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Erro ao buscar ligas');

                    const data = await response.json();
                    ligasHistorico = data.ligas || [];

                    const select = document.getElementById('filtroLigaHistorico');
                    if (select) {
                        select.innerHTML = '<option value="">Todas as Ligas</option>' +
                            ligasHistorico.map(l =>
                                `<option value="${l.liga_id}">${l.liga_nome} (${l.total_acessos} acessos)</option>`
                            ).join('');
                    }
                } catch (error) {
                    console.error('[Historico] Erro ao carregar ligas:', error);
                }
            }

            async function carregarHistoricoAcessos(reset = true) {
                if (reset) historicoPage = 1;

                const ligaId = document.getElementById('filtroLigaHistorico')?.value || '';
                const listaEl = document.getElementById('listaHistoricoAcessos');
                const footerEl = document.getElementById('footerHistorico');

                if (reset && listaEl) {
                    listaEl.innerHTML = `
                        <div class="modal-historico-loading">
                            <span class="material-icons">hourglass_empty</span>
                            <span>Carregando historico...</span>
                        </div>
                    `;
                }

                try {
                    const url = `/api/admin/usuarios-online/historico?page=${historicoPage}&limit=20${ligaId ? '&liga=' + ligaId : ''}`;
                    const response = await fetch(url, {
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Erro ao buscar histórico');

                    const data = await response.json();

                    // Atualizar stats
                    document.getElementById('totalAcessosHistorico').textContent = data.total_acessos || 0;
                    document.getElementById('totalUsuariosHistorico').textContent = data.total_usuarios || 0;

                    // Renderizar lista
                    if (!data.usuarios || data.usuarios.length === 0) {
                        listaEl.innerHTML = `
                            <div class="modal-historico-empty">
                                <span class="material-icons">person_off</span>
                                <span>Nenhum acesso registrado no periodo</span>
                            </div>
                        `;
                        footerEl.style.display = 'none';
                        return;
                    }

                    const html = data.usuarios.map(u => `
                        <div class="historico-item">
                            <div class="historico-avatar">
                                ${u.escudo
                                    ? `<img src="${u.escudo}" alt="" onerror="this.outerHTML='<span class=\\'material-icons\\'>person</span>'" />`
                                    : '<span class="material-icons">person</span>'
                                }
                            </div>
                            <div class="historico-info">
                                <span class="historico-nome">${u.nome_time || 'Time'}</span>
                                <span class="historico-liga">${u.liga_nome || ''}</span>
                            </div>
                            <div class="historico-meta">
                                <span class="historico-acessos">${u.total_acessos} ${u.total_acessos === 1 ? 'acesso' : 'acessos'}</span>
                                <span class="historico-ultimo">${u.ultimo_acesso_relativo}</span>
                            </div>
                        </div>
                    `).join('');

                    if (reset) {
                        listaEl.innerHTML = html;
                    } else {
                        listaEl.insertAdjacentHTML('beforeend', html);
                    }

                    // Mostrar/ocultar botão de carregar mais
                    historicoHasMore = data.has_more;
                    footerEl.style.display = historicoHasMore ? 'flex' : 'none';

                } catch (error) {
                    console.error('[Historico] Erro:', error);
                    listaEl.innerHTML = `
                        <div class="modal-historico-error">
                            <span class="material-icons">error_outline</span>
                            <span>Erro ao carregar historico</span>
                        </div>
                    `;
                }
            }

            async function carregarMaisHistorico() {
                if (!historicoHasMore) return;
                historicoPage++;
                await carregarHistoricoAcessos(false);
            }

            // Fechar modal ao clicar fora
            if (!window.__painel_state.modalBound) {
                window.__painel_state.modalBound = true;
                document.addEventListener('click', (e) => {
                    const modal = document.getElementById('modalHistoricoAcessos');
                    if (modal && e.target === modal) {
                        fecharModalHistorico();
                    }
                });
            }

            // Expor funções globalmente
            window.abrirModalHistoricoAcessos = abrirModalHistoricoAcessos;
            window.fecharModalHistorico = fecharModalHistorico;
            window.carregarHistoricoAcessos = carregarHistoricoAcessos;
            window.carregarMaisHistorico = carregarMaisHistorico;

            // Função de inicialização reutilizável
            async function initPainel() {
                if (window.__painel_state.initRunning) return;
                window.__painel_state.initRunning = true;
                console.log("[DASHBOARD] Inicializando dashboard...");

                try {
                    const autenticado = await verificarAutenticacao();

                    if (autenticado) {
                        console.log(
                            "[DASHBOARD] Usuario autenticado, carregando ligas...",
                        );
                        await loadLayout();
                        await carregarDadosLigas();
                        carregarHeaderAnalitico();
                        iniciarAtualizacaoUsuariosOnline();
                    } else {
                        console.log("[DASHBOARD] Autenticacao falhou");
                    }
                } finally {
                    window.__painel_state.initRunning = false;
                }
            }

            // === Inicializar quando a página carregar ===
            if (!window.__painel_state.domBound) {
                window.__painel_state.domBound = true;
                document.addEventListener("DOMContentLoaded", async () => {
                    // Verificar se estamos na página painel
                    if (!window.location.pathname.includes('painel.html')) {
                        return;
                    }
                    await initPainel();
                });
            }

            // ✅ FIX: Reinicializar após navegação SPA
            if (!window.__painel_state.spaBound) {
                window.__painel_state.spaBound = true;
                window.addEventListener('spa:navigated', async (e) => {
                    const { pageName } = e.detail || {};
                    if (pageName === 'painel.html') {
                        console.log('[DASHBOARD] Reinicializando após navegação SPA...');
                        await initPainel();
                    }
                });
            }

            // ✅ FIX: Também inicializar se o DOM já estiver pronto (para navegação SPA)
            if (!window.__painel_state.readyChecked) {
                window.__painel_state.readyChecked = true;
                if (document.readyState !== 'loading' && window.location.pathname.includes('painel.html')) {
                    initPainel();
                }
            }

            // === HEADER ANALÍTICO ===
            function atualizarSaudacao() {
                const hora = new Date().getHours();
                let saudacao = 'Boa noite';
                if (hora >= 5 && hora < 12) saudacao = 'Bom dia';
                else if (hora >= 12 && hora < 18) saudacao = 'Boa tarde';

                const el = document.getElementById('dashboardGreeting');
                if (el) {
                    const nome = document.getElementById('userName')?.textContent || 'Admin';
                    el.textContent = `${saudacao}, ${nome}`;
                }
            }

            async function carregarHeaderAnalitico() {
                try {
                    // Buscar status do sistema (mercado + temporada) e manutenção em paralelo
                    const [systemRes, manutRes] = await Promise.all([
                        fetch('/api/app/system-status', { credentials: 'include' }),
                        fetch('/api/admin/manutencao', { credentials: 'include' })
                    ]);

                    // Saudação contextual
                    atualizarSaudacao();

                    let sys = null;
                    const alerts = [];

                    // Status do Mercado
                    if (systemRes.ok) {
                        sys = await systemRes.json();
                        const mercado = sys.mercado || {};
                        const temporada = sys.temporada || {};

                        // Dot + Label do mercado
                        const dot = document.getElementById('mercadoDot');
                        const label = document.getElementById('mercadoLabel');
                        if (dot && label) {
                            if (mercado.mercado_aberto) {
                                dot.className = 'mercado-dot aberto';
                                label.textContent = 'Mercado Aberto';
                            } else if (mercado.temporada_encerrada || mercado.game_over) {
                                dot.className = 'mercado-dot encerrado';
                                label.textContent = 'Temporada Encerrada';
                            } else {
                                dot.className = 'mercado-dot fechado';
                                label.textContent = 'Mercado Fechado';
                            }
                        }

                        // Rodada
                        const rodadaLabel = document.getElementById('rodadaLabel');
                        const rodadaAtual = mercado.rodada_atual || 0;
                        const rodadaFinal = temporada.rodada_final || 38;
                        if (rodadaLabel) {
                            rodadaLabel.textContent = `Rodada ${rodadaAtual} de ${rodadaFinal}`;
                        }

                        // Barra de progresso
                        const tempoAtual = temporada.atual || mercado.temporada || new Date().getFullYear();
                        const percent = rodadaFinal > 0 ? Math.round((rodadaAtual / rodadaFinal) * 100) : 0;

                        const progressTemporada = document.getElementById('progressTemporada');
                        const progressPercent = document.getElementById('progressPercent');
                        const progressBarFill = document.getElementById('progressBarFill');

                        if (progressTemporada) progressTemporada.textContent = tempoAtual;
                        if (progressPercent) progressPercent.textContent = `${percent}%`;
                        if (progressBarFill) progressBarFill.style.width = `${percent}%`;

                        // Alerta de consolidação pendente
                        if (sys.permissoes && sys.permissoes.deve_consolidar) {
                            alerts.push({
                                type: 'alert-warning',
                                icon: 'sync_problem',
                                text: 'Rodada pendente de consolidação',
                                href: 'ferramentas.html'
                            });
                        }

                        // Alerta de pré-temporada
                        if (sys.permissoes && sys.permissoes.is_pre_temporada) {
                            alerts.push({
                                type: 'alert-info',
                                icon: 'calendar_today',
                                text: 'Pré-temporada em andamento',
                                href: 'ferramentas.html'
                            });
                        }
                    }

                    // Alerta de manutenção
                    if (manutRes.ok) {
                        const manut = await manutRes.json();
                        if (manut.ativo) {
                            alerts.push({
                                type: 'alert-danger',
                                icon: 'engineering',
                                text: 'Modo Manutenção ATIVO',
                                href: 'ferramentas.html'
                            });
                        }
                    }

                    // Renderizar alertas
                    const alertsContainer = document.getElementById('dashboardAlerts');
                    if (alertsContainer && alerts.length > 0) {
                        alertsContainer.style.display = 'flex';
                        alertsContainer.innerHTML = alerts.map(a => `
                            <a href="${a.href}" class="dashboard-alert ${a.type}">
                                <span class="material-icons">${a.icon}</span>
                                ${a.text}
                            </a>
                        `).join('');
                    } else if (alertsContainer) {
                        alertsContainer.style.display = 'none';
                    }

                } catch (error) {
                    console.warn('[DASHBOARD] Erro ao carregar header analítico:', error);
                    // Fallback: saudação sem dados do mercado
                    atualizarSaudacao();
                }
            }

            // Função global para retry
            window.carregarDadosLigas = carregarDadosLigas;
        </script>

        <!-- ========================================
             SAÚDE DO SISTEMA - JavaScript (Fase 2)
             ======================================== -->
        <script>
            // Toggle da seção de Saúde do Sistema
            window.toggleHealthSection = function() {
                const section = document.getElementById('healthSection');
                if (!section) return;

                const isOpen = section.classList.contains('open');

                if (isOpen) {
                    section.classList.remove('open');
                    localStorage.setItem('health_section_open', 'false');
                } else {
                    section.classList.add('open');
                    localStorage.setItem('health_section_open', 'true');

                    // Carregar dados apenas na primeira abertura
                    if (!section.dataset.loaded) {
                        loadHealthData();
                        section.dataset.loaded = 'true';
                    }
                }
            };

            // Carregar dados de saúde do sistema
            async function loadHealthData() {
                const container = document.getElementById('healthComponentsContainer');
                if (!container) return;

                try {
                    const response = await fetch('/api/admin/system-health');
                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'Erro ao carregar dados');
                    }

                    // Atualizar badge do health score
                    updateHealthScoreBadge(data.health_score);

                    // Renderizar componentes
                    renderHealthComponents(data);

                } catch (error) {
                    console.error('[HEALTH] Erro ao carregar dados:', error);
                    container.innerHTML = `
                        <div class="health-error">
                            <span class="material-icons">error</span>
                            <div>Erro ao carregar status do sistema</div>
                            <button onclick="loadHealthData()" style="margin-top: 12px; padding: 8px 16px; background: #FF5500; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }

            // Atualizar badge de health score
            function updateHealthScoreBadge(score) {
                const badge = document.getElementById('healthScoreBadge');
                const valueEl = document.getElementById('healthScoreValue');

                if (!badge || !valueEl) return;

                valueEl.textContent = `${score}%`;

                // Remover classes anteriores
                badge.classList.remove('warning', 'danger');

                // Adicionar classe baseada no score
                if (score >= 80) {
                    // Verde (padrão)
                } else if (score >= 60) {
                    badge.classList.add('warning');
                } else {
                    badge.classList.add('danger');
                }
            }

            // Renderizar componentes de saúde
            function renderHealthComponents(data) {
                const container = document.getElementById('healthComponentsContainer');
                if (!container) return;

                const components = [
                    {
                        name: 'MarketGate',
                        icon: '🎯',
                        status: data.components?.marketGate?.status || 'unknown',
                        details: [
                            { label: 'Status', value: data.components?.marketGate?.status || '--' },
                            { label: 'Última Consulta', value: data.components?.marketGate?.lastCheck || '--' }
                        ]
                    },
                    {
                        name: 'API Cartola FC',
                        icon: '⚽',
                        status: data.components?.cartolaApi?.status || 'unknown',
                        details: [
                            { label: 'Status', value: data.components?.cartolaApi?.status || '--' },
                            { label: 'Rodada', value: data.components?.cartolaApi?.rodada_atual || '--' }
                        ]
                    },
                    {
                        name: 'API Jogos',
                        icon: '🏟️',
                        status: data.components?.jogosApi?.status || 'unknown',
                        details: [
                            { label: 'Status', value: data.components?.jogosApi?.status || '--' },
                            { label: 'Requests', value: data.components?.jogosApi?.requests || '--' }
                        ]
                    },
                    {
                        name: 'Banco de Dados',
                        icon: '💾',
                        status: data.components?.database?.status || 'unknown',
                        details: [
                            { label: 'Status', value: data.components?.database?.status || '--' },
                            { label: 'Collections', value: data.components?.database?.collections || '--' }
                        ]
                    },
                    {
                        name: 'Consolidação',
                        icon: '⚙️',
                        status: data.components?.consolidacao?.status || 'unknown',
                        details: [
                            { label: 'Última', value: data.components?.consolidacao?.lastRun || '--' },
                            { label: 'Próxima', value: data.components?.consolidacao?.nextRun || '--' }
                        ]
                    },
                    {
                        name: 'Sistema',
                        icon: '🖥️',
                        status: 'online',
                        details: [
                            { label: 'Uptime', value: data.components?.system?.uptime || '--' },
                            { label: 'Memória', value: data.components?.system?.memory || '--' }
                        ]
                    }
                ];

                const html = `
                    <div class="health-components-grid">
                        ${components.map(comp => `
                            <div class="health-component-card">
                                <div class="health-component-header">
                                    <div class="health-component-status">
                                        <span class="health-status-dot ${comp.status}"></span>
                                        <span class="health-component-name">${comp.name}</span>
                                    </div>
                                    <span class="health-component-icon">${comp.icon}</span>
                                </div>
                                <div class="health-component-details">
                                    ${comp.details.map(detail => `
                                        <div class="health-detail-item">
                                            <span class="health-detail-label">${detail.label}</span>
                                            <span class="health-detail-value">${detail.value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.innerHTML = html;
            }

            // Restaurar estado da seção ao carregar
            document.addEventListener('DOMContentLoaded', function() {
                const isOpen = localStorage.getItem('health_section_open') === 'true';
                if (isOpen) {
                    const section = document.getElementById('healthSection');
                    if (section) {
                        section.classList.add('open');
                        // Carregar dados imediatamente se já estava aberto
                        loadHealthData();
                        section.dataset.loaded = 'true';
                    }
                }
            });

            // SPA: reinicializar ao navegar
            window.addEventListener('spa:navigated', (e) => {
                if (e.detail?.pageName === 'painel.html') {
                    const isOpen = localStorage.getItem('health_section_open') === 'true';
                    if (isOpen) {
                        const section = document.getElementById('healthSection');
                        if (section && !section.dataset.loaded) {
                            section.classList.add('open');
                            loadHealthData();
                            section.dataset.loaded = 'true';
                        }
                    }
                }
            });
        </script>

        <!-- PROTECAO CLIENT-SIDE -->
        <script>
            if (!window.__painel_protection_guard) {
                window.__painel_protection_guard = true;
                (function () {
                    "use strict";
                    var isMobile =
                        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                            navigator.userAgent,
                        );
                    if (!isMobile) {
                        document.addEventListener("keydown", function (e) {
                            if (e.key === "F12" || e.keyCode === 123) {
                                e.preventDefault();
                                return false;
                            }
                            if (
                                e.ctrlKey &&
                                e.shiftKey &&
                                (e.key === "I" || e.key === "i" || e.keyCode === 73)
                            ) {
                                e.preventDefault();
                                return false;
                            }
                            if (
                                e.ctrlKey &&
                                e.shiftKey &&
                                (e.key === "J" || e.key === "j" || e.keyCode === 74)
                            ) {
                                e.preventDefault();
                                return false;
                            }
                            if (
                                e.ctrlKey &&
                                e.shiftKey &&
                                (e.key === "C" || e.key === "c" || e.keyCode === 67)
                            ) {
                                e.preventDefault();
                                return false;
                            }
                            if (
                                e.ctrlKey &&
                                (e.key === "U" || e.key === "u" || e.keyCode === 85)
                            ) {
                                e.preventDefault();
                                return false;
                            }
                            if (
                                e.ctrlKey &&
                                (e.key === "S" || e.key === "s" || e.keyCode === 83)
                            ) {
                                e.preventDefault();
                                return false;
                            }
                        });
                        document.addEventListener("contextmenu", function (e) {
                            e.preventDefault();
                            return false;
                        });
                    }
                    if (window.self !== window.top) {
                        window.top.location = window.self.location;
                    }
                })();
            }
        </script>

    </body>
</html>
