<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Detalhe da Liga - Super Cartola Manager</title>

        <!-- Suprimir warnings de extens√µes do navegador -->
        <script>
            // Capturar erros de extens√µes que n√£o afetam o sistema
            window.addEventListener("unhandledrejection", function (event) {
                if (
                    event.reason &&
                    event.reason.message &&
                    event.reason.message.includes("message channel closed")
                ) {
                    event.preventDefault(); // Silenciar este erro espec√≠fico
                }
            });
        </script>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

        <!-- CSS HIER√ÅRQUICO MODULAR -->
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="detalhe-liga.css" />
        <link rel="stylesheet" href="css/base.css" />
        <link rel="stylesheet" href="css/performance.css" />
        <link rel="stylesheet" href="css/modules/detalhe-liga-redesign.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

        <!-- MATERIAL ICONS -->
        <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet"
        />
        <style>
            /* Fallback Material Icons */
            @font-face {
                font-family: "Material Icons";
                font-style: normal;
                font-weight: 400;
                src: url(https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2)
                    format("woff2");
            }
            .material-icons {
                font-family: "Material Icons" !important;
                font-weight: normal;
                font-style: normal;
                font-size: 24px;
                line-height: 1;
                letter-spacing: normal;
                text-transform: none;
                display: inline-block;
                white-space: nowrap;
                word-wrap: normal;
                direction: ltr;
                -webkit-font-feature-settings: "liga";
                font-feature-settings: "liga";
                -webkit-font-smoothing: antialiased;
            }
        </style>

        <!-- EXTERNAL DEPENDENCIES -->
        <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />

        <!-- CORRE√á√ÉO CR√çTICA: Definir fun√ß√µes globais no HEAD antes do carregamento -->
        <script>
            // === GERENCIAMENTO DA LOGO - DEFINIDO NO HEAD ===
            let logoTentativas = [
                "img/logo-supercartola.png",
                "../public/img/logo-supercartola.png",
                "./public/img/logo-supercartola.png",
                "/public/img/logo-supercartola.png",
                "public/img/logo-supercartola.png",
            ];
            let logoIndiceAtual = 0;

            function tentarProximoCaminho(img) {
                logoIndiceAtual++;
                if (logoIndiceAtual < logoTentativas.length) {
                    img.src = logoTentativas[logoIndiceAtual];
                } else {
                    // Todas as tentativas falharam, mostrar emoji
                    mostrarLogoFallback();
                }
            }

            function logoCarregada(img) {
                const fallback = document.getElementById("logoFallback");
                if (fallback) {
                    fallback.style.display = "none";
                }
                img.style.display = "block";
            }

            function mostrarLogoFallback() {
                const logoImage = document.getElementById("logoImage");
                const fallback = document.getElementById("logoFallback");
                if (logoImage) {
                    logoImage.style.display = "none";
                }
                if (fallback) {
                    fallback.style.display = "inline-block";
                }
            }

            // Fun√ß√£o goToDashboard para compatibilidade com layout
            function goToDashboard() {
                window.location.href = "painel.html";
            }

            // =====================================================================
            // CACHE RODADAS - FUN√á√ïES GLOBAIS (DEFINIDAS NO HEAD)
            // =====================================================================
            let ligaIdCache = null;

            function obterLigaIdCache() {
                if (ligaIdCache) return ligaIdCache;
                const urlParams = new URLSearchParams(window.location.search);
                const ligaIdUrl =
                    urlParams.get("id") || urlParams.get("ligaId");
                if (ligaIdUrl) {
                    ligaIdCache = ligaIdUrl;
                    return ligaIdUrl;
                }
                if (window.ligaAtual?.id) return window.ligaAtual.id;
                if (window.ligaId) return window.ligaId;
                const ligaIdStorage = localStorage.getItem("ligaIdAtual");
                if (ligaIdStorage) return ligaIdStorage;
                return null;
            }

            function abrirModalRecalcMini() {
                const modal = document.getElementById("modalRecalcMini");
                if (modal) modal.classList.add("show");
            }

            function abrirModalLimparMini() {
                const modal = document.getElementById("modalLimparMini");
                if (modal) modal.classList.add("show");
            }

            function fecharModalMini(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove("show");
            }

            function mostrarToastMini(tipo, mensagem) {
                const toast = document.getElementById("toastCacheMini");
                if (!toast) return;
                const icone = toast.querySelector(".material-symbols-outlined");
                const texto = document.getElementById("toastCacheMiniTexto");
                toast.classList.remove("success", "error");
                toast.classList.add(tipo);
                if (icone)
                    icone.textContent =
                        tipo === "success" ? "check_circle" : "error";
                if (texto) texto.textContent = mensagem;
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 3500);
            }

            async function executarRecalcMini() {
                const ligaId = obterLigaIdCache();
                if (!ligaId) {
                    mostrarToastMini("error", "Liga n√£o identificada");
                    return;
                }
                const inicio = parseInt(
                    document.getElementById("miniRodadaInicio").value,
                );
                const fim = parseInt(
                    document.getElementById("miniRodadaFim").value,
                );
                const btn = document.getElementById("btnRecalcMini");
                if (inicio < 1 || fim > 38 || inicio > fim) {
                    mostrarToastMini("error", "Valores inv√°lidos");
                    return;
                }
                btn.disabled = true;
                btn.innerHTML =
                    '<div class="spinner-mini"></div>Recalculando...';
                try {
                    const response = await fetch(
                        `/api/rodadas-cache/${ligaId}/recalcular`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                rodadaInicio: inicio,
                                rodadaFim: fim,
                            }),
                        },
                    );
                    const resultado = await response.json();
                    if (response.ok && resultado.success) {
                        fecharModalMini("modalRecalcMini");
                        mostrarToastMini(
                            "success",
                            `‚úÖ ${resultado.totalRecalculados} registros recalculados`,
                        );
                    } else {
                        throw new Error(resultado.erro || "Erro ao recalcular");
                    }
                } catch (error) {
                    mostrarToastMini("error", error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = "Executar";
                }
            }

            async function executarLimparMini() {
                const ligaId = obterLigaIdCache();
                if (!ligaId) {
                    mostrarToastMini("error", "Liga n√£o identificada");
                    return;
                }
                try {
                    const response = await fetch(
                        `/api/rodadas-cache/${ligaId}/limpar`,
                        {
                            method: "DELETE",
                        },
                    );
                    const resultado = await response.json();
                    if (response.ok && resultado.success) {
                        fecharModalMini("modalLimparMini");
                        mostrarToastMini(
                            "success",
                            `üóëÔ∏è ${resultado.deletedCount} registros removidos`,
                        );
                    } else {
                        throw new Error(resultado.erro || "Erro ao limpar");
                    }
                } catch (error) {
                    mostrarToastMini("error", error.message);
                }
            }
        </script>
    </head>

    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main detalhe-liga-redesign">
                <div class="page-content">
                    <!-- Bot√£o Voltar -->
                    <div class="back-button-container">
                        <a href="painel.html" class="btn-back-new">
                            <span class="material-icons">arrow_back</span>
                            Voltar aos M√≥dulos
                        </a>
                    </div>

                    <!-- Header da Liga - NOVO DESIGN (IDs MANTIDOS) -->
                    <div class="liga-header-new">
                        <div class="liga-header-left">
                            <div class="liga-logo-container" id="ligaLogoContainer">
                                <span class="material-icons liga-logo-icon">emoji_events</span>
                            </div>
                            <div class="liga-header-info">
                                <h1 id="nomeLiga">Nome da Liga</h1>
                                <p id="quantidadeTimes">0 participantes</p>
                            </div>
                        </div>
                        <div class="liga-header-actions">
                            <button class="btn-header-action btn-header-secondary" onclick="location.reload()">
                                <span class="material-icons">refresh</span>
                                Atualizar
                            </button>
                        </div>
                    </div>

                    <!-- Tela Principal - 11 Cards Independentes (IDs E DATA-MODULE MANTIDOS) -->
                    <div id="main-screen" class="main-screen">
                        <div class="modules-grid modules-grid-expanded">
                            <!-- 1. Card Participantes -->
                            <div class="module-card" data-module="participantes">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">groups</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Participantes</h3>
                                <p class="module-description">Gerenciar times e cartoleiros da liga.</p>
                                <div class="module-count" id="participantes-count">0 membros</div>
                            </div>

                            <!-- 2. Card Classifica√ß√£o Geral -->
                            <div class="module-card" data-module="ranking-geral">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">leaderboard</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Classifica√ß√£o</h3>
                                <p class="module-description">Ranking geral acumulado da liga.</p>
                            </div>

                            <!-- 3. Card Resultados Parciais -->
                            <div class="module-card" data-module="parciais">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">timelapse</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Parciais</h3>
                                <p class="module-description">Acompanhamento em tempo real.</p>
                            </div>

                            <!-- 4. Card Top 10 -->
                            <div class="module-card" data-module="top10">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">star</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Top 10 - Destaques</h3>
                                <p class="module-description">Maiores e menores pontua√ß√µes por rodada.</p>
                            </div>

                            <!-- 5. Card Por Rodadas -->
                            <div class="module-card" data-module="rodadas">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">calendar_month</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Ranking por Rodada</h3>
                                <p class="module-description">Classifica√ß√£o detalhada rodada a rodada.</p>
                            </div>

                            <!-- 6. Card Melhor M√™s -->
                            <div class="module-card" data-module="melhor-mes">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">emoji_events</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Melhor do M√™s</h3>
                                <p class="module-description">Competi√ß√£o mensal baseada em edi√ß√µes.</p>
                            </div>

                            <!-- 7. Card Mata-mata -->
                            <div class="module-card" data-module="mata-mata">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">sports_mma</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Mata-Mata</h3>
                                <p class="module-description">Chaves eliminat√≥rias e confrontos diretos.</p>
                            </div>

                            <!-- 8. Card Pontos Corridos -->
                            <div class="module-card" data-module="pontos-corridos">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">list_alt</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Pontos Corridos</h3>
                                <p class="module-description">Tabela geral acumulada da liga.</p>
                            </div>

                            <!-- 9. Card Luva de Ouro -->
                            <div class="module-card" data-module="luva-de-ouro">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">sports_handball</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Luva de Ouro</h3>
                                <p class="module-description">Ranking de defesas dos goleiros.</p>
                            </div>

                            <!-- 10. Card Artilheiro -->
                            <div class="module-card" data-module="artilheiro-campeao">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">sports_soccer</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Artilheiro</h3>
                                <p class="module-description">Ranking de gols dos atacantes.</p>
                            </div>

                            <!-- 11. Card Fluxo Financeiro -->
                            <div class="module-card" data-module="fluxo-financeiro">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">attach_money</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Financeiro</h3>
                                <p class="module-description">Controle de pagamentos e extratos.</p>
                            </div>
                        </div>
                    </div>

                    <!-- === SE√á√ÉO DE DESTAQUES: MITOS E MICOS DA √öLTIMA RODADA === -->
                    <div class="highlights-section">
                        <!-- Tabela Mitos -->
                        <div class="highlight-card">
                            <div class="highlight-card-header">
                                <div class="highlight-card-title gold">
                                    <span class="material-icons">emoji_events</span>
                                    <span>Mitos da √öltima Rodada (<span id="rodadaMitos">R--</span>)</span>
                                </div>
                                <span class="highlight-badge" id="statusRodadaMitos">--</span>
                            </div>
                            <table class="highlight-table">
                                <thead>
                                    <tr>
                                        <th>Pos</th>
                                        <th>Time</th>
                                        <th>Pts</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaMitosBody">
                                    <tr>
                                        <td class="pos-cell gold">
                                            <span class="material-icons">workspace_premium</span> 1¬∫
                                        </td>
                                        <td>
                                            <div class="team-cell">
                                                <div class="team-avatar">--</div>
                                                <span class="team-name">Carregando...</span>
                                            </div>
                                        </td>
                                        <td class="pts-cell positive">--</td>
                                    </tr>
                                    <tr>
                                        <td class="pos-cell">2¬∫</td>
                                        <td>
                                            <div class="team-cell">
                                                <div class="team-avatar">--</div>
                                                <span class="team-name">Carregando...</span>
                                            </div>
                                        </td>
                                        <td class="pts-cell">--</td>
                                    </tr>
                                    <tr>
                                        <td class="pos-cell">3¬∫</td>
                                        <td>
                                            <div class="team-cell">
                                                <div class="team-avatar">--</div>
                                                <span class="team-name">Carregando...</span>
                                            </div>
                                        </td>
                                        <td class="pts-cell">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Tabela Micos -->
                        <div class="highlight-card">
                            <div class="highlight-card-header">
                                <div class="highlight-card-title red">
                                    <span class="material-icons" style="transform: rotate(180deg);">thumb_down</span>
                                    <span>Micos da √öltima Rodada (<span id="rodadaMicos">R--</span>)</span>
                                </div>
                            </div>
                            <table class="highlight-table">
                                <thead>
                                    <tr>
                                        <th>Pos</th>
                                        <th>Time</th>
                                        <th>Pts</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaMicosBody">
                                    <tr>
                                        <td class="pos-cell">
                                            <span class="material-icons" style="font-size:14px;vertical-align:middle;color:#6b7280;margin-right:4px;">sentiment_very_dissatisfied</span> 32¬∫
                                        </td>
                                        <td>
                                            <div class="team-cell">
                                                <div class="team-avatar">--</div>
                                                <span class="team-name">Carregando...</span>
                                            </div>
                                        </td>
                                        <td class="pts-cell negative">--</td>
                                    </tr>
                                    <tr>
                                        <td class="pos-cell">31¬∫</td>
                                        <td>
                                            <div class="team-cell">
                                                <div class="team-avatar">--</div>
                                                <span class="team-name">Carregando...</span>
                                            </div>
                                        </td>
                                        <td class="pts-cell">--</td>
                                    </tr>
                                    <tr>
                                        <td class="pos-cell">30¬∫</td>
                                        <td>
                                            <div class="team-cell">
                                                <div class="team-avatar">--</div>
                                                <span class="team-name">Carregando...</span>
                                            </div>
                                        </td>
                                        <td class="pts-cell">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- === CARDS DE ESTAT√çSTICAS R√ÅPIDAS === -->
                    <div class="quick-stats-section">
                        <div class="quick-stat-card highlight">
                            <div class="quick-stat-value" id="statRodadasJogadas">38</div>
                            <div class="quick-stat-label">Rodadas Jogadas</div>
                        </div>
                        <div class="quick-stat-card">
                            <div class="quick-stat-value" id="statPremiacaoTotal">R$ 0</div>
                            <div class="quick-stat-label">Premia√ß√£o Total</div>
                        </div>
                        <div class="quick-stat-card">
                            <div class="quick-stat-value" id="statMediaLiga">0.0</div>
                            <div class="quick-stat-label">M√©dia Liga</div>
                        </div>
                        <div class="quick-stat-card">
                            <div class="quick-stat-value" id="statRecordePontos">0.0</div>
                            <div class="quick-stat-label">Recorde Pontos</div>
                        </div>
                    </div>

                    <!-- Tela Secund√°ria - Conte√∫do Din√¢mico (IDs MANTIDOS) -->
                    <div id="secondary-screen" class="dynamic-content">
                        <div id="dynamic-content-area">
                            <!-- Conte√∫do ser√° injetado aqui dinamicamente -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- Overlay de Loading (ID MANTIDO) -->
            <div id="processing-overlay" class="processing-overlay">
                <div class="spinner"></div>
                <div class="processing-text">Carregando dados...</div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- jsPDF para exporta√ß√£o de PDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

        <!-- COMPONENTE CACHE RODADAS -->
        <style>
            /* Modais */
            .modal-cache-mini {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                z-index: 9999;
                align-items: center;
                justify-content: center;
            }
            .modal-cache-mini.show {
                display: flex;
            }
            .modal-cache-content {
                background: #1a1a1a;
                border: 1px solid #3a3a3c;
                border-radius: 12px;
                padding: 24px;
                max-width: 420px;
                width: 90%;
            }
            .modal-cache-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 16px;
            }
            .modal-cache-header .material-symbols-outlined {
                color: #f97316;
                font-size: 24px;
            }
            .modal-cache-header h3 {
                font-size: 16px;
                font-weight: 600;
                color: #fff;
                margin: 0;
            }
            .modal-cache-body {
                margin-bottom: 20px;
            }
            .modal-cache-body p {
                color: #9ca3af;
                font-size: 13px;
                line-height: 1.5;
                margin-bottom: 12px;
            }
            .input-mini-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 12px;
            }
            .input-mini-field label {
                font-size: 11px;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                display: block;
                margin-bottom: 4px;
            }
            .input-mini-field input {
                width: 100%;
                background: #262626;
                border: 1px solid #3a3a3c;
                border-radius: 6px;
                padding: 8px;
                color: #fff;
                font-size: 14px;
            }
            .input-mini-field input:focus {
                outline: none;
                border-color: #f97316;
            }
            .modal-cache-footer {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }
            .btn-mini {
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                border: none;
                transition: all 0.2s;
            }
            .btn-mini-cancel {
                background: #262626;
                color: #9ca3af;
            }
            .btn-mini-cancel:hover {
                background: #333;
            }
            .btn-mini-confirm {
                background: #f97316;
                color: white;
            }
            .btn-mini-confirm:hover {
                background: #ea580c;
            }
            .btn-mini-confirm:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn-mini-danger {
                background: #ef4444;
                color: white;
            }
            .btn-mini-danger:hover {
                background: #dc2626;
            }
            .spinner-mini {
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top: 2px solid white;
                width: 12px;
                height: 12px;
                animation: spin 0.8s linear infinite;
                display: inline-block;
                margin-right: 6px;
            }
            .toast-cache-mini {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #1a1a1a;
                border: 1px solid #3a3a3c;
                border-radius: 8px;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                font-size: 13px;
            }
            .toast-cache-mini.show {
                transform: translateX(0);
            }
            .toast-cache-mini.success {
                border-color: #22c55e;
            }
            .toast-cache-mini.error {
                border-color: #ef4444;
            }
            .toast-cache-mini .material-symbols-outlined {
                font-size: 20px;
            }
            .toast-cache-mini.success .material-symbols-outlined {
                color: #22c55e;
            }
            .toast-cache-mini.error .material-symbols-outlined {
                color: #ef4444;
            }
        </style>

        <div class="modal-cache-mini" id="modalRecalcMini">
            <div class="modal-cache-content">
                <div class="modal-cache-header">
                    <span class="material-symbols-outlined">refresh</span>
                    <h3>Recalcular Rodadas</h3>
                </div>
                <div class="modal-cache-body">
                    <p>
                        Recalcula as posi√ß√µes considerando times ativos em cada
                        rodada.
                    </p>
                    <div class="input-mini-group">
                        <div class="input-mini-field">
                            <label>De</label>
                            <input
                                type="number"
                                id="miniRodadaInicio"
                                value="1"
                                min="1"
                                max="38"
                            />
                        </div>
                        <div class="input-mini-field">
                            <label>At√©</label>
                            <input
                                type="number"
                                id="miniRodadaFim"
                                value="38"
                                min="1"
                                max="38"
                            />
                        </div>
                    </div>
                </div>
                <div class="modal-cache-footer">
                    <button
                        class="btn-mini btn-mini-cancel"
                        onclick="fecharModalMini('modalRecalcMini')"
                    >
                        Cancelar
                    </button>
                    <button
                        class="btn-mini btn-mini-confirm"
                        id="btnRecalcMini"
                        onclick="executarRecalcMini()"
                    >
                        Executar
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-cache-mini" id="modalLimparMini">
            <div class="modal-cache-content">
                <div class="modal-cache-header">
                    <span class="material-symbols-outlined">delete</span>
                    <h3>Limpar Cache</h3>
                </div>
                <div class="modal-cache-body">
                    <p style="color: #ef4444; font-weight: 600">
                        ‚ö†Ô∏è Remove todos os dados de cache desta liga.
                    </p>
                    <p>Ser√° necess√°rio recalcular depois.</p>
                </div>
                <div class="modal-cache-footer">
                    <button
                        class="btn-mini btn-mini-cancel"
                        onclick="fecharModalMini('modalLimparMini')"
                    >
                        Cancelar
                    </button>
                    <button
                        class="btn-mini btn-mini-danger"
                        onclick="executarLimparMini()"
                    >
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

        <div class="toast-cache-mini" id="toastCacheMini">
            <span class="material-symbols-outlined"></span>
            <span id="toastCacheMiniTexto"></span>
        </div>

        <script>
            // Listener para fechar modais ao clicar fora
            document.addEventListener("DOMContentLoaded", () => {
                document
                    .querySelectorAll(".modal-cache-mini")
                    .forEach((modal) => {
                        modal.addEventListener("click", (e) => {
                            if (
                                e.target.classList.contains("modal-cache-mini")
                            ) {
                                modal.classList.remove("show");
                            }
                        });
                    });
            });
        </script>

        <!-- SCHEDULERS AUTOM√ÅTICOS (devem carregar antes dos m√≥dulos) -->
        <script src="js/parciais-scheduler.js"></script>
        <script src="js/luva-de-ouro/luva-de-ouro-scheduler.js"></script>

        <!-- SCRIPTS MODULARES -->
        <script src="js/cards-condicionais.js"></script>
        <script src="js/sistema-modulos-init.js"></script>
        <script type="module" src="js/detalhe-liga-orquestrador.js"></script>

        <!-- M√ìDULOS JS EXISTENTES -->
        <script type="module" src="js/utils.js"></script>
        <script type="module" src="js/navigation.js"></script>
        <script src="js/seletor-ligas.js"></script>

        <!-- LOGO DINAMICA DA LIGA NO HEADER -->
        <script>
            // Observa mudan√ßas no elemento nomeLiga para atualizar a logo
            function atualizarLogoLiga() {
                const nomeLigaEl = document.getElementById('nomeLiga');
                const logoContainer = document.getElementById('ligaLogoContainer');
                if (!nomeLigaEl || !logoContainer) return;

                const nome = (nomeLigaEl.textContent || '').toLowerCase();
                let logoUrl = null;

                if (nome.includes('super')) {
                    logoUrl = 'img/logo-supercartola.png';
                } else if (nome.includes('sobral') || nome.includes('cartoleiros')) {
                    logoUrl = 'img/logo-cartoleirossobral.png';
                }

                if (logoUrl) {
                    logoContainer.innerHTML = `
                        <img src="${logoUrl}" alt="" class="liga-logo-img-header"
                             onerror="this.parentElement.innerHTML='<span class=\\'material-icons liga-logo-icon\\'>emoji_events</span>';" />
                    `;
                }
            }

            // Usar MutationObserver para detectar quando o nome da liga √© atualizado
            document.addEventListener('DOMContentLoaded', () => {
                const nomeLigaEl = document.getElementById('nomeLiga');
                if (nomeLigaEl) {
                    const observer = new MutationObserver(atualizarLogoLiga);
                    observer.observe(nomeLigaEl, { childList: true, characterData: true, subtree: true });
                    // Tamb√©m verificar ap√≥s um delay (fallback)
                    setTimeout(atualizarLogoLiga, 500);
                    setTimeout(atualizarLogoLiga, 1500);
                }
            });
        </script>

        <!-- DADOS DE DESTAQUES E ESTAT√çSTICAS v2.0 -->
        <script>
            // === CARREGAR DADOS DE DESTAQUES (MITOS/MICOS) E ESTAT√çSTICAS ===
            // v2.0: Usa endpoint consolidacao que retorna RodadaSnapshot com dados reais
            async function carregarDadosDestaques() {
                const ligaId = obterLigaIdCache();
                if (!ligaId) {
                    console.warn('Liga ID n√£o encontrado para carregar destaques');
                    return;
                }

                try {
                    // Buscar hist√≥rico completo consolidado (rodadasnapshots)
                    const response = await fetch(`/api/consolidacao/ligas/${ligaId}/historico-completo`);
                    if (!response.ok) throw new Error('Erro ao buscar hist√≥rico consolidado');

                    const result = await response.json();
                    if (!result.success || !result.rodadas || result.rodadas.length === 0) {
                        console.warn('Nenhum snapshot encontrado');
                        return;
                    }

                    // Pegar √∫ltima rodada COM DADOS (n√£o apenas maior n√∫mero)
                    const rodadas = result.rodadas;
                    // Filtrar rodadas que t√™m dados de ranking_rodada ou top10
                    const rodadasComDados = rodadas.filter(r => {
                        const dados = r.dados || {};
                        const temRanking = dados.ranking_rodada && dados.ranking_rodada.length > 0;
                        const temMitos = dados.top10?.mitos && dados.top10.mitos.length > 0;
                        return temRanking || temMitos;
                    });

                    console.log('[DEBUG-DESTAQUES] Total rodadas:', rodadas.length, '| Com dados:', rodadasComDados.length);

                    // Usar √∫ltima rodada com dados, ou √∫ltima rodada como fallback
                    const ultimaRodada = rodadasComDados.length > 0
                        ? rodadasComDados.reduce((max, r) => (r.rodada > max.rodada) ? r : max, rodadasComDados[0])
                        : rodadas.reduce((max, r) => (r.rodada > max.rodada) ? r : max, rodadas[0]);

                    const rodadaNum = ultimaRodada.rodada;
                    const dados = ultimaRodada.dados || {};

                    console.log('[DEBUG-DESTAQUES] Usando rodada:', rodadaNum);

                    // Atualizar n√∫mero da rodada
                    const rodadaMitosEl = document.getElementById('rodadaMitos');
                    const rodadaMicosEl = document.getElementById('rodadaMicos');
                    const statusEl = document.getElementById('statusRodadaMitos');

                    if (rodadaMitosEl) rodadaMitosEl.textContent = `R${rodadaNum}`;
                    if (rodadaMicosEl) rodadaMicosEl.textContent = `R${rodadaNum}`;
                    if (statusEl) statusEl.textContent = ultimaRodada.status === 'consolidada' ? 'Finalizada' : 'Em andamento';

                    // Usar ranking_rodada para extrair Top 3 Mitos e Top 3 Micos
                    // (top10.mitos/micos s√≥ guarda 1 item cada - mito e mico da rodada)
                    const rankingRodada = dados.ranking_rodada || [];
                    const rankingGeral = dados.ranking_geral || [];

                    // Top 3 Mitos = primeiros 3 do ranking (maior pontua√ß√£o)
                    // Top 3 Micos = √∫ltimos 3 do ranking (menor pontua√ß√£o), em ordem reversa
                    const rankingOrdenado = [...rankingRodada].sort((a, b) =>
                        (b.pontos_rodada || b.pontuacao || 0) - (a.pontos_rodada || a.pontuacao || 0)
                    );
                    const mitos = rankingOrdenado.slice(0, 3);
                    const micos = rankingOrdenado.slice(-3).reverse();

                    // Criar mapa de nomes/escudos - prioridade: times_stats > ranking_geral
                    // times_stats sempre tem nomes completos, ranking_geral pode ter null
                    const timesMap = {};
                    const timesStats = dados.times_stats || [];

                    // Primeiro, popular com ranking_geral (pode ter escudos)
                    rankingGeral.forEach(t => {
                        const id = t.timeId || t.time_id;
                        if (id) {
                            timesMap[id] = {
                                nome_time: t.nome_time,
                                nome_cartola: t.nome_cartola,
                                escudo: t.escudo
                            };
                        }
                    });

                    // Depois, sobrescrever com times_stats (sempre tem nomes completos)
                    timesStats.forEach(t => {
                        const id = t.time_id || t.timeId;
                        if (id) {
                            timesMap[id] = {
                                ...timesMap[id],
                                nome_time: t.nome_time || timesMap[id]?.nome_time,
                                nome_cartola: t.nome_cartola || timesMap[id]?.nome_cartola,
                                escudo: t.escudo || timesMap[id]?.escudo
                            };
                        }
                    });

                    // Enriquecer mitos/micos com dados do timesMap
                    const mitosEnriquecidos = mitos.map(m => {
                        const info = timesMap[m.time_id] || {};
                        return {
                            ...m,
                            nome_time: m.nome_time || info.nome_time || 'Time',
                            nome_cartola: m.nome_cartola || info.nome_cartola || '',
                            escudo: m.escudo || info.escudo || ''
                        };
                    });

                    const micosEnriquecidos = micos.map(m => {
                        const info = timesMap[m.time_id] || {};
                        return {
                            ...m,
                            nome_time: m.nome_time || info.nome_time || 'Time',
                            nome_cartola: m.nome_cartola || info.nome_cartola || '',
                            escudo: m.escudo || info.escudo || ''
                        };
                    });

                    // Renderizar tabelas - usar top 3 de cada
                    renderizarTabelaMitos(mitosEnriquecidos.slice(0, 3));
                    renderizarTabelaMicos(micosEnriquecidos.slice(0, 3));

                    // Calcular estat√≠sticas usando todos os snapshots
                    calcularEstatisticas(rodadas, rankingRodada);

                } catch (error) {
                    console.error('Erro ao carregar destaques:', error);
                }
            }

            function renderizarTabelaMitos(top3) {
                const tbody = document.getElementById('tabelaMitosBody');
                if (!tbody || !top3.length) return;

                tbody.innerHTML = top3.map((time, index) => {
                    const nome = time.nome_time || time.nomeTime || 'Time';
                    const pontos = (time.pontos_rodada || time.pontuacao || 0).toFixed(2);
                    const escudo = time.escudo || '';
                    const sigla = nome.substring(0, 3).toUpperCase();
                    const isFirst = index === 0;

                    return `
                        <tr>
                            <td class="pos-cell ${isFirst ? 'gold' : ''}">
                                ${isFirst ? '<span class="material-icons">workspace_premium</span>' : ''} ${index + 1}¬∫
                            </td>
                            <td>
                                <div class="team-cell">
                                    ${escudo
                                        ? `<img src="${escudo}" alt="" class="team-avatar-img" onerror="this.outerHTML='<div class=\\'team-avatar\\'>${sigla}</div>'" />`
                                        : `<div class="team-avatar">${sigla}</div>`
                                    }
                                    <span class="team-name">${nome}</span>
                                </div>
                            </td>
                            <td class="pts-cell ${isFirst ? 'positive' : ''}">${pontos}</td>
                        </tr>
                    `;
                }).join('');
            }

            function renderizarTabelaMicos(bottom3) {
                const tbody = document.getElementById('tabelaMicosBody');
                if (!tbody || !bottom3.length) return;

                tbody.innerHTML = bottom3.map((time, index) => {
                    const nome = time.nome_time || time.nomeTime || 'Time';
                    const pontos = (time.pontos_rodada || time.pontuacao || 0).toFixed(2);
                    const escudo = time.escudo || '';
                    const sigla = nome.substring(0, 3).toUpperCase();
                    const posicao = time.posicao || (32 - index);
                    const isLast = index === 0;

                    return `
                        <tr>
                            <td class="pos-cell">
                                ${isLast ? '<span class="material-icons" style="font-size:14px;vertical-align:middle;color:#6b7280;margin-right:4px;">sentiment_very_dissatisfied</span>' : ''} ${posicao}¬∫
                            </td>
                            <td>
                                <div class="team-cell">
                                    ${escudo
                                        ? `<img src="${escudo}" alt="" class="team-avatar-img" onerror="this.outerHTML='<div class=\\'team-avatar\\'>${sigla}</div>'" />`
                                        : `<div class="team-avatar">${sigla}</div>`
                                    }
                                    <span class="team-name">${nome}</span>
                                </div>
                            </td>
                            <td class="pts-cell ${isLast ? 'negative' : ''}">${pontos}</td>
                        </tr>
                    `;
                }).join('');
            }

            function calcularEstatisticas(rodadas, rankingAtual) {
                // Rodadas jogadas (total de snapshots consolidados)
                const rodadasJogadas = rodadas.length;
                const statRodadasEl = document.getElementById('statRodadasJogadas');
                if (statRodadasEl) statRodadasEl.textContent = rodadasJogadas;

                // M√©dia da liga (√∫ltima rodada)
                if (rankingAtual && rankingAtual.length > 0) {
                    const somaTotal = rankingAtual.reduce((sum, t) => sum + (t.pontos_rodada || 0), 0);
                    const media = somaTotal / rankingAtual.length;
                    const statMediaEl = document.getElementById('statMediaLiga');
                    if (statMediaEl) statMediaEl.textContent = media.toFixed(1);
                }

                // Recorde de pontos (maior pontua√ß√£o de todas as rodadas)
                let recorde = 0;
                rodadas.forEach(rodada => {
                    const dados = rodada.dados || {};
                    const ranking = dados.ranking_rodada || [];
                    ranking.forEach(r => {
                        const pts = r.pontos_rodada || 0;
                        if (pts > recorde) recorde = pts;
                    });
                    // Tamb√©m verificar destaques/mitos
                    const mitos = dados.top10?.mitos || [];
                    mitos.forEach(m => {
                        const pts = m.pontos_rodada || 0;
                        if (pts > recorde) recorde = pts;
                    });
                });
                const statRecordeEl = document.getElementById('statRecordePontos');
                if (statRecordeEl) statRecordeEl.textContent = recorde.toFixed(1);

                // Premia√ß√£o total (estimativa: R$100 por participante)
                const numParticipantes = rankingAtual ? rankingAtual.length : 32;
                const premiacao = numParticipantes * 100;
                const statPremiacaoEl = document.getElementById('statPremiacaoTotal');
                if (statPremiacaoEl) statPremiacaoEl.textContent = `R$ ${premiacao.toLocaleString('pt-BR')}`;
            }

            // Carregar quando a p√°gina estiver pronta e o ligaId dispon√≠vel
            let destaquesCarregados = false;

            async function tentarCarregarDestaques() {
                if (destaquesCarregados) return;

                const ligaId = obterLigaIdCache();
                if (ligaId) {
                    destaquesCarregados = true;
                    await carregarDadosDestaques();
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                // Tentar carregar em intervalos at√© conseguir
                setTimeout(tentarCarregarDestaques, 500);
                setTimeout(tentarCarregarDestaques, 1500);
                setTimeout(tentarCarregarDestaques, 3000);

                // Tamb√©m escutar por mudan√ßas no nome da liga (indica que dados carregaram)
                const nomeLigaEl = document.getElementById('nomeLiga');
                if (nomeLigaEl) {
                    const observer = new MutationObserver(() => {
                        setTimeout(tentarCarregarDestaques, 200);
                    });
                    observer.observe(nomeLigaEl, { childList: true, characterData: true, subtree: true });
                }
            });
        </script>

        <!-- Menu do Perfil Admin -->
        <script src="js/core/sidebar-menu.js"></script>
    </body>
</html>
