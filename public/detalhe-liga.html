<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Detalhe da Liga - Super Cartola Manager</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="detalhe-liga.css" />

        <style>
            /* === MELHORIAS - CARDS DESATIVADOS + LOGO MAIOR === */

            /* Logo Sidebar Aumentado */
            .logo-image {
                width: 42px !important;
                height: 42px !important;
                object-fit: contain;
                filter: drop-shadow(0 0 8px rgba(255, 69, 0, 0.4));
                transition: all 0.3s ease;
            }

            #logoFallback {
                width: 42px !important;
                height: 42px !important;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px !important;
                color: var(--laranja);
                text-shadow: 0 0 8px rgba(255, 69, 0, 0.4);
                transition: all 0.3s ease;
            }

            /* Cards Desativados */
            .module-card.disabled {
                opacity: 0.65 !important;
                cursor: not-allowed !important;
                pointer-events: none !important;
                background: linear-gradient(135deg, #1a1a1a 0%, #161616 100%) !important;
                border-color: rgba(160, 160, 160, 0.3) !important;
            }

            .module-card.disabled::before {
                background: linear-gradient(135deg, #888888 0%, #666666 100%) !important;
                opacity: 1 !important;
            }

            .module-card.disabled .module-icon {
                color: #999999 !important;
            }

            .module-card.disabled .module-title {
                color: #aaaaaa !important;
            }

            .module-card.disabled .module-items li {
                color: #888888 !important;
            }

            .module-card.disabled .module-items li::before {
                color: #777777 !important;
            }

            .module-card.disabled:hover {
                transform: none !important;
                box-shadow: none !important;
                border-color: rgba(96, 96, 96, 0.3) !important;
            }

            /* Tooltip para Cards Desativados */
            .module-card.disabled::after {
                content: "N√£o aplic√°vel a esta liga";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: #ffffff;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
                z-index: 10;
            }

            .module-card.disabled:hover::after {
                opacity: 1;
            }

            /* Responsividade Logo */
            @media (max-width: 768px) {
                .logo-image {
                    width: 36px !important;
                    height: 36px !important;
                }
                #logoFallback {
                    width: 36px !important;
                    height: 36px !important;
                    font-size: 24px !important;
                }
            }

            @media (max-width: 480px) {
                .logo-image {
                    width: 32px !important;
                    height: 32px !important;
                }
                #logoFallback {
                    width: 32px !important;
                    height: 32px !important;
                    font-size: 22px !important;
                }
            }
        </style>

        <!-- Lucide Icons -->
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
    </head>

    <body>
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main">
                <!-- Header removido para eliminar redund√¢ncia -->

                <div class="page-content">
                    <!-- Header da Liga Simplificado -->
                    <div class="liga-header">
                        <h2 id="nomeLiga" class="liga-titulo">Nome da Liga</h2>
                        <p id="quantidadeTimes" class="liga-info">
                            0 participantes
                        </p>
                    </div>

                    <!-- Tela Principal - Cards Organizados -->
                    <div id="main-screen" class="main-screen">
                        <div class="modules-grid">
                            <!-- Card Participantes -->
                            <div
                                class="module-card"
                                data-module="participantes"
                            >
                                <div class="module-header">
                                    <i
                                        class="module-icon"
                                        data-lucide="users"
                                    ></i>
                                    <h3 class="module-title">PARTICIPANTES</h3>
                                </div>
                                <ul class="module-items">
                                    <li>Lista completa</li>
                                    <li id="participantes-count">0 membros</li>
                                </ul>
                            </div>

                            <!-- Card Rankings -->
                            <div class="module-card" data-module="rankings">
                                <div class="module-header">
                                    <i
                                        class="module-icon"
                                        data-lucide="bar-chart-3"
                                    ></i>
                                    <h3 class="module-title">RANKINGS</h3>
                                </div>
                                <ul class="module-items">
                                    <li data-action="ranking-geral">Geral</li>
                                    <li data-action="top10">Top 10</li>
                                </ul>
                            </div>

                            <!-- Card Temporal -->
                            <div class="module-card" data-module="temporal">
                                <div class="module-header">
                                    <i
                                        class="module-icon"
                                        data-lucide="calendar"
                                    ></i>
                                    <h3 class="module-title">TEMPORAL</h3>
                                </div>
                                <ul class="module-items">
                                    <li data-action="rodadas">Rodadas</li>
                                    <li data-action="melhor-mes">Melhor M√™s</li>
                                </ul>
                            </div>

                            <!-- Card Competi√ß√µes -->
                            <div class="module-card" data-module="competicoes">
                                <div class="module-header">
                                    <i
                                        class="module-icon"
                                        data-lucide="zap"
                                    ></i>
                                    <h3 class="module-title">COMPETI√á√ïES</h3>
                                </div>
                                <ul class="module-items">
                                    <li data-action="mata-mata">Mata-mata</li>
                                    <li data-action="pontos-corridos">
                                        Pontos
                                    </li>
                                </ul>
                            </div>

                            <!-- Card Pr√™mios -->
                            <div class="module-card" data-module="premios">
                                <div class="module-header">
                                    <i
                                        class="module-icon"
                                        data-lucide="award"
                                    ></i>
                                    <h3 class="module-title">PR√äMIOS</h3>
                                </div>
                                <ul class="module-items">
                                    <li data-action="luva-de-ouro">
                                        Luva Ouro
                                    </li>
                                    <li data-action="artilheiro-campeao">
                                        Artilheiro
                                    </li>
                                </ul>
                            </div>

                            <!-- Card Financeiro -->
                            <div class="module-card" data-module="financeiro">
                                <div class="module-header">
                                    <i
                                        class="module-icon"
                                        data-lucide="dollar-sign"
                                    ></i>
                                    <h3 class="module-title">FINANCEIRO</h3>
                                </div>
                                <ul class="module-items">
                                    <li data-action="fluxo-financeiro">
                                        Fluxo
                                    </li>
                                    <li>Extrato</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tela Secund√°ria - Conte√∫do Din√¢mico -->
                    <div id="secondary-screen" class="dynamic-content">
                        <button class="back-button" onclick="voltarParaCards()">
                            ‚Üê Voltar aos M√≥dulos
                        </button>
                        <div id="dynamic-content-area">
                            <!-- Conte√∫do ser√° injetado aqui -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- Overlay de Loading -->
            <div id="processing-overlay" class="processing-overlay">
                <div class="spinner"></div>
                <div class="processing-text">Carregando dados...</div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Scripts M√≥dulos -->
        <script type="module" src="js/sistema-modulos-init.js"></script>
        <script type="module" src="js/utils.js"></script>
        <script type="module" src="js/navigation.js"></script>
        <script type="module" src="js/participantes.js"></script>
        <script type="module" src="js/ranking.js"></script>
        <script type="module" src="js/rodadas.js"></script>
        <script type="module" src="js/mata-mata.js"></script>
        <script type="module" src="js/pontos-corridos.js"></script>
        <script type="module" src="js/pontos-corridos-utils.js"></script>
        <script type="module" src="js/luva-de-ouro.js"></script>
        <script type="module" src="js/artilheiro-campeao.js"></script>
        <script type="module" src="js/melhor-mes.js"></script>
        <script type="module" src="js/top10.js"></script>
        <script type="module" src="js/fluxo-financeiro.js"></script>
        <script type="module" src="js/gols.js"></script>
        <script type="module" src="js/gols-por-rodada.js"></script>
        <script type="module" src="js/liga-modificacoes.js"></script>
        <script type="module" src="js/filtro-liga-especial.js"></script>
        <script type="module" src="js/gerenciar-ligas.js"></script>
        <script src="js/seletor-ligas.js"></script>
        <script src="js/cards-condicionais.js"></script>

        <script type="module">
            import {
                carregarDadosBasicos,
                carregarDetalhesLiga,
            } from "./js/participantes.js";

            // Sistema de controle seguro mantido
            let processingModule = false;
            const modules = {};

            // Carregar layout (sem header)
            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    // Apenas sidebar, sem header
                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document
                            .getElementById("sidebar-placeholder")
                            .replaceWith(sidebar);
                    }

                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            // Carregar m√≥dulos din√¢micos
            async function loadModules() {
                try {
                    modules.ranking = await import("./js/ranking.js");
                    modules.rodadas = await import("./js/rodadas.js");
                    modules.mataMata = await import("./js/mata-mata.js");
                    modules.pontosCorreidos = await import(
                        "./js/pontos-corridos.js"
                    );
                    modules.luvaDeOuro = await import("./js/luva-de-ouro.js");
                    modules.artilheiroCampeao = await import(
                        "./js/artilheiro-campeao.js"
                    );
                    modules.melhorMes = await import("./js/melhor-mes.js");
                    modules.top10 = await import("./js/top10.js");
                    modules.fluxoFinanceiro = await import(
                        "./js/fluxo-financeiro.js"
                    );
                } catch (error) {
                    console.error("Erro ao carregar m√≥dulos:", error);
                }
            }

            // Sistema de navega√ß√£o entre cards
            function initializeNavigation() {
                const cards = document.querySelectorAll(".module-card");
                const items = document.querySelectorAll(".module-items li[data-action]");

                // Cards principais com verifica√ß√£o condicional
                cards.forEach((card) => {
                    // Verificar se est√° desabilitado
                    if (card.classList.contains('disabled')) {
                        return; // N√£o adicionar event listener
                    }

                    card.addEventListener("click", async (e) => {
                        if (processingModule) return;

                        card.style.transform = "translateY(-1px) scale(0.98)";
                        setTimeout(() => {
                            card.style.transform = "";
                        }, 150);

                        const module = card.dataset.module;
                        if (module === "participantes") {
                            await showParticipantes();
                        } else {
                            const firstAction = card.querySelector("li[data-action]");
                            if (firstAction) {
                                await executeAction(firstAction.dataset.action);
                            }
                        }
                    });
                });

                // Items espec√≠ficos com verifica√ß√£o
                items.forEach((item) => {
                    const parentCard = item.closest('.module-card');
                    if (parentCard && parentCard.classList.contains('disabled')) {
                        return; // N√£o adicionar event listener
                    }

                    item.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        if (processingModule) return;

                        item.style.opacity = "0.6";
                        setTimeout(() => {
                            item.style.opacity = "";
                        }, 150);

                        await executeAction(item.dataset.action);
                    });
                });
            }

            // Estados de loading
            function showLoading(text = "Processando dados...") {
                const overlay = document.getElementById("processing-overlay");
                const textEl = overlay.querySelector(".processing-text");
                textEl.textContent = text;
                overlay.classList.add("active");
            }

            function hideLoading() {
                const overlay = document.getElementById("processing-overlay");
                overlay.classList.remove("active");
            }

            // Executar a√ß√£o espec√≠fica
            async function executeAction(action) {
                if (processingModule) return;
                processingModule = true;

                try {
                    showLoading("Carregando m√≥dulo...");
                    showSecondaryScreen();

                    const contentArea = document.getElementById(
                        "dynamic-content-area",
                    );
                    contentArea.innerHTML =
                        '<div class="loading-state">Preparando conte√∫do...</div>';

                    switch (action) {
                        case "ranking-geral":
                            contentArea.innerHTML = `
                            <div id="ranking-geral">
                                <div id="rankingContainer">
                                    <div id="rankingGeralLoading" class="loading-state">Carregando ranking geral...</div>
                                    <div id="rankingGeralTableContainer" style="display: none;">
                                        <div id="rankingGeralExportBtnContainer" class="text-end mb-2"></div>
                                        <table class="ranking-table">
                                            <thead>
                                                <tr>
                                                    <th>Pos</th><th>‚ù§Ô∏è</th><th>Cartoleiro</th><th>Time</th><th>Pontos</th><th>M√©dia</th><th>Rodadas</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rankingGeralTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                            if (modules.ranking?.carregarRankingGeral) {
                                await modules.ranking.carregarRankingGeral();
                            }
                            break;

                        case "rodadas":
                            contentArea.innerHTML = `
                            <div id="rodadas">
                                <div class="mb-3">
                                    <select id="rodadaSelect" class="form-control">
                                        <option value="">Escolha uma rodada</option>
                                    </select>
                                </div>
                                <div class="table-responsive">
                                    <table class="ranking-table">
                                        <thead>
                                            <tr><th>Pos</th><th>‚ù§Ô∏è</th><th>Cartoleiro</th><th>Time</th><th>Pontos</th><th>Banco</th></tr>
                                        </thead>
                                        <tbody id="rankingBody">
                                            <tr><td colspan="6" class="empty-state">Selecione uma rodada</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                            if (modules.rodadas?.carregarRodadas) {
                                await modules.rodadas.carregarRodadas();
                            }
                            break;

                        case "mata-mata":
                            contentArea.innerHTML =
                                '<div id="mataMataContent"><div class="loading-state">Carregando mata-mata...</div></div>';
                            if (modules.mataMata?.carregarMataMata) {
                                await modules.mataMata.carregarMataMata();
                            }
                            break;

                        case "pontos-corridos":
                            contentArea.innerHTML =
                                '<div id="pontosCorridosContent"><div class="loading-state">Carregando pontos corridos...</div></div>';
                            if (
                                modules.pontosCorreidos
                                    ?.inicializarPontosCorreidos
                            ) {
                                await modules.pontosCorreidos.inicializarPontosCorreidos();
                            }
                            break;

                        case "luva-de-ouro":
                            contentArea.innerHTML =
                                '<div id="luvaDeOuroContent"><div class="loading-state">Carregando luva de ouro...</div></div>';
                            if (modules.luvaDeOuro?.inicializarLuvaDeOuro) {
                                await modules.luvaDeOuro.inicializarLuvaDeOuro();
                            }
                            break;

                        case "artilheiro-campeao":
                            contentArea.innerHTML =
                                '<div id="artilheiroCampeaoContent"><div class="loading-state">Carregando artilheiro campe√£o...</div></div>';
                            if (
                                modules.artilheiroCampeao
                                    ?.inicializarArtilheiroCampeao
                            ) {
                                await modules.artilheiroCampeao.inicializarArtilheiroCampeao();
                            }
                            break;

                        case "melhor-mes":
                            contentArea.innerHTML =
                                '<div id="melhorMesContent"><div class="loading-state">Carregando melhor m√™s...</div></div>';
                            if (modules.melhorMes?.inicializarMelhorMes) {
                                await modules.melhorMes.inicializarMelhorMes();
                            }
                            break;

                        case "top10":
                            contentArea.innerHTML = `
                            <div id="top10">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div id="top10MitosExportBtnContainer" class="text-end mb-2"></div>
                                        <div id="top10MitosTable"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="top10MicosExportBtnContainer" class="text-end mb-2"></div>
                                        <div id="top10MicosTable"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                            if (modules.top10?.inicializarTop10) {
                                await modules.top10.inicializarTop10();
                            }
                            break;

                        case "fluxo-financeiro":
                            contentArea.innerHTML =
                                '<div id="fluxoFinanceiroContent"><div class="loading-state">Carregando fluxo financeiro...</div></div>';
                            if (
                                modules.fluxoFinanceiro
                                    ?.inicializarFluxoFinanceiro
                            ) {
                                await modules.fluxoFinanceiro.inicializarFluxoFinanceiro();
                            }
                            break;

                        default:
                            contentArea.innerHTML =
                                '<div class="empty-state">Funcionalidade em desenvolvimento</div>';
                    }
                } catch (error) {
                    document.getElementById("dynamic-content-area").innerHTML =
                        `
                    <div class="empty-state">Erro: ${error.message}</div>
                `;
                } finally {
                    hideLoading();
                    processingModule = false;
                }
            }

            // Mostrar participantes
            async function showParticipantes() {
                if (processingModule) return;
                processingModule = true;

                try {
                    showLoading("Carregando participantes...");
                    showSecondaryScreen();

                    const contentArea = document.getElementById(
                        "dynamic-content-area",
                    );
                    contentArea.innerHTML =
                        '<div class="loading-state">Buscando dados dos participantes...</div>';

                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const ligaId = urlParams.get("id");

                    if (!ligaId) {
                        contentArea.innerHTML =
                            '<div class="empty-state">ID da liga n√£o encontrado</div>';
                        return;
                    }

                    const response = await fetch(`/api/ligas/${ligaId}`);
                    if (!response.ok) {
                        throw new Error("Erro ao carregar liga");
                    }

                    const liga = await response.json();
                    if (!liga.times || liga.times.length === 0) {
                        contentArea.innerHTML =
                            '<div class="empty-state">Nenhum participante cadastrado</div>';
                        return;
                    }

                    let participantesHtml = `
                    <h4 style="color: #ffffff; margin-bottom: 15px;">
                        üë• Participantes da Liga (${liga.times.length})
                    </h4>
                    <div class="participantes-grid">
                `;

                    for (const timeId of liga.times) {
                        try {
                            const timeResponse = await fetch(
                                `/api/time/${timeId}`,
                            );
                            if (timeResponse.ok) {
                                const time = await timeResponse.json();
                                participantesHtml += `
                                <div class="participante-card">
                                    <img src="${time.url_escudo_png || "/escudos/default.png"}" 
                                         alt="Escudo" class="participante-escudo"
                                         onerror="this.src='/escudos/default.png'">
                                    <div class="participante-nome">${time.nome_cartoleiro || "N/A"}</div>
                                    <div class="participante-time">${time.nome_time || "Time N/A"}</div>
                                </div>
                            `;
                            }
                        } catch (error) {
                            console.warn(
                                `Erro ao carregar time ${timeId}:`,
                                error,
                            );
                        }
                    }

                    participantesHtml += "</div>";
                    contentArea.innerHTML = participantesHtml;
                } catch (error) {
                    document.getElementById("dynamic-content-area").innerHTML =
                        `
                    <div class="empty-state">Erro ao carregar participantes: ${error.message}</div>
                `;
                } finally {
                    hideLoading();
                    processingModule = false;
                }
            }

            // Navega√ß√£o entre telas
            function showSecondaryScreen() {
                document.getElementById("main-screen").style.display = "none";
                document
                    .getElementById("secondary-screen")
                    .classList.add("active");
            }

            function voltarParaCards() {
                document
                    .getElementById("secondary-screen")
                    .classList.remove("active");
                document.getElementById("main-screen").style.display = "block";
            }

            // Atualizar header da liga (sem redund√¢ncia)
            function updateLigaHeader(liga) {
                const nomeElement = document.getElementById("nomeLiga");
                const quantidadeElement =
                    document.getElementById("quantidadeTimes");

                if (nomeElement) {
                    // Remove "Liga:" e deixa apenas o nome limpo
                    nomeElement.textContent = liga.nome || "Nome da Liga";
                }

                if (quantidadeElement) {
                    const participantes =
                        liga.participantes?.length || liga.times?.length || 0;
                    quantidadeElement.textContent = `${participantes} participantes`;
                }
            }

            // Atualizar contador de participantes
            async function updateParticipantesCount() {
                try {
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const ligaId = urlParams.get("id");

                    if (!ligaId) return;

                    const response = await fetch(`/api/ligas/${ligaId}`);
                    if (response.ok) {
                        const liga = await response.json();

                        // Atualizar header da liga
                        updateLigaHeader(liga);

                        // Atualizar contador no card
                        const count =
                            liga.participantes?.length ||
                            liga.times?.length ||
                            0;
                        document.getElementById(
                            "participantes-count",
                        ).textContent = `${count} membros`;
                    }
                } catch (error) {
                    console.warn("Erro ao atualizar contador:", error);
                }
            }

            // Expor fun√ß√£o globalmente
            window.voltarParaCards = voltarParaCards;

            // === SISTEMA CONDICIONAL DE CARDS ===

            const CARDS_CONFIG = {
                "684cb1c8af923da7c7df51de": { // Super Cartola 2025
                    disabled: ["premios"],
                    reason: "Pr√™mios n√£o se aplicam a esta liga"
                },
                "684d821cf1a7ae16d1f89572": { // Cartoleiros do Sobral
                    disabled: ["competicoes"], 
                    reason: "Competi√ß√µes n√£o se aplicam a esta liga"
                }
            };

            function aplicarConfiguracaoCards() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const ligaId = urlParams.get("id");

                    if (!ligaId) return;

                    const config = CARDS_CONFIG[ligaId];
                    if (!config) return;

                    config.disabled.forEach(moduleId => {
                        const card = document.querySelector(`[data-module="${moduleId}"]`);
                        if (card) {
                            card.classList.add('disabled');
                            console.log(`üö´ Card "${moduleId}" desabilitado para liga ${ligaId}`);
                        }
                    });
                } catch (error) {
                    console.error("Erro ao aplicar configura√ß√£o cards:", error);
                }
            }

            function isModuleDisabled(moduleId) {
                const urlParams = new URLSearchParams(window.location.search);
                const ligaId = urlParams.get("id");
                const config = CARDS_CONFIG[ligaId];
                return config && config.disabled.includes(moduleId);
            }

            // Inicializa√ß√£o
            document.addEventListener("DOMContentLoaded", async function () {
                await loadLayout();
                await new Promise((resolve) => setTimeout(resolve, 500));
                await loadModules();
                await updateParticipantesCount();
                initializeNavigation();

                // Inicializar √≠cones Lucide
                if (typeof lucide !== "undefined") {
                    lucide.createIcons();
                }

                // Aplicar configura√ß√£o de cards ap√≥s inicializa√ß√£o
                setTimeout(aplicarConfiguracaoCards, 200);
            });
        </script>
    </body>
</html>