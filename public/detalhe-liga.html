<!doctype html>
<html lang="pt-BR">
  <head>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detalhes da Liga - Super Cartola Manager</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Adiciona html2canvas para exporta√ß√£o de imagem -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
      /* === TEMA ESCURO SOBRESCREVENDO INLINE STYLES === */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background: var(--bg-secondary) !important;
        border-radius: 12px;
        box-shadow: var(--shadow-lg) !important;
        border: 1px solid var(--border-primary) !important;
        color: var(--text-primary) !important;
      }

      /* Headers escuros */
      h2,
      h3 {
        color: var(--text-primary) !important;
        text-align: center;
        margin-bottom: 15px;
      }

      h2 {
        color: var(--laranja) !important;
        text-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
        font-size: 1.8rem;
      }

      /* Breadcrumb melhorado */
      .breadcrumb-container {
        margin: 0 0 20px 0;
        padding: 12px 0;
        border-bottom: 2px solid var(--border-primary);
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 13px;
        font-weight: 500;
      }

      .breadcrumb a {
        color: var(--text-muted);
        text-decoration: none;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .breadcrumb a:hover {
        color: var(--laranja);
        background: var(--laranja-alpha);
      }

      .breadcrumb .separator {
        color: var(--text-dark);
        margin: 0 4px;
      }

      .breadcrumb .current {
        color: var(--laranja);
        font-weight: 600;
      }

      /* Bot√£o voltar escuro */
      .btn-voltar {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        padding: 12px 20px;
        background: var(--gradient-card) !important;
        color: var(--text-primary) !important;
        border: 1px solid var(--border-primary) !important;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      .btn-voltar:hover {
        background: var(--bg-card-hover) !important;
        border-color: var(--laranja) !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Tabs escuras */
      .tabs {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        margin: 20px 0;
        gap: 5px;
        padding: 8px;
        background: var(--bg-card) !important;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-primary);
      }

      .tab {
        padding: 12px 16px !important;
        border: none !important;
        background: transparent !important;
        color: var(--text-muted) !important;
        cursor: pointer;
        border-radius: 8px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
        display: flex;
        align-items: center;
        gap: 6px;
        text-transform: none;
        letter-spacing: 0.3px;
      }

      .tab:hover {
        background: var(--laranja-alpha) !important;
        color: var(--laranja) !important;
        transform: translateY(-1px);
      }

      .tab.active {
        background: var(--gradient-primary) !important;
        color: var(--text-primary) !important;
        font-weight: 600 !important;
        box-shadow: var(--shadow-orange) !important;
      }

      .tab span {
        font-size: 1.1em;
      }

      /* Tab content escuro */
      .tab-content {
        display: none;
        padding: 25px !important;
        border: 1px solid var(--border-primary) !important;
        border-radius: 12px !important;
        margin-top: 15px;
        background: var(--bg-card) !important;
        box-shadow: var(--shadow-md) !important;
        color: var(--text-primary) !important;
      }

      .tab-content.active {
        display: block;
        animation: fadeInUp 0.3s ease-out;
      }

      /* Alertas escuros */
      .alert {
        padding: 15px !important;
        border-radius: 8px !important;
        margin: 15px 0 !important;
        font-weight: 500;
        font-size: 13px;
        border: 1px solid transparent;
      }

      .alert-success {
        background: rgba(34, 197, 94, 0.2) !important;
        border-color: var(--success) !important;
        color: var(--success) !important;
      }

      .alert-warning {
        background: rgba(255, 69, 0, 0.2) !important;
        border-color: var(--laranja) !important;
        color: var(--laranja) !important;
      }

      .alert-error,
      .error-message {
        background: rgba(239, 68, 68, 0.2) !important;
        border-color: var(--danger) !important;
        color: var(--danger) !important;
      }

      .alert-info {
        background: rgba(59, 130, 246, 0.2) !important;
        border-color: var(--info) !important;
        color: var(--info) !important;
      }

      /* Loading escuro */
      .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--laranja-alpha) !important;
        border-top: 4px solid var(--laranja) !important;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-container {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted) !important;
        background: var(--bg-card) !important;
        border-radius: 12px;
        border: 1px solid var(--border-primary);
      }

      /* Bot√µes escuros */
      .carregar-participantes-btn,
      .toggle-participants,
      .refresh-btn,
      .parciais-btn {
        background: var(--gradient-primary) !important;
        color: var(--text-primary) !important;
        border: none !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        box-shadow: var(--shadow-orange) !important;
      }

      .carregar-participantes-btn:hover,
      .toggle-participants:hover,
      .refresh-btn:hover,
      .parciais-btn:hover {
        transform: translateY(-2px) !important;
        box-shadow: var(--shadow-lg) !important;
        filter: brightness(1.1);
      }

      .carregar-participantes-btn:disabled {
        background: var(--text-muted) !important;
        cursor: not-allowed !important;
        transform: none !important;
        opacity: 0.6;
      }

      /* Select escuro */
      .rodadas-select {
        padding: 12px 16px !important;
        border: 1px solid var(--border-primary) !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        min-width: 250px;
        background: var(--bg-card) !important;
        color: var(--text-primary) !important;
        outline: none;
        transition: all 0.3s ease;
      }

      .rodadas-select:focus {
        border-color: var(--laranja) !important;
        box-shadow: 0 0 0 3px var(--laranja-alpha) !important;
      }

      /* Actions container */
      .rodadas-actions {
        display: flex;
        gap: 15px !important;
        margin-bottom: 20px !important;
        align-items: center;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        border: 1px solid var(--border-primary);
      }

      /* Participantes inicial escuro */
      .participantes-inicial {
        text-align: center !important;
        padding: 50px 30px !important;
        color: var(--text-muted) !important;
        background: var(--bg-card) !important;
        border-radius: 12px;
        border: 2px dashed var(--border-primary);
      }

      .participantes-inicial h3 {
        color: var(--laranja) !important;
        margin-bottom: 15px !important;
      }

      /* Tabelas escuras */
      .ranking-table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-top: 20px !important;
        background: var(--bg-card) !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        box-shadow: var(--shadow-md) !important;
        border: 1px solid var(--border-primary) !important;
      }

      .ranking-table th,
      .ranking-table td {
        border: 1px solid var(--border-secondary) !important;
        padding: 10px 8px !important;
        text-align: left !important;
        color: var(--text-secondary) !important;
        font-size: 13px !important;
      }

      .ranking-table th {
        background: var(--table-header-bg) !important;
        color: var(--text-primary) !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        font-size: 12px !important;
        letter-spacing: 0.5px !important;
      }

      .ranking-table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02) !important;
      }

      .ranking-table tbody tr:hover {
        background: var(--table-row-hover) !important;
      }

      /* Grid de times escuro */
      .times-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)) !important;
        gap: 20px !important;
        margin-top: 20px;
      }

      .time-card {
        border: 1px solid var(--border-primary) !important;
        border-radius: 12px !important;
        padding: 20px !important;
        text-align: center !important;
        background: var(--gradient-card) !important;
        box-shadow: var(--shadow-md) !important;
        transition: all 0.3s ease !important;
        color: var(--text-primary) !important;
      }

      .time-card:hover {
        transform: translateY(-5px) !important;
        box-shadow: var(--shadow-lg) !important;
        border-color: var(--laranja) !important;
      }

      .time-card img {
        width: 60px !important;
        height: 60px !important;
        border-radius: 50% !important;
        margin-bottom: 15px !important;
        object-fit: cover !important;
        border: 2px solid var(--border-primary);
        transition: all 0.3s ease;
      }

      .time-card:hover img {
        border-color: var(--laranja);
        box-shadow: 0 0 15px rgba(255, 69, 0, 0.4);
      }

      .time-card h4 {
        margin-bottom: 8px !important;
        color: var(--text-primary) !important;
        font-size: 1.1em !important;
        font-weight: 600;
      }

      .time-card p {
        font-size: 0.9em !important;
        color: var(--text-muted) !important;
        margin: 0;
      }

      /* Debug panel escuro */
      #debug-panel {
        position: fixed !important;
        top: 10px !important;
        right: 10px !important;
        background: rgba(0, 0, 0, 0.9) !important;
        color: var(--text-primary) !important;
        padding: 15px !important;
        border-radius: 8px !important;
        font-family: "JetBrains Mono", monospace !important;
        font-size: 11px !important;
        max-width: 320px !important;
        z-index: 1001 !important;
        border: 1px solid var(--laranja) !important;
        box-shadow: var(--shadow-orange) !important;
      }

      /* Highlights escuros */
      .mito-highlight {
        background: rgba(34, 197, 94, 0.3) !important;
        color: var(--success) !important;
        font-weight: bold !important;
        border-radius: 4px;
        padding: 2px 4px;
      }

      .mico-highlight {
        background: rgba(239, 68, 68, 0.3) !important;
        color: var(--danger) !important;
        font-style: italic !important;
        border-radius: 4px;
        padding: 2px 4px;
      }

      /* Tabela artilheiro (mant√©m especificidades) */
      #tabela-artilheiro-rodada table.ranking-table th,
      #tabela-artilheiro-rodada table.ranking-table td {
        padding: 2px 3px !important;
        font-size: 9px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(3),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(3) {
        max-width: 50px !important;
        width: 50px !important;
        padding: 2px 2px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(4),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(4) {
        max-width: 50px !important;
        width: 50px !important;
        padding: 2px 2px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(1),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(1) {
        width: 20px !important;
        padding: 2px 1px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(2),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(2) {
        width: 20px !important;
        padding: 2px 1px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(5),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(5),
      #tabela-artilheiro-rodada table.ranking-table th:nth-child(6),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(6),
      #tabela-artilheiro-rodada table.ranking-table th:nth-child(7),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(7) {
        width: 25px !important;
        padding: 2px 1px !important;
      }

      #tabela-artilheiro-rodada img {
        width: 12px !important;
        height: 12px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table {
        font-size: 9px !important;
        width: auto !important;
        max-width: 400px !important;
      }

      /* Rodadas espec√≠ficas */
      #rodadas table.ranking-table th:nth-child(1),
      #rodadas table.ranking-table td:nth-child(1) {
        text-align: center !important;
      }

      #rodadas table.ranking-table th:nth-child(5),
      #rodadas table.ranking-table td:nth-child(5) {
        text-align: center !important;
      }

      #rodadas table.ranking-table th:nth-child(6),
      #rodadas table.ranking-table td:nth-child(6) {
        text-align: center !important;
      }

      /* Global loading */
      #global-loading {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: rgba(10, 10, 10, 0.95) !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 9999 !important;
        color: var(--text-primary) !important;
      }

      #global-loading.show {
        display: flex !important;
      }

      #global-loading.hide {
        display: none !important;
      }

      #global-loading .loading-spinner {
        width: 60px !important;
        height: 60px !important;
        border-width: 6px !important;
        margin-bottom: 20px;
      }

      /* Anima√ß√µes */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsividade */
      @media (max-width: 768px) {
        .container {
          padding: 15px !important;
          margin: 10px !important;
        }

        .tabs {
          gap: 3px !important;
          padding: 6px !important;
        }

        .tab {
          padding: 10px 12px !important;
          font-size: 12px !important;
        }

        .tab-content {
          padding: 20px 15px !important;
        }

        .times-grid {
          grid-template-columns: repeat(
            auto-fill,
            minmax(150px, 1fr)
          ) !important;
          gap: 15px !important;
        }

        .rodadas-actions {
          flex-direction: column !important;
          gap: 10px !important;
        }

        .rodadas-select {
          min-width: 200px !important;
        }
      }

      @media (max-width: 480px) {
        h2 {
          font-size: 1.5rem !important;
        }

        .tab {
          padding: 8px 10px !important;
          font-size: 11px !important;
        }

        .times-grid {
          grid-template-columns: 1fr !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar ser√° injetado aqui -->
      <div id="sidebar-placeholder"></div>

      <!-- Conte√∫do principal -->
      <main class="app-main">
        <!-- Header ser√° injetado aqui -->
        <div id="header-placeholder"></div>

        <!-- Conte√∫do da p√°gina -->
        <div class="page-content">
          <div id="debug-panel" style="display: none">
            <strong>Status dos M√≥dulos:</strong>
            <div id="debug-content"></div>
          </div>

          <div id="global-loading" class="hide">
            <div class="loading-spinner"></div>
            <p>Inicializando aplica√ß√£o...</p>
          </div>

          <div class="container">
            <!-- Breadcrumb melhorado -->
            <div class="breadcrumb-container">
              <nav class="breadcrumb">
                <a href="dashboard.html">üè† Dashboard</a>
                <span class="separator">‚Üí</span>
                <a href="gerenciar.html">‚öôÔ∏è Gerenciar Ligas</a>
                <span class="separator">‚Üí</span>
                <span class="current" id="breadcrumbLiga">üèÜ Liga</span>
              </nav>
            </div>

            <!-- Cabe√ßalho simplificado -->
            <div class="liga-header-simple">
              <h2 id="nomeLiga">üèÜ Carregando...</h2>
              <p id="quantidadeTimes"></p>
            </div>

            <div class="tabs">
              <button class="tab active" data-tab="participantes">
                <span>üë•</span> Participantes
              </button>
              <button class="tab" data-tab="rodadas">
                <span>üìä</span> Rodadas
              </button>
              <button class="tab" data-tab="mata-mata">
                <span>‚öîÔ∏è</span> Disputas Mata-Mata
              </button>
              <button class="tab" data-tab="ranking-geral">
                <span>üèÜ</span> Ranking Geral
              </button>
              <button class="tab" data-tab="pontos-corridos">
                <span>üìà</span> Liga Pontos Corridos
              </button>
              <button class="tab" data-tab="melhor-mes">
                <span>‚≠ê</span> Melhor do M√™s
              </button>
              <button class="tab" data-tab="top-10">
                <span>üî•</span> Top 10
              </button>
              <button class="tab" data-tab="fluxo-financeiro">
                <span>üí∞</span> Fluxo Financeiro
              </button>
              <button class="tab" data-tab="artilheiro-campeao">
                <span>‚öΩ</span> Artilheiro Campe√£o
              </button>
              <button class="tab" data-tab="luva-de-ouro">
                <span>ü•Ö</span> Luva de Ouro
              </button>
            </div>

            <div
              id="errorMessage"
              class="error-message"
              style="display: none"
            ></div>

            <div class="tab-contents">
              <div id="participantes" class="tab-content active">
                <div id="participantes-inicial" class="participantes-inicial">
                  <h3>üë• Participantes da Liga</h3>
                  <p>
                    Clique no bot√£o abaixo para carregar e visualizar os
                    participantes da liga.
                  </p>
                  <button
                    id="carregarParticipantesBtn"
                    class="carregar-participantes-btn"
                  >
                    üî• Carregar Participantes
                  </button>
                </div>
                <div
                  id="participantes-loading"
                  class="loading-container"
                  style="display: none"
                >
                  <div class="loading-spinner"></div>
                  <p>Carregando participantes...</p>
                </div>
                <button
                  class="toggle-participants"
                  type="button"
                  style="display: none"
                >
                  Exibir Participantes
                </button>
                <div
                  id="timesContainer"
                  class="times-container"
                  style="display: none"
                >
                  <div class="times-grid"></div>
                </div>
              </div>

              <div id="rodadas" class="tab-content">
                <div class="rodadas-header">
                  <div class="rodadas-actions">
                    <select id="rodadaSelect" class="rodadas-select">
                      <option value="">Escolha uma rodada</option>
                    </select>
                    <button class="refresh-btn" id="refreshApiBtn">
                      Atualizar dados da API
                    </button>
                    <button id="parciaisBtn" class="parciais-btn" type="button">
                      Parciais
                    </button>
                  </div>
                </div>
                <div id="rodadasExportBtnContainer"></div>
                <div id="loading" style="display: none">Carregando...</div>
                <table id="rankingTable" class="ranking-table">
                  <thead>
                    <tr>
                      <th style="width: 36px; text-align: center">Pos</th>
                      <th style="width: 40px; text-align: center">‚ù§Ô∏è</th>
                      <th style="min-width: 110px; text-align: left">
                        Cartoleiro
                      </th>
                      <th style="min-width: 110px; text-align: left">
                        Time Cartoleiro
                      </th>
                      <th style="width: 48px; text-align: center">Pts</th>
                      <th style="width: 60px; text-align: center">Banco</th>
                    </tr>
                  </thead>
                  <tbody id="rankingBody"></tbody>
                </table>
              </div>

              <div id="mata-mata" class="tab-content">
                <div class="loading-container">
                  <div class="loading-spinner"></div>
                  <p>Carregando disputas mata-mata...</p>
                </div>
              </div>

              <div id="ranking-geral" class="tab-content">
                <div class="loading-container">
                  <div class="loading-spinner"></div>
                  <p>Calculando ranking geral...</p>
                </div>
              </div>

              <div id="pontos-corridos" class="tab-content">
                <div id="pontosCorridosSelect"></div>
                <div id="pontosCorridosRodada"></div>
              </div>

              <div id="melhor-mes" class="tab-content">
                <div id="melhorMesSelect"></div>
                <div id="melhorMesTabela"></div>
              </div>

              <div id="top-10" class="tab-content">
                <div
                  id="top10MitosExportBtnContainer"
                  style="text-align: right; margin-bottom: 8px"
                ></div>
                <div id="top10MitosTable"></div>
                <div style="height: 20px"></div>
                <div
                  id="top10MicosExportBtnContainer"
                  style="text-align: right; margin-bottom: 8px"
                ></div>
                <div id="top10MicosTable"></div>
              </div>

              <div id="fluxo-financeiro" class="tab-content">
                <div
                  id="fluxoFinanceiroButtons"
                  class="participantes-buttons-container"
                ></div>
                <div
                  id="fluxoFinanceiroExportBtnContainer"
                  style="text-align: right; margin-bottom: 8px"
                ></div>
                <div id="fluxoFinanceiroContent"></div>
              </div>

              <div id="artilheiro-campeao" class="tab-content">
                <div id="artilheiro-loading" class="loading-container">
                  <div class="loading-spinner"></div>
                  <p>Carregando dados do artilheiro campe√£o...</p>
                </div>
                <div id="artilheiro-container" style="display: none"></div>
              </div>

              <div id="luva-de-ouro" class="tab-content">
                <div
                  id="luvaDeOuroExportBtnContainer"
                  style="text-align: right; margin-bottom: 8px"
                ></div>
                <div id="luvaDeOuroContent"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
      console.log("üöÄ Iniciando carregamento da aplica√ß√£o...");

      // === INTEGRA√á√ÉO COM LAYOUT.HTML ===
      async function loadLayout() {
        try {
          console.log("üì¶ Carregando layout.html...");
          const response = await fetch("layout.html");
          const layoutHtml = await response.text();

          // Parse do HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(layoutHtml, "text/html");

          // Injetar sidebar
          const sidebar = doc.querySelector(".app-sidebar");
          if (sidebar) {
            document.getElementById("sidebar-placeholder").replaceWith(sidebar);
            console.log("‚úÖ Sidebar injetado");
          }

          // Injetar header
          const header = doc.querySelector(".page-header");
          if (header) {
            document.getElementById("header-placeholder").replaceWith(header);
            console.log("‚úÖ Header injetado");
          }

          // Executar scripts do layout
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            if (script.textContent.trim()) {
              const newScript = document.createElement("script");
              newScript.textContent = script.textContent;
              document.head.appendChild(newScript);
            }
          });

          console.log("‚úÖ Layout integrado com sucesso");
        } catch (error) {
          console.error("‚ùå Erro ao carregar layout:", error);
        }
      }

      // === ATUALIZAR BREADCRUMB ===
      function atualizarBreadcrumb(nomeLiga) {
        const breadcrumbLiga = document.getElementById("breadcrumbLiga");
        if (breadcrumbLiga && nomeLiga) {
          breadcrumbLiga.textContent = `üèÜ ${nomeLiga}`;
        }
      }

      // Debug panel
      const debugPanel = document.getElementById("debug-panel");
      const debugContent = document.getElementById("debug-content");
      let debugMode = localStorage.getItem("debug-mode") === "true";

      function toggleDebug() {
        debugMode = !debugMode;
        localStorage.setItem("debug-mode", debugMode.toString());
        debugPanel.style.display = debugMode ? "block" : "none";
      }

      // Ctrl+D para ativar debug
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "d") {
          e.preventDefault();
          toggleDebug();
        }
      });

      function updateDebug(modulo, status, erro = null) {
        if (!debugMode) return;
        const statusIcon =
          status === "ok" ? "‚úÖ" : status === "loading" ? "‚è≥" : "‚ùå";
        const errorText = erro ? ` (${erro})` : "";
        debugContent.innerHTML += `<div>${statusIcon} ${modulo}${errorText}</div>`;
      }

      // Fun√ß√£o para mostrar erro global
      function mostrarErroGlobal(mensagem, erro = null) {
        console.error("‚ùå Erro global:", mensagem, erro);
        const errorDiv = document.getElementById("errorMessage");
        if (errorDiv) {
          errorDiv.innerHTML = `
            <strong>Erro:</strong> ${mensagem}
            ${erro ? `<br><small>${erro.message}</small>` : ""}
            <br><small>Pressione Ctrl+D para ver detalhes do debug</small>
          `;
          errorDiv.style.display = "block";
        }
      }

      // Fun√ß√µes globais para uso em caso de falha dos m√≥dulos
      const fallbackFunctions = {
        carregarDetalhesLigaBasico: async () => {
          console.log("üìÑ Usando fallback para carregarDetalhesLigaBasico");
          try {
            // MODIFICA√á√ÉO: Tenta usar a nova fun√ß√£o primeiro
            if (modulosCarregados.participantes?.carregarDadosBasicos) {
              const resultado =
                await modulosCarregados.participantes.carregarDadosBasicos();
              if (resultado) return resultado;
            }

            // Fallback original melhorado
            const params = new URLSearchParams(window.location.search);
            const ligaId = params.get("id");

            if (!ligaId) {
              throw new Error("ID da liga n√£o encontrado na URL");
            }

            console.log(`Fallback: Buscando liga ${ligaId}`);
            const response = await fetch(`/api/ligas/${ligaId}`);

            if (!response.ok) {
              throw new Error(
                `Erro HTTP: ${response.status} ${response.statusText}`,
              );
            }

            const liga = await response.json();

            if (!liga) {
              throw new Error("Liga n√£o encontrada");
            }

            // Atualiza elementos da interface
            const nomeElement = document.getElementById("nomeLiga");
            const quantidadeElement =
              document.getElementById("quantidadeTimes");

            if (nomeElement) {
              nomeElement.textContent = `üèÜ ${liga.nome || "Liga"}`;
              // Atualizar breadcrumb
              atualizarBreadcrumb(liga.nome);
            }

            if (quantidadeElement) {
              const participantes = liga.participantes || liga.times || [];
              const quantidade = Array.isArray(participantes)
                ? participantes.length
                : 0;
              quantidadeElement.textContent = `${quantidade} participantes`;
            }

            console.log(
              `‚úÖ Fallback: Liga carregada - ${liga.nome} com ${(liga.participantes || liga.times || []).length} participantes`,
            );
            return liga;
          } catch (error) {
            console.error("‚ùå Fallback falhou:", error);
            mostrarErroGlobal("Erro ao carregar dados b√°sicos da liga", error);
          }
        },
      };

      // M√≥dulos para carregar
      const modulosConfig = [
        {
          nome: "participantes",
          arquivo: "./js/participantes.js",
          funcoes: [
            "carregarDetalhesLiga",
            "toggleParticipants",
            "carregarDadosBasicos",
          ],
          critico: true,
        },
        {
          nome: "rodadas",
          arquivo: "./js/rodadas.js",
          funcoes: ["carregarRodadas"],
          critico: false,
        },
        {
          nome: "mata-mata",
          arquivo: "./js/mata-mata.js",
          funcoes: ["carregarMataMata"],
          critico: false,
        },
        {
          nome: "ranking",
          arquivo: "./js/ranking.js",
          funcoes: ["carregarRankingGeral"],
          critico: false,
        },
        {
          nome: "melhor-mes",
          arquivo: "./js/melhor-mes.js",
          funcoes: ["inicializarMelhorMes"],
          critico: false,
        },
        {
          nome: "pontos-corridos",
          arquivo: "./js/pontos-corridos.js",
          funcoes: ["inicializarPontosCorridos"],
          critico: false,
        },
        {
          nome: "top10",
          arquivo: "./js/top10.js",
          funcoes: ["inicializarTop10"],
          critico: false,
        },
        {
          nome: "fluxo-financeiro",
          arquivo: "./js/fluxo-financeiro.js",
          funcoes: ["inicializarFluxoFinanceiro"],
          critico: false,
        },
        {
          nome: "artilheiro-campeao",
          arquivo: "./js/artilheiro-campeao.js",
          funcoes: ["inicializarArtilheiroCampeao"],
          critico: false,
        },
        {
          nome: "luva-de-ouro",
          arquivo: "./js/luva-de-ouro.js",
          funcoes: ["inicializarLuvaDeOuro"],
          critico: false,
        },
      ];

      // Tornar modulosCarregados dispon√≠vel globalmente
      window.modulosCarregados = {};
      const modulosCarregados = window.modulosCarregados;
      let modulo_participantes_ok = false;
      let participantesCarregados = false;

      // Carregar m√≥dulo individual com timeout
      async function carregarModulo(config) {
        updateDebug(config.nome, "loading");

        return new Promise((resolve) => {
          const timeout = setTimeout(() => {
            console.warn(`‚ö†Ô∏è Timeout ao carregar ${config.nome}`);
            updateDebug(config.nome, "error", "timeout");
            resolve(false);
          }, 10000); // 10 segundos timeout

          import(config.arquivo)
            .then((modulo) => {
              clearTimeout(timeout);

              const funcoesDisponiveis = {};
              let funcoesEncontradas = 0;

              config.funcoes.forEach((funcao) => {
                if (modulo[funcao]) {
                  funcoesDisponiveis[funcao] = modulo[funcao];
                  funcoesEncontradas++;
                } else {
                  console.warn(
                    `‚ö†Ô∏è Fun√ß√£o ${funcao} n√£o encontrada em ${config.nome}`,
                  );
                }
              });

              if (funcoesEncontradas > 0) {
                modulosCarregados[config.nome] = funcoesDisponiveis;
                console.log(
                  `‚úÖ M√≥dulo ${config.nome} carregado (${funcoesEncontradas}/${config.funcoes.length} fun√ß√µes)`,
                );
                updateDebug(config.nome, "ok");

                if (config.nome === "participantes") {
                  modulo_participantes_ok = true;
                }

                resolve(true);
              } else {
                console.error(
                  `‚ùå Nenhuma fun√ß√£o v√°lida encontrada em ${config.nome}`,
                );
                updateDebug(config.nome, "error", "no functions");
                resolve(false);
              }
            })
            .catch((error) => {
              clearTimeout(timeout);
              console.error(`‚ùå Erro ao carregar ${config.nome}:`, error);
              updateDebug(config.nome, "error", error.message);
              resolve(false);
            });
        });
      }

      // Fun√ß√£o para carregar participantes quando solicitado
      async function carregarParticipantes() {
        if (participantesCarregados) return;

        const btnCarregar = document.getElementById("carregarParticipantesBtn");
        const inicial = document.getElementById("participantes-inicial");
        const loading = document.getElementById("participantes-loading");

        try {
          console.log("üìÑ Iniciando carregamento dos participantes...");

          // Desabilita bot√£o e mostra loading
          btnCarregar.disabled = true;
          btnCarregar.textContent = "Carregando...";
          inicial.style.display = "none";
          loading.style.display = "block";

          // Carrega os dados dos participantes
          if (
            modulo_participantes_ok &&
            modulosCarregados.participantes?.carregarDetalhesLiga
          ) {
            await modulosCarregados.participantes.carregarDetalhesLiga();
          } else {
            await fallbackFunctions.carregarDetalhesLigaBasico();
          }

          // Mostra a interface dos participantes
          loading.style.display = "none";
          document.querySelector(".toggle-participants").style.display =
            "block";
          document.getElementById("timesContainer").style.display = "block";

          participantesCarregados = true;
          console.log("‚úÖ Participantes carregados com sucesso!");
        } catch (error) {
          console.error("‚ùå Erro ao carregar participantes:", error);
          loading.style.display = "none";
          inicial.style.display = "block";
          btnCarregar.disabled = false;
          btnCarregar.textContent = "üî• Carregar Participantes";
          mostrarErroGlobal("Erro ao carregar participantes", error);
        }
      }

      // ‚úÖ CORRE√á√ÉO: Fun√ß√£o unificada executarAcaoAba
      async function executarAcaoAba(tabId) {
        console.log(`üéØ Executando a√ß√£o da aba: ${tabId}`);
        try {
          switch (tabId) {
            case "participantes":
              // Para a aba participantes, apenas mostra a interface atual
              // O carregamento √© feito pelo bot√£o espec√≠fico
              break;
            case "rodadas":
              if (modulosCarregados.rodadas?.carregarRodadas) {
                await modulosCarregados.rodadas.carregarRodadas();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo rodadas n√£o dispon√≠vel");
              }
              break;
            case "mata-mata":
              if (modulosCarregados["mata-mata"]?.carregarMataMata) {
                await modulosCarregados["mata-mata"].carregarMataMata();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo mata-mata n√£o dispon√≠vel");
              }
              break;
            case "ranking-geral":
              if (modulosCarregados.ranking?.carregarRankingGeral) {
                await modulosCarregados.ranking.carregarRankingGeral();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo ranking n√£o dispon√≠vel");
              }
              break;
            case "melhor-mes":
              if (modulosCarregados["melhor-mes"]?.inicializarMelhorMes) {
                await modulosCarregados["melhor-mes"].inicializarMelhorMes();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo melhor-mes n√£o dispon√≠vel");
              }
              break;
            case "pontos-corridos":
              if (
                modulosCarregados["pontos-corridos"]?.inicializarPontosCorridos
              ) {
                await modulosCarregados[
                  "pontos-corridos"
                ].inicializarPontosCorridos();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo pontos-corridos n√£o dispon√≠vel");
              }
              break;
            case "top-10":
              if (modulosCarregados.top10?.inicializarTop10) {
                await modulosCarregados.top10.inicializarTop10();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo top10 n√£o dispon√≠vel");
              }
              break;
            case "fluxo-financeiro":
              if (
                modulosCarregados["fluxo-financeiro"]
                  ?.inicializarFluxoFinanceiro
              ) {
                await modulosCarregados[
                  "fluxo-financeiro"
                ].inicializarFluxoFinanceiro();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo fluxo-financeiro n√£o dispon√≠vel");
              }
              break;
            case "artilheiro-campeao":
              if (
                modulosCarregados["artilheiro-campeao"]
                  ?.inicializarArtilheiroCampeao
              ) {
                await modulosCarregados[
                  "artilheiro-campeao"
                ].inicializarArtilheiroCampeao();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo artilheiro-campeao n√£o dispon√≠vel");
              }
              break;
            case "luva-de-ouro":
              if (modulosCarregados["luva-de-ouro"]?.inicializarLuvaDeOuro) {
                await modulosCarregados["luva-de-ouro"].inicializarLuvaDeOuro();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo luva-de-ouro n√£o dispon√≠vel");
              }
              break;
          }
        } catch (error) {
          console.error(`‚ùå Erro ao executar a√ß√£o da aba ${tabId}:`, error);
          mostrarErroGlobal(`Erro na aba ${tabId}`, error);
        }
      }

      // ‚úÖ CORRE√á√ÉO: Fun√ß√£o atualizarPagina unificada
      async function atualizarPagina() {
        console.log("üéØ DOM carregado, iniciando aplica√ß√£o...");

        try {
          // === INTEGRA√á√ÉO COM LAYOUT PRIMEIRO ===
          await loadLayout();

          // Carregar dados b√°sicos automaticamente
          console.log("üì¶ Carregando dados b√°sicos da liga...");
          await fallbackFunctions.carregarDetalhesLigaBasico();

          // Carregar m√≥dulos cr√≠ticos
          console.log("üì¶ Carregando m√≥dulos cr√≠ticos...");
          const criticos = modulosConfig.filter((m) => m.critico);
          for (const modulo of criticos) {
            await carregarModulo(modulo);
          }

          // Carregar m√≥dulos n√£o-cr√≠ticos
          console.log("üì¶ Carregando m√≥dulos n√£o-cr√≠ticos...");
          const naoCriticos = modulosConfig.filter((m) => !m.critico);
          const promises = naoCriticos.map(carregarModulo);
          await Promise.allSettled(promises);

          console.log("üéõÔ∏è Configurando interface...");

          // Configurar personaliza√ß√£o da liga
          const params = new URLSearchParams(window.location.search);
          const ligaId = params.get("id");

          const tabMataMata = document.querySelector(
            '.tab[data-tab="mata-mata"]',
          );
          const tabPontosCorridos = document.querySelector(
            '.tab[data-tab="pontos-corridos"]',
          );
          const tabArtilheiro = document.querySelector(
            '.tab[data-tab="artilheiro-campeao"]',
          );
          const tabLuva = document.querySelector(
            '.tab[data-tab="luva-de-ouro"]',
          );

          if (tabArtilheiro) tabArtilheiro.style.display = "none";
          if (tabLuva) tabLuva.style.display = "none";

          if (ligaId === "684d821cf1a7ae16d1f89572") {
            if (tabMataMata) tabMataMata.style.display = "none";
            if (tabPontosCorridos) tabPontosCorridos.style.display = "none";
            if (tabArtilheiro) tabArtilheiro.style.display = "";
            if (tabLuva) tabLuva.style.display = "";
          }

          // Configurar event listeners das abas
          const tabs = document.querySelectorAll(".tab");
          const tabContents = document.querySelectorAll(".tab-content");

          tabs.forEach((tab) => {
            tab.addEventListener("click", async () => {
              const tabId = tab.getAttribute("data-tab");

              tabs.forEach((t) => t.classList.remove("active"));
              tabContents.forEach((content) =>
                content.classList.remove("active"),
              );
              tab.classList.add("active");

              const tabContent = document.getElementById(tabId);
              if (tabContent) {
                tabContent.classList.add("active");
                await executarAcaoAba(tabId);
              }
            });
          });

          // Configurar bot√£o de carregar participantes
          const btnCarregarParticipantes = document.getElementById(
            "carregarParticipantesBtn",
          );
          if (btnCarregarParticipantes) {
            btnCarregarParticipantes.addEventListener(
              "click",
              carregarParticipantes,
            );
          }

          // Configurar bot√£o toggle (s√≥ funciona depois de carregar)
          const toggleButton = document.querySelector(".toggle-participants");
          if (toggleButton) {
            if (modulosCarregados.participantes?.toggleParticipants) {
              toggleButton.onclick =
                modulosCarregados.participantes.toggleParticipants;
            } else {
              toggleButton.onclick = () => {
                const container = document.getElementById("timesContainer");
                container.style.display =
                  container.style.display === "none" ? "block" : "none";
              };
            }
          }

          const refreshButton = document.getElementById("refreshApiBtn");
          if (refreshButton && modulosCarregados.rodadas?.carregarRodadas) {
            refreshButton.onclick = () =>
              modulosCarregados.rodadas.carregarRodadas(true);
          }

          console.log("üéâ Aplica√ß√£o inicializada!");
          console.log("üìä M√≥dulos carregados:", Object.keys(modulosCarregados));

          if (debugMode) {
            updateDebug(
              "SISTEMA",
              "ok",
              `${Object.keys(modulosCarregados).length} m√≥dulos ativos`,
            );
          }
        } catch (error) {
          console.error("‚ùå Erro cr√≠tico:", error);
          mostrarErroGlobal("Erro cr√≠tico na inicializa√ß√£o", error);
        }
      }

      // ‚úÖ Event listener para DOMContentLoaded
      document.addEventListener("DOMContentLoaded", async () => {
        const globalLoading = document.getElementById("global-loading");

        // Mostrar loading usando classe
        if (globalLoading) {
          globalLoading.className = "show";
        }

        // Timeout de seguran√ßa - esconde loading ap√≥s 30 segundos no m√°ximo
        const safetyTimeout = setTimeout(() => {
          console.warn("‚ö†Ô∏è Timeout de seguran√ßa - escondendo loading");
          if (globalLoading) {
            globalLoading.className = "hide";
          }
        }, 30000);

        try {
          await atualizarPagina();

          // Verificar se h√° uma aba espec√≠fica na URL
          const urlParams = new URLSearchParams(window.location.search);
          const tabParam = urlParams.get("tab");

          if (tabParam) {
            // Ativar a aba espec√≠fica
            const tabButton = document.querySelector(
              `[data-tab="${tabParam}"]`,
            );
            if (tabButton) {
              tabButton.click();
            }
          }
        } catch (error) {
          console.error("‚ùå Erro ao atualizar p√°gina:", error);
          mostrarErroGlobal("Erro ao atualizar a p√°gina", error);
        } finally {
          // Limpar timeout de seguran√ßa
          clearTimeout(safetyTimeout);

          // Esconder loading usando classe
          if (globalLoading) {
            globalLoading.className = "hide";
          }

          console.log("‚úÖ Loading escondido - interface deve estar vis√≠vel");
        }
      });
    </script>
  </body>
</html>
