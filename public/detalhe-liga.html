<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Detalhe da Liga - Super Cartola Manager</title>

        <!-- Suprimir warnings de extens√µes do navegador -->
        <script>
            // Capturar erros de extens√µes que n√£o afetam o sistema
            if (!window.__dl_unhandledrejection_guard) {
                window.__dl_unhandledrejection_guard = true;
                window.addEventListener("unhandledrejection", function (event) {
                    if (
                        event.reason &&
                        event.reason.message &&
                        event.reason.message.includes("message channel closed")
                    ) {
                        event.preventDefault(); // Silenciar este erro espec√≠fico
                    }
                });
            }
        </script>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

        <!-- CSS HIER√ÅRQUICO MODULAR -->
        <!-- Design Tokens (SEMPRE PRIMEIRO) -->
        <link rel="stylesheet" href="css/_admin-tokens.css" />
        <link rel="stylesheet" href="style.css" />
        <link rel="stylesheet" href="detalhe-liga.css" />
        <link rel="stylesheet" href="css/base.css" />
        <link rel="stylesheet" href="css/performance.css" />
        <link rel="stylesheet" href="css/modules/detalhe-liga-redesign.css" />
        <link rel="stylesheet" href="css/modules/dashboard-redesign.css" />
        <link rel="stylesheet" href="css/modules/layout-horizontal.css" />
        <link rel="stylesheet" href="css/modules/fluxo-financeiro.css" />
        <link rel="stylesheet" href="css/modules/gerenciar.css" />
        <link rel="stylesheet" href="css/modules/capitao-luxo.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet" />

        <!-- MATERIAL ICONS -->
        <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet"
        />
        <!-- MATERIAL SYMBOLS OUTLINED (para m√≥dulos novos) -->
        <link
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="css/modules/super-modal.css" />
        <script src="js/super-modal.js"></script>
        <style>
            /* Fallback Material Icons */
            @font-face {
                font-family: "Material Icons";
                font-style: normal;
                font-weight: 400;
                src: url(https://fonts.gstatic.com/s/materialicons/v140/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2)
                    format("woff2");
            }
            .material-icons {
                font-family: "Material Icons" !important;
                font-weight: normal;
                font-style: normal;
                font-size: 24px;
                line-height: 1;
                letter-spacing: normal;
                text-transform: none;
                display: inline-block;
                white-space: nowrap;
                word-wrap: normal;
                direction: ltr;
                -webkit-font-feature-settings: "liga";
                font-feature-settings: "liga";
                -webkit-font-smoothing: antialiased;
            }
        </style>

        <!-- EXTERNAL DEPENDENCIES -->
        <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />

        <!-- CORRE√á√ÉO CR√çTICA: Definir fun√ß√µes globais no HEAD antes do carregamento -->
        <script>
            // === GERENCIAMENTO DA LOGO - DEFINIDO NO HEAD ===
            // Compat√≠vel com navega√ß√£o SPA (evita re-declara√ß√£o)
            window.logoTentativas = window.logoTentativas || [
                "img/logo-supercartola.png",
                "../public/img/logo-supercartola.png",
                "./public/img/logo-supercartola.png",
                "/public/img/logo-supercartola.png",
                "public/img/logo-supercartola.png",
            ];
            window.logoIndiceAtual = window.logoIndiceAtual ?? 0;

            function tentarProximoCaminho(img) {
                window.logoIndiceAtual++;
                if (window.logoIndiceAtual < window.logoTentativas.length) {
                    img.src = window.logoTentativas[window.logoIndiceAtual];
                } else {
                    // Todas as tentativas falharam, mostrar emoji
                    mostrarLogoFallback();
                }
            }

            function logoCarregada(img) {
                const fallback = document.getElementById("logoFallback");
                if (fallback) {
                    fallback.style.display = "none";
                }
                img.style.display = "block";
            }

            function mostrarLogoFallback() {
                const logoImage = document.getElementById("logoImage");
                const fallback = document.getElementById("logoFallback");
                if (logoImage) {
                    logoImage.style.display = "none";
                }
                if (fallback) {
                    fallback.style.display = "inline-block";
                }
            }

            // Fun√ß√£o goToDashboard para compatibilidade com layout
            function goToDashboard() {
                window.location.href = "painel.html";
            }

            // =====================================================================
            // CACHE RODADAS - FUN√á√ïES GLOBAIS (DEFINIDAS NO HEAD)
            // =====================================================================
            // Usar window.* para evitar re-declara√ß√£o em navega√ß√£o SPA
            if (typeof window.ligaIdCache === 'undefined') {
                window.ligaIdCache = null;
            }

            function obterLigaIdCache() {
                if (window.ligaIdCache) return window.ligaIdCache;
                const urlParams = new URLSearchParams(window.location.search);
                const ligaIdUrl =
                    urlParams.get("id") || urlParams.get("ligaId");
                if (ligaIdUrl) {
                    window.ligaIdCache = ligaIdUrl;
                    return ligaIdUrl;
                }
                if (window.ligaAtual?.id) return window.ligaAtual.id;
                if (window.ligaId) return window.ligaId;
                const ligaIdStorage = localStorage.getItem("ligaIdAtual");
                if (ligaIdStorage) return ligaIdStorage;
                return null;
            }

            // =====================================================================
            // CACHE TEMPORADA - FUN√á√ïES GLOBAIS (NAVEGA√á√ÉO MULTI-TEMPORADA)
            // =====================================================================
            // Usar window.* para evitar re-declara√ß√£o em navega√ß√£o SPA
            if (typeof window.temporadaCache === 'undefined') {
                window.temporadaCache = null;
            }

            function obterTemporadaCache() {
                if (window.temporadaCache) return window.temporadaCache;
                const temporadaUrl = window.SeasonContext?.getUrlSeason
                    ? window.SeasonContext.getUrlSeason()
                    : null;
                if (temporadaUrl) {
                    window.temporadaCache = parseInt(temporadaUrl, 10);
                    return window.temporadaCache;
                }
                // Fallback: temporada do sistema
                return window.SeasonContext?.getTemporadaSistema
                    ? window.SeasonContext.getTemporadaSistema()
                    : new Date().getFullYear();
            }

            // Exportar globalmente para uso em m√≥dulos
            window.obterTemporadaCache = obterTemporadaCache;
            window.temporadaContexto = obterTemporadaCache();

            function abrirModalRecalcMini() {
                const modal = document.getElementById("modalRecalcMini");
                if (modal) modal.classList.add("show");
            }

            function abrirModalLimparMini() {
                const modal = document.getElementById("modalLimparMini");
                if (modal) modal.classList.add("show");
            }

            // Abrir modal de configuracao de modulos
            function abrirModalModulos() {
                const ligaId = obterLigaIdCache();
                if (!ligaId) {
                    SuperModal.toast.warning('Liga nao identificada');
                    return;
                }

                // Criar modal container se nao existir
                let container = document.getElementById('modalModulosContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'modalModulosContainer';
                    document.body.appendChild(container);
                }

                // Template do modal principal
                container.innerHTML = `
                    <div class="modal fade" id="modalConfigModulos" tabindex="-1" data-bs-backdrop="static">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content bg-gray-800 text-white">
                                <div class="modal-header border-gray-700">
                                    <h5 class="modal-title">
                                        <span class="material-icons" style="vertical-align: middle;">extension</span>
                                        Configurar Modulos da Liga
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="listaModulosContainer">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <p class="text-muted mt-2">Carregando modulos...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer border-gray-700">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <span class="material-icons" style="vertical-align: middle;">close</span>
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Inicializar ModulosUI
                const temporada = new Date().getFullYear();
                ModulosUI.init({
                    ligaId: ligaId,
                    temporada: temporada,
                    containerSelector: '#listaModulosContainer',
                    modalContainerSelector: '#modalModulosContainer'
                });

                // Exibir modal
                const modal = new bootstrap.Modal(document.getElementById('modalConfigModulos'));
                modal.show();
            }

            // Toggle se√ß√£o de Administra√ß√£o da Liga
            function toggleAdminSection() {
                const section = document.getElementById("admin-tools-section");
                if (section) {
                    section.classList.toggle("admin-collapsed");
                    // Salvar prefer√™ncia no localStorage
                    const isCollapsed = section.classList.contains("admin-collapsed");
                    localStorage.setItem("adminSectionCollapsed", isCollapsed);
                }
            }

            // Restaurar estado da se√ß√£o Admin ao carregar
            if (!window.__dl_admin_section_init) {
                window.__dl_admin_section_init = true;
                document.addEventListener("DOMContentLoaded", function() {
                    const section = document.getElementById("admin-tools-section");
                    const savedState = localStorage.getItem("adminSectionCollapsed");
                    // Por padr√£o come√ßa colapsado, a menos que o usu√°rio tenha expandido
                    if (savedState === "false" && section) {
                        section.classList.remove("admin-collapsed");
                    }
                    // Atualizar texto do bot√£o voltar baseado no estado inicial
                    atualizarBotaoVoltar();
                });
            }

            // =====================================================================
            // BOT√ÉO VOLTAR CONTEXTUAL
            // - Se estiver nos cards da liga ‚Üí vai para painel.html (Dashboard)
            // - Se estiver em um m√≥dulo ‚Üí volta para os cards da liga
            // =====================================================================
            function voltarContextual() {
                const secondaryScreen = document.getElementById("secondary-screen");
                const estaEmModulo = secondaryScreen &&
                    (secondaryScreen.classList.contains("active") ||
                     secondaryScreen.style.display === "block");

                if (estaEmModulo) {
                    // Est√° em um m√≥dulo ‚Üí voltar para cards da liga
                    if (typeof window.voltarParaCards === "function") {
                        window.voltarParaCards();
                    } else if (window.orquestrador?.voltarParaCards) {
                        window.orquestrador.voltarParaCards();
                    }
                    atualizarBotaoVoltar();
                } else {
                    // Est√° nos cards ‚Üí ir para dashboard
                    window.location.href = "painel.html";
                }
            }

            function atualizarBotaoVoltar() {
                const secondaryScreen = document.getElementById("secondary-screen");
                const btnTexto = document.getElementById("btnVoltarTexto");
                if (!btnTexto) return;

                const estaEmModulo = secondaryScreen &&
                    (secondaryScreen.classList.contains("active") ||
                     secondaryScreen.style.display === "block");

                btnTexto.textContent = estaEmModulo ? "Voltar aos Cards" : "Voltar ao Dashboard";
            }

            // Observar mudan√ßas na tela secund√°ria para atualizar o bot√£o
            if (!window.__dl_secondary_observer_init) {
                window.__dl_secondary_observer_init = true;
                document.addEventListener("DOMContentLoaded", function() {
                    const secondaryScreen = document.getElementById("secondary-screen");
                    if (secondaryScreen) {
                        const observer = new MutationObserver(atualizarBotaoVoltar);
                        observer.observe(secondaryScreen, { attributes: true, attributeFilter: ["class", "style"] });
                        window.__dl_secondary_observer = observer;
                    }
                });
            }

            function fecharModalMini(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove("show");
            }

            function mostrarToastMini(tipo, mensagem) {
                const toast = document.getElementById("toastCacheMini");
                if (!toast) return;
                const icone = toast.querySelector(".material-symbols-outlined");
                const texto = document.getElementById("toastCacheMiniTexto");
                toast.classList.remove("success", "error");
                toast.classList.add(tipo);
                if (icone)
                    icone.textContent =
                        tipo === "success" ? "check_circle" : "error";
                if (texto) texto.textContent = mensagem;
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 3500);
            }

            // ‚úÖ FIX P0: Helper para fetch com timeout (CRIT-FIN-001)
            async function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error(`Timeout: servidor n√£o respondeu em ${timeoutMs / 1000}s`);
                    }
                    throw error;
                }
            }

            async function executarRecalcMini() {
                const ligaId = obterLigaIdCache();
                if (!ligaId) {
                    mostrarToastMini("error", "Liga n√£o identificada");
                    return;
                }
                const inicio = parseInt(
                    document.getElementById("miniRodadaInicio").value,
                );
                const fim = parseInt(
                    document.getElementById("miniRodadaFim").value,
                );
                const btn = document.getElementById("btnRecalcMini");
                if (inicio < 1 || fim > 38 || inicio > fim) {
                    mostrarToastMini("error", "Valores inv√°lidos");
                    return;
                }

                // ‚úÖ CRIT-FIN-002: Elementos da barra de progresso
                const progressContainer = document.getElementById("recalcProgress");
                const progressText = document.getElementById("recalcProgressText");
                const progressBar = document.getElementById("recalcProgressBar");

                // Desabilitar bot√£o e mostrar feedback inicial
                btn.disabled = true;
                btn.innerHTML =
                    '<div class="spinner-mini"></div>Recalculando...';

                // Mostrar barra de progresso
                progressContainer.style.display = "block";
                progressText.textContent = "Processando rec√°lculo...";
                progressBar.style.width = "0%";

                // ‚úÖ CRIT-FIN-002: Warning ap√≥s 20s
                let warningTimeout = setTimeout(() => {
                    progressText.innerHTML = '‚è±Ô∏è <strong>Est√° demorando mais que o esperado...</strong> O servidor est√° processando muitas rodadas.';
                    progressText.style.color = "#f59e0b"; // Amber-500
                }, 20000);

                // ‚úÖ CRIT-FIN-002: Simula√ß√£o de progresso (fake progress baseado em tempo)
                let fakeProgress = 0;
                const progressInterval = setInterval(() => {
                    if (fakeProgress < 90) {
                        fakeProgress += Math.random() * 10;
                        if (fakeProgress > 90) fakeProgress = 90;
                        progressBar.style.width = `${fakeProgress}%`;
                    }
                }, 1000);

                try {
                    // ‚úÖ FIX P0: Timeout de 30s para rec√°lculo (CRIT-FIN-001)
                    const response = await fetchWithTimeout(
                        `/api/rodadas-cache/${ligaId}/recalcular`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                rodadaInicio: inicio,
                                rodadaFim: fim,
                            }),
                        },
                        30000 // 30s timeout para processar at√© 38 rodadas
                    );

                    if (!response.ok) {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }

                    const resultado = await response.json();
                    if (resultado.success) {
                        // ‚úÖ CRIT-FIN-002: Completar progresso ao sucesso
                        clearTimeout(warningTimeout);
                        clearInterval(progressInterval);
                        progressBar.style.width = "100%";
                        progressText.textContent = `‚úÖ ${resultado.totalRecalculados} registros recalculados`;
                        progressText.style.color = "#10b981"; // Green-500

                        // Aguardar 1s para usu√°rio ver progresso completo
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        fecharModalMini("modalRecalcMini");
                        mostrarToastMini(
                            "success",
                            `‚úÖ ${resultado.totalRecalculados} registros recalculados`,
                        );
                    } else {
                        throw new Error(resultado.erro || "Erro ao recalcular");
                    }
                } catch (error) {
                    console.error('[RECALC-CACHE] Erro:', error);

                    // ‚úÖ CRIT-FIN-002: Limpar timers
                    clearTimeout(warningTimeout);
                    clearInterval(progressInterval);

                    // Mensagem espec√≠fica para timeout
                    let errorMsg = error.message;
                    if (error.message.includes('Timeout')) {
                        const totalRodadas = fim - inicio + 1;
                        errorMsg = `Timeout: rec√°lculo de ${totalRodadas} rodadas demorou mais que 30s. Tente um intervalo menor.`;
                    }

                    // ‚úÖ CRIT-FIN-002: Mostrar erro na √°rea de progresso
                    progressBar.style.width = "100%";
                    progressBar.style.background = "#ef4444"; // Red-500
                    progressText.innerHTML = `‚ùå <strong>Erro:</strong> ${errorMsg}`;
                    progressText.style.color = "#ef4444";

                    mostrarToastMini("error", errorMsg);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = "Executar";

                    // ‚úÖ CRIT-FIN-002: Esconder progresso ap√≥s 3s (se houver erro)
                    setTimeout(() => {
                        if (progressContainer.style.display !== "none") {
                            progressContainer.style.display = "none";
                            progressBar.style.width = "0%";
                            progressBar.style.background = "linear-gradient(90deg, #FF5500 0%, #FF8833 100%)";
                            progressText.style.color = "var(--text-muted, #9ca3af)";
                        }
                    }, 3000);
                }
            }

            async function executarLimparMini() {
                const ligaId = obterLigaIdCache();
                if (!ligaId) {
                    mostrarToastMini("error", "Liga n√£o identificada");
                    return;
                }
                try {
                    // ‚úÖ FIX P0: Timeout de 10s para limpeza (CRIT-FIN-001)
                    const response = await fetchWithTimeout(
                        `/api/rodadas-cache/${ligaId}/limpar`,
                        {
                            method: "DELETE",
                        },
                        10000 // 10s timeout para opera√ß√£o de limpeza
                    );

                    if (!response.ok) {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }

                    const resultado = await response.json();
                    if (resultado.success) {
                        fecharModalMini("modalLimparMini");
                        mostrarToastMini(
                            "success",
                            `üóëÔ∏è ${resultado.deletedCount} registros removidos`,
                        );
                    } else {
                        throw new Error(resultado.erro || "Erro ao limpar");
                    }
                } catch (error) {
                    console.error('[LIMPAR-CACHE] Erro:', error);

                    // Mensagem espec√≠fica para timeout
                    let errorMsg = error.message;
                    if (error.message.includes('Timeout')) {
                        errorMsg = 'Timeout: opera√ß√£o de limpeza demorou mais que 10s. Servidor pode estar processando em background.';
                    }

                    mostrarToastMini("error", errorMsg);
                }
            }
        </script>
    </head>

    <body class="detalhe-liga-page">
        <div class="app-container">
            <div id="sidebar-placeholder"></div>

            <main class="app-main detalhe-liga-redesign">
                <div class="page-content">
                    <!-- Bot√£o Voltar Contextual -->
                    <div class="back-button-container">
                        <button id="btnVoltarContextual" class="btn-back-new" onclick="voltarContextual()">
                            <span class="material-icons">arrow_back</span>
                            <span id="btnVoltarTexto">Voltar ao Dashboard</span>
                        </button>
                    </div>

                    <!-- Header da Liga - NOVO DESIGN (IDs MANTIDOS) -->
                    <div class="liga-header-new">
                        <div class="liga-header-left">
                            <div class="liga-logo-container" id="ligaLogoContainer">
                                <span class="material-icons liga-logo-icon">emoji_events</span>
                            </div>
                            <div class="liga-header-info">
                                <h1 id="nomeLiga">Nome da Liga</h1>
                                <p id="quantidadeTimes">0 participantes</p>
                                <!-- Badge de Temporada Hist√≥rica (Multi-Temporada) -->
                                <span id="temporadaBadge" class="temporada-badge" style="display: none;">
                                    <span class="material-icons">history</span>
                                    <span>Temporada </span><span id="temporadaLabel">2025</span>
                                </span>
                            </div>
                        </div>
                        <div class="liga-header-actions">
                            <button class="btn-header-action btn-header-secondary" onclick="location.reload()">
                                <span class="material-icons">refresh</span>
                                Atualizar
                            </button>
                        </div>
                    </div>

                    <!-- Tela Principal - 11 Cards Independentes (IDs E DATA-MODULE MANTIDOS) -->
                    <div id="main-screen" class="main-screen">
                        <div class="modules-grid modules-grid-expanded">
                            <!-- 1. Card Participantes -->
                            <div class="module-card" data-module="participantes">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">groups</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Participantes</h3>
                                <p class="module-description">Gerenciar times e cartoleiros da liga.</p>
                                <div class="module-count" id="participantes-count">0 membros</div>
                            </div>

                            <!-- 2. Card Classifica√ß√£o Geral -->
                            <div class="module-card" data-module="ranking-geral">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">leaderboard</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Classifica√ß√£o</h3>
                                <p class="module-description">Ranking geral acumulado da liga.</p>
                            </div>

                            <!-- 3. Card Resultados Parciais -->
                            <div class="module-card" data-module="parciais">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">timelapse</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Parciais</h3>
                                <p class="module-description">Acompanhamento em tempo real.</p>
                            </div>

                            <!-- 4. Card Top 10 -->
                            <div class="module-card" data-module="top10">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">star</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Top 10 - Destaques</h3>
                                <p class="module-description">Maiores e menores pontua√ß√µes por rodada.</p>
                            </div>

                            <!-- 5. Card Por Rodadas -->
                            <div class="module-card" data-module="rodadas">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">calendar_month</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Ranking por Rodada</h3>
                                <p class="module-description">Classifica√ß√£o detalhada rodada a rodada.</p>
                            </div>

                            <!-- 6. Card Melhor M√™s -->
                            <div class="module-card" data-module="melhor-mes">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">emoji_events</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Melhor do M√™s</h3>
                                <p class="module-description">Competi√ß√£o mensal baseada em edi√ß√µes.</p>
                            </div>

                            <!-- 7. Card Mata-mata -->
                            <div class="module-card" data-module="mata-mata">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">sports_mma</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Mata-Mata</h3>
                                <p class="module-description">Chaves eliminat√≥rias e confrontos diretos.</p>
                            </div>

                            <!-- 8. Card Pontos Corridos -->
                            <div class="module-card" data-module="pontos-corridos">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">list_alt</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Pontos Corridos</h3>
                                <p class="module-description">Tabela geral acumulada da liga.</p>
                            </div>

                            <!-- 9. Card Luva de Ouro -->
                            <div class="module-card" data-module="luva-de-ouro">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">sports_handball</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Luva de Ouro</h3>
                                <p class="module-description">Ranking de defesas dos goleiros.</p>
                            </div>

                            <!-- 10. Card Artilheiro -->
                            <div class="module-card" data-module="artilheiro-campeao">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">sports_soccer</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Artilheiro</h3>
                                <p class="module-description">Ranking de gols dos atacantes.</p>
                            </div>

                            <!-- 11. Card Fluxo Financeiro -->
                            <div class="module-card" data-module="fluxo-financeiro">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">attach_money</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Financeiro</h3>
                                <p class="module-description">Controle de pagamentos e extratos.</p>
                            </div>

                            <!-- ============================================= -->
                            <!-- NOVAS DISPUTAS 2026 - Lan√ßamentos Exclusivos -->
                            <!-- ============================================= -->

                            <!-- 12. Card Tiro Certo (NOVO 2026) -->
                            <div class="module-card module-card-2026" data-module="tiro-certo">
                                <div class="module-header">
                                    <div class="module-icon icon-2026">
                                        <span class="material-icons">gps_fixed</span>
                                    </div>
                                    <span class="badge-2026">2026</span>
                                </div>
                                <h3 class="module-title">Tiro Certo</h3>
                                <p class="module-description">Modo Survival: errou, caiu fora.</p>
                                <div class="module-status-2026">Em breve</div>
                            </div>

                            <!-- 13. Card Bol√£o Copa & Liberta (NOVO 2026) -->
                            <div class="module-card module-card-2026" data-module="bolao-copa">
                                <div class="module-header">
                                    <div class="module-icon icon-2026">
                                        <span class="material-icons">public</span>
                                    </div>
                                    <span class="badge-2026">2026</span>
                                </div>
                                <h3 class="module-title">Bol√£o Copa & Liberta</h3>
                                <p class="module-description">Palpites em torneios internacionais.</p>
                                <div class="module-status-2026">Em breve</div>
                            </div>

                            <!-- 14. Card Resta Um (RETORNO 2026) -->
                            <div class="module-card module-card-2026" data-module="resta-um">
                                <div class="module-header">
                                    <div class="module-icon icon-2026">
                                        <span class="material-icons">person_off</span>
                                    </div>
                                    <span class="badge-2026">2026</span>
                                </div>
                                <h3 class="module-title">Resta Um</h3>
                                <p class="module-description">Elimina√ß√£o progressiva por rodada.</p>
                                <div class="module-status-2026">Em breve</div>
                            </div>

                            <!-- 15. Card Capit√£o de Luxo -->
                            <div class="module-card module-card-capitao" data-module="capitao-luxo">
                                <div class="module-header">
                                    <div class="module-icon">
                                        <span class="material-icons">military_tech</span>
                                    </div>
                                    <span class="material-icons module-arrow">chevron_right</span>
                                </div>
                                <h3 class="module-title">Capit√£o de Luxo</h3>
                                <p class="module-description">Ranking exclusivo de capit√£es.</p>
                            </div>
                        </div>
                    </div>

                    <!-- === SE√á√ÉO ADMINISTRA√á√ÉO DA LIGA (COLAPS√ÅVEL) === -->
                    <div class="admin-tools-section admin-collapsed" id="admin-tools-section">
                        <button class="admin-tools-toggle" onclick="toggleAdminSection()">
                            <div class="admin-tools-title">
                                <span class="material-icons">admin_panel_settings</span>
                                <span>Administra√ß√£o da Liga</span>
                            </div>
                            <span class="admin-toggle-icon material-icons">expand_more</span>
                        </button>
                        <div class="admin-tools-grid">
                            <!-- Editar Dados da Liga -->
                            <a href="#" class="admin-tool-item" id="btnEditarLiga">
                                <div class="admin-tool-icon edit">
                                    <span class="material-icons">edit</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Editar Dados</span>
                                    <span class="admin-tool-desc">Nome, formato e configura√ß√µes</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </a>

                            <!-- Gerenciar Times -->
                            <a href="#" class="admin-tool-item" id="btnGerenciarTimes">
                                <div class="admin-tool-icon teams">
                                    <span class="material-icons">group_add</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Gerenciar Times</span>
                                    <span class="admin-tool-desc">Adicionar ou remover participantes</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </a>

                            <!-- Processar Rodadas -->
                            <a href="ferramentas-rodadas.html" class="admin-tool-item">
                                <div class="admin-tool-icon process">
                                    <span class="material-icons">autorenew</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Processar Rodadas</span>
                                    <span class="admin-tool-desc">Popular e atualizar dados</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </a>

                            <!-- Recalcular Cache -->
                            <button class="admin-tool-item" onclick="abrirModalRecalcMini()">
                                <div class="admin-tool-icon cache">
                                    <span class="material-icons">refresh</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Recalcular Cache</span>
                                    <span class="admin-tool-desc">Recalcula rankings das rodadas</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </button>

                            <!-- Auditoria de Extratos -->
                            <a href="#" class="admin-tool-item" id="btnAuditoria">
                                <div class="admin-tool-icon audit">
                                    <span class="material-icons">fact_check</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Auditoria</span>
                                    <span class="admin-tool-desc">Verificar integridade dos extratos</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </a>

                            <!-- Limpar Cache -->
                            <button class="admin-tool-item danger" onclick="abrirModalLimparMini()">
                                <div class="admin-tool-icon danger">
                                    <span class="material-icons">delete_sweep</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Limpar Cache</span>
                                    <span class="admin-tool-desc">Remove dados de cache</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </button>

                            <!-- Configurar M√≥dulos -->
                            <button class="admin-tool-item" onclick="abrirModalModulos()">
                                <div class="admin-tool-icon modules">
                                    <span class="material-icons">extension</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Configurar Modulos</span>
                                    <span class="admin-tool-desc">Ativar/desativar e configurar modulos</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </button>

                            <!-- Criar Nova Liga -->
                            <a href="criar-liga.html" class="admin-tool-item">
                                <div class="admin-tool-icon create">
                                    <span class="material-icons">add_circle</span>
                                </div>
                                <div class="admin-tool-info">
                                    <span class="admin-tool-label">Criar Nova Liga</span>
                                    <span class="admin-tool-desc">Iniciar uma nova competi√ß√£o</span>
                                </div>
                                <span class="material-icons admin-tool-arrow">chevron_right</span>
                            </a>
                        </div>
                    </div>

                    <!-- Tela Secund√°ria - Conte√∫do Din√¢mico (IDs MANTIDOS) -->
                    <div id="secondary-screen" class="dynamic-content">
                        <div id="dynamic-content-area">
                            <!-- Conte√∫do ser√° injetado aqui dinamicamente -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- Overlay de Loading (ID MANTIDO) -->
            <div id="processing-overlay" class="processing-overlay">
                <div class="spinner"></div>
                <div class="processing-text">Carregando dados...</div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- jsPDF para exporta√ß√£o de PDF -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

        <!-- COMPONENTE CACHE RODADAS -->
        <style>
            /* Modais */
            .modal-cache-mini {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                z-index: 9999;
                align-items: center;
                justify-content: center;
            }
            .modal-cache-mini.show {
                display: flex;
            }
            .modal-cache-content {
                background: #1a1a1a;
                border: 1px solid #3a3a3c;
                border-radius: 12px;
                padding: 24px;
                max-width: 420px;
                width: 90%;
            }
            .modal-cache-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 16px;
            }
            .modal-cache-header .material-symbols-outlined {
                color: #f97316;
                font-size: 24px;
            }
            .modal-cache-header h3 {
                font-size: 16px;
                font-weight: 600;
                color: #fff;
                margin: 0;
            }
            .modal-cache-body {
                margin-bottom: 20px;
            }
            .modal-cache-body p {
                color: #9ca3af;
                font-size: 13px;
                line-height: 1.5;
                margin-bottom: 12px;
            }
            .input-mini-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 12px;
            }
            .input-mini-field label {
                font-size: 11px;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                display: block;
                margin-bottom: 4px;
            }
            .input-mini-field input {
                width: 100%;
                background: #262626;
                border: 1px solid #3a3a3c;
                border-radius: 6px;
                padding: 8px;
                color: #fff;
                font-size: 14px;
            }
            .input-mini-field input:focus {
                outline: none;
                border-color: #f97316;
            }
            .modal-cache-footer {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }
            .btn-mini {
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                border: none;
                transition: all 0.2s;
            }
            .btn-mini-cancel {
                background: #262626;
                color: #9ca3af;
            }
            .btn-mini-cancel:hover {
                background: #333;
            }
            .btn-mini-confirm {
                background: #f97316;
                color: white;
            }
            .btn-mini-confirm:hover {
                background: #ea580c;
            }
            .btn-mini-confirm:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn-mini-danger {
                background: #ef4444;
                color: white;
            }
            .btn-mini-danger:hover {
                background: #dc2626;
            }
            .spinner-mini {
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top: 2px solid white;
                width: 12px;
                height: 12px;
                animation: admin-spin 0.8s linear infinite;
                display: inline-block;
                margin-right: 6px;
            }
            .toast-cache-mini {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #1a1a1a;
                border: 1px solid #3a3a3c;
                border-radius: 8px;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                font-size: 13px;
            }
            .toast-cache-mini.show {
                transform: translateX(0);
            }
            .toast-cache-mini.success {
                border-color: #22c55e;
            }
            .toast-cache-mini.error {
                border-color: #ef4444;
            }
            .toast-cache-mini .material-symbols-outlined {
                font-size: 20px;
            }
            .toast-cache-mini.success .material-symbols-outlined {
                color: #22c55e;
            }
            .toast-cache-mini.error .material-symbols-outlined {
                color: #ef4444;
            }
        </style>

        <div class="modal-cache-mini" id="modalRecalcMini">
            <div class="modal-cache-content">
                <div class="modal-cache-header">
                    <span class="material-symbols-outlined">refresh</span>
                    <h3>Recalcular Rodadas</h3>
                </div>
                <div class="modal-cache-body">
                    <p>
                        Recalcula as posi√ß√µes considerando times ativos em cada
                        rodada.
                    </p>
                    <div class="input-mini-group">
                        <div class="input-mini-field">
                            <label>De</label>
                            <input
                                type="number"
                                id="miniRodadaInicio"
                                value="1"
                                min="1"
                                max="38"
                            />
                        </div>
                        <div class="input-mini-field">
                            <label>At√©</label>
                            <input
                                type="number"
                                id="miniRodadaFim"
                                value="38"
                                min="1"
                                max="38"
                            />
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ CRIT-FIN-002: Barra de progresso -->
                <div id="recalcProgress" style="display: none; padding: 0 20px 15px 20px;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px;">
                        <p id="recalcProgressText" style="color: var(--text-muted, #9ca3af); font-size: 0.85rem; margin: 0 0 8px 0; text-align: center;">
                            Processando...
                        </p>
                        <div style="background: var(--bg-tertiary, #1a1a1a); height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="recalcProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #FF5500 0%, #FF8833 100%); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-cache-footer">
                    <button
                        class="btn-mini btn-mini-cancel"
                        onclick="fecharModalMini('modalRecalcMini')"
                    >
                        Cancelar
                    </button>
                    <button
                        class="btn-mini btn-mini-confirm"
                        id="btnRecalcMini"
                        onclick="executarRecalcMini()"
                    >
                        Executar
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-cache-mini" id="modalLimparMini">
            <div class="modal-cache-content">
                <div class="modal-cache-header">
                    <span class="material-symbols-outlined">delete</span>
                    <h3>Limpar Cache</h3>
                </div>
                <div class="modal-cache-body">
                    <p style="color: #ef4444; font-weight: 600">
                        ‚ö†Ô∏è Remove todos os dados de cache desta liga.
                    </p>
                    <p>Ser√° necess√°rio recalcular depois.</p>
                </div>
                <div class="modal-cache-footer">
                    <button
                        class="btn-mini btn-mini-cancel"
                        onclick="fecharModalMini('modalLimparMini')"
                    >
                        Cancelar
                    </button>
                    <button
                        class="btn-mini btn-mini-danger"
                        onclick="executarLimparMini()"
                    >
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

        <div class="toast-cache-mini" id="toastCacheMini">
            <span class="material-symbols-outlined"></span>
            <span id="toastCacheMiniTexto"></span>
        </div>

        <script>
            // Listener para fechar modais ao clicar fora
            if (!window.__dl_modal_close_init) {
                window.__dl_modal_close_init = true;
                document.addEventListener("DOMContentLoaded", () => {
                    document
                        .querySelectorAll(".modal-cache-mini")
                        .forEach((modal) => {
                            modal.addEventListener("click", (e) => {
                                if (
                                    e.target.classList.contains("modal-cache-mini")
                                ) {
                                    modal.classList.remove("show");
                                }
                            });
                        });
                });
            }
        </script>

        <!-- CONTEXTO DE TEMPORADA (deve carregar antes dos m√≥dulos) -->
        <script src="js/core/season-context.js"></script>

        <!-- SCHEDULERS AUTOM√ÅTICOS (devem carregar antes dos m√≥dulos) -->
        <script src="js/parciais-scheduler.js"></script>
        <script src="js/luva-de-ouro/luva-de-ouro-scheduler.js"></script>

        <!-- SCRIPTS MODULARES -->
        <script src="js/cards-condicionais.js"></script>
        <script src="js/sistema-modulos-init.js"></script>

        <!-- SISTEMA DE CONFIGURACAO DE MODULOS -->
        <script src="js/modulos/modulos-api.js"></script>
        <script src="js/modulos/modulos-wizard.js"></script>
        <script src="js/modulos/modulos-ui.js"></script>
        
        <!-- COMPONENTE DE TOOLTIPS DE REGRAS FINANCEIRAS -->
        <script src="js/components/tooltip-regras-financeiras.js"></script>
        
        <script type="module" src="js/detalhe-liga-orquestrador.js"></script>

        <!-- M√ìDULOS JS EXISTENTES -->
        <script type="module" src="js/utils.js"></script>
        <script type="module" src="js/navigation.js"></script>
        <!-- seletor-ligas.js REMOVIDO - redundante com sidebar -->

        <!-- LOGO DINAMICA DA LIGA NO HEADER -->
        <script>
            // Observa mudan√ßas no elemento nomeLiga para atualizar a logo
            function atualizarLogoLiga() {
                const nomeLigaEl = document.getElementById('nomeLiga');
                const logoContainer = document.getElementById('ligaLogoContainer');
                if (!nomeLigaEl || !logoContainer) return;

                // ‚úÖ Logo din√¢mica via campo liga.logo (sem hardcode)
                // A logo √© obtida do objeto da liga carregado via API
                const logoUrl = window._currentLigaLogo || null;

                if (logoUrl) {
                    logoContainer.innerHTML = `
                        <img src="${logoUrl}" alt="" class="liga-logo-img-header"
                             onerror="this.parentElement.innerHTML='<span class=\\'material-icons liga-logo-icon\\'>emoji_events</span>';" />
                    `;
                }
            }

            // Usar MutationObserver para detectar quando o nome da liga √© atualizado
            if (!window.__dl_logo_observer_init) {
                window.__dl_logo_observer_init = true;
                document.addEventListener('DOMContentLoaded', () => {
                    const nomeLigaEl = document.getElementById('nomeLiga');
                    if (nomeLigaEl) {
                        const observer = new MutationObserver(atualizarLogoLiga);
                        observer.observe(nomeLigaEl, { childList: true, characterData: true, subtree: true });
                        window.__dl_logo_observer = observer;
                        // Tamb√©m verificar ap√≥s um delay (fallback)
                        setTimeout(atualizarLogoLiga, 500);
                        setTimeout(atualizarLogoLiga, 1500);
                    }
                });
            }
        </script>

        <!-- ADMINISTRA√á√ÉO DA LIGA - HANDLERS -->
        <script>
            // === HANDLERS PARA BOT√ïES DE ADMINISTRA√á√ÉO ===
            if (!window.__dl_admin_handlers_init) {
                window.__dl_admin_handlers_init = true;
                document.addEventListener('DOMContentLoaded', () => {
                    const ligaId = obterLigaIdCache();

                // Bot√£o Editar Liga
                const btnEditar = document.getElementById('btnEditarLiga');
                if (btnEditar) {
                    btnEditar.addEventListener('click', (e) => {
                        e.preventDefault();
                        const id = obterLigaIdCache();
                        if (id) {
                            window.location.href = `editar-liga.html?id=${id}`;
                        } else {
                            SuperModal.toast.warning('Liga nao identificada');
                        }
                    });
                }

                // Bot√£o Gerenciar Times
                const btnTimes = document.getElementById('btnGerenciarTimes');
                if (btnTimes) {
                    btnTimes.addEventListener('click', (e) => {
                        e.preventDefault();
                        const id = obterLigaIdCache();
                        if (id) {
                            window.location.href = `preencher-liga.html?id=${id}`;
                        } else {
                            SuperModal.toast.warning('Liga nao identificada');
                        }
                    });
                }

                // Bot√£o Auditoria
                const btnAuditoria = document.getElementById('btnAuditoria');
                if (btnAuditoria) {
                    btnAuditoria.addEventListener('click', (e) => {
                        e.preventDefault();
                        const id = obterLigaIdCache();
                        if (id) {
                            window.location.href = `auditoria-extratos.html?liga=${id}`;
                        } else {
                            SuperModal.toast.warning('Liga nao identificada');
                        }
                    });
                }
                });
            }
        </script>

    </body>
</html>
