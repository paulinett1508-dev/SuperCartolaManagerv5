<!doctype html>
<html lang="pt-BR">
  <head>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detalhes da Liga</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Adiciona html2canvas para exporta√ß√£o de imagem -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
      .mito-highlight {
        background-color: #cceeff !important;
        font-weight: bold;
      }
      .mico-highlight {
        background-color: #ffdddd !important;
        font-style: italic;
      }

      #tabela-artilheiro-rodada table.ranking-table th,
      #tabela-artilheiro-rodada table.ranking-table td {
        padding: 2px 3px !important;
        font-size: 9px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(3),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(3) {
        max-width: 50px !important;
        width: 50px !important;
        padding: 2px 2px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(4),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(4) {
        max-width: 50px !important;
        width: 50px !important;
        padding: 2px 2px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(1),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(1) {
        width: 20px !important;
        padding: 2px 1px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(2),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(2) {
        width: 20px !important;
        padding: 2px 1px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table th:nth-child(5),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(5),
      #tabela-artilheiro-rodada table.ranking-table th:nth-child(6),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(6),
      #tabela-artilheiro-rodada table.ranking-table th:nth-child(7),
      #tabela-artilheiro-rodada table.ranking-table td:nth-child(7) {
        width: 25px !important;
        padding: 2px 1px !important;
      }

      #tabela-artilheiro-rodada img {
        width: 12px !important;
        height: 12px !important;
      }

      #tabela-artilheiro-rodada table.ranking-table {
        font-size: 9px !important;
        width: auto !important;
        max-width: 400px !important;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
      }
      .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      .alert-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-container {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        text-align: center;
      }

      /* Debug panel */
      #debug-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        max-width: 300px;
        z-index: 1000;
      }

      /* Estilos para a aba de participantes */
      .participantes-inicial {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .carregar-participantes-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        margin-bottom: 20px;
      }

      .carregar-participantes-btn:hover {
        background: #2980b9;
      }

      .carregar-participantes-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      /* Estilos para os bot√µes de navega√ß√£o das abas */
      .tabs {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
        gap: 5px;
      }

      .tab {
        padding: 10px 15px;
        border: none;
        background-color: #ecf0f1;
        color: #34495e;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
        transition: background-color 0.3s, color 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
      }

      .tab:hover {
        background-color: #bdc3c7;
      }

      .tab.active {
        background-color: #3498db;
        color: white;
      }

      .tab span {
        font-size: 1.1em;
      }

      .tab-content {
        display: none;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-top: 10px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }

      .tab-content.active {
        display: block;
      }

      /* Estilos adicionais para o container principal */
      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #fdfdfd;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }

      h2, h3 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 15px;
      }

      .btn-voltar {
        display: inline-block;
        margin-bottom: 20px;
        padding: 10px 20px;
        background-color: #95a5a6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.3s;
      }

      .btn-voltar:hover {
        background-color: #7f8c8d;
      }

      /* Estilos para tabelas */
      .ranking-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .ranking-table th,
      .ranking-table td {
        border: 1px solid #ddd;
        padding: 10px 8px;
        text-align: left;
      }

      .ranking-table th {
        background-color: #3498db;
        color: white;
        font-weight: bold;
      }

      .ranking-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      .ranking-table tbody tr:hover {
        background-color: #e0e0e0;
      }

      /* Estilos espec√≠ficos para colunas da tabela de rodadas */
      #rodadas table.ranking-table th:nth-child(1),
      #rodadas table.ranking-table td:nth-child(1) {
        text-align: center;
      }

      #rodadas table.ranking-table th:nth-child(5),
      #rodadas table.ranking-table td:nth-child(5) {
        text-align: center;
      }

      #rodadas table.ranking-table th:nth-child(6),
      #rodadas table.ranking-table td:nth-child(6) {
        text-align: center;
      }

      /* Estilos para bot√µes de a√ß√£o */
      .rodadas-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }

      .rodadas-select {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        min-width: 200px;
      }

      .refresh-btn,
      .parciais-btn {
        padding: 10px 15px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .refresh-btn:hover,
      .parciais-btn:hover {
        background-color: #2980b9;
      }

      .times-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .time-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        background-color: #fafafa;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: transform 0.2s;
      }

      .time-card:hover {
        transform: translateY(-5px);
      }

      .time-card img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-bottom: 10px;
        object-fit: cover;
      }

      .time-card h4 {
        margin-bottom: 5px;
        color: #34495e;
        font-size: 1.1em;
      }

      .time-card p {
        font-size: 0.9em;
        color: #7f8c8d;
      }

      .toggle-participants {
        display: block;
        width: fit-content;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        transition: background-color 0.3s;
      }

      .toggle-participants:hover {
        background-color: #2980b9;
      }
    </style>
  </head>
  <body>
    <div id="debug-panel" style="display: none">
      <strong>Status dos M√≥dulos:</strong>
      <div id="debug-content"></div>
    </div>

    <div id="global-loading" class="loading-container" style="display: none">
      <div class="loading-spinner"></div>
      <p>Inicializando aplica√ß√£o...</p>
    </div>

    <div class="container">
      <h2 id="nomeLiga">üèÜ Carregando...</h2>
      <p id="quantidadeTimes" style="text-align: center; color: #7f8c8d"></p>
      <button
        class="btn-voltar"
        onclick="window.history.back()"
        aria-label="Voltar para a p√°gina anterior"
      >
        ‚¨Ö Voltar
      </button>

      <div class="tabs">
        <button class="tab active" data-tab="participantes">
          <span>üë• Participantes</span>
        </button>
        <button class="tab" data-tab="rodadas">
          <span>üìä Rodadas</span>
        </button>
        <button class="tab" data-tab="mata-mata">
          <span>‚öîÔ∏è Disputas Mata-Mata</span>
        </button>
        <button class="tab" data-tab="ranking-geral">
          <span>üèÜ Ranking Geral</span>
        </button>
        <button class="tab" data-tab="pontos-corridos">
          <span>üìà Liga Pontos Corridos</span>
        </button>
        <button class="tab" data-tab="melhor-mes">
          <span>‚≠ê Melhor do M√™s</span>
        </button>
        <button class="tab" data-tab="top-10">
          <span>üî• Top 10</span>
        </button>
        <button class="tab" data-tab="fluxo-financeiro">
          <span>üí∞ Fluxo Financeiro</span>
        </button>
        <button class="tab" data-tab="artilheiro-campeao">
          <span>‚öΩ Artilheiro Campe√£o</span>
        </button>
        <button class="tab" data-tab="luva-de-ouro">
          <span>ü•Ö Luva de Ouro</span>
        </button>
      </div>

      <div id="errorMessage" class="error-message" style="display: none"></div>

      <div class="tab-contents">
        <div id="participantes" class="tab-content active">
          <div id="participantes-inicial" class="participantes-inicial">
            <h3>üë• Participantes da Liga</h3>
            <p>
              Clique no bot√£o abaixo para carregar e visualizar os participantes
              da liga.
            </p>
            <button
              id="carregarParticipantesBtn"
              class="carregar-participantes-btn"
            >
              üì• Carregar Participantes
            </button>
          </div>
          <div
            id="participantes-loading"
            class="loading-container"
            style="display: none"
          >
            <div class="loading-spinner"></div>
            <p>Carregando participantes...</p>
          </div>
          <button
            class="toggle-participants"
            type="button"
            style="display: none"
          >
            Exibir Participantes
          </button>
          <div
            id="timesContainer"
            class="times-container"
            style="display: none"
          >
            <div class="times-grid"></div>
          </div>
        </div>

        <div id="rodadas" class="tab-content">
          <div class="rodadas-header">
            <div class="rodadas-actions">
              <select id="rodadaSelect" class="rodadas-select">
                <option value="">Escolha uma rodada</option>
              </select>
              <button class="refresh-btn" id="refreshApiBtn">
                Atualizar dados da API
              </button>
              <button id="parciaisBtn" class="parciais-btn" type="button">
                Parciais
              </button>
            </div>
          </div>
          <div id="rodadasExportBtnContainer"></div>
          <div id="loading" style="display: none">Carregando...</div>
          <table id="rankingTable" class="ranking-table">
            <thead>
              <tr>
                <th style="width: 36px; text-align: center">Pos</th>
                <th style="width: 40px; text-align: center">‚ù§Ô∏è</th>
                <th style="min-width: 110px; text-align: left">Cartoleiro</th>
                <th style="min-width: 110px; text-align: left">
                  Time Cartoleiro
                </th>
                <th style="width: 48px; text-align: center">Pts</th>
                <th style="width: 60px; text-align: center">Banco</th>
              </tr>
            </thead>
            <tbody id="rankingBody"></tbody>
          </table>
        </div>

        <div id="mata-mata" class="tab-content">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Carregando disputas mata-mata...</p>
          </div>
        </div>

        <div id="ranking-geral" class="tab-content">
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Calculando ranking geral...</p>
          </div>
        </div>

        <div id="pontos-corridos" class="tab-content">
          <div id="pontosCorridosSelect"></div>
          <div id="pontosCorridosRodada"></div>
        </div>

        <div id="melhor-mes" class="tab-content">
          <div id="melhorMesSelect"></div>
          <div id="melhorMesTabela"></div>
        </div>

        <div id="top-10" class="tab-content">
          <div
            id="top10MitosExportBtnContainer"
            style="text-align: right; margin-bottom: 8px"
          ></div>
          <div id="top10MitosTable"></div>
          <div style="height: 20px"></div>
          <div
            id="top10MicosExportBtnContainer"
            style="text-align: right; margin-bottom: 8px"
          ></div>
          <div id="top10MicosTable"></div>
        </div>

        <div id="fluxo-financeiro" class="tab-content">
          <div
            id="fluxoFinanceiroButtons"
            class="participantes-buttons-container"
          ></div>
          <div
            id="fluxoFinanceiroExportBtnContainer"
            style="text-align: right; margin-bottom: 8px"
          ></div>
          <div id="fluxoFinanceiroContent"></div>
        </div>

        <div id="artilheiro-campeao" class="tab-content">
          <div id="artilheiro-loading" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Carregando dados do artilheiro campe√£o...</p>
          </div>
          <div id="artilheiro-container" style="display: none"></div>
        </div>

        <div id="luva-de-ouro" class="tab-content">
          <div
            id="luvaDeOuroExportBtnContainer"
            style="text-align: right; margin-bottom: 8px"
          ></div>
          <div id="luvaDeOuroContent"></div>
        </div>
      </div>
    </div>

    <script type="module">
      console.log("üöÄ Iniciando carregamento da aplica√ß√£o...");

      // Debug panel
      const debugPanel = document.getElementById("debug-panel");
      const debugContent = document.getElementById("debug-content");
      let debugMode = localStorage.getItem("debug-mode") === "true";

      function toggleDebug() {
        debugMode = !debugMode;
        localStorage.setItem("debug-mode", debugMode.toString());
        debugPanel.style.display = debugMode ? "block" : "none";
      }

      // Ctrl+D para ativar debug
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "d") {
          e.preventDefault();
          toggleDebug();
        }
      });

      function updateDebug(modulo, status, erro = null) {
        if (!debugMode) return;
        const statusIcon =
          status === "ok" ? "‚úÖ" : status === "loading" ? "‚è≥" : "‚ùå";
        const errorText = erro ? ` (${erro})` : "";
        debugContent.innerHTML += `<div>${statusIcon} ${modulo}${errorText}</div>`;
      }

      // Fun√ß√£o para mostrar erro global
      function mostrarErroGlobal(mensagem, erro = null) {
        console.error("‚ùå Erro global:", mensagem, erro);
        const errorDiv = document.getElementById("errorMessage");
        if (errorDiv) {
          errorDiv.innerHTML = `
            <strong>Erro:</strong> ${mensagem}
            ${erro ? `<br><small>${erro.message}</small>` : ""}
            <br><small>Pressione Ctrl+D para ver detalhes do debug</small>
          `;
          errorDiv.style.display = "block";
        }
      }

      // Fun√ß√µes globais para uso em caso de falha dos m√≥dulos
      const fallbackFunctions = {
        carregarDetalhesLigaBasico: async () => {
          console.log("üîÑ Usando fallback para carregarDetalhesLigaBasico");
          try {
            // MODIFICA√á√ÉO: Tenta usar a nova fun√ß√£o primeiro
            if (modulosCarregados.participantes?.carregarDadosBasicos) {
              const resultado = await modulosCarregados.participantes.carregarDadosBasicos();
              if (resultado) return resultado;
            }

            // Fallback original melhorado
            const params = new URLSearchParams(window.location.search);
            const ligaId = params.get("id");

            if (!ligaId) {
              throw new Error("ID da liga n√£o encontrado na URL");
            }

            console.log(`Fallback: Buscando liga ${ligaId}`);
            const response = await fetch(`/api/ligas/${ligaId}`);

            if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
            }

            const liga = await response.json();

            if (!liga) {
              throw new Error("Liga n√£o encontrada");
            }

            // Atualiza elementos da interface
            const nomeElement = document.getElementById("nomeLiga");
            const quantidadeElement = document.getElementById("quantidadeTimes");

            if (nomeElement) {
              nomeElement.textContent = `üèÜ ${liga.nome || "Liga"}`;
            }

            if (quantidadeElement) {
              const participantes = liga.participantes || liga.times || [];
              const quantidade = Array.isArray(participantes) ? participantes.length : 0;
              quantidadeElement.textContent = `${quantidade} participantes`;
            }

            console.log(`‚úÖ Fallback: Liga carregada - ${liga.nome} com ${(liga.participantes || liga.times || []).length} participantes`);
            return liga;
          } catch (error) {
            console.error("‚ùå Fallback falhou:", error);
            mostrarErroGlobal("Erro ao carregar dados b√°sicos da liga", error);
          }
        },
      };

      // M√≥dulos para carregar
      const modulosConfig = [
        {
          nome: "participantes",
          arquivo: "./js/participantes.js",
          funcoes: [
            "carregarDetalhesLiga",
            "toggleParticipants",
            "carregarDadosBasicos",
          ],
          critico: true,
        },
        {
          nome: "rodadas",
          arquivo: "./js/rodadas.js",
          funcoes: ["carregarRodadas"],
          critico: false,
        },
        {
          nome: "mata-mata",
          arquivo: "./js/mata-mata.js",
          funcoes: ["carregarMataMata"],
          critico: false,
        },
        {
          nome: "ranking",
          arquivo: "./js/ranking.js",
          funcoes: ["carregarRankingGeral"],
          critico: false,
        },
        {
          nome: "melhor-mes",
          arquivo: "./js/melhor-mes.js",
          funcoes: ["inicializarMelhorMes"],
          critico: false,
        },
        {
          nome: "pontos-corridos",
          arquivo: "./js/pontos-corridos.js",
          funcoes: ["inicializarPontosCorridos"],
          critico: false,
        },
        {
          nome: "top10",
          arquivo: "./js/top10.js",
          funcoes: ["inicializarTop10"],
          critico: false,
        },
        {
          nome: "fluxo-financeiro",
          arquivo: "./js/fluxo-financeiro.js",
          funcoes: ["inicializarFluxoFinanceiro"],
          critico: false,
        },
        {
          nome: "artilheiro-campeao",
          arquivo: "./js/artilheiro-campeao.js",
          funcoes: ["inicializarArtilheiroCampeao"],
          critico: false,
        },
        {
          nome: "luva-de-ouro",
          arquivo: "./js/luva-de-ouro.js",
          funcoes: ["inicializarLuvaDeOuro"],
          critico: false,
        },
      ];

      // Tornar modulosCarregados dispon√≠vel globalmente
      window.modulosCarregados = {};
      const modulosCarregados = window.modulosCarregados;
      let modulo_participantes_ok = false;
      let participantesCarregados = false;

      // Carregar m√≥dulo individual com timeout
      async function carregarModulo(config) {
        updateDebug(config.nome, "loading");

        return new Promise((resolve) => {
          const timeout = setTimeout(() => {
            console.warn(`‚ö†Ô∏è Timeout ao carregar ${config.nome}`);
            updateDebug(config.nome, "error", "timeout");
            resolve(false);
          }, 10000); // 10 segundos timeout

          import(config.arquivo)
            .then((modulo) => {
              clearTimeout(timeout);

              const funcoesDisponiveis = {};
              let funcoesEncontradas = 0;

              config.funcoes.forEach((funcao) => {
                if (modulo[funcao]) {
                  funcoesDisponiveis[funcao] = modulo[funcao];
                  funcoesEncontradas++;
                } else {
                  console.warn(
                    `‚ö†Ô∏è Fun√ß√£o ${funcao} n√£o encontrada em ${config.nome}`,
                  );
                }
              });

              if (funcoesEncontradas > 0) {
                modulosCarregados[config.nome] = funcoesDisponiveis;
                console.log(
                  `‚úÖ M√≥dulo ${config.nome} carregado (${funcoesEncontradas}/${config.funcoes.length} fun√ß√µes)`,
                );
                updateDebug(config.nome, "ok");

                if (config.nome === "participantes") {
                  modulo_participantes_ok = true;
                }

                resolve(true);
              } else {
                console.error(
                  `‚ùå Nenhuma fun√ß√£o v√°lida encontrada em ${config.nome}`,
                );
                updateDebug(config.nome, "error", "no functions");
                resolve(false);
              }
            })
            .catch((error) => {
              clearTimeout(timeout);
              console.error(`‚ùå Erro ao carregar ${config.nome}:`, error);
              updateDebug(config.nome, "error", error.message);
              resolve(false);
            });
        });
      }

      // Fun√ß√£o para carregar participantes quando solicitado
      async function carregarParticipantes() {
        if (participantesCarregados) return;

        const btnCarregar = document.getElementById("carregarParticipantesBtn");
        const inicial = document.getElementById("participantes-inicial");
        const loading = document.getElementById("participantes-loading");

        try {
          console.log("üîÑ Iniciando carregamento dos participantes...");

          // Desabilita bot√£o e mostra loading
          btnCarregar.disabled = true;
          btnCarregar.textContent = "Carregando...";
          inicial.style.display = "none";
          loading.style.display = "block";

          // Carrega os dados dos participantes
          if (
            modulo_participantes_ok &&
            modulosCarregados.participantes?.carregarDetalhesLiga
          ) {
            await modulosCarregados.participantes.carregarDetalhesLiga();
          } else {
            await fallbackFunctions.carregarDetalhesLigaBasico();
          }

          // Mostra a interface dos participantes
          loading.style.display = "none";
          document.querySelector(".toggle-participants").style.display =
            "block";
          document.getElementById("timesContainer").style.display = "block";

          participantesCarregados = true;
          console.log("‚úÖ Participantes carregados com sucesso!");
        } catch (error) {
          console.error("‚ùå Erro ao carregar participantes:", error);
          loading.style.display = "none";
          inicial.style.display = "block";
          btnCarregar.disabled = false;
          btnCarregar.textContent = "üì• Carregar Participantes";
          mostrarErroGlobal("Erro ao carregar participantes", error);
        }
      }

      // ‚úÖ CORRE√á√ÉO: Fun√ß√£o unificada executarAcaoAba
      async function executarAcaoAba(tabId) {
        console.log(`üéØ Executando a√ß√£o da aba: ${tabId}`);
        try {
          switch (tabId) {
            case "participantes":
              // Para a aba participantes, apenas mostra a interface atual
              // O carregamento √© feito pelo bot√£o espec√≠fico
              break;
            case "rodadas":
              if (modulosCarregados.rodadas?.carregarRodadas) {
                await modulosCarregados.rodadas.carregarRodadas();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo rodadas n√£o dispon√≠vel");
              }
              break;
            case "mata-mata":
              if (modulosCarregados["mata-mata"]?.carregarMataMata) {
                await modulosCarregados["mata-mata"].carregarMataMata();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo mata-mata n√£o dispon√≠vel");
              }
              break;
            case "ranking-geral":
              if (modulosCarregados.ranking?.carregarRankingGeral) {
                await modulosCarregados.ranking.carregarRankingGeral();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo ranking n√£o dispon√≠vel");
              }
              break;
            case "melhor-mes":
              if (modulosCarregados["melhor-mes"]?.inicializarMelhorMes) {
                await modulosCarregados["melhor-mes"].inicializarMelhorMes();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo melhor-mes n√£o dispon√≠vel");
              }
              break;
            case "pontos-corridos":
              if (
                modulosCarregados["pontos-corridos"]?.inicializarPontosCorridos
              ) {
                await modulosCarregados[
                  "pontos-corridos"
                ].inicializarPontosCorridos();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo pontos-corridos n√£o dispon√≠vel");
              }
              break;
            case "top-10":
              if (modulosCarregados.top10?.inicializarTop10) {
                await modulosCarregados.top10.inicializarTop10();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo top10 n√£o dispon√≠vel");
              }
              break;
            case "fluxo-financeiro":
              if (
                modulosCarregados["fluxo-financeiro"]
                  ?.inicializarFluxoFinanceiro
              ) {
                await modulosCarregados[
                  "fluxo-financeiro"
                ].inicializarFluxoFinanceiro();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo fluxo-financeiro n√£o dispon√≠vel");
              }
              break;
            case "artilheiro-campeao":
              if (
                modulosCarregados["artilheiro-campeao"]
                  ?.inicializarArtilheiroCampeao
              ) {
                await modulosCarregados[
                  "artilheiro-campeao"
                ].inicializarArtilheiroCampeao();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo artilheiro-campeao n√£o dispon√≠vel");
              }
              break;
            case "luva-de-ouro":
              if (modulosCarregados["luva-de-ouro"]?.inicializarLuvaDeOuro) {
                await modulosCarregados["luva-de-ouro"].inicializarLuvaDeOuro();
              } else {
                console.warn("‚ö†Ô∏è M√≥dulo luva-de-ouro n√£o dispon√≠vel");
              }
              break;
          }
        } catch (error) {
          console.error(`‚ùå Erro ao executar a√ß√£o da aba ${tabId}:`, error);
          mostrarErroGlobal(`Erro na aba ${tabId}`, error);
        }
      }

      // ‚úÖ CORRE√á√ÉO: Fun√ß√£o atualizarPagina unificada
      async function atualizarPagina() {
        console.log("üéØ DOM carregado, iniciando aplica√ß√£o...");

        try {
          // Carregar dados b√°sicos automaticamente
          console.log("üì¶ Carregando dados b√°sicos da liga...");
          await fallbackFunctions.carregarDetalhesLigaBasico();

          // Carregar m√≥dulos cr√≠ticos
          console.log("üì¶ Carregando m√≥dulos cr√≠ticos...");
          const criticos = modulosConfig.filter((m) => m.critico);
          for (const modulo of criticos) {
            await carregarModulo(modulo);
          }

          // Carregar m√≥dulos n√£o-cr√≠ticos
          console.log("üì¶ Carregando m√≥dulos n√£o-cr√≠ticos...");
          const naoCriticos = modulosConfig.filter((m) => !m.critico);
          const promises = naoCriticos.map(carregarModulo);
          await Promise.allSettled(promises);

          console.log("üéõÔ∏è Configurando interface...");

          // Configurar personaliza√ß√£o da liga
          const params = new URLSearchParams(window.location.search);
          const ligaId = params.get("id");

          const tabMataMata = document.querySelector(
            '.tab[data-tab="mata-mata"]',
          );
          const tabPontosCorridos = document.querySelector(
            '.tab[data-tab="pontos-corridos"]',
          );
          const tabArtilheiro = document.querySelector(
            '.tab[data-tab="artilheiro-campeao"]',
          );
          const tabLuva = document.querySelector(
            '.tab[data-tab="luva-de-ouro"]',
          );

          if (tabArtilheiro) tabArtilheiro.style.display = "none";
          if (tabLuva) tabLuva.style.display = "none";

          if (ligaId === "684d821cf1a7ae16d1f89572") {
            if (tabMataMata) tabMataMata.style.display = "none";
            if (tabPontosCorridos) tabPontosCorridos.style.display = "none";
            if (tabArtilheiro) tabArtilheiro.style.display = "";
            if (tabLuva) tabLuva.style.display = "";
          }

          // Configurar event listeners das abas
          const tabs = document.querySelectorAll(".tab");
          const tabContents = document.querySelectorAll(".tab-content");

          tabs.forEach((tab) => {
            tab.addEventListener("click", async () => {
              const tabId = tab.getAttribute("data-tab");

              tabs.forEach((t) => t.classList.remove("active"));
              tabContents.forEach((content) =>
                content.classList.remove("active"),
              );
              tab.classList.add("active");

              const tabContent = document.getElementById(tabId);
              if (tabContent) {
                tabContent.classList.add("active");
                await executarAcaoAba(tabId);
              }
            });
          });

          // Configurar bot√£o de carregar participantes
          const btnCarregarParticipantes = document.getElementById(
            "carregarParticipantesBtn",
          );
          if (btnCarregarParticipantes) {
            btnCarregarParticipantes.addEventListener(
              "click",
              carregarParticipantes,
            );
          }

          // Configurar bot√£o toggle (s√≥ funciona depois de carregar)
          const toggleButton = document.querySelector(".toggle-participants");
          if (toggleButton) {
            if (modulosCarregados.participantes?.toggleParticipants) {
              toggleButton.onclick =
                modulosCarregados.participantes.toggleParticipants;
            } else {
              toggleButton.onclick = () => {
                const container = document.getElementById("timesContainer");
                container.style.display =
                  container.style.display === "none" ? "block" : "none";
              };
            }
          }

          const refreshButton = document.getElementById("refreshApiBtn");
          if (refreshButton && modulosCarregados.rodadas?.carregarRodadas) {
            refreshButton.onclick = () =>
              modulosCarregados.rodadas.carregarRodadas(true);
          }

          console.log("üéâ Aplica√ß√£o inicializada!");
          console.log("üìä M√≥dulos carregados:", Object.keys(modulosCarregados));

          if (debugMode) {
            updateDebug(
              "SISTEMA",
              "ok",
              `${Object.keys(modulosCarregados).length} m√≥dulos ativos`,
            );
          }
        } catch (error) {
          console.error("‚ùå Erro cr√≠tico:", error);
          mostrarErroGlobal("Erro cr√≠tico na inicializa√ß√£o", error);
        }
      }

      // ‚úÖ Event listener para DOMContentLoaded
      document.addEventListener("DOMContentLoaded", async () => {
        const globalLoading = document.getElementById("global-loading");
        globalLoading.style.display = "block"; // Mostra spinner global

        try {
          await atualizarPagina();
          
          // Verificar se h√° uma aba espec√≠fica na URL
          const urlParams = new URLSearchParams(window.location.search);
          const tabParam = urlParams.get('tab');
          
          if (tabParam) {
            // Ativar a aba espec√≠fica
            const tabButton = document.querySelector(`[data-tab="${tabParam}"]`);
            if (tabButton) {
              tabButton.click();
            }
          }
        } catch (error) {
          console.error("‚ùå Erro ao atualizar p√°gina:", error);
          mostrarErroGlobal("Erro ao atualizar a p√°gina", error);
        } finally {
          globalLoading.style.display = "none"; // Oculta ap√≥s carregamento
        }
      });
    </script>
  </body>
</html>