<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o de Migra√ß√£o - Super Cartola Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">üîß Valida√ß√£o de Migra√ß√£o PC/MM/Top10</h1>
            <p class="text-gray-400">Revise e valide corre√ß√µes de extratos financeiros</p>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-700 mb-6">
            <div class="flex space-x-8">
                <button onclick="showTab('preview')" id="tab-preview" class="tab-active pb-3 font-semibold transition">
                    üìä Preview de Corre√ß√µes
                </button>
                <button onclick="showTab('validacao')" id="tab-validacao" class="pb-3 font-semibold text-gray-400 hover:text-white transition">
                    ‚úÖ Valida√ß√£o Individual
                </button>
                <button onclick="showTab('execucao')" id="tab-execucao" class="pb-3 font-semibold text-gray-400 hover:text-white transition">
                    üöÄ Execu√ß√£o em Massa
                </button>
            </div>
        </div>

        <!-- Tab: Preview -->
        <div id="content-preview" class="tab-content">
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">An√°lise de Participantes</h2>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="filtroLigaId" placeholder="Filtrar por Liga ID (opcional)"
                           class="flex-1 bg-gray-700 rounded px-4 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <button onclick="carregarPreview()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-semibold transition">
                        üîç Analisar
                    </button>
                </div>
                <div id="loading-preview" class="hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                    <p class="mt-2 text-gray-400">Analisando participantes...</p>
                </div>
                <div id="resultado-preview"></div>
            </div>
        </div>

        <!-- Tab: Valida√ß√£o Individual -->
        <div id="content-validacao" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Recalcular e Validar Participante</h2>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <input type="text" id="validacaoLigaId" placeholder="Liga ID"
                           class="bg-gray-700 rounded px-4 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <input type="number" id="validacaoTimeId" placeholder="Time ID"
                           class="bg-gray-700 rounded px-4 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <button onclick="recalcularParticipante()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded font-semibold transition">
                        ‚úÖ Recalcular e Validar
                    </button>
                </div>
                <div id="loading-validacao" class="hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"></div>
                    <p class="mt-2 text-gray-400">Recalculando extrato...</p>
                </div>
                <div id="resultado-validacao"></div>
            </div>
        </div>

        <!-- Tab: Execu√ß√£o em Massa -->
        <div id="content-execucao" class="tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">‚ö†Ô∏è Execu√ß√£o em Massa</h2>
                <div class="bg-yellow-900/30 border border-yellow-600 rounded p-4 mb-4">
                    <p class="font-semibold mb-2">‚ö†Ô∏è ATEN√á√ÉO:</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li>Esta opera√ß√£o ir√° deletar TODOS os caches com problemas detectados</li>
                        <li>Os extratos ser√£o recalculados automaticamente no pr√≥ximo acesso</li>
                        <li>Recomenda-se fazer o Preview primeiro para revisar o que ser√° alterado</li>
                    </ul>
                </div>
                <div class="flex gap-4">
                    <input type="text" id="execucaoLigaId" placeholder="Liga ID (opcional - vazio = todas)"
                           class="flex-1 bg-gray-700 rounded px-4 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <button onclick="executarMigracao()" class="bg-red-600 hover:bg-red-700 px-8 py-2 rounded font-semibold transition">
                        üöÄ Executar Migra√ß√£o
                    </button>
                </div>
                <div id="loading-execucao" class="hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-500"></div>
                    <p class="mt-2 text-gray-400">Executando migra√ß√£o...</p>
                </div>
                <div id="resultado-execucao"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active', 'text-blue-500');
                el.classList.add('text-gray-400');
            });

            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const tab = document.getElementById(`tab-${tabName}`);
            tab.classList.add('tab-active');
            tab.classList.remove('text-gray-400');
        }

        // Preview de Corre√ß√µes
        async function carregarPreview() {
            const loading = document.getElementById('loading-preview');
            const resultado = document.getElementById('resultado-preview');
            const ligaId = document.getElementById('filtroLigaId').value.trim();

            loading.classList.remove('hidden');
            resultado.innerHTML = '';

            try {
                const url = ligaId
                    ? `/api/admin/migracao-validacao/preview-correcoes?ligaId=${ligaId}`
                    : `/api/admin/migracao-validacao/preview-correcoes`;

                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                // Renderizar resumo
                resultado.innerHTML = `
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-3xl font-bold text-blue-400">${data.resumo.ligasAnalisadas}</div>
                            <div class="text-sm text-gray-400 mt-1">Ligas</div>
                        </div>
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-3xl font-bold text-purple-400">${data.resumo.participantesAnalisados}</div>
                            <div class="text-sm text-gray-400 mt-1">Participantes</div>
                        </div>
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-3xl font-bold text-red-400">${data.resumo.participantesComProblema}</div>
                            <div class="text-sm text-gray-400 mt-1">Com Problemas</div>
                        </div>
                        <div class="bg-gray-700 rounded p-4 text-center">
                            <div class="text-3xl font-bold text-green-400">${data.resumo.participantesOK}</div>
                            <div class="text-sm text-gray-400 mt-1">OK</div>
                        </div>
                    </div>
                `;

                // Renderizar participantes com problemas
                if (data.problemas.length > 0) {
                    resultado.innerHTML += `
                        <h3 class="text-lg font-bold mb-3 text-red-400">üî¥ Participantes com Problemas</h3>
                        <div class="space-y-3">
                            ${data.problemas.map(p => `
                                <div class="bg-gray-700 rounded p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <div class="font-bold text-lg">${p.time}</div>
                                            <div class="text-sm text-gray-400">${p.liga} ‚Ä¢ Time ${p.timeId}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold ${p.saldoAtual >= 0 ? 'text-green-400' : 'text-red-400'}">
                                                R$ ${p.saldoAtual.toFixed(2)}
                                            </div>
                                            <div class="text-sm text-gray-400">Saldo Atual (Cache)</div>
                                        </div>
                                    </div>

                                    ${p.contextoFinanceiro ? `
                                        <div class="grid grid-cols-2 gap-2 mb-3 p-2 bg-gray-800 rounded">
                                            <div class="text-xs">
                                                <span class="text-gray-400">Legado 2025:</span>
                                                <span class="font-semibold ${p.contextoFinanceiro.saldoLegado2025 >= 0 ? 'text-green-400' : 'text-red-400'}">
                                                    R$ ${p.contextoFinanceiro.saldoLegado2025.toFixed(2)}
                                                </span>
                                            </div>
                                            <div class="text-xs">
                                                <span class="text-gray-400">Inscri√ß√£o 2026:</span>
                                                <span class="font-semibold ${p.contextoFinanceiro.inscricao2026.paga ? 'text-green-400' : 'text-yellow-400'}">
                                                    ${p.contextoFinanceiro.inscricao2026.paga ? '‚úÖ PAGA' : '‚ö†Ô∏è PENDENTE'}
                                                    (R$ ${p.contextoFinanceiro.inscricao2026.valor.toFixed(2)})
                                                </span>
                                            </div>
                                        </div>
                                    ` : ''}

                                    <div class="flex flex-wrap gap-2 mb-3">
                                        ${p.modulosFaltantes.map(m => `
                                            <span class="bg-red-900/50 text-red-300 px-2 py-1 rounded text-xs font-semibold">
                                                ‚ùå ${m}
                                            </span>
                                        `).join('')}
                                    </div>
                                    <div class="text-sm text-gray-400 mb-3">
                                        Rodada consolidada: ${p.rodadaConsolidada} ‚Ä¢ Transa√ß√µes: ${p.totalTransacoes}
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="validarEspecifico('${p.ligaId}', ${p.timeId})"
                                                class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm transition">
                                            üîç Validar
                                        </button>
                                        <a href="${p.urlParticipante}" target="_blank"
                                           class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm transition inline-block">
                                            üëÅÔ∏è Ver Extrato
                                        </a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultado.innerHTML += `
                        <div class="bg-green-900/30 border border-green-600 rounded p-6 text-center">
                            <div class="text-4xl mb-2">‚úÖ</div>
                            <div class="font-bold text-green-400">Nenhum problema encontrado!</div>
                            <div class="text-sm text-gray-400 mt-1">Todos os participantes est√£o com cache correto.</div>
                        </div>
                    `;
                }

            } catch (error) {
                resultado.innerHTML = `
                    <div class="bg-red-900/30 border border-red-600 rounded p-4">
                        <p class="font-semibold">‚ùå Erro ao carregar preview:</p>
                        <p class="text-sm mt-1">${error.message}</p>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Recalcular Participante Individual
        async function recalcularParticipante() {
            const loading = document.getElementById('loading-validacao');
            const resultado = document.getElementById('resultado-validacao');
            const ligaId = document.getElementById('validacaoLigaId').value.trim();
            const timeId = document.getElementById('validacaoTimeId').value.trim();

            if (!ligaId || !timeId) {
                alert('Por favor, preencha Liga ID e Time ID');
                return;
            }

            loading.classList.remove('hidden');
            resultado.innerHTML = '';

            try {
                const response = await fetch('/api/admin/migracao-validacao/recalcular-participante', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ligaId, timeId: parseInt(timeId) })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                const mudou = data.diferenca.mudou;
                const corFundo = mudou ? 'bg-yellow-900/30 border-yellow-600' : 'bg-green-900/30 border-green-600';
                const icone = mudou ? '‚ö†Ô∏è' : '‚úÖ';

                resultado.innerHTML = `
                    <div class="${corFundo} border rounded p-6">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-2">${icone}</div>
                            <h3 class="text-2xl font-bold">${mudou ? 'Saldo Alterado' : 'Saldo Mantido'}</h3>
                        </div>

                        <div class="grid grid-cols-3 gap-6 mb-6">
                            <div class="text-center">
                                <div class="text-sm text-gray-400 mb-1">Antes</div>
                                <div class="text-3xl font-bold">R$ ${data.antes.saldo.toFixed(2)}</div>
                                <div class="text-xs text-gray-500 mt-1">${data.antes.transacoes} transa√ß√µes</div>
                            </div>
                            <div class="text-center flex items-center justify-center">
                                <div class="text-4xl">${mudou ? '‚Üí' : '='}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-400 mb-1">Depois</div>
                                <div class="text-3xl font-bold ${mudou ? 'text-yellow-400' : 'text-green-400'}">
                                    R$ ${data.depois.saldo.toFixed(2)}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${data.depois.transacoes} transa√ß√µes</div>
                            </div>
                        </div>

                        ${mudou ? `
                            <div class="bg-gray-800 rounded p-4 text-center">
                                <div class="text-sm text-gray-400 mb-1">Diferen√ßa</div>
                                <div class="text-2xl font-bold ${data.diferenca.valor > 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${data.diferenca.valor > 0 ? '+' : ''}R$ ${data.diferenca.valor.toFixed(2)}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${data.diferenca.percentual !== 'N/A' ? `(${data.diferenca.percentual}%)` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <div class="mt-4 text-center">
                            <a href="/participante/?liga=${ligaId}&time=${timeId}&view=extrato" target="_blank"
                               class="inline-block bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded transition">
                                üëÅÔ∏è Ver Extrato Completo
                            </a>
                        </div>
                    </div>
                `;

            } catch (error) {
                resultado.innerHTML = `
                    <div class="bg-red-900/30 border border-red-600 rounded p-4">
                        <p class="font-semibold">‚ùå Erro ao recalcular:</p>
                        <p class="text-sm mt-1">${error.message}</p>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Validar participante espec√≠fico da lista
        function validarEspecifico(ligaId, timeId) {
            document.getElementById('validacaoLigaId').value = ligaId;
            document.getElementById('validacaoTimeId').value = timeId;
            showTab('validacao');
            recalcularParticipante();
        }

        // Executar Migra√ß√£o em Massa
        async function executarMigracao() {
            const ligaId = document.getElementById('execucaoLigaId').value.trim();

            const confirmar = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                `Esta opera√ß√£o ir√°:\n` +
                `1. Deletar TODOS os caches com problemas detectados\n` +
                `2. Os extratos ser√£o recalculados automaticamente\n\n` +
                `${ligaId ? `Filtro: Liga ${ligaId}` : 'TODAS as ligas ser√£o processadas'}\n\n` +
                `Deseja continuar?`
            );

            if (!confirmar) return;

            const loading = document.getElementById('loading-execucao');
            const resultado = document.getElementById('resultado-execucao');

            loading.classList.remove('hidden');
            resultado.innerHTML = '';

            try {
                const url = ligaId
                    ? `/api/admin/migracao/fix-extrato-2026?ligaId=${ligaId}&force=true`
                    : `/api/admin/migracao/fix-extrato-2026?force=true`;

                const response = await fetch(url, { method: 'POST' });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                resultado.innerHTML = `
                    <div class="bg-green-900/30 border border-green-600 rounded p-6">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-2">‚úÖ</div>
                            <h3 class="text-2xl font-bold text-green-400">Migra√ß√£o Conclu√≠da!</h3>
                        </div>

                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div class="bg-gray-800 rounded p-3 text-center">
                                <div class="text-2xl font-bold">${data.stats.ligasAnalisadas}</div>
                                <div class="text-xs text-gray-400">Ligas</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3 text-center">
                                <div class="text-2xl font-bold">${data.stats.participantesAnalisados}</div>
                                <div class="text-xs text-gray-400">Participantes</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-yellow-400">${data.stats.cachesComProblemas}</div>
                                <div class="text-xs text-gray-400">Problemas</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-green-400">${data.stats.cachesCorrigidos}</div>
                                <div class="text-xs text-gray-400">Corrigidos</div>
                            </div>
                        </div>

                        <div class="text-center text-sm text-gray-400">
                            ${data.message}
                        </div>
                    </div>
                `;

            } catch (error) {
                resultado.innerHTML = `
                    <div class="bg-red-900/30 border border-red-600 rounded p-4">
                        <p class="font-semibold">‚ùå Erro ao executar migra√ß√£o:</p>
                        <p class="text-sm mt-1">${error.message}</p>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
