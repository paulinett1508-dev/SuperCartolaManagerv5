<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Popular Rodadas - Super Cartola Manager</title>
        <link rel="stylesheet" href="style.css" />
        <style>
            /* === ESTILOS ESPEC√çFICOS DA P√ÅGINA === */
            .admin-container {
                max-width: 600px;
                margin: 0 auto;
                background: var(--gradient-card);
                border-radius: 16px;
                padding: 30px;
                box-shadow: var(--shadow-lg);
                border: 1px solid var(--border-primary);
                position: relative;
                overflow: hidden;
            }

            .admin-container::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--gradient-primary);
                box-shadow: var(--shadow-glow);
            }

            .admin-header {
                margin-bottom: 25px;
                padding-bottom: 20px;
                border-bottom: 2px solid var(--border-primary);
            }

            .admin-title {
                font-size: 20px;
                font-weight: 700;
                color: var(--text-primary);
                margin: 0 0 8px 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .admin-title .icon {
                color: var(--laranja);
                font-size: 24px;
            }

            .liga-info-box {
                background: rgba(255, 69, 0, 0.1);
                border: 1px solid rgba(255, 69, 0, 0.3);
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 20px;
            }

            .liga-info-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 8px 0;
            }

            .liga-info-label {
                font-size: 12px;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-weight: 600;
            }

            .liga-info-value {
                font-size: 14px;
                color: var(--text-primary);
                font-weight: 700;
                font-family: "JetBrains Mono", monospace;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-bottom: 15px;
            }

            .form-label {
                display: block;
                font-size: 13px;
                color: var(--text-secondary);
                margin-bottom: 6px;
                font-weight: 600;
            }

            .form-input {
                width: 100%;
                padding: 10px 12px;
                font-size: 14px;
                background: var(--bg-card);
                border: 1px solid var(--border-primary);
                border-radius: 8px;
                color: var(--text-primary);
                transition: all 0.3s ease;
                text-align: center;
                font-weight: 600;
            }

            .form-input:focus {
                border-color: var(--laranja);
                box-shadow: 0 0 0 3px var(--laranja-alpha);
                background: var(--bg-card-hover);
            }

            .checkbox-group {
                background: rgba(255, 69, 0, 0.05);
                border: 1px solid rgba(255, 69, 0, 0.2);
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                gap: 10px;
                transition: all 0.3s ease;
            }

            .checkbox-group:hover {
                background: rgba(255, 69, 0, 0.1);
                border-color: rgba(255, 69, 0, 0.3);
            }

            .checkbox-input {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--laranja);
            }

            .checkbox-label {
                font-size: 13px;
                color: var(--text-secondary);
                cursor: pointer;
                user-select: none;
                flex: 1;
            }

            .action-buttons {
                display: flex;
                gap: 12px;
                margin-top: 25px;
            }

            .btn-primary {
                flex: 1;
                padding: 14px 24px;
                background: var(--gradient-primary);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-orange);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 8px 32px rgba(255, 69, 0, 0.5);
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .btn-secondary {
                padding: 14px 24px;
                background: var(--bg-card);
                color: var(--text-secondary);
                border: 1px solid var(--border-primary);
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btn-secondary:hover {
                background: var(--bg-card-hover);
                border-color: var(--laranja);
                color: var(--laranja);
            }

            /* === STATUS MESSAGE === */
            .status-container {
                margin-top: 25px;
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                display: none;
                animation: fadeInUp 0.3s ease-out;
            }

            .status-container.visible {
                display: block;
            }

            .status-container.loading {
                background: rgba(255, 69, 0, 0.1);
                border: 1px solid rgba(255, 69, 0, 0.3);
            }

            .status-container.success {
                background: rgba(34, 197, 94, 0.1);
                border: 1px solid rgba(34, 197, 94, 0.3);
            }

            .status-container.error {
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .status-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(255, 69, 0, 0.2);
                border-top-color: var(--laranja);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 15px;
            }

            .status-title {
                font-size: 16px;
                font-weight: 700;
                margin-bottom: 8px;
                color: var(--text-primary);
            }

            .status-message {
                font-size: 13px;
                color: var(--text-secondary);
                line-height: 1.5;
            }

            .status-container.success .status-title {
                color: var(--success);
            }

            .status-container.error .status-title {
                color: var(--danger);
            }

            /* === PROGRESS BAR === */
            .progress-container {
                margin: 15px 0;
                display: none;
            }

            .progress-container.visible {
                display: block;
            }

            .progress-bar-bg {
                width: 100%;
                height: 8px;
                background: rgba(255, 69, 0, 0.1);
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-bar-fill {
                height: 100%;
                background: var(--gradient-primary);
                border-radius: 4px;
                transition: width 0.5s ease;
                box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
            }

            .progress-text {
                font-size: 12px;
                color: var(--text-muted);
                text-align: center;
                margin-top: 8px;
            }

            /* === RESPONSIVE === */
            @media (max-width: 768px) {
                .admin-container {
                    padding: 20px;
                    margin: 15px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                }

                .action-buttons {
                    flex-direction: column;
                }

                .btn-primary,
                .btn-secondary {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <!-- Sidebar ser√° injetado aqui -->
            <div id="sidebar-placeholder"></div>

            <!-- Conte√∫do principal -->
            <main class="app-main">
                <!-- Header ser√° injetado aqui -->
                <div id="header-placeholder"></div>

                <!-- Conte√∫do da p√°gina -->
                <div class="page-content">
                    <!-- Breadcrumb -->
                    <nav class="breadcrumb">
                        <a href="dashboard.html">Dashboard</a>
                        <span class="separator">‚Ä∫</span>
                        <a href="gerenciar.html">Gerenciar Ligas</a>
                        <span class="separator">‚Ä∫</span>
                        <span class="current">Popular Rodadas</span>
                    </nav>

                    <!-- Container Principal -->
                    <div class="admin-container">
                        <div class="admin-header">
                            <h2 class="admin-title">
                                <span class="icon">‚öôÔ∏è</span>
                                Popular Rodadas no Sistema
                            </h2>
                        </div>

                        <!-- Informa√ß√µes da Liga -->
                        <div class="liga-info-box">
                            <div class="liga-info-item">
                                <span class="liga-info-label"
                                    >Liga Selecionada</span
                                >
                                <span class="liga-info-value" id="ligaNome"
                                    >Carregando...</span
                                >
                            </div>
                            <div class="liga-info-item">
                                <span class="liga-info-label">ID da Liga</span>
                                <span class="liga-info-value" id="ligaId"
                                    >-</span
                                >
                            </div>
                            <div class="liga-info-item">
                                <span class="liga-info-label"
                                    >Total de Times</span
                                >
                                <span class="liga-info-value" id="totalTimes"
                                    >-</span
                                >
                            </div>
                        </div>

                        <!-- Formul√°rio -->
                        <form id="popularForm">
                            <div class="form-group">
                                <div class="form-row">
                                    <div>
                                        <label for="inicio" class="form-label"
                                            >Rodada Inicial</label
                                        >
                                        <input
                                            type="number"
                                            id="inicio"
                                            class="form-input"
                                            min="1"
                                            max="38"
                                            value="1"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label for="fim" class="form-label"
                                            >Rodada Final</label
                                        >
                                        <input
                                            type="number"
                                            id="fim"
                                            class="form-input"
                                            min="1"
                                            max="38"
                                            value="38"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="repopular"
                                    class="checkbox-input"
                                />
                                <label for="repopular" class="checkbox-label">
                                    <strong>Repopular rodadas</strong> -
                                    Sobrescrever dados existentes (use com
                                    cautela)
                                </label>
                            </div>

                            <!-- Progress Bar -->
                            <div
                                class="progress-container"
                                id="progressContainer"
                            >
                                <div class="progress-bar-bg">
                                    <div
                                        class="progress-bar-fill"
                                        id="progressBar"
                                        style="width: 0%"
                                    ></div>
                                </div>
                                <div class="progress-text" id="progressText">
                                    0 de 0 rodadas
                                </div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="action-buttons">
                                <button
                                    type="button"
                                    class="btn-secondary"
                                    onclick="window.location.href='gerenciar.html'"
                                >
                                    ‚Üê Voltar
                                </button>
                                <button
                                    type="submit"
                                    class="btn-primary"
                                    id="popularBtn"
                                >
                                    <span>üîÑ</span>
                                    Popular Rodadas
                                </button>
                            </div>
                        </form>

                        <!-- Status Container -->
                        <div class="status-container" id="statusContainer">
                            <div
                                class="status-spinner"
                                id="statusSpinner"
                            ></div>
                            <div class="status-title" id="statusTitle"></div>
                            <div
                                class="status-message"
                                id="statusMessage"
                            ></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            // === VARI√ÅVEIS GLOBAIS ===
            let ligaData = null;
            let isRequestInProgress = false;

            // === CARREGAR LAYOUT ===
            async function loadLayout() {
                try {
                    const response = await fetch("layout.html");
                    const layoutHtml = await response.text();

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(layoutHtml, "text/html");

                    // Injetar sidebar
                    const sidebar = doc.querySelector(".app-sidebar");
                    if (sidebar) {
                        document
                            .getElementById("sidebar-placeholder")
                            .replaceWith(sidebar);
                    }

                    // Injetar header
                    const header = doc.querySelector(".page-header");
                    if (header) {
                        // Atualizar t√≠tulo do header para esta p√°gina
                        const pageTitle = header.querySelector("#pageTitle");
                        const pageSubtitle =
                            header.querySelector("#pageSubtitle");
                        if (pageTitle)
                            pageTitle.textContent = "‚öôÔ∏è Popular Rodadas";
                        if (pageSubtitle)
                            pageSubtitle.textContent =
                                "Importar dados das rodadas do Cartola FC";

                        document
                            .getElementById("header-placeholder")
                            .replaceWith(header);
                    }

                    // Executar scripts do layout
                    const scripts = doc.querySelectorAll("script");
                    scripts.forEach((script) => {
                        if (script.textContent.trim()) {
                            const newScript = document.createElement("script");
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });
                } catch (error) {
                    console.error("Erro ao carregar layout:", error);
                }
            }

            // === CARREGAR DADOS DA LIGA ===
            async function loadLigaData() {
                const urlParams = new URLSearchParams(window.location.search);
                const ligaId = urlParams.get("id");

                if (!ligaId) {
                    showStatus(
                        "error",
                        "Erro",
                        "ID da liga n√£o fornecido. Retorne ao gerenciador de ligas.",
                    );
                    return;
                }

                try {
                    // Buscar dados da liga
                    const response = await fetch(`/api/ligas/${ligaId}`);
                    if (!response.ok) throw new Error("Liga n√£o encontrada");

                    ligaData = await response.json();

                    // Atualizar interface
                    document.getElementById("ligaId").textContent =
                        ligaId.substring(0, 8) + "...";
                    document.getElementById("ligaNome").textContent =
                        ligaData.nome || "Liga sem nome";
                    document.getElementById("totalTimes").textContent =
                        ligaData.times?.length || 0;
                } catch (error) {
                    console.error("Erro ao carregar liga:", error);
                    showStatus(
                        "error",
                        "Erro",
                        "N√£o foi poss√≠vel carregar os dados da liga.",
                    );
                    document.getElementById("popularBtn").disabled = true;
                }
            }

            // === FUN√á√ÉO PARA POPULAR RODADAS ===
            async function popularRodadas(e) {
                e.preventDefault();

                if (isRequestInProgress) return;

                const inicio = parseInt(
                    document.getElementById("inicio").value,
                );
                const fim = parseInt(document.getElementById("fim").value);
                const repopular = document.getElementById("repopular").checked;
                const popularBtn = document.getElementById("popularBtn");
                const progressContainer =
                    document.getElementById("progressContainer");
                const progressBar = document.getElementById("progressBar");
                const progressText = document.getElementById("progressText");

                // Valida√ß√µes
                if (
                    !ligaData ||
                    isNaN(inicio) ||
                    isNaN(fim) ||
                    inicio > fim ||
                    inicio < 1 ||
                    fim > 38
                ) {
                    showStatus(
                        "error",
                        "Erro de Valida√ß√£o",
                        "Verifique os valores das rodadas (1-38).",
                    );
                    return;
                }

                // Confirmar repopular se marcado
                if (repopular) {
                    const confirmar = confirm(
                        `‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° prestes a SOBRESCREVER os dados das rodadas ${inicio} a ${fim}.\n\n` +
                            "Isso apagar√° permanentemente os dados existentes.\n\n" +
                            "Deseja continuar?",
                    );
                    if (!confirmar) return;
                }

                isRequestInProgress = true;
                popularBtn.disabled = true;

                // Mostrar progress
                progressContainer.classList.add("visible");
                progressBar.style.width = "0%";
                progressText.textContent = `0 de ${fim - inicio + 1} rodadas`;

                // Mostrar status de carregamento
                showStatus(
                    "loading",
                    "Populando Rodadas",
                    `Processando rodadas ${inicio} a ${fim}... Isso pode levar alguns minutos.`,
                );

                try {
                    // Simular progresso visual (backend n√£o tem SSE implementado ainda)
                    let progress = 0;
                    const totalRodadas = fim - inicio + 1;
                    const progressInterval = setInterval(() => {
                        if (progress < 90) {
                            progress += Math.random() * 10;
                            progressBar.style.width =
                                Math.min(progress, 90) + "%";
                            const rodadasProcessadas = Math.floor(
                                (progress / 100) * totalRodadas,
                            );
                            progressText.textContent = `${rodadasProcessadas} de ${totalRodadas} rodadas`;
                        }
                    }, 1000);

                    const response = await fetch(
                        `/api/ligas/${ligaData._id}/rodadas`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ inicio, fim, repopular }),
                            signal: AbortSignal.timeout(300000), // 5 minutos timeout
                        },
                    );

                    clearInterval(progressInterval);

                    if (!response.ok) {
                        const errorData = await response
                            .json()
                            .catch(() => ({}));
                        throw new Error(
                            errorData.error || `Erro ${response.status}`,
                        );
                    }

                    const data = await response.json();

                    // Completar progress
                    progressBar.style.width = "100%";
                    progressText.textContent = `${totalRodadas} de ${totalRodadas} rodadas`;

                    // Mostrar sucesso com estat√≠sticas
                    let successMessage =
                        data.message || "Rodadas populadas com sucesso!";
                    if (data.estatisticas) {
                        const stats = data.estatisticas;
                        successMessage += `<br><br>üìä Estat√≠sticas:<br>`;
                        successMessage += `‚Ä¢ Rodadas processadas: ${stats.rodadasProcessadas}<br>`;
                        successMessage += `‚Ä¢ Rodadas puladas: ${stats.rodadasPuladas}<br>`;
                        successMessage += `‚Ä¢ Registros inseridos: ${stats.registrosInseridos}<br>`;
                        if (stats.timesFaltantes?.length > 0) {
                            successMessage += `<br>‚ö†Ô∏è Times n√£o cadastrados: ${stats.timesFaltantes.join(", ")}`;
                        }
                    }

                    showStatus("success", "‚úÖ Sucesso!", successMessage);

                    // Limpar formul√°rio
                    document.getElementById("repopular").checked = false;
                } catch (error) {
                    console.error("Erro:", error);

                    let errorMessage = "Ocorreu um erro ao popular as rodadas.";
                    if (
                        error.name === "AbortError" ||
                        error.message.includes("timeout")
                    ) {
                        errorMessage =
                            "A opera√ß√£o excedeu o tempo limite. Tente com menos rodadas.";
                    } else if (error.message.includes("Failed to fetch")) {
                        errorMessage =
                            "Erro de conex√£o. Verifique sua internet.";
                    } else {
                        errorMessage = error.message;
                    }

                    showStatus("error", "‚ùå Erro", errorMessage);
                } finally {
                    isRequestInProgress = false;
                    popularBtn.disabled = false;

                    // Esconder progress ap√≥s 2 segundos
                    setTimeout(() => {
                        progressContainer.classList.remove("visible");
                    }, 2000);
                }
            }

            // === MOSTRAR STATUS ===
            function showStatus(type, title, message) {
                const container = document.getElementById("statusContainer");
                const spinner = document.getElementById("statusSpinner");
                const statusTitle = document.getElementById("statusTitle");
                const statusMessage = document.getElementById("statusMessage");

                container.className = `status-container visible ${type}`;
                spinner.style.display = type === "loading" ? "block" : "none";
                statusTitle.textContent = title;
                statusMessage.innerHTML = message;
            }

            // === INICIALIZA√á√ÉO ===
            document.addEventListener("DOMContentLoaded", async () => {
                await loadLayout();
                await loadLigaData();

                // Adicionar event listener ao formul√°rio
                document
                    .getElementById("popularForm")
                    .addEventListener("submit", popularRodadas);

                // Valida√ß√£o em tempo real
                const inicioInput = document.getElementById("inicio");
                const fimInput = document.getElementById("fim");

                inicioInput.addEventListener("change", () => {
                    const inicio = parseInt(inicioInput.value);
                    if (inicio < 1) inicioInput.value = 1;
                    if (inicio > 38) inicioInput.value = 38;

                    // Ajustar fim se necess√°rio
                    if (parseInt(fimInput.value) < inicio) {
                        fimInput.value = inicio;
                    }
                });

                fimInput.addEventListener("change", () => {
                    const fim = parseInt(fimInput.value);
                    if (fim < 1) fimInput.value = 1;
                    if (fim > 38) fimInput.value = 38;

                    // Ajustar in√≠cio se necess√°rio
                    if (parseInt(inicioInput.value) > fim) {
                        inicioInput.value = fim;
                    }
                });
            });
        </script>
    </body>
</html>
