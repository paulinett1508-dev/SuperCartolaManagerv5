// CORRE√á√ÉO CR√çTICA DO EXPORT-BASE.JS - LINHAS 372/468
// Problema: Promises rejeitadas no carregamento do html2canvas

// FUN√á√ÉO CORRIGIDA: gerarCanvasMobileDarkHD
export async function gerarCanvasMobileDarkHD(element, filename) {
  try {
    console.log(`[EXPORT-BASE-MOBILE-DARK] üì± Gerando canvas mobile HD: ${filename}`);

    // CORRE√á√ÉO CR√çTICA: Aguardar carregamento completo do html2canvas
    let html2canvas;
    try {
      html2canvas = await carregarHtml2Canvas();
    } catch (error) {
      console.error("[EXPORT-BASE-MOBILE-DARK] Erro ao carregar html2canvas:", error);
      throw new Error("N√£o foi poss√≠vel carregar a biblioteca de exporta√ß√£o");
    }

    // Verifica√ß√£o adicional de seguran√ßa
    if (!html2canvas || typeof html2canvas !== 'function') {
      throw new Error("html2canvas n√£o est√° dispon√≠vel ap√≥s o carregamento");
    }

    // Aguardar carregamento de todas as imagens
    const imagens = element.querySelectorAll("img");
    if (imagens.length > 0) {
      console.log(`[EXPORT-BASE-MOBILE-DARK] Aguardando ${imagens.length} imagens...`);
      
      await Promise.allSettled(
        Array.from(imagens).map((img) => {
          return new Promise((resolve) => {
            if (img.complete && img.naturalWidth > 0) {
              resolve();
            } else {
              const timer = setTimeout(() => {
                console.warn(`[EXPORT-BASE-MOBILE-DARK] Timeout na imagem: ${img.src}`);
                resolve();
              }, MOBILE_DARK_HD_CONFIG.export.imageTimeout);

              img.onload = () => {
                clearTimeout(timer);
                resolve();
              };
              
              img.onerror = () => {
                clearTimeout(timer);
                console.warn(`[EXPORT-BASE-MOBILE-DARK] Erro ao carregar imagem: ${img.src}`);
                resolve();
              };
            }
          });
        })
      );
    }

    // Aguardar renderiza√ß√£o completa com delay adicional
    await new Promise((resolve) => {
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          setTimeout(resolve, 100); // Delay adicional para estabilidade
        });
      });
    });

    console.log("[EXPORT-BASE-MOBILE-DARK] Iniciando captura canvas...");

    // Gerar canvas com configura√ß√µes HD mobile
    const canvas = await html2canvas(element, {
      allowTaint: MOBILE_DARK_HD_CONFIG.export.allowTaint,
      useCORS: MOBILE_DARK_HD_CONFIG.export.useCORS,
      scale: MOBILE_DARK_HD_CONFIG.scale,
      logging: MOBILE_DARK_HD_CONFIG.export.logging,
      width: MOBILE_DARK_HD_CONFIG.width,
      height: Math.max(element.scrollHeight, MOBILE_DARK_HD_CONFIG.minHeight),
      backgroundColor: MOBILE_DARK_HD_CONFIG.export.backgroundColor,
      removeContainer: false, // N√£o remover automaticamente
      letterRendering: MOBILE_DARK_HD_CONFIG.export.letterRendering,
      imageTimeout: MOBILE_DARK_HD_CONFIG.export.imageTimeout,
      pixelRatio: Math.max(window.devicePixelRatio || 1, 2),
    });

    // Verificar se canvas foi gerado corretamente
    if (!canvas || canvas.width === 0 || canvas.height === 0) {
      throw new Error("Canvas gerado √© inv√°lido");
    }

    // Download da imagem HD
    const link = document.createElement("a");
    link.download = filename;
    link.href = canvas.toDataURL(
      `image/${MOBILE_DARK_HD_CONFIG.export.format}`,
      MOBILE_DARK_HD_CONFIG.export.quality,
    );

    // Verificar se dataURL foi gerado
    if (!link.href || link.href === 'data:,') {
      throw new Error("Falha ao gerar dados da imagem");
    }

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log(`[EXPORT-BASE-MOBILE-DARK] ‚úÖ Imagem HD exportada: ${filename}`);
    mostrarNotificacaoSucessoMobile("Imagem HD exportada com sucesso!");
    
  } catch (error) {
    console.error("[EXPORT-BASE-MOBILE-DARK] ‚ùå Erro no canvas HD:", error);
    mostrarNotificacaoErroMobile("Erro ao exportar imagem HD. Tente novamente.");
    throw error;
  } finally {
    // Limpar container tempor√°rio
    if (element && element.parentNode === document.body) {
      try {
        document.body.removeChild(element);
      } catch (cleanupError) {
        console.warn("[EXPORT-BASE-MOBILE-DARK] Erro na limpeza:", cleanupError);
      }
    }
  }
}

// FUN√á√ÉO CORRIGIDA: carregarHtml2Canvas
async function carregarHtml2Canvas() {
  // Verificar se j√° est√° carregado
  if (window.html2canvas && typeof window.html2canvas === 'function') {
    console.log("[EXPORT-BASE-MOBILE-DARK] html2canvas j√° dispon√≠vel");
    return window.html2canvas;
  }

  console.log("[EXPORT-BASE-MOBILE-DARK] Carregando html2canvas dinamicamente...");

  return new Promise((resolve, reject) => {
    // Verificar se script j√° est√° sendo carregado
    const existingScript = document.querySelector('script[src*="html2canvas"]');
    if (existingScript) {
      // Aguardar carregamento do script existente
      const checkInterval = setInterval(() => {
        if (window.html2canvas) {
          clearInterval(checkInterval);
          resolve(window.html2canvas);
        }
      }, 100);

      // Timeout para o script existente
      setTimeout(() => {
        clearInterval(checkInterval);
        if (!window.html2canvas) {
          reject(new Error("Timeout aguardando script existente"));
        }
      }, 10000);
      return;
    }

    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    script.crossOrigin = "anonymous";
    script.async = true;

    let resolved = false;

    script.onload = () => {
      if (resolved) return;
      
      // Aguardar um momento para o script se registrar
      setTimeout(() => {
        if (window.html2canvas && typeof window.html2canvas === 'function') {
          resolved = true;
          console.log("[EXPORT-BASE-MOBILE-DARK] ‚úÖ html2canvas carregado com sucesso");
          resolve(window.html2canvas);
        } else {
          resolved = true;
          console.error("[EXPORT-BASE-MOBILE-DARK] ‚ùå html2canvas n√£o dispon√≠vel ap√≥s carregamento");
          reject(new Error("html2canvas n√£o se registrou corretamente"));
        }
      }, 200);
    };

    script.onerror = (error) => {
      if (resolved) return;
      resolved = true;
      console.error("[EXPORT-BASE-MOBILE-DARK] ‚ùå Erro ao carregar html2canvas:", error);
      reject(new Error("Falha no carregamento do script html2canvas"));
    };

    // Timeout de seguran√ßa
    setTimeout(() => {
      if (!resolved) {
        resolved = true;
        console.error("[EXPORT-BASE-MOBILE-DARK] ‚ùå Timeout ao carregar html2canvas");
        reject(new Error("Timeout de 10s ao carregar html2canvas"));
      }
    }, 10000);

    document.head.appendChild(script);
  });
}