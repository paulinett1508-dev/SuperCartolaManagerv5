# üîç INVESTIGA√á√ÉO DE PERFORMANCE E SEGURAN√áA - SUPER CARTOLA

## CONTEXTO
O sistema est√° apresentando lentid√£o na navega√ß√£o ap√≥s republish. Preciso de uma an√°lise completa para identificar gargalos e garantir que a arquitetura est√° otimizada.

---

## 1Ô∏è‚É£ ARMAZENAMENTO MONGODB - DADOS PR√â-CALCULADOS

### REGRA FUNDAMENTAL
> **O app do participante NUNCA deve calcular dados em tempo real. Todos os c√°lculos pesados s√£o responsabilidade do ADMIN e devem estar armazenados no MongoDB.**

### VERIFICAR SE EXISTEM COLLECTIONS DE CACHE:

```javascript
// Listar todas as collections do banco
db.getCollectionNames()
```

### COLLECTIONS ESPERADAS (cache/snapshots):

| Collection | Prop√≥sito | Atualiza√ß√£o |
|------------|-----------|-------------|
| `ranking_cache` | Ranking geral pr√©-calculado | Admin ao consolidar |
| `ranking_turno_cache` | Rankings por turno (1¬∫/2¬∫) | Admin ao consolidar |
| `pontos_corridos_cache` | Tabela pontos corridos | Admin ao consolidar |
| `top10_cache` | Top 10 Mitos/Micos | Admin ao consolidar |
| `extrato_cache` | Extratos financeiros | Admin ao salvar fluxo |
| `artilheiro_cache` | Artilheiro campe√£o | Admin ao registrar gols |
| `luva_ouro_cache` | Luva de ouro | Admin ao registrar defesas |
| `mata_mata_cache` | Chaves mata-mata | Admin ao atualizar |

### AN√ÅLISE NECESS√ÅRIA:

1. **Verificar se as collections de cache existem:**
```bash
# No shell do MongoDB
show collections
```

2. **Verificar estrutura de cada cache:**
```javascript
// Exemplo: ranking_cache
db.ranking_cache.findOne()

// Deve conter campos como:
// - ligaId
// - dados (array pr√©-calculado)
// - atualizadoEm (timestamp)
// - rodadaAtual
```

3. **Verificar se APIs do participante usam cache ou recalculam:**

Analisar os controllers em `/controllers/` para garantir que:
- ‚ùå N√ÉO fazem `aggregate()` pesados em tempo real
- ‚ùå N√ÉO fazem m√∫ltiplos `find()` + loops de c√°lculo
- ‚úÖ APENAS fazem `findOne()` no cache correspondente

### ENDPOINTS PARA AUDITAR:

```
GET /api/ligas/:id/ranking          ‚Üí Deve ler ranking_cache
GET /api/ranking-turno/:id          ‚Üí Deve ler ranking_turno_cache  
GET /api/pontos-corridos/:id        ‚Üí Deve ler pontos_corridos_cache
GET /api/top10/:id                  ‚Üí Deve ler top10_cache
GET /api/extrato-cache/:liga/:time  ‚Üí Deve ler extrato_cache
GET /api/artilheiro-campeao/:id     ‚Üí Deve ler artilheiro_cache
GET /api/luva-de-ouro/:id           ‚Üí Deve ler luva_ouro_cache
```

---

## 2Ô∏è‚É£ SNAPSHOTS E SUPER CACHES INTELIGENTES

### VERIFICAR SISTEMA DE CACHE NO FRONTEND:

1. **Cache Manager existe?**
```
/public/js/core/cache-manager.js
```

2. **Estrutura esperada do Cache Manager:**
```javascript
const CacheManager = {
    // Cache em mem√≥ria (sessionStorage ou vari√°vel)
    cache: new Map(),
    
    // TTL por tipo de dado
    TTL: {
        ranking: 5 * 60 * 1000,      // 5 minutos
        extrato: 10 * 60 * 1000,     // 10 minutos
        estaticas: 30 * 60 * 1000,   // 30 minutos (liga info, etc)
    },
    
    get(key) { ... },
    set(key, data, ttl) { ... },
    invalidate(key) { ... },
    invalidateAll() { ... }
};
```

3. **API Client usa cache?**
```
/public/js/core/api-client.js
```

Deve ter l√≥gica como:
```javascript
async function fetchComCache(url, options = {}) {
    const cacheKey = url;
    const cached = CacheManager.get(cacheKey);
    if (cached) return cached;
    
    const response = await fetch(url);
    const data = await response.json();
    CacheManager.set(cacheKey, data, options.ttl);
    return data;
}
```

### VERIFICAR CHAMADAS DUPLICADAS:

No DevTools (Network), ao navegar entre m√≥dulos:
- ‚ùå Mesma API sendo chamada m√∫ltiplas vezes
- ‚ùå APIs sendo chamadas a cada troca de aba
- ‚úÖ Dados vindos do cache (sem request)

### SNAPSHOTS NO MONGODB:

Verificar se existe sistema de snapshot para dados hist√≥ricos:
```javascript
// Collection de snapshots
db.snapshots.find({ tipo: "ranking", ligaId: "xxx" }).sort({ criadoEm: -1 }).limit(5)
```

---

## 3Ô∏è‚É£ SEGURAN√áA DE CONSOLE / F12

### PROTE√á√ïES NECESS√ÅRIAS NO FRONTEND:

1. **Desabilitar DevTools em produ√ß√£o:**

Arquivo: `/public/js/participante-auth.js` ou `/public/js/security.js`

```javascript
// Detectar DevTools aberto
(function() {
    const threshold = 160;
    const devtools = { open: false };
    
    setInterval(() => {
        const widthThreshold = window.outerWidth - window.innerWidth > threshold;
        const heightThreshold = window.outerHeight - window.innerHeight > threshold;
        
        if (widthThreshold || heightThreshold) {
            if (!devtools.open) {
                devtools.open = true;
                console.clear();
                console.log('%c‚ö†Ô∏è ACESSO RESTRITO', 'color: red; font-size: 24px; font-weight: bold;');
            }
        } else {
            devtools.open = false;
        }
    }, 1000);
})();
```

2. **Desabilitar atalhos de DevTools:**
```javascript
document.addEventListener('keydown', (e) => {
    // F12
    if (e.key === 'F12') e.preventDefault();
    // Ctrl+Shift+I
    if (e.ctrlKey && e.shiftKey && e.key === 'I') e.preventDefault();
    // Ctrl+Shift+J
    if (e.ctrlKey && e.shiftKey && e.key === 'J') e.preventDefault();
    // Ctrl+U (view source)
    if (e.ctrlKey && e.key === 'u') e.preventDefault();
});
```

3. **Desabilitar clique direito:**
```javascript
document.addEventListener('contextmenu', (e) => e.preventDefault());
```

4. **Limpar console periodicamente:**
```javascript
setInterval(() => {
    if (window.location.pathname.includes('/participante')) {
        console.clear();
    }
}, 5000);
```

5. **N√£o expor dados sens√≠veis no console:**
- ‚ùå `console.log(participante)` com dados completos
- ‚ùå `console.log(token)` 
- ‚úÖ Apenas logs de debug com prefixo remov√≠veis em prod

### VERIFICAR:
```bash
grep -rn "console.log" public/js/participante*.js | wc -l
```

Se houver muitos, considerar wrapper:
```javascript
const DEBUG = false; // false em produ√ß√£o
const log = (...args) => DEBUG && console.log(...args);
```

---

## 4Ô∏è‚É£ PROTE√á√ÉO DE ROTAS - REMO√á√ÉO DE /participante

### CEN√ÅRIOS DE ATAQUE:

1. Usu√°rio logado em `/participante/index.html`
2. Remove `/participante` da URL ‚Üí `/index.html`
3. Tenta acessar painel admin

### PROTE√á√ïES NECESS√ÅRIAS:

#### A) MIDDLEWARE DE PROTE√á√ÉO (Backend):

Arquivo: `/middleware/auth.js`

```javascript
export function protegerRotas(req, res, next) {
    const path = req.path;
    
    // Rotas p√∫blicas (n√£o proteger)
    const rotasPublicas = [
        '/participante-login.html',
        '/api/participante/auth/login',
        '/api/app/versao',
        '/favicon.png',
        '/escudos/'
    ];
    
    if (rotasPublicas.some(rota => path.startsWith(rota))) {
        return next();
    }
    
    // Rotas do participante - verificar sess√£o participante
    if (path.startsWith('/participante') || path.startsWith('/api/participante')) {
        if (!req.session?.participante) {
            return res.redirect('/participante-login.html');
        }
        return next();
    }
    
    // Rotas admin - verificar sess√£o admin
    if (!req.session?.admin && !req.session?.user) {
        // Tentar acessar admin sem estar logado
        return res.redirect('/login.html');
    }
    
    next();
}
```

#### B) VERIFICA√á√ÉO NO FRONTEND (participante):

Arquivo: `/public/js/participante-auth.js`

```javascript
// Executar imediatamente ao carregar
(function verificarAcessoParticipante() {
    const path = window.location.pathname;
    
    // Se n√£o est√° em rota de participante, redirecionar
    if (!path.includes('/participante') && !path.includes('participante-login')) {
        window.location.href = '/participante-login.html';
        return;
    }
    
    // Verificar sess√£o v√°lida
    const sessao = sessionStorage.getItem('participante_session');
    if (!sessao && !path.includes('login')) {
        window.location.href = '/participante-login.html';
    }
})();
```

#### C) HEADERS DE SEGURAN√áA (Backend):

Arquivo: `/config/security.js`

```javascript
import helmet from 'helmet';

export function setupSecurity(app) {
    app.use(helmet({
        contentSecurityPolicy: {
            directives: {
                defaultSrc: ["'self'"],
                scriptSrc: ["'self'", "'unsafe-inline'", "cdn.tailwindcss.com", "fonts.googleapis.com"],
                styleSrc: ["'self'", "'unsafe-inline'", "fonts.googleapis.com"],
                imgSrc: ["'self'", "data:", "*.cartola.fc"],
                connectSrc: ["'self'"],
                frameSrc: ["'none'"],
                objectSrc: ["'none'"]
            }
        },
        xFrameOptions: { action: 'deny' },
        noSniff: true,
        referrerPolicy: { policy: 'same-origin' }
    }));
    
    // Remover header que exp√µe tecnologia
    app.disable('x-powered-by');
}
```

#### D) VERIFICAR SESS√ïES SEPARADAS:

```javascript
// Sess√£o do participante
req.session.participante = {
    id: participante._id,
    timeId: participante.timeId,
    ligaId: participante.ligaId,
    tipo: 'participante' // IMPORTANTE!
};

// Sess√£o do admin  
req.session.admin = {
    id: admin._id,
    email: admin.email,
    tipo: 'admin' // IMPORTANTE!
};
```

E no middleware:
```javascript
// Participante tentando acessar admin
if (req.session?.participante && !path.startsWith('/participante')) {
    return res.status(403).json({ error: 'Acesso negado' });
}
```

---

## 5Ô∏è‚É£ CHECKLIST DE INVESTIGA√á√ÉO

### PERFORMANCE:

- [ ] Collections de cache existem no MongoDB?
- [ ] APIs do participante fazem `findOne` no cache (n√£o recalculam)?
- [ ] Cache Manager est√° implementado no frontend?
- [ ] API Client usa cache antes de fazer fetch?
- [ ] Network mostra requisi√ß√µes sendo cacheadas?
- [ ] N√£o h√° chamadas duplicadas ao navegar?

### SEGURAN√áA:

- [ ] DevTools √© detectado e tratado?
- [ ] Atalhos F12/Ctrl+Shift+I bloqueados?
- [ ] Clique direito desabilitado?
- [ ] Console.logs sens√≠veis removidos?
- [ ] Middleware protegerRotas implementado?
- [ ] Sess√µes admin/participante s√£o separadas?
- [ ] Headers de seguran√ßa (helmet) configurados?
- [ ] Tentativa de acessar /admin redireciona para login?

### COMANDOS √öTEIS:

```bash
# Verificar tamanho das collections
mongosh --eval "db.getCollectionNames().forEach(c => print(c + ': ' + db[c].stats().size))"

# Buscar console.logs no c√≥digo
grep -rn "console.log" public/js/ --include="*.js" | wc -l

# Verificar imports de seguran√ßa
grep -rn "helmet\|protegerRotas\|security" index.js

# Verificar middleware de auth
cat middleware/auth.js

# Verificar cache controllers
ls -la controllers/*Cache*.js
```

---

## üìã RELAT√ìRIO ESPERADO

Ap√≥s a investiga√ß√£o, documentar:

1. **Gargalos encontrados:** (lista)
2. **Collections de cache faltando:** (lista)
3. **APIs que recalculam em vez de ler cache:** (lista)
4. **Vulnerabilidades de seguran√ßa:** (lista)
5. **A√ß√µes corretivas necess√°rias:** (priorizado)

---

**Data:** $(date)
**Vers√£o do Sistema:** Verificar em /api/app/versao