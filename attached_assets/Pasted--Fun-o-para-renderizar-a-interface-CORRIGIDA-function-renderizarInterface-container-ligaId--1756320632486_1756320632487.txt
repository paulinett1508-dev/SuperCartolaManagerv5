// Função para renderizar a interface - CORRIGIDA
function renderizarInterface(container, ligaId) {
  console.log("[MATA-MATA] Renderizando interface...");

  const edicoesHtml = `
    <div class="edicao-selector">
      <label for="edicao-select">Edição:</label>
      <select id="edicao-select">
        <option value="" selected disabled>Selecione uma edição</option>
        ${edicoes
          .map(
            (edicao) => `
          <option value="${edicao.id}" ${!edicao.ativo ? "disabled" : ""}>
            ${edicao.nome} (Rodadas ${edicao.rodadaInicial}-${edicao.rodadaFinal})
          </option>
        `,
          )
          .join("")}
      </select>
    </div>
  `;

  const fasesHtml = `
    <div id="fase-nav-container" style="display:none;">
      <div class="fase-nav">
        <button class="fase-btn active" data-fase="primeira">1ª FASE</button>
        <button class="fase-btn" data-fase="oitavas">OITAVAS</button>
        <button class="fase-btn" data-fase="quartas">QUARTAS</button>
        <button class="fase-btn" data-fase="semis">SEMIS</button>
        <button class="fase-btn" data-fase="final">FINAL</button>
      </div>
    </div>
    <div id="mataMataContent">
      <div class="instrucao-inicial">
        <p>Por favor, selecione uma edição do Mata-Mata para visualizar os confrontos.</p>
      </div>
    </div>
  `;

  container.innerHTML = edicoesHtml + fasesHtml;

  const edicaoSelect = document.getElementById("edicao-select");
  if (edicaoSelect) {
    let debounceTimer;
    edicaoSelect.addEventListener("change", function (event) {
      clearTimeout(debounceTimer);
      const controller = new AbortController();

      debounceTimer = setTimeout(() => {
        if (controller.signal.aborted) return;

        edicaoAtual = parseInt(this.value);
        console.log(`[MATA-MATA] Edição selecionada: ${edicaoAtual}`);

        const faseNavContainer = document.getElementById("fase-nav-container");
        if (faseNavContainer) faseNavContainer.style.display = "block";

        container
          .querySelectorAll(".fase-btn")
          .forEach((btn) => btn.classList.remove("active"));
        const primeiraFaseBtn = container.querySelector(
          '.fase-btn[data-fase="primeira"]',
        );
        if (primeiraFaseBtn) primeiraFaseBtn.classList.add("active");

        carregarFase("primeira", ligaId);
      }, 300);

      window.addEventListener(
        "beforeunload",
        () => {
          controller.abort();
          clearTimeout(debounceTimer);
        },
        { once: true },
      );
    });
  }

  container.querySelectorAll(".fase-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      if (!edicaoAtual) {
        const message =
          "Por favor, selecione uma edição do Mata-Mata primeiro.";
        console.warn(`[MATA-MATA] ${message}`);

        const alertDiv = document.createElement("div");
        alertDiv.className = "alert alert-warning";
        alertDiv.textContent = message;

        const contentDiv = document.getElementById("mataMataContent");
        if (contentDiv) {
          contentDiv.innerHTML = "";
          contentDiv.appendChild(alertDiv);
        }
        return;
      }

      container
        .querySelectorAll(".fase-btn")
        .forEach((b) => b.classList.remove("active"));
      this.classList.add("active");

      const fase = this.getAttribute("data-fase");
      console.log(`[MATA-MATA] Fase selecionada: ${fase}`);
      carregarFase(fase, ligaId);
    });
  });
}