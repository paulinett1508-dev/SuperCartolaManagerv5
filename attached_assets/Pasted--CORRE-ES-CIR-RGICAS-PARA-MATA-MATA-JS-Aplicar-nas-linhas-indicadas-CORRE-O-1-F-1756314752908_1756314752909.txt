// CORREÃ‡Ã•ES CIRÃšRGICAS PARA MATA-MATA.JS
// Aplicar nas linhas indicadas

// ===== CORREÃ‡ÃƒO 1: FunÃ§Ã£o carregarExports (linhas 15-55) =====
// SUBSTITUIR o bloco Promise por:

if (exportsCarregando) {
  return new Promise((resolve) => {
    const controller = new AbortController();
    const checkInterval = setInterval(() => {
      if (exportsCarregados || !exportsCarregando) {
        clearInterval(checkInterval);
        controller.abort(); // Cleanup
        resolve(exportsCarregados);
      }
    }, 100);
    
    // Cleanup apÃ³s timeout
    setTimeout(() => {
      clearInterval(checkInterval);
      controller.abort();
      resolve(false);
    }, 5000);
  });
}

// ===== CORREÃ‡ÃƒO 2: FunÃ§Ã£o carregarRodadas (linhas 84-118) =====
// SUBSTITUIR o bloco Promise por:

if (rodadasCarregando) {
  return new Promise((resolve) => {
    const controller = new AbortController();
    const checkInterval = setInterval(() => {
      if (rodadasCarregados || !rodadasCarregando) {
        clearInterval(checkInterval);
        controller.abort(); // Cleanup
        resolve(rodadasCarregados);
      }
    }, 100);
    
    // Cleanup apÃ³s timeout  
    setTimeout(() => {
      clearInterval(checkInterval);
      controller.abort();
      resolve(false);
    }, 5000);
  });
}

// ===== CORREÃ‡ÃƒO 3: Event listener com debounce (linha 317) =====
// SUBSTITUIR o addEventListener por:

edicaoSelect.addEventListener("change", function(event) {
  clearTimeout(debounceTimer);
  const controller = new AbortController();
  
  debounceTimer = setTimeout(() => {
    if (controller.signal.aborted) return;
    
    edicaoAtual = parseInt(this.value);
    console.log(`[MATA-MATA] ğŸ“‹ EdiÃ§Ã£o selecionada: ${edicaoAtual}`);

    const faseNavContainer = document.getElementById("fase-nav-container");
    if (faseNavContainer) faseNavContainer.style.display = "block";

    container
      .querySelectorAll(".fase-btn")
      .forEach((btn) => btn.classList.remove("active"));
    const primeiraFaseBtn = container.querySelector(
      '.fase-btn[data-fase="primeira"]',
    );
    if (primeiraFaseBtn) primeiraFaseBtn.classList.add("active");

    carregarFase("primeira", ligaId);
  }, 300);
  
  // Cleanup no unload
  window.addEventListener('beforeunload', () => {
    controller.abort();
    clearTimeout(debounceTimer);
  }, { once: true });
});

// ===== CORREÃ‡ÃƒO 4: Adicionar ao final do arquivo =====
// ADICIONAR antes da Ãºltima linha:

// Cleanup global para evitar memory leaks
window.addEventListener('beforeunload', () => {
  clearTimeout(debounceTimer);
  moduleCache.clear();
  exportsCarregados = false;
  rodadasCarregados = false;
  console.log('[MATA-MATA] ğŸ§¹ Cleanup executado');
});

// Interceptar erros de Promise nÃ£o tratadas
window.addEventListener('unhandledrejection', (event) => {
  if (event.reason && event.reason.message && 
      event.reason.message.includes('message channel closed')) {
    event.preventDefault();
    console.log('[MATA-MATA] ğŸ›¡ï¸ Promise rejection interceptada e ignorada');
  }
});