# ============================================================================
# PRE-COMMIT HOOK - Sistema H√≠brido de Skills
# ============================================================================
#
# Sincroniza automaticamente .agent/ quando docs/skills/ mudar
#
# Comportamento:
# - Detecta se docs/skills/ tem mudan√ßas staged
# - Se sim, executa sync-skills.js
# - Adiciona .agent/ modificado ao staging
# - N√ÉO bloqueia commit se falhar (apenas avisa)
#
# Para pular: SKIP_SYNC=1 git commit -m "mensagem"
# ============================================================================

# Verificar se deve pular sincroniza√ß√£o
if [ "$SKIP_SYNC" = "1" ]; then
  echo "‚è≠Ô∏è  [PRE-COMMIT] Sincroniza√ß√£o pulada (SKIP_SYNC=1)"
  exit 0
fi

# Verificar se docs/skills/ tem mudan√ßas staged
SKILLS_CHANGED=$(git diff --cached --name-only | grep "^docs/skills/" || true)

if [ -z "$SKILLS_CHANGED" ]; then
  # Nenhuma mudan√ßa em docs/skills/, pular sincroniza√ß√£o
  exit 0
fi

echo ""
echo "üîÑ [PRE-COMMIT] Mudan√ßas detectadas em docs/skills/"

# Valida√ß√£o r√°pida de frontmatter (apenas arquivos staged)
echo "üîç [PRE-COMMIT] Validando frontmatter..."
if node scripts/validation/frontmatter-check.js > /dev/null 2>&1; then
  echo "‚úÖ [PRE-COMMIT] Frontmatter v√°lido"
else
  echo "‚ö†Ô∏è  [PRE-COMMIT] Avisos no frontmatter (n√£o bloqueia commit)"
  echo "    Execute: npm run validate:frontmatter"
fi

echo "üì¶ [PRE-COMMIT] Sincronizando .agent/..."
echo ""

# Executar sincroniza√ß√£o
if node scripts/sync-skills.js; then
  echo ""
  echo "‚úÖ [PRE-COMMIT] Sincroniza√ß√£o conclu√≠da com sucesso"

  # Adicionar .agent/ modificado ao staging
  git add .agent/

  echo "‚úÖ [PRE-COMMIT] .agent/ adicionado ao commit"
  echo ""
else
  echo ""
  echo "‚ö†Ô∏è  [PRE-COMMIT] Sincroniza√ß√£o falhou, mas permitindo commit"
  echo "‚ö†Ô∏è  [PRE-COMMIT] Execute manualmente: npm run sync-skills"
  echo ""
  # N√£o bloquear commit, apenas avisar
  exit 0
fi

exit 0
