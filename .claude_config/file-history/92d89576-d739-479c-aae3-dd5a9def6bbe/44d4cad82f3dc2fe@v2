// =====================================================================
// PARTICIPANTE-BOAS-VINDAS.JS - v7.2 (TAILWIND)
// =====================================================================

if (window.Log)
    Log.info("PARTICIPANTE-BOAS-VINDAS", "üîÑ Carregando m√≥dulo v7.2...");

// =====================================================================
// FUN√á√ÉO PRINCIPAL
// =====================================================================
export async function inicializarBoasVindasParticipante(params) {
    let ligaId, timeId, participante;

    if (
        typeof params === "object" &&
        params !== null &&
        !Array.isArray(params)
    ) {
        ligaId = params.ligaId;
        timeId = params.timeId;
        participante = params.participante;
    } else {
        ligaId = params;
        timeId = arguments[1];
    }

    ligaId = typeof ligaId === "string" ? ligaId : String(ligaId || "");
    timeId = typeof timeId === "string" ? timeId : String(timeId || "");

    if (window.Log)
        Log.debug("PARTICIPANTE-BOAS-VINDAS", "üöÄ Inicializando...", {
            ligaId,
            timeId,
            participante,
        });

    if (!ligaId || ligaId === "[object Object]") {
        if (window.Log)
            Log.error("PARTICIPANTE-BOAS-VINDAS", "‚ùå Liga ID inv√°lido");
        return;
    }

    if (!timeId || timeId === "undefined") {
        if (window.Log)
            Log.error("PARTICIPANTE-BOAS-VINDAS", "‚ùå Time ID inv√°lido");
        return;
    }

    await carregarDadosERenderizar(ligaId, timeId, participante);
}

window.inicializarBoasVindasParticipante = inicializarBoasVindasParticipante;

// =====================================================================
// CARREGAR DADOS E RENDERIZAR
// =====================================================================
async function carregarDadosERenderizar(ligaId, timeId, participante) {
    const container = document.getElementById("boas-vindas-container");
    if (!container) return;

    // Loading
    container.innerHTML = `
        <div class="flex justify-center items-center min-h-[300px]">
            <div class="text-center">
                <div class="w-10 h-10 border-4 border-zinc-700 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-sm text-white/70">Carregando...</p>
            </div>
        </div>
    `;

    try {
        // ‚úÖ Buscar rodada atual primeiro para usar no cache
        const [resLiga, resRanking, resRodadas] = await Promise.all([
            fetch(`/api/ligas/${ligaId}`),
            fetch(`/api/ligas/${ligaId}/ranking`),
            fetch(`/api/rodadas/${ligaId}/rodadas?inicio=1&fim=38`),
        ]);

        const liga = resLiga.ok ? await resLiga.json() : null;
        const ranking = resRanking.ok ? await resRanking.json() : [];
        const rodadas = resRodadas.ok ? await resRodadas.json() : [];

        // ‚úÖ Determinar rodada atual para buscar extrato com o mesmo endpoint que o m√≥dulo Extrato usa
        const minhasRodadasTemp = rodadas.filter(
            (r) => Number(r.timeId) === Number(timeId) || Number(r.time_id) === Number(timeId)
        );
        const ultimaRodadaNum = minhasRodadasTemp.length > 0
            ? Math.max(...minhasRodadasTemp.map(r => r.rodada))
            : 1;

        // ‚úÖ Usar o MESMO endpoint de cache que o Extrato usa para consist√™ncia
        let extratoData = null;
        try {
            const resCache = await fetch(`/api/extrato-cache/${ligaId}/times/${timeId}/cache?rodadaAtual=${ultimaRodadaNum}`);
            if (resCache.ok) {
                const cacheData = await resCache.json();
                extratoData = {
                    saldo_atual: cacheData?.resumo?.saldo_final ?? cacheData?.resumo?.saldo ?? 0,
                    resumo: cacheData?.resumo || {}
                };
            }
        } catch (e) {
            if (window.Log) Log.warn("PARTICIPANTE-BOAS-VINDAS", "Cache n√£o dispon√≠vel, usando fallback");
        }

        // Fallback para endpoint de c√°lculo se cache n√£o existir
        if (!extratoData || extratoData.saldo_atual === undefined) {
            const resFallback = await fetch(`/api/fluxo-financeiro/${ligaId}/extrato/${timeId}`);
            extratoData = resFallback.ok ? await resFallback.json() : null;
        }

        // ‚úÖ CORRE√á√ÉO: Buscar campos manuais (igual ao Extrato faz)
        // Esses s√£o valores adicionados manualmente no admin que devem ser somados ao saldo
        let totalCamposManuais = 0;
        try {
            const resCampos = await fetch(`/api/fluxo-financeiro/${ligaId}/times/${timeId}`);
            if (resCampos.ok) {
                const camposData = await resCampos.json();
                if (camposData.success && camposData.campos && Array.isArray(camposData.campos)) {
                    totalCamposManuais = camposData.campos.reduce((total, campo) => {
                        return total + (parseFloat(campo.valor) || 0);
                    }, 0);
                    if (window.Log && totalCamposManuais !== 0) {
                        Log.info("PARTICIPANTE-BOAS-VINDAS", `üí∞ Campos manuais: R$ ${totalCamposManuais.toFixed(2)}`);
                    }
                }
            }
        } catch (e) {
            if (window.Log) Log.warn("PARTICIPANTE-BOAS-VINDAS", "N√£o foi poss√≠vel buscar campos manuais");
        }

        // Adicionar campos manuais ao extratoData se existirem
        if (extratoData && totalCamposManuais !== 0) {
            extratoData.camposManuais = totalCamposManuais;
        }

        const meuTimeIdNum = Number(timeId);
        const meuTime = ranking.find((t) => Number(t.timeId) === meuTimeIdNum);
        const posicao = meuTime ? meuTime.posicao : null;
        const totalParticipantes = ranking.length;

        const minhasRodadas = rodadas.filter(
            (r) =>
                Number(r.timeId) === meuTimeIdNum ||
                Number(r.time_id) === meuTimeIdNum,
        );

        const pontosTotal = minhasRodadas.reduce((total, rodada) => {
            return total + (parseFloat(rodada.pontos) || 0);
        }, 0);

        const rodadasOrdenadas = [...minhasRodadas].sort(
            (a, b) => b.rodada - a.rodada,
        );
        const ultimaRodada = rodadasOrdenadas[0];
        const rodadaAtual = ultimaRodada ? ultimaRodada.rodada : 0;

        // Posi√ß√£o anterior
        let posicaoAnterior = null;
        if (rodadaAtual > 1 && minhasRodadas.length >= 2) {
            const rodadasAteAnterior = rodadas.filter(
                (r) => r.rodada < rodadaAtual,
            );
            const rankingAnterior = calcularRankingManual(rodadasAteAnterior);
            const meuTimeAnterior = rankingAnterior.find(
                (t) => Number(t.timeId) === meuTimeIdNum,
            );
            if (meuTimeAnterior) posicaoAnterior = meuTimeAnterior.posicao;
        }

        // ‚úÖ Saldo financeiro = saldo do extrato + campos manuais (adicionados no admin)
        const saldoBase = extratoData?.saldo_atual ?? extratoData?.resumo?.saldo_final ?? 0;
        const saldoFinanceiro = saldoBase + (extratoData?.camposManuais || 0);
        const nomeTime =
            participante?.nome_time || meuTime?.nome_time || "Seu Time";
        const nomeCartola =
            participante?.nome_cartola || meuTime?.nome_cartola || "Cartoleiro";
        const nomeLiga = liga?.nome || "Liga";

        if (window.Log)
            Log.info("PARTICIPANTE-BOAS-VINDAS", "‚úÖ Dados finais:", {
                nomeTime,
                nomeCartola,
                pontosTotais: pontosTotal,
            });

        renderizarBoasVindas(container, {
            posicao,
            totalParticipantes,
            pontosTotal,
            ultimaRodada,
            rodadaAtual,
            nomeTime,
            nomeCartola,
            nomeLiga,
            saldoFinanceiro,
            posicaoAnterior,
            minhasRodadas: rodadasOrdenadas,
        });
    } catch (error) {
        if (window.Log)
            Log.error("PARTICIPANTE-BOAS-VINDAS", "‚ùå Erro:", error);
        container.innerHTML = `
            <div class="text-center py-16 px-5">
                <span class="material-icons text-5xl text-red-500">error</span>
                <p class="text-white/70 mt-4">Erro ao carregar dados</p>
            </div>
        `;
    }
}

// =====================================================================
// HELPERS
// =====================================================================
function calcularRankingManual(rodadas) {
    const timesAgrupados = {};
    rodadas.forEach((rodada) => {
        const timeId = Number(rodada.timeId) || Number(rodada.time_id);
        if (!timesAgrupados[timeId]) {
            timesAgrupados[timeId] = { timeId, pontos_totais: 0 };
        }
        timesAgrupados[timeId].pontos_totais += parseFloat(rodada.pontos) || 0;
    });
    return Object.values(timesAgrupados)
        .sort((a, b) => b.pontos_totais - a.pontos_totais)
        .map((time, index) => ({ ...time, posicao: index + 1 }));
}

function formatarPontos(valor) {
    return valor.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });
}

function getZonaInfo(posicao, total) {
    if (!posicao || !total)
        return {
            texto: "N/D",
            corTexto: "text-white/50",
            corBg: "bg-white/5",
            icon: "help",
        };
    const percentual = (posicao / total) * 100;
    if (percentual <= 33)
        return {
            texto: "Zona de Premia√ß√£o",
            corTexto: "text-green-400",
            corBg: "bg-green-400/10",
            icon: "emoji_events",
        };
    if (percentual <= 66)
        return {
            texto: "Zona Neutra",
            corTexto: "text-yellow-400",
            corBg: "bg-yellow-400/10",
            icon: "remove",
        };
    return {
        texto: "Zona de Risco",
        corTexto: "text-red-400",
        corBg: "bg-red-400/10",
        icon: "warning",
    };
}

// =====================================================================
// RENDERIZA√á√ÉO - TAILWIND CLASSES
// =====================================================================
function renderizarBoasVindas(container, data) {
    const {
        posicao,
        totalParticipantes,
        pontosTotal,
        ultimaRodada,
        rodadaAtual,
        nomeTime,
        nomeCartola,
        nomeLiga,
        saldoFinanceiro,
        posicaoAnterior,
        minhasRodadas,
    } = data;

    const zona = getZonaInfo(posicao, totalParticipantes);
    const primeiroNome = nomeCartola.split(" ")[0];
    const rodadasRestantes = Math.max(0, 38 - rodadaAtual);
    const pontosUltimaRodada = ultimaRodada
        ? parseFloat(ultimaRodada.pontos).toFixed(2)
        : "0.00";

    // Varia√ß√£o posi√ß√£o
    let variacaoPosHTML = "";
    if (posicao && posicaoAnterior) {
        const diff = posicaoAnterior - posicao;
        if (diff > 0)
            variacaoPosHTML = `<span class="text-green-400 text-xs ml-1">‚ñ≤${diff}</span>`;
        else if (diff < 0)
            variacaoPosHTML = `<span class="text-red-400 text-xs ml-1">‚ñº${Math.abs(diff)}</span>`;
    }

    // Varia√ß√£o pontos
    let variacaoInfo = {
        valor: "--",
        cor: "text-white/50",
        icon: "trending_flat",
    };
    if (minhasRodadas.length >= 2) {
        const ultima = parseFloat(minhasRodadas[0].pontos) || 0;
        const penultima = parseFloat(minhasRodadas[1].pontos) || 0;
        const diff = ultima - penultima;
        if (diff > 0)
            variacaoInfo = {
                valor: `+${diff.toFixed(1)}`,
                cor: "text-green-400",
                icon: "trending_up",
            };
        else if (diff < 0)
            variacaoInfo = {
                valor: diff.toFixed(1),
                cor: "text-red-400",
                icon: "trending_down",
            };
        else
            variacaoInfo = {
                valor: "0.0",
                cor: "text-white/50",
                icon: "trending_flat",
            };
    }

    // Saldo - v7.2: Cores din√¢micas com style inline
    const saldoAbs = Math.abs(saldoFinanceiro);
    const saldoFormatadoNumero = saldoAbs.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });
    const saldoFormatado =
        saldoFinanceiro >= 0
            ? `R$ ${saldoFormatadoNumero}`
            : `-R$ ${saldoFormatadoNumero}`;
    const saldoCorStyle =
        saldoFinanceiro > 0
            ? "color: #4ade80;"
            : saldoFinanceiro < 0
              ? "color: #f87171;"
              : "color: rgba(255,255,255,0.5);";

    container.innerHTML = `
        <div class="pb-28">

            <!-- Sauda√ß√£o -->
            <div class="px-4 py-4">
                <h1 class="text-xl font-bold leading-tight tracking-tight text-white">Ol√°, ${primeiroNome}! üëã</h1>
                <p class="text-sm font-normal text-white/70">${nomeLiga} ‚Ä¢ Rodada ${rodadaAtual || "--"}</p>
            </div>

            <!-- Card Principal do Time -->
            <div class="mx-4 mb-4 rounded-xl bg-surface-dark p-4">
                <h3 class="mb-4 text-center text-base font-bold leading-tight text-white">${nomeTime}</h3>
                <div class="flex items-center justify-around">
                    <div class="text-center">
                        <p class="text-xs font-medium uppercase leading-normal text-white/70">Posi√ß√£o</p>
                        <p class="text-4xl font-bold leading-tight tracking-tighter text-white">${posicao ? `${posicao}¬∫` : "--"}</p>
                        <p class="text-xs font-normal leading-normal text-white/70">de ${totalParticipantes}${variacaoPosHTML}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-medium uppercase leading-normal text-white/70">Pontos</p>
                        <p class="text-4xl font-bold leading-tight tracking-tighter text-white">${formatarPontos(pontosTotal).split(",")[0]}</p>
                        <p class="text-xs font-normal leading-normal text-white/70">total acumulado</p>
                    </div>
                </div>
                <div class="mt-4 flex items-center justify-center gap-2 rounded-full ${zona.corBg} py-1.5 px-4">
                    <span class="material-icons text-sm ${zona.corTexto}">${zona.icon}</span>
                    <p class="text-xs font-medium text-white/90">${zona.texto}</p>
                </div>
            </div>

            <!-- Card Saldo Financeiro -->
            <div class="mx-4 mb-4 rounded-xl bg-surface-dark p-4 cursor-pointer active:scale-[0.98] transition-transform" onclick="window.participanteNav?.navegarPara('extrato')">
                <div class="flex w-full items-center gap-4 text-left">
                    <div class="flex-shrink-0">
                        <span class="material-icons text-3xl text-primary">paid</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-medium uppercase text-white/70">Saldo Financeiro</p>
                        <p class="text-lg font-bold" style="${saldoCorStyle}">${saldoFormatado}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="material-icons text-white/70">arrow_forward_ios</span>
                    </div>
                </div>
            </div>

            <!-- Grid de Estat√≠sticas -->
            <div class="mx-4 mb-4 grid grid-cols-3 gap-3">
                <div class="flex flex-col items-center justify-center gap-1 rounded-xl bg-surface-dark p-3">
                    <p class="text-xs font-medium uppercase text-white/70">Rodadas</p>
                    <p class="text-2xl font-bold text-white">${rodadaAtual || 0}</p>
                </div>
                <div class="flex flex-col items-center justify-center gap-1 rounded-xl bg-surface-dark p-3">
                    <p class="text-xs font-medium uppercase text-white/70">Participantes</p>
                    <p class="text-2xl font-bold text-white">${totalParticipantes}</p>
                </div>
                <div class="flex flex-col items-center justify-center gap-1 rounded-xl bg-surface-dark p-3">
                    <p class="text-xs font-medium uppercase text-white/70">Faltam</p>
                    <p class="text-2xl font-bold text-primary">${rodadasRestantes}</p>
                </div>
            </div>

            <!-- Card de Desempenho -->
            <div class="mx-4 mb-4 rounded-xl bg-surface-dark p-4">
                <div class="flex items-center gap-2 mb-3">
                    <span class="material-icons text-primary">insights</span>
                    <h3 class="text-sm font-bold text-white">Seu Desempenho</h3>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-primary text-xl">bolt</span>
                            <span class="text-xs text-white/70">Rodada ${rodadaAtual}</span>
                        </div>
                        <span class="text-sm font-bold text-white">${pontosUltimaRodada} pts</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <div class="flex items-center gap-2">
                            <span class="material-icons ${variacaoInfo.cor} text-xl">${variacaoInfo.icon}</span>
                            <span class="text-xs text-white/70">Varia√ß√£o</span>
                        </div>
                        <span class="text-sm font-bold ${variacaoInfo.cor}">${variacaoInfo.valor}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-primary text-xl">history</span>
                            <span class="text-xs text-white/70">Posi√ß√£o anterior</span>
                        </div>
                        <span class="text-sm font-bold text-white">${posicaoAnterior ? `${posicaoAnterior}¬∫` : "--"}</span>
                    </div>
                </div>
            </div>

            <!-- Card de Dica -->
            <div class="mx-4 mb-4 flex items-start gap-3 rounded-xl bg-primary/10 p-4">
                <span class="material-icons mt-0.5 text-primary">lightbulb</span>
                <div>
                    <p class="text-sm font-bold uppercase text-white/90">Dica</p>
                    <p class="text-sm font-normal text-white/70">Acompanhe seu extrato financeiro para entender sua evolu√ß√£o na liga!</p>
                </div>
            </div>
        </div>
    `;
}

if (window.Log)
    Log.info("PARTICIPANTE-BOAS-VINDAS", "‚úÖ M√≥dulo v7.2 carregado");
