# Super Cartola Manager - Diretrizes de Desenvolvimento

## üõ†Ô∏è Comandos Principais
- **Start Dev:** `npm run dev` (Nodemon + Hot Reload)
- **Start Prod:** `npm start`
- **Testes:** `npm test` (Roda todos os testes via Jest)
- **Lint:** `npm run lint` e `npm run lint:fix`
- **Consolida√ß√£o Manual:** `npm run consolidar` (Processa rodadas pendentes)
- **MCP Database:** O arquivo `.mcp.json` configura o servidor MCP para consultas ao Mongo.

## üèóÔ∏è Arquitetura e Tech Stack
- **Runtime:** Node.js (ES Modules habilitado).
- **Backend:** Express.js (MVC Pattern).
- **Database:** MongoDB + Mongoose. Use o servidor MCP para inspecionar schemas reais.
- **Frontend Admin:** HTML/CSS/Vanilla JS (Desktop) - `public/admin/`.
- **Frontend App:** Mobile-First Modular JS - `public/participante/`.
- **Auth:** Replit Auth (Admin) e Express Session (Participantes).

## üß† Regras de Neg√≥cio Cr√≠ticas (Cartola)
1.  **Pontua√ß√£o:** Baseada na API oficial do Cartola FC.
2.  **Ligas:**
    - *SuperCartola:* 32 times. Regra financeira complexa (Top/Bottom tier).
    - *Cartoleiros Sobral:* 6 times. Regra simplificada + Luva de Ouro.
3.  **Formatos de Disputa:**
    - *Pontos Corridos:* Todos contra todos. Vit√≥ria (+5), Empate (+3), Derrota (-5).
    - *Mata-Mata:* Chaveamento (1¬∫ vs 32¬∫). 5 edi√ß√µes por temporada.
    - *Mitos/Micos:* Top 10 e Bottom 10 da rodada geram b√¥nus/multa financeira.
4.  **Consolida√ß√£o:** Os dados de rodada tornam-se imut√°veis ap√≥s processados (`RodadaSnapshot`). Nunca recalcule uma rodada consolidada sem backup.
5.  **Participantes Inativos:** Times que desistem t√™m `ativo: false` e `rodada_desistencia` definidos. Seus dados s√£o travados at√© `rodada_desistencia - 1`.

## üìä Regras de Arredondamento e Precis√£o
- **Pontua√ß√£o:** Sempre usar `toFixed(2)` para exibi√ß√£o de valores decimais.
- **M√©dias:** Calcular com `parseFloat((valor).toFixed(2))` para manter 2 casas decimais.
- **Saldos Financeiros:** Arredondar para 2 casas em todas as opera√ß√µes (PC, Mata-Mata, Top10).

## üö´ Gest√£o de Participantes Inativos
O sistema trata participantes que desistiram da liga de forma especial:
- **Modelo Time:** Campos `ativo` (boolean) e `rodada_desistencia` (n√∫mero).
- **Helper Centralizado:** `utils/participanteHelper.js` com fun√ß√µes:
  - `buscarStatusParticipantes()` - Busca status em batch
  - `obterUltimaRodadaValida()` - Retorna `min(rodadaFim, rodada_desistencia - 1)`
  - `ordenarRankingComInativos()` - Ativos primeiro, depois inativos
- **Regra de Travamento:** Extrato financeiro, artilheiro, goleiros - dados travados na rodada anterior √† desist√™ncia.
- **Exibi√ß√£o:** Inativos aparecem no final dos rankings com indicador visual.

## üéØ Corre√ß√µes Cr√≠ticas Implementadas (2024-2025)

### Temporada Encerrada (R38)
- **Problema:** Quando `rodadaAtual >= 38`, mercado permanece "aberto" mas dados s√£o finais.
- **Solu√ß√£o:** Controllers verificam `if (rodadaAtual >= 38)` e usam R38 como rodadaFim sem subtrair.
- **Arquivos:** `artilheiroCampeaoController.js:154-175`, `goleirosService.js:756-763`

### Top 10 (Mitos/Micos)
- **Estrutura:** Cache em `Top10Cache` com `mitos[]` e `micos[]` por rodada.
- **Valores SuperCartola:** Mitos: 30‚Üí12 (posi√ß√µes 1-10), Micos: -30‚Üí-12 (posi√ß√µes 23-32).
- **Valores Sobral:** Mitos: 10‚Üí1, Micos: -10‚Üí-1.
- **Controller:** `fluxoFinanceiroController.js:125-225` - fun√ß√£o `calcularTop10()`.

## üíª Diretrizes de C√≥digo (Style Guide)
- **Idioma:** Coment√°rios e documenta√ß√£o em **Portugu√™s (PT-BR)**. Nomes de vari√°veis/fun√ß√µes em camelCase (h√≠brido PT/EN aceito, ex: `rodadaController`, `getTeamStats`).
- **Banco de Dados:**
    - N√ÉO adivinhe nomes de campos. Use a tool `get_collection_schema` do MCP para verificar a estrutura antes de criar queries complexas.
    - Use `async/await` para todas as chamadas de banco.
- **Frontend:**
    - Evite frameworks complexos (React/Vue) neste projeto. Mantenha Vanilla JS modular.
    - Use `fetch` para API calls.
- **Tratamento de Erros:** Sempre envolva chamadas de API externa e Banco em `try/catch`. Logs de erro devem ser descritivos.

## üìÇ Estrutura de Pastas Relevante
- `controllers/`: L√≥gica de neg√≥cio (~20 arquivos).
- `services/`: Integra√ß√µes externas (API Cartola) e l√≥gica pura.
- `models/`: Schemas do Mongoose (17 cole√ß√µes).
- `utils/`: Helpers como `participanteHelper.js`, `participanteUtils.js`.
- `public/participante/js/modules/`: L√≥gica do frontend mobile (carregamento pregui√ßoso).

## üóÑÔ∏è Cole√ß√µes MongoDB
```
times, ligas, rodadas, rodadasnapshots, gols, golsconsolidados, goleiros,
artilheirocampeaos, sessions, rankingturnos, top10caches, matamatacaches,
pontoscorridoscaches, rankinggeralcaches, extratofinanceirocaches,
fluxofinanceirocampos, melhor_mes_cache
```

## ‚ö†Ô∏è Restri√ß√µes do Ambiente (Replit)
- N√£o tente usar `sudo` ou instalar pacotes de sistema globalmente.
- Use a vari√°vel `MONGODB_URI` dos Secrets.
- Respeite o rate-limit da API do Cartola FC.