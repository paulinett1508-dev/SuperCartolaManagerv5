# SUPER CARTOLA MANAGER - PROJECT RULES

## üß† Tech Stack & Constraints
- **Runtime:** Node.js (Replit Environment).
- **Database:** MongoDB (Native Driver).
- **Frontend:** HTML5, CSS3, Vanilla JS (ES6 Modules).
- **Styling:** TailwindCSS (via CDN).
- **Architecture:** MVC (Models, Controllers, Views/Public).

## üéØ PROTOCOLOS DE DESENVOLVIMENTO (OBRIGAT√ìRIOS)

### S.A.I.S Protocol (Antes de QUALQUER altera√ß√£o)
1. **SOLICITAR** arquivo original completo
2. **ANALISAR** linha por linha
3. **IDENTIFICAR** depend√™ncias
4. **ALTERAR** minimamente focado no objetivo

**NUNCA**:
- Modificar sem ver arquivo completo
- Reescrever c√≥digo funcional
- Assumir melhorias sem requisi√ß√£o
- Fazer m√∫ltiplas solu√ß√µes para mesmo problema

### S.D.A - Sistema de Depend√™ncias Arquiteturais
Antes de modificar QUALQUER arquivo:
1. Mapear quem importa (`grep -r "require.*arquivo"`)
2. Verificar IDs/classes CSS usados
3. Checar rotas/formul√°rios que referenciam
4. Solicitar arquivos dependentes identificados
5. S√ì ENT√ÉO propor mudan√ßas m√≠nimas

### ANTIPATTERN Mode (SEMPRE ATIVO)
‚úÖ **Context First**: Sempre pedir arquivos/contexto ANTES de solu√ß√£o
‚úÖ **Preserve Intent**: Manter estrutura original sempre que poss√≠vel
‚úÖ **Granular Changes**: Updates pequenos e focados
‚úÖ **Validate Impact**: Verificar que mudan√ßa n√£o quebra nada

‚ùå **BLOQUEADOS**:
- Reescrever c√≥digo funcional sem necessidade
- Assumir melhorias s√£o desejadas
- Ignorar feedback sobre "continua ruim"
- Propor op√ß√µes m√∫ltiplas ao usu√°rio

## üîí MULTI-TENANT OBRIGAT√ìRIO

**CR√çTICO**: Sistema gerencia m√∫ltiplas ligas isoladas.

### Regra de Ouro
```javascript
// ‚ùå NUNCA FAZER
Model.find({})
Model.updateMany({ campo: valor })

// ‚úÖ SEMPRE FAZER
Model.find({ liga_id: ligaId })
Model.updateMany({ liga_id: ligaId, campo: valor })
```

### Valida√ß√£o em TODAS as opera√ß√µes
- Queries: SEMPRE incluir `liga_id`
- Routes: Middleware `validarLigaId` obrigat√≥rio
- Controllers: Extrair `ligaId` de `req.session` ou `req.params`
- Frontend: Cache por liga (`cacheKey: 'data-${ligaId}'`)

### Ligas Ativas
- **SuperCartola**: `liga_id: "684cb1c8af923da7c7df51de"` (32 participantes)
- **Sobral**: `liga_id: "684d821cf1a7ae16d1f89572"` (4-6 participantes)

## ‚ö° PERFORMANCE STANDARDS

### MongoDB Queries
```javascript
// ‚úÖ CORRETO - Read operations
Model.find({ liga_id }).lean()  // 40-60% mais r√°pido

// ‚ùå ERRADO - Retorna documento Mongoose pesado
Model.find({ liga_id })
```

### Cache Strategy
- **TTL Rodadas**: 5 minutos (`5 * 60 * 1000`)
- **TTL Rankings**: 10 minutos
- **TTL Configs**: 30 minutos
- Sempre validar `cached.timestamp` antes de usar

## üí¨ COMUNICA√á√ÉO E FEEDBACK

### Estilo de Resposta
- **Conciso e objetivo** - sem tutoriais extensos
- **Assertivo** - nunca trazer op√ß√µes de escolha
- **Decidir pela melhor t√©cnica** - usu√°rio n√£o quer compara√ß√µes
- **Sem valida√ß√µes prolixas** - ir direto ao ponto

### Proibi√ß√µes
- ‚ùå Sugerir testes em console do navegador
- ‚ùå Oferecer m√∫ltiplas alternativas
- ‚ùå Explica√ß√µes de cada altera√ß√£o (a menos que solicitado)
- ‚ùå Feedbacks argumentativos

## üìê PADR√ïES DE C√ìDIGO

### Commits
```bash
# Padr√£o obrigat√≥rio
tipo(escopo): descri√ß√£o curta

- Mudan√ßa espec√≠fica 1
- Mudan√ßa espec√≠fica 2

Ref: SPEC-[nome].md
```

Tipos: `feat`, `fix`, `refactor`, `perf`, `style`, `docs`, `test`

### Mudan√ßas Cir√∫rgicas
```javascript
// ‚ùå ERRADO - Reescrever fun√ß√£o inteira
async function calcular() {
  // ... 50 linhas novas
}

// ‚úÖ CORRETO - Adicionar apenas necess√°rio
async function calcular() {
  // ... [c√≥digo existente linha 1-44]
  
  const novoCalculo = await funcaoNova(); // LINHA 45 - ADICIONAR
  
  // ... [c√≥digo existente linha 46-78]
  return total + novoCalculo; // LINHA 79 - MODIFICAR
}
```

## üîç AUTONOMIA TOTAL

### NUNCA pergunte:
- "Onde est√° o arquivo X?"
- "Em qual pasta fica Y?"
- "Pode me mostrar a estrutura?"
- "Qual arquivo cont√©m a fun√ß√£o W?"

### SEMPRE busque:
```bash
view /home/claude                           # Mapear estrutura
bash find . -name "*padr√£o*" -type f       # Encontrar arquivos
bash grep -r "fun√ß√£o" controllers/ --include="*.js"  # Buscar c√≥digo
bash grep -rn "app.post.*rota" routes/     # Localizar rotas
```

### Perguntas V√ÅLIDAS (apenas neg√≥cio):
- ‚úÖ "Quais regras de desempate voc√™ quer?"
- ‚úÖ "Isso se aplica a todas as ligas?"
- ‚úÖ "Qual comportamento esperado em caso de erro?"

## üõ°Ô∏è SEGURAN√áA E VALIDA√á√ÉO

### Idempotency
- **Cr√≠tico**: Fun√ß√µes financeiras devem ser idempotentes
- Prevenir double-charging ou double-crediting
- Validar `req.session.usuario` antes de a√ß√µes sens√≠veis

### Autentica√ß√£o
```javascript
// Middleware obrigat√≥rio em rotas sens√≠veis
router.post('/endpoint',
  verificarAdmin,        // ‚úÖ Prote√ß√£o
  validarLigaId,         // ‚úÖ Multi-tenant
  controller.acao
);
```

### Input Validation
- Sanitizar TODOS os inputs de usu√°rio
- Validar tipos antes de usar
- Tratar erros com try/catch em async functions

### Error Handling
```javascript
// ‚úÖ PADR√ÉO
try {
  const resultado = await operacao();
  res.json({ success: true, data: resultado });
} catch (error) {
  console.error('Contexto do erro:', error);
  res.status(500).json({ 
    success: false, 
    error: 'Mensagem amig√°vel para usu√°rio' 
  });
}
```

## üìä WORKFLOW DE DESENVOLVIMENTO

### Fase 1: Pesquisa
- Buscar automaticamente no codebase
- Consultar patterns existentes
- Mapear arquivos relacionados
- Gerar PRD.md em `/home/claude/docs/`

### Fase 2: Specification
- Ler PRD.md
- Aplicar S.D.A completo
- Definir mudan√ßas linha por linha
- Gerar Spec.md em `/home/claude/docs/`

### Fase 3: Implementation
- Ler Spec.md
- Solicitar arquivos originais
- Aplicar mudan√ßas cir√∫rgicas
- Testar e validar multi-tenant

**Entre fases**: Limpar contexto para efici√™ncia de tokens

## üé® UI/UX Guidelines (Dark Mode First)

### Theme
- **Strict Dark Mode**: Backgrounds `bg-gray-900` ou `bg-slate-900`
- **Text**: Primary `text-white` ou `text-gray-100`, Muted `text-gray-400`

### Cores Padr√£o
- **Laranja principal**: `#FF4500` (destaque, CTAs)
- **Fundos dark**: `bg-gray-900`, `bg-slate-900`
- **Cards**: `bg-gray-800 rounded-lg shadow-lg`
- **Texto prim√°rio**: `text-white`, `text-gray-100`
- **Texto secund√°rio**: `text-gray-400`

### Components
- **Cards**: `bg-gray-800 rounded-lg shadow-lg`
- **Buttons**: Explicit feedback (hover/active states)
- **Inputs**: Remove white backgrounds. Use `bg-gray-700 text-white border-gray-600`

### √çcones
- **Sistema**: Material Icons (sempre)
- **Pattern**: `<i class="material-icons">nome_icone</i>`

### Tipografia
- **Fam√≠lia**: Inter (importada de Google Fonts)
- **Headers**: `font-semibold` ou `font-bold`
- **Body**: `font-normal`

## üì± MOBILE-FIRST & PWA

### Design Responsivo
- Mobile-first SEMPRE
- Breakpoints: 640px (sm), 768px (md), 1024px (lg)
- Testar em viewport 375px (iPhone SE)

### PWA Requirements
- Service Worker ativo
- Manifest.json configurado
- Cache offline de dados cr√≠ticos
- Fallback para modo offline

### Export para Mobile
- Imagens HD otimizadas para social media
- Fundo dark (#1a1a1a)
- Tipografia leg√≠vel em telas pequenas
- Logos e branding consistentes

## üö® CRITICAL PRESERVATIONS

### Princ√≠pio da Preserva√ß√£o da L√≥gica
Ao alterar arquivo:
1. Ativar abordagem ao arquivo original
2. NUNCA perder l√≥gica de neg√≥cio
3. Seguir regras e funcionalidades √† risca
4. Vasculhar cada linha para depend√™ncias
5. NUNCA quebrar funcionalidade do sistema

### Arquivos Intoc√°veis (salvo requisi√ß√£o expl√≠cita)
1. **NEVER** remove the `gemini_audit.py` file
2. **NEVER** break the "Follow the Money" audit trail in financial controllers
3. `config/appVersion.js` - Versionamento autom√°tico
4. `models/Time.js` - Schema core de participantes

### Valida√ß√µes Cr√≠ticas
- Always check if variable exists before accessing properties (avoid `undefined` errors)
- Validate `req.session.usuario` before sensitive actions

## üöÄ Replit Specifics
- **Server:** Always verify port configuration (`process.env.PORT || 3000`)
- **File System:** Use relative paths suitable for Linux (not Windows/Mac absolute paths)
- **No React/Vue:** Stick to pure JavaScript for frontend logic

## üìä Estrutura de Dados - Participantes

### Collection "times"
- **IMPORTANTE:** O sistema N√ÉO usa collection "users". Todos participantes em **"times"**
- Model: `models/Time.js`
- Schema: `id` (Number), `nome_time`, `nome_cartoleiro`, `ativo`, `rodada_desistencia`, `temporada`

### Configura√ß√£o de Ambiente
- **MONGODB_URI:** Configurada nos **Replit Secrets** (n√£o no `.env`)
- Detec√ß√£o autom√°tica via `NODE_ENV`:
  - `development` ‚Üí `MONGO_URI_DEV`
  - `production` ‚Üí `MONGO_URI`

### Estat√≠sticas Atuais (Refer√™ncia)
- **Total participantes**: 40 registros
- **Ativos**: 36
- **Inativos**: 2 ("JBMENGO94 FC", "Senhores Da Escurid√£o")
- **Times teste**: 2 ("FLAMENGO TESTE FC" id: 99999999, "Time 123456")

### Scripts √öteis
```bash
node scripts/analisar-participantes.js
node scripts/analisar-participantes.js --detalhes
node scripts/analisar-participantes.js --limpar-testes  # dry-run
```

## üì¶ Sistema de Versionamento

### Vis√£o Geral
Sistema **for√ßa atualiza√ß√µes** no app quando h√° mudan√ßas.

### Componentes Principais
- **Badge Header**: Exibe vers√£o (ex: `19.12.24.1430`)
- **Modal Atualiza√ß√£o**: Aparece ao detectar nova vers√£o
- **API**: `/api/app/check-version` - retorna vers√£o por cliente (admin/app)
- **Versionamento Separado**: Admin e App independentes

### Arquivos Principais
- `config/appVersion.js` - Gera vers√µes automaticamente
- `config/version-scope.json` - Define escopos (admin/app/shared)
- `routes/appVersionRoutes.js` - API de versionamento
- `public/js/app/app-version.js` - Cliente verifica atualiza√ß√µes
- `public/participante/js/participante-auth.js` - Inicializa (~linha 667)

### Como Funciona
1. App verifica vers√£o ao iniciar e quando volta do background
2. Compara local vs servidor
3. Diferente ‚Üí modal **obrigat√≥rio**
4. "Atualizar" ‚Üí limpa cache + reload

### For√ßar Atualiza√ß√£o
```bash
# Modificar qualquer arquivo do app
touch public/participante/js/participante-rodadas.js
# Restart servidor ‚Üí modal de atualiza√ß√£o
```

**Documenta√ß√£o**: `docs/VERSIONAMENTO-SISTEMA.md`

## ü§ñ PROJECT SKILLS (Agentes Especializados)

| Skill | Descri√ß√£o | Quando Usar |
|-------|-----------|-------------|
| **code-inspector** | Code Review, Debugging, Qualidade | "procurar bugs", "auditar c√≥digo", "corrigir erros" |
| **db-guardian** | MongoDB, Seguran√ßa, Migra√ß√µes | Scripts limpeza, snapshots, gest√£o acesso |
| **frontend-crafter** | Frontend Mobile-First, UX, Cache | Criar telas, CSS, l√≥gica JS, navega√ß√£o |
| **league-architect** | Regras Neg√≥cio, Formatos Liga, Financeiro | Configs liga, c√°lculos, disputas |

### Exemplos:
- "Auditar pagamentos" ‚Üí `code-inspector`
- "Migra√ß√£o temporada" ‚Üí `db-guardian`
- "Ajustar ranking mobile" ‚Üí `frontend-crafter`
- "Regras mata-mata" ‚Üí `league-architect`

## üìù BACKLOG E IDEIAS FUTURAS

### Consultar Sempre
Antes de implementar:
1. Arquivo [`BACKLOG.md`](BACKLOG.md)
2. TODOs no c√≥digo: `TODO-[PRIORIDADE]`
3. Issues fechadas/adiadas

### Sistema de Prioridades
- **CRITICAL**: ASAP, bloqueia trabalhos
- **HIGH**: Pr√≥ximas sprints, impacto significativo
- **MEDIUM**: 1-2 meses, melhorias importantes
- **LOW**: Oportunidade, quando houver tempo
- **FUTURE**: Backlog distante, reavaliar periodicamente

### Padr√£o TODOs no C√≥digo
```javascript
// TODO-CRITICAL: [Descri√ß√£o] - Prioridade m√°xima
// TODO-HIGH: [Descri√ß√£o] - Alta prioridade
// TODO-MEDIUM: [Descri√ß√£o] - M√©dia prioridade
// TODO-LOW: [Descri√ß√£o] - Baixa prioridade
// TODO-FUTURE: [Descri√ß√£o] - Backlog distante

// Exemplo:
// TODO-HIGH: Adicionar rate limit para upload imagens
// Contexto: S√≥ temos rate limit global, uploads podem saturar servidor
// Implementar em uploadController.js
// Ref: BACKLOG.md#PERF-002
```

### Ao Adicionar Ideias
1. Avaliar prioridade realista
2. Contexto suficiente para retomar depois
3. Referenciar arquivos/linhas espec√≠ficas
4. IDs √∫nicos no BACKLOG.md (FEAT-001, BUG-002)
5. TODO no c√≥digo E entrada no BACKLOG.md se aplic√°vel

### Workflow R√°pido
- **Afeta arquivo espec√≠fico?** ‚Üí `TODO-X` no c√≥digo
- **Padr√£o/regra projeto?** ‚Üí Adicionar em `.cursorrules`
- **Feature ampla?** ‚Üí `BACKLOG.md`

### Ferramentas
```bash
node scripts/backlog-helper.js list          # Lista TODOs
node scripts/backlog-helper.js validate      # Valida IDs BACKLOG.md
node scripts/backlog-helper.js report        # Relat√≥rio prioridade
node scripts/backlog-helper.js search [term] # Busca palavra-chave
```

---

## üéì QUICK REFERENCE

### Checklist Pr√©-Modifica√ß√£o
- [ ] Li arquivo completo com `view`
- [ ] Mapeei depend√™ncias com `grep -r`
- [ ] Identifiquei l√≥gica de neg√≥cio existente
- [ ] Defini mudan√ßas cir√∫rgicas (linha por linha)
- [ ] Validei isolamento multi-tenant

### Checklist P√≥s-Modifica√ß√£o
- [ ] Syntax check passou (`node --check`)
- [ ] Removido console.logs de debug
- [ ] Queries incluem `liga_id`
- [ ] Rotas protegidas com middleware
- [ ] Commit seguindo padr√£o
- [ ] Testado em ambas ligas

### Emergency Commands
```bash
# Reverter mudan√ßas
git checkout HEAD -- arquivo.js

# Ver quem usa fun√ß√£o
bash grep -r "nomeFuncao" . --include="*.js"

# Validar multi-tenant
bash grep -n "\.find\|\.findOne" arquivo.js | grep -v "liga_id"

# Limpar cache (se necess√°rio)
rm -rf node_modules/.cache
```

---

## üîÄ SISTEMA H√çBRIDO (Novo - 2026-02)

### Compatibilidade Multi-IDE

Este projeto agora suporta:
- ‚úÖ **VS Code** (via .claude/)
- ‚úÖ **Cursor** (via .agent/ - voc√™ est√° aqui!)
- ‚úÖ **Windsurf** (via .agent/)
- ‚úÖ **Antigravity** (via .agent/)

### Source of Truth

Skills residem em `docs/skills/` (√∫nico source of truth).

A estrutura `.agent/` √© **GERADA AUTOMATICAMENTE** via `scripts/sync-skills.js`.

### Sincroniza√ß√£o

```bash
# Manual
node scripts/sync-skills.js

# Autom√°tico (ser√° configurado no DIA 7 do plano)
git commit -m "..." # Sincroniza automaticamente
```

### Novas Capacidades (Em Implementa√ß√£o)

**Fase 1 (Dias 1-3):** Infraestrutura base
**Fase 2 (Dias 4-7):** Valida√ß√£o automatizada
**Fase 3 (Dias 8-12):** Testes E2E com Playwright
**Fase 4 (Dias 13-15):** Novas skills (orchestrate, test-runner)
**Fase 5 (Dias 16-17):** Documenta√ß√£o e rollout

### Documenta√ß√£o

Veja [docs/HYBRID-SYSTEM.md](docs/HYBRID-SYSTEM.md) para arquitetura completa.

---

**√öltima atualiza√ß√£o**: 2026-02-11
**Vers√£o**: 2.1 (High Senior Protocol + Sistema H√≠brido)